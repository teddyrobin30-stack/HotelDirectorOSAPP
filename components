
import React, { useState, useEffect } from 'react';
import { X, User, Shield, Lock, Eye, EyeOff, Save, CheckSquare, Square, ChevronRight, Search, KeyRound, AlertTriangle } from 'lucide-react';
import { UserProfile, UserRole, UserPermissions } from '../types';
import { useAuth, getDefaultPermissions } from '../services/authContext';

interface AdvancedAccessModalProps {
  isOpen: boolean;
  onClose: () => void;
}

const AdvancedAccessModal: React.FC<AdvancedAccessModalProps> = ({ isOpen, onClose }) => {
  const { getAllUsers, adminUpdateUser, user: currentUser } = useAuth();
  const [users, setUsers] = useState<UserProfile[]>([]);
  const [selectedUser, setSelectedUser] = useState<UserProfile | null>(null);
  const [searchTerm, setSearchTerm] = useState('');

  // Edit States
  const [editName, setEditName] = useState('');
  const [editRole, setEditRole] = useState<UserRole>('staff');
  const [newPassword, setNewPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [editPermissions, setEditPermissions] = useState<UserPermissions | null>(null);

  useEffect(() => {
    if (isOpen) {
      setUsers(getAllUsers());
    }
  }, [isOpen]);

  const handleSelectUser = (u: UserProfile) => {
    setSelectedUser(u);
    setEditName(u.displayName);
    setEditRole(u.role);
    setEditPermissions(u.permissions || getDefaultPermissions(u.role));
    setNewPassword('');
  };

  const handleSave = async () => {
    if (!selectedUser || !editPermissions) return;

    await adminUpdateUser(selectedUser.uid, {
      displayName: editName,
      role: editRole,
      permissions: editPermissions,
      password: newPassword || undefined
    });

    setUsers(getAllUsers()); // Refresh list
    setNewPassword('');
    alert("Utilisateur mis √† jour avec succ√®s !");
  };

  const togglePermission = (key: keyof UserPermissions) => {
    if (!editPermissions) return;
    setEditPermissions({ ...editPermissions, [key]: !editPermissions[key] });
  };

  const filteredUsers = users.filter(u => 
    u.displayName.toLowerCase().includes(searchTerm.toLowerCase()) || 
    u.email.toLowerCase().includes(searchTerm.toLowerCase())
  );

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[160] bg-black/80 flex items-center justify-center animate-in fade-in backdrop-blur-sm p-4">
      <div className="w-full max-w-5xl h-[85vh] bg-white dark:bg-slate-900 rounded-[32px] shadow-2xl flex overflow-hidden">
        
        {/* LEFT: USER LIST */}
        <div className="w-1/3 border-r border-slate-200 dark:border-slate-800 flex flex-col bg-slate-50 dark:bg-slate-900/50">
           <div className="p-6 border-b border-slate-200 dark:border-slate-800">
              <h3 className="text-lg font-black mb-4 flex items-center gap-2">
                <Shield size={20} className="text-indigo-600"/> 
                Gestion des Acc√®s
              </h3>
              <div className="flex items-center gap-2 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                 <Search size={16} className="text-slate-400"/>
                 <input 
                   type="text" 
                   placeholder="Rechercher..." 
                   className="bg-transparent outline-none text-xs font-bold w-full"
                   value={searchTerm}
                   onChange={(e) => setSearchTerm(e.target.value)}
                 />
              </div>
           </div>
           
           <div className="flex-1 overflow-y-auto p-3 space-y-2">
              {filteredUsers.map(u => (
                <div 
                  key={u.uid}
                  onClick={() => handleSelectUser(u)}
                  className={`p-4 rounded-xl cursor-pointer transition-all flex items-center justify-between group ${selectedUser?.uid === u.uid ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-white dark:hover:bg-slate-800 hover:shadow'}`}
                >
                   <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${selectedUser?.uid === u.uid ? 'bg-white/20 text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-500'}`}>
                         {u.displayName.slice(0, 2).toUpperCase()}
                      </div>
                      <div>
                         <p className="text-sm font-bold">{u.displayName}</p>
                         <p className={`text-[10px] uppercase font-bold ${selectedUser?.uid === u.uid ? 'text-white/70' : 'text-slate-400'}`}>{u.role}</p>
                      </div>
                   </div>
                   <ChevronRight size={16} className={`opacity-0 group-hover:opacity-100 transition-opacity ${selectedUser?.uid === u.uid ? 'text-white' : 'text-slate-300'}`}/>
                </div>
              ))}
           </div>
        </div>

        {/* RIGHT: EDIT PANEL */}
        <div className="flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-slate-900">
           {selectedUser ? (
             <>
               <div className="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-start">
                  <div>
                     <h2 className="text-2xl font-black">{selectedUser.displayName}</h2>
                     <p className="text-sm text-slate-500">{selectedUser.email}</p>
                  </div>
                  <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                     <X size={20}/>
                  </button>
               </div>

               <div className="flex-1 overflow-y-auto p-8 space-y-8">
                  
                  {/* 1. Identity & Security */}
                  <div className="space-y-4">
                     <h4 className="text-xs font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
                        <User size={14}/> Identit√© & S√©curit√©
                     </h4>
                     <div className="grid grid-cols-2 gap-6">
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold uppercase text-slate-500">Nom complet</label>
                           <input 
                             type="text" 
                             value={editName}
                             onChange={(e) => setEditName(e.target.value)}
                             className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border-2 border-transparent focus:border-indigo-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold uppercase text-slate-500">R√¥le Principal</label>
                           <select 
                             value={editRole}
                             onChange={(e) => setEditRole(e.target.value as UserRole)}
                             className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border-2 border-transparent focus:border-indigo-500"
                           >
                              <option value="admin">Administrateur</option>
                              <option value="manager">Manager</option>
                              <option value="staff">Staff</option>
                           </select>
                        </div>
                     </div>

                     <div className="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-900/30 flex items-center gap-4">
                        <div className="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-amber-600">
                           <KeyRound size={20}/>
                        </div>
                        <div className="flex-1">
                           <label className="text-[10px] font-bold uppercase text-amber-600 mb-1 block">R√©initialiser Mot de Passe</label>
                           <div className="flex items-center gap-2">
                              <input 
                                type={showPassword ? "text" : "password"} 
                                placeholder="Nouveau mot de passe..." 
                                value={newPassword}
                                onChange={(e) => setNewPassword(e.target.value)}
                                className="bg-white dark:bg-slate-900 p-2 rounded-lg text-sm outline-none flex-1 border border-amber-200 dark:border-amber-800"
                              />
                              <button onClick={() => setShowPassword(!showPassword)} className="text-amber-500 hover:text-amber-700">
                                 {showPassword ? <EyeOff size={16}/> : <Eye size={16}/>}
                              </button>
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* 2. Fine-grained Permissions */}
                  {editPermissions && (
                    <div className="space-y-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                       <h4 className="text-xs font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
                          <Lock size={14}/> Permissions d'acc√®s aux Vues
                       </h4>
                       <div className="grid grid-cols-2 gap-3">
                          {[
                            { key: 'canViewAgenda', label: 'Agenda & Planning' },
                            { key: 'canViewCRM', label: 'CRM Commercial & Groupes' },
                            { key: 'canViewMessaging', label: 'Messagerie Interne' },
                            { key: 'canViewReception', label: 'R√©ception (Logbook/Taxis...)' },
                            { key: 'canViewFnb', label: 'F&B (Stocks/Recettes)' },
                            { key: 'canViewHousekeeping', label: 'Housekeeping (Chambres/Linge)' },
                            { key: 'canViewMaintenance', label: 'Maintenance & Technique' },
                            { key: 'canViewSpa', label: 'Spa & Bien-√™tre' },
                            { key: 'canManageSettings', label: 'ADMINISTRATION GLOBALE (Danger)', danger: true }
                          ].map(perm => (
                            <div 
                              key={perm.key}
                              onClick={() => togglePermission(perm.key as keyof UserPermissions)}
                              className={`p-3 rounded-xl border-2 cursor-pointer flex items-center gap-3 transition-all ${editPermissions[perm.key as keyof UserPermissions] 
                                ? (perm.danger ? 'bg-red-50 border-red-500' : 'bg-indigo-50 border-indigo-500 dark:bg-indigo-900/20 dark:border-indigo-500') 
                                : 'bg-slate-50 dark:bg-slate-800 border-transparent opacity-60'}`}
                            >
                               <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${editPermissions[perm.key as keyof UserPermissions] ? (perm.danger ? 'bg-red-500 border-red-500' : 'bg-indigo-600 border-indigo-600') : 'border-slate-300 bg-white dark:bg-slate-700'}`}>
                                  {editPermissions[perm.key as keyof UserPermissions] && <CheckSquare size={12} className="text-white"/>}
                               </div>
                               <span className={`text-xs font-bold ${perm.danger ? 'text-red-600' : 'text-slate-700 dark:text-slate-200'}`}>
                                  {perm.label}
                                  {perm.danger && <AlertTriangle size={12} className="inline ml-2 text-red-500"/>}
                               </span>
                            </div>
                          ))}
                       </div>
                    </div>
                  )}

               </div>

               {/* Footer */}
               <div className="p-6 border-t border-slate-100 dark:border-slate-800 flex justify-end gap-3 bg-slate-50 dark:bg-slate-900/50">
                  <button onClick={onClose} className="px-6 py-3 rounded-xl font-bold text-xs uppercase text-slate-500 hover:bg-white dark:hover:bg-slate-800 transition-colors">Annuler</button>
                  <button 
                    onClick={handleSave}
                    className="px-8 py-3 rounded-xl bg-indigo-600 text-white font-black text-xs uppercase shadow-lg hover:bg-indigo-700 flex items-center gap-2 transition-transform active:scale-95"
                  >
                     <Save size={16}/> Enregistrer les modifications
                  </button>
               </div>
             </>
           ) : (
             <div className="flex-1 flex flex-col items-center justify-center text-slate-300 dark:text-slate-700">
                <Shield size={64} className="mb-4 opacity-50"/>
                <p className="text-xl font-black">S√©lectionnez un utilisateur</p>
                <p className="font-medium text-sm">pour modifier ses acc√®s</p>
             </div>
           )}
        </div>
      </div>
    </div>
  );
};

export default AdvancedAccessModal;


import React, { useState, useMemo } from 'react';
import { 
  ChevronLeft, ChevronRight, Plus, 
  Calendar as CalendarIcon, Clock, MapPin, 
  Layers, ListFilter, CalendarDays, Users, RefreshCw, CheckCircle2, Video, Tag, Briefcase
} from 'lucide-react';
import { CalendarEvent, UserSettings, Group, Task } from '../types';

interface AgendaViewProps {
  events: CalendarEvent[];
  todos: Task[];
  userSettings: UserSettings;
  onAdd: () => void;
  onEventClick: (event: CalendarEvent) => void;
  onGroupClick: (group: Group) => void;
  groups: Group[];
}

const AgendaView: React.FC<AgendaViewProps> = ({ events, todos, userSettings, onAdd, onEventClick, onGroupClick, groups }) => {
  const [view, setView] = useState<'day' | 'week' | 'month'>('day');
  const [currentDate, setCurrentDate] = useState(new Date());
  const [activeFilter, setActiveFilter] = useState('ALL');

  const filters = [
    { id: 'ALL', label: 'Toutes' },
    { id: 'RDV', label: 'Rendez-vous' },
    { id: 'GROUPE', label: 'Groupes' },
    { id: 'PERSO', label: 'Perso' },
    { id: 'F&B', label: 'F&B' },
    { id: 'MAINTENANCE', label: 'Maintenance' },
    { id: 'RH', label: 'RH' },
    { id: 'TRAVAUX', label: 'Travaux' },
  ];

  const isSameDay = (d1: Date, d2: Date) => 
    d1.getDate() === d2.getDate() && 
    d1.getMonth() === d2.getMonth() && 
    d1.getFullYear() === d2.getFullYear();

  const isDateInRange = (d: Date, startStr: string, endStr: string) => {
    if (!startStr || !endStr) return false;
    const checkDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const start = new Date(startStr);
    const end = new Date(endStr);
    start.setHours(0,0,0,0);
    end.setHours(0,0,0,0);
    return checkDate >= start && checkDate <= end;
  };

  // Helper to get items for a specific date and apply active filter
  const getItemsForDate = (date: Date) => {
    let dayEvts = events.filter(e => isSameDay(new Date(e.start), date));
    // Filter Pipeline Groups: Must have valid dates
    let dayGroups = groups.filter(g => g.startDate && g.endDate && isDateInRange(date, g.startDate, g.endDate));
    let dayTasks = todos.filter(t => t.date && isSameDay(new Date(t.date), date));

    if (activeFilter !== 'ALL') {
      if (activeFilter === 'RDV') {
        dayEvts = dayEvts.filter(e => e.type === 'pro' || e.type === 'google');
        dayGroups = [];
        dayTasks = [];
      } else if (activeFilter === 'GROUPE') {
        dayEvts = [];
        dayTasks = [];
      } else if (activeFilter === 'PERSO') {
        dayEvts = dayEvts.filter(e => e.type === 'perso');
        dayGroups = [];
        dayTasks = dayTasks.filter(t => t.tag === 'Perso');
      } else {
        // Filter by specific Task Tag (F&B, Maintenance, etc.)
        dayEvts = [];
        dayGroups = [];
        dayTasks = dayTasks.filter(t => t.tag.toUpperCase() === activeFilter);
      }
    }

    return { events: dayEvts, groups: dayGroups, tasks: dayTasks };
  };

  // Month Grid Logic
  const monthData = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    
    let startDay = firstDayOfMonth.getDay();
    startDay = startDay === 0 ? 6 : startDay - 1;
    
    const days = [];
    for (let i = 0; i < startDay; i++) {
      days.push({ day: null, date: null });
    }
    for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
      days.push({ day: i, date: new Date(year, month, i) });
    }
    return days;
  }, [currentDate]);

  // Week Logic
  const weekDays = useMemo(() => {
    const d = new Date(currentDate);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    
    return Array.from({ length: 7 }).map((_, i) => {
      const dayDate = new Date(monday);
      dayDate.setDate(monday.getDate() + i);
      return dayDate;
    });
  }, [currentDate]);

  const changeDate = (dir: number) => {
    const d = new Date(currentDate);
    if (view === 'month') {
      d.setMonth(d.getMonth() + dir);
    } else if (view === 'week') {
      d.setDate(d.getDate() + (dir * 7));
    } else {
      d.setDate(d.getDate() + dir);
    }
    setCurrentDate(d);
  };

  const themeHex = `text-${userSettings.themeColor}-600`;
  const themeBg = `bg-${userSettings.themeColor}-600`;

  const renderItemList = (date: Date) => {
    const { events: dEvents, groups: dGroups, tasks: dTasks } = getItemsForDate(date);
    
    if (dEvents.length === 0 && dGroups.length === 0 && dTasks.length === 0) {
      return (
        <div className="py-12 text-center opacity-30 animate-in fade-in zoom-in duration-300">
          <CalendarDays size={32} className="mx-auto mb-2 text-slate-300" />
          <p className="text-[10px] font-black uppercase tracking-[0.2em]">Rien √† signaler</p>
        </div>
      );
    }

    return (
      <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-300">
        
        {/* PIPELINE GROUPS OVERLAY - Distinct Visuals */}
        {dGroups.map(g => {
          const isConfirmed = g.status === 'confirmed';
          return (
            <div 
              key={`g-${g.id}`} 
              onClick={() => onGroupClick(g)} // REDIRECT TO DETAIL (READ ONLY IN CALENDAR)
              className={`p-4 rounded-2xl border-l-[6px] shadow-sm cursor-pointer transition-all hover:translate-x-1 active:scale-[0.98] ${
                isConfirmed 
                  ? 'border-l-violet-500 bg-violet-50 dark:bg-violet-900/10 border-y border-r border-violet-100 dark:border-violet-900' 
                  : 'border-l-amber-400 bg-amber-50 dark:bg-amber-900/10 border-y border-r border-amber-100 dark:border-amber-900'
              }`}
            >
              <div className="flex justify-between items-start mb-1">
                <span className={`text-[9px] font-black uppercase tracking-widest flex items-center gap-1 ${isConfirmed ? 'text-violet-600' : 'text-amber-600'}`}>
                  <Briefcase size={10} /> {isConfirmed ? 'Confirm√©' : 'Option'}
                </span>
                {/* Visual Indicator that this is a Group Event */}
                <div className={`px-2 py-0.5 rounded text-[8px] font-bold uppercase text-white ${isConfirmed ? 'bg-violet-500' : 'bg-amber-400'}`}>
                  Groupe
                </div>
              </div>
              <h4 className={`font-bold text-sm leading-snug ${userSettings.darkMode ? 'text-white' : 'text-slate-900'}`}>
                {g.name} <span className="opacity-60 font-normal">({isConfirmed ? 'Confirm√©' : 'Option'})</span>
              </h4>
              <div className={`flex items-center gap-3 mt-2 text-[10px] font-medium ${isConfirmed ? 'text-violet-400' : 'text-amber-500'}`}>
                 <span>{g.pax} PAX</span>
                 <span>‚Ä¢</span>
                 <span>{g.nights} Nuits</span>
              </div>
            </div>
          );
        })}

        {/* TASKS */}
        {dTasks.map(t => (
          <div key={`t-${t.id}`} className={`p-5 rounded-[28px] border-2 shadow-sm transition-all ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-emerald-50/30 border-emerald-100'}`}>
            <span className="text-[8px] font-black uppercase text-emerald-600 mb-1.5 block flex items-center gap-1 tracking-widest">
              <CheckCircle2 size={10} /> T√¢che ‚Ä¢ {t.tag}
            </span>
            <h4 className={`font-bold text-sm ${t.done ? 'line-through opacity-50' : ''}`}>{t.text}</h4>
          </div>
        ))}

        {/* STANDARD EVENTS */}
        {dEvents.map(evt => (
          <div key={`e-${evt.id}`} onClick={() => onEventClick(evt)} className={`p-5 rounded-[28px] border-2 shadow-sm cursor-pointer transition-all active:scale-[0.98] ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-50 hover:border-indigo-100'}`}>
            <div className="flex justify-between items-start mb-1.5">
              <span className={`text-[8px] font-black uppercase tracking-widest flex items-center gap-1 ${evt.type === 'google' ? 'text-blue-500' : (evt.type === 'perso' ? 'text-amber-500' : themeHex)}`}>
                <Clock size={10} /> {evt.time} ‚Ä¢ {evt.type === 'perso' ? 'Personnel' : 'Professionnel'}
              </span>
              <div className={`w-2 h-2 rounded-full ${evt.type === 'perso' ? 'bg-amber-500' : themeBg}`}></div>
            </div>
            <h4 className="font-bold text-sm">{evt.title}</h4>
            {evt.videoLink && (
              <button 
                onClick={(e) => { e.stopPropagation(); window.open(evt.videoLink, '_blank'); }}
                className="mt-4 w-full py-2.5 px-3 rounded-2xl bg-blue-50 text-blue-600 text-[10px] font-black flex items-center justify-center gap-2 hover:bg-blue-100 transition-colors shadow-sm"
              >
                <Video size={14} /> REJOINDRE VISIO
              </button>
            )}
          </div>
        ))}
      </div>
    );
  };

  return (
    <div className="h-full flex flex-col animate-in fade-in relative">
      {/* Header */}
      <div className={`p-6 pb-4 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900' : 'bg-slate-50'}`}>
        <h2 className="text-xl font-black capitalize tracking-tight">
          {view === 'month' 
            ? currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })
            : view === 'week'
              ? `Sem. ${Math.ceil(currentDate.getDate() / 7)} - ${currentDate.toLocaleDateString('fr-FR', { month: 'short' })}`
              : currentDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })
          }
        </h2>
        <div className="flex gap-2 items-center">
          <div className="flex gap-1 items-center bg-slate-100 dark:bg-slate-800 rounded-full p-0.5">
            <button onClick={() => changeDate(-1)} className="p-2 rounded-full hover:bg-white dark:hover:bg-slate-700 transition-all"><ChevronLeft size={18}/></button>
            <button onClick={() => changeDate(1)} className="p-2 rounded-full hover:bg-white dark:hover:bg-slate-700 transition-all"><ChevronRight size={18}/></button>
          </div>
          <button 
            onClick={onAdd}
            className={`p-2.5 rounded-2xl text-white shadow-xl ${themeBg} transition-all active:scale-90 hover:opacity-90`}
          >
            <Plus size={20} />
          </button>
        </div>
      </div>

      {/* View Tabs */}
      <div className="px-6 pb-4">
        <div className={`flex p-1 rounded-2xl ${userSettings.darkMode ? 'bg-slate-800' : 'bg-slate-200/50'}`}>
          {(['day', 'week', 'month'] as const).map((v) => (
            <button 
              key={v}
              onClick={() => setView(v)} 
              className={`flex-1 py-2 text-[9px] font-black rounded-xl uppercase tracking-widest transition-all ${view === v ? 'bg-white shadow-sm ' + themeHex : 'text-slate-400'}`}
            >
              {v === 'day' ? 'Jour' : v === 'week' ? 'Semaine' : 'Mois'}
            </button>
          ))}
        </div>
      </div>

      {/* Filter Chips - Fix: More compact size (py-1.5, px-4, rounded-full) */}
      <div className="w-full pb-4 pt-1">
        <div className="flex gap-2 overflow-x-auto no-scrollbar px-6 snap-x">
          {filters.map(filter => (
            <button
              key={filter.id}
              onClick={() => setActiveFilter(filter.id)}
              className={`px-4 py-1.5 rounded-full text-[8px] font-black uppercase tracking-widest whitespace-nowrap transition-all border-2 snap-center ${activeFilter === filter.id ? `bg-slate-900 border-slate-900 text-white shadow-md` : `${userSettings.darkMode ? 'bg-slate-800 border-transparent text-slate-400' : 'bg-white border-slate-100 text-slate-500 hover:border-slate-200'}`}`}
            >
              {filter.label}
            </button>
          ))}
          {/* Spacer to fix clipping at the very end of scroll */}
          <div className="min-w-[24px] h-1" />
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto px-6 no-scrollbar pb-32">
        {view === 'month' ? (
          <div className={`p-6 rounded-[36px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-50'}`}>
            <div className="grid grid-cols-7 gap-1 mb-5 text-center text-[10px] font-black text-slate-300 uppercase tracking-widest">
              {['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].map(d => <span key={d} className="w-full">{d}</span>)}
            </div>
            <div className="grid grid-cols-7 gap-y-4 gap-x-1">
              {monthData.map((item, i) => {
                if (!item.date) return <div key={`empty-${i}`} className="aspect-square" />;
                const { events: eCount, groups: gCount, tasks: tCount } = getItemsForDate(item.date);
                const hasSomething = eCount.length > 0 || gCount.length > 0 || tCount.length > 0;
                const isToday = isSameDay(item.date, new Date());
                const isSelected = isSameDay(item.date, currentDate);

                return (
                  <button 
                    key={`day-${i}`}
                    onClick={() => { setCurrentDate(item.date!); setView('day'); }}
                    className={`aspect-square relative rounded-[18px] flex flex-col items-center justify-center transition-all ${isSelected ? themeBg + ' text-white shadow-lg scale-110 z-10' : isToday ? 'bg-slate-100 dark:bg-slate-700 font-black' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}
                  >
                    <span className="text-xs font-bold">{item.day}</span>
                    {hasSomething && !isSelected && (
                      <div className="absolute bottom-1.5 flex gap-0.5">
                        <div className={`w-1 h-1 rounded-full ${gCount.length > 0 ? 'bg-violet-500' : eCount.length > 0 ? themeBg : 'bg-emerald-500'}`} />
                      </div>
                    )}
                  </button>
                );
              })}
            </div>
          </div>
        ) : view === 'week' ? (
          <div className="space-y-10">
            {weekDays.map((day, idx) => (
              <div key={`week-day-${idx}`} className="space-y-4">
                <div className="flex items-center gap-4">
                  <span className={`text-[10px] font-black uppercase tracking-[0.2em] whitespace-nowrap ${isSameDay(day, new Date()) ? themeHex : 'text-slate-300'}`}>
                    {day.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}
                  </span>
                  <div className="flex-1 h-[1px] bg-slate-100 dark:bg-slate-800"></div>
                </div>
                {renderItemList(day)}
              </div>
            ))}
          </div>
        ) : (
          <div className="space-y-8">
            <div className="flex items-center gap-5">
               <div className={`w-14 h-14 rounded-3xl flex flex-col items-center justify-center ${themeBg} text-white shadow-xl`}>
                  <span className="text-[9px] font-black uppercase tracking-tighter">{currentDate.toLocaleDateString('fr-FR', { weekday: 'short' })}</span>
                  <span className="text-xl font-black">{currentDate.getDate()}</span>
               </div>
               <div>
                  <h3 className="font-black text-lg tracking-tight">{currentDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })}</h3>
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <Layers size={12} /> {activeFilter === 'ALL' ? 'Vue d\'ensemble' : filters.find(f => f.id === activeFilter)?.label}
                  </p>
               </div>
            </div>
            <div className="pt-2">
              {renderItemList(currentDate)}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default AgendaView;

import React, { useState, useEffect, useRef } from 'react';
import { GoogleGenAI } from "@google/genai";
import { X, Send, Sparkles, Loader2, Bot, User } from 'lucide-react';
import { UserSettings, Task, Contact, Room, MonthlyInventory, MaintenanceTicket } from '../types';

interface AiAssistantProps {
  isOpen: boolean;
  onClose: () => void;
  userSettings: UserSettings;
  // Donn√©es r√©elles optionnelles (pour √©viter les crashs si non pass√©es)
  tasks?: Task[];
  contacts?: Contact[];
  rooms?: Room[];
  inventory?: Record<string, MonthlyInventory>;
  maintenance?: MaintenanceTicket[];
}

interface Message {
  id: string;
  role: 'user' | 'model';
  text: string;
  timestamp: Date;
}

const AiAssistant: React.FC<AiAssistantProps> = ({ 
  isOpen, onClose, userSettings, 
  tasks = [], 
  contacts = [], 
  rooms = [], 
  inventory = {}, 
  maintenance = [] 
}) => {
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Message[]>([
    {
      id: 'welcome',
      role: 'model',
      text: "Bonjour ! Je suis votre assistant. Je suis connect√© aux donn√©es de l'h√¥tel. Demandez-moi : '√âtat du stock', 'Combien de t√¢ches ?' ou 'Taux d'occupation'.",
      timestamp: new Date()
    }
  ]);
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Auto-scroll
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isOpen]);

  // FONCTION D'ANALYSE LOCALE (DETERMINISTE & RAPIDE)
  const analyzeLocalData = (query: string): string | null => {
    const lower = query.toLowerCase();

    // 1. INVENTAIRE / STOCK
    if (lower.includes('stock') || lower.includes('inventaire') || lower.includes('article')) {
      const currentMonthKey = Object.keys(inventory || {}).sort().reverse()[0];
      if (!currentMonthKey) return "Aucun inventaire trouv√©.";
      
      const items = inventory[currentMonthKey]?.items || [];
      const totalItems = items.length;
      const totalValue = items.reduce((acc, item) => acc + (item.currentQty * item.unitCost), 0);
      const lowStock = items.filter(i => i.currentQty < 5).length;

      return `üì¶ **Inventaire (${currentMonthKey})** :\n- ${totalItems} r√©f√©rences enregistr√©es.\n- Valeur totale : ${totalValue.toFixed(2)} ‚Ç¨.\n- ${lowStock} articles en stock faible (< 5).`;
    }

    // 2. TACHES / MAINTENANCE
    if (lower.includes('t√¢che') || lower.includes('ticket') || lower.includes('maintenance')) {
      const openTasks = tasks.filter(t => !t.done).length;
      const urgentTasks = tasks.filter(t => !t.done && t.priority === 'High').length;
      const openTickets = maintenance.filter(t => t.status !== 'resolved').length;

      return `üìã **Plan d'action & Technique** :\n- ${openTasks} t√¢ches √† faire (dont ${urgentTasks} urgentes).\n- ${openTickets} tickets de maintenance en cours.`;
    }

    // 3. CHAMBRES / MENAGE
    if (lower.includes('chambre') || lower.includes('m√©nage') || lower.includes('propre')) {
      const total = rooms.length;
      const clean = rooms.filter(r => r.statusHK === 'ready').length;
      const dirty = rooms.filter(r => r.statusHK === 'not_started').length;
      const progress = rooms.filter(r => r.statusHK === 'in_progress').length;

      return `üõè **√âtat des Lieux** :\n- Total : ${total} chambres.\n- Pr√™tes : ${clean} ‚úÖ\n- √Ä faire : ${dirty} ‚ùå\n- En cours : ${progress} ‚è≥`;
    }

    // 4. CONTACTS / VIP
    if (lower.includes('contact') || lower.includes('client') || lower.includes('vip')) {
      const total = contacts.length;
      const vips = contacts.filter(c => c.vip).length;
      const inHouse = contacts.filter(c => c.status === 'In House').length;

      return `üë• **Base Clients** :\n- ${total} contacts enregistr√©s.\n- ${vips} VIPs identifi√©s.\n- ${inHouse} clients actuellement en maison (statut 'In House').`;
    }

    return null; // Pas de correspondance locale -> Appel API
  };

  const handleSend = async () => {
    if (!input.trim()) return;

    const userMsg: Message = {
      id: Date.now().toString(),
      role: 'user',
      text: input,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsLoading(true);

    // 1. TENTATIVE D'ANALYSE LOCALE D'ABORD
    const localResponse = analyzeLocalData(input);
    
    if (localResponse) {
        // R√©ponse instantan√©e sans API
        const botMsg: Message = {
            id: (Date.now() + 1).toString(),
            role: 'model',
            text: localResponse,
            timestamp: new Date()
        };
        setMessages(prev => [...prev, botMsg]);
        setIsLoading(false);
        return;
    }

    // 2. SINON : APPEL API (Si cl√© configur√©e, sinon message d√©faut)
    try {
      if (!process.env.API_KEY) {
         throw new Error("Pas de cl√© API configur√©e.");
      }

      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      
      // Contexte all√©g√© pour l'IA (√©viter d'envoyer trop de donn√©es)
      const contextSummary = {
         tasksCount: tasks.length,
         roomsReady: rooms.filter(r => r.statusHK === 'ready').length,
         contactsCount: contacts.length
      };

      const systemPrompt = `Tu es un assistant h√¥telier. R√©ponds bri√®vement. Contexte : ${JSON.stringify(contextSummary)}.`;

      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: [
          { role: 'user', parts: [{ text: systemPrompt + "\n\n" + input }] }
        ]
      });

      const textResponse = response.text || "Je n'ai pas compris.";

      const botMsg: Message = {
        id: (Date.now() + 1).toString(),
        role: 'model',
        text: textResponse,
        timestamp: new Date()
      };

      setMessages(prev => [...prev, botMsg]);

    } catch (error) {
      console.warn("IA non disponible ou erreur:", error);
      const fallbackMsg: Message = {
        id: (Date.now() + 1).toString(),
        role: 'model',
        text: "Je n'ai pas trouv√© l'information pr√©cise dans mes donn√©es locales. Essayez des mots-cl√©s comme 'stock', 'chambres' ou 't√¢ches'.",
        timestamp: new Date()
      };
      setMessages(prev => [...prev, fallbackMsg]);
    } finally {
      setIsLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <>
      <div 
        className="fixed inset-0 z-[190] bg-black/20 backdrop-blur-sm transition-opacity" 
        onClick={onClose}
      />
      <div className={`fixed inset-y-0 right-0 z-[200] w-full md:w-[450px] shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col ${userSettings.darkMode ? 'bg-slate-900 border-l border-slate-800' : 'bg-white border-l border-slate-100'}`}>
        
        {/* Header */}
        <div className="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-violet-600 text-white">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white/20 rounded-xl backdrop-blur-md">
              <Sparkles size={20} className="text-white animate-pulse" />
            </div>
            <div>
              <h2 className="text-lg font-black tracking-tight">HotelOS Genius</h2>
              <p className="text-[10px] font-medium opacity-80 uppercase tracking-widest">Assistant Donn√©es</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors">
            <X size={20} />
          </button>
        </div>

        {/* Chat Area */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-950">
          {messages.map((msg) => {
            const isModel = msg.role === 'model';
            return (
              <div key={msg.id} className={`flex gap-3 ${isModel ? 'justify-start' : 'justify-end'}`}>
                {isModel && (
                  <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center shrink-0 shadow-md mt-1">
                    <Bot size={16} className="text-white" />
                  </div>
                )}
                <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm text-sm leading-relaxed whitespace-pre-wrap ${
                  isModel 
                    ? 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-tl-none' 
                    : 'bg-indigo-600 text-white rounded-tr-none'
                }`}>
                  {msg.text}
                </div>
                {!isModel && (
                  <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center shrink-0 mt-1">
                    <User size={16} className="text-slate-500" />
                  </div>
                )}
              </div>
            );
          })}
          {isLoading && (
            <div className="flex gap-3 justify-start">
               <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center shrink-0 shadow-md">
                  <Bot size={16} className="text-white" />
               </div>
               <div className="p-4 rounded-2xl bg-white dark:bg-slate-800 rounded-tl-none shadow-sm flex items-center gap-2 text-slate-500">
                  <Loader2 size={16} className="animate-spin" />
                  <span className="text-xs font-bold">Analyse en cours...</span>
               </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input Area */}
        <div className="p-4 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800">
           <div className="flex gap-2">
              <input 
                type="text" 
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                placeholder="Interroger les donn√©es..."
                className="flex-1 bg-slate-100 dark:bg-slate-800 border-transparent focus:border-indigo-500 border-2 rounded-xl px-4 py-3 text-sm font-bold outline-none dark:text-white transition-all"
                autoFocus
              />
              <button 
                onClick={handleSend}
                disabled={!input.trim() || isLoading}
                className="p-3 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl shadow-lg transition-all active:scale-95"
              >
                <Send size={20} />
              </button>
           </div>
           <div className="mt-3 flex gap-2 overflow-x-auto no-scrollbar pb-1">
              {['√âtat du stock', 'Combien de t√¢ches ?', 'Chambres propres ?', 'Liste VIP'].map(suggestion => (
                <button 
                  key={suggestion}
                  onClick={() => { setInput(suggestion); }}
                  className="px-3 py-1.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-[10px] font-bold text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-colors whitespace-nowrap"
                >
                  {suggestion}
                </button>
              ))}
           </div>
        </div>

      </div>
    </>
  );
};

export default AiAssistant;

import React, { useState } from 'react';
import { X, Building, CreditCard, Box, Plus, Trash2, Save, FileText, MapPin, Clock } from 'lucide-react';
import { BusinessConfig, CatalogItem, Venue, UserSettings } from '../types';

interface BusinessConfigModalProps {
  isOpen: boolean;
  onClose: () => void;
  config: BusinessConfig;
  catalog: CatalogItem[];
  venues: Venue[];
  onSaveConfig: (config: BusinessConfig) => void;
  onSaveCatalog: (catalog: CatalogItem[]) => void;
  onSaveVenues: (venues: Venue[]) => void;
  userSettings: UserSettings;
}

const BusinessConfigModal: React.FC<BusinessConfigModalProps> = ({ 
  isOpen, onClose, config, catalog, venues, onSaveConfig, onSaveCatalog, onSaveVenues, userSettings 
}) => {
  const [activeTab, setActiveTab] = useState<'info' | 'catalog' | 'venues'>('info');
  const [localConfig, setLocalConfig] = useState<BusinessConfig>(config);
  const [localCatalog, setLocalCatalog] = useState<CatalogItem[]>(catalog);
  const [localVenues, setLocalVenues] = useState<Venue[]>(venues || []);

  if (!isOpen) return null;

  const handleConfigChange = (field: keyof BusinessConfig, value: string) => {
    setLocalConfig(prev => ({ ...prev, [field]: value }));
  };

  const handleCatalogChange = (id: string, field: keyof CatalogItem, value: any) => {
    setLocalCatalog(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  const handleVenueChange = (id: string, field: keyof Venue, value: any) => {
    setLocalVenues(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  const addCatalogItem = () => {
    setLocalCatalog([...localCatalog, { 
      id: Date.now().toString(), 
      name: 'Nouveau Produit', 
      defaultPrice: 0, 
      defaultVat: 20,
      technicalDescription: ''
    }]);
  };

  const addVenue = () => {
    setLocalVenues([...localVenues, {
      id: Date.now().toString(),
      name: 'Nouvelle Salle',
      capacity: 10,
      type: 'Salle de r√©union'
    }]);
  };

  const removeCatalogItem = (id: string) => {
    setLocalCatalog(prev => prev.filter(item => item.id !== id));
  };

  const removeVenue = (id: string) => {
    setLocalVenues(prev => prev.filter(item => item.id !== id));
  };

  const saveAll = () => {
    onSaveConfig(localConfig);
    onSaveCatalog(localCatalog);
    onSaveVenues(localVenues);
    onClose();
  };

  const themeHex = `text-${userSettings.themeColor}-600`;
  const themeBg = `bg-${userSettings.themeColor}-600`;

  return (
    <div className="fixed inset-0 z-[150] bg-black/70 flex items-center justify-center animate-in fade-in backdrop-blur-sm">
      <div className={`w-full max-w-2xl rounded-[32px] mx-4 p-6 pb-8 shadow-2xl flex flex-col max-h-[90vh] ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        {/* Header */}
        <div className="flex justify-between items-center mb-6 shrink-0">
           <div className="flex items-center gap-3">
             <div className={`p-3 rounded-2xl ${userSettings.darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
               <Building size={24} className={themeHex} />
             </div>
             <div>
               <h2 className="text-xl font-black">Configuration Business</h2>
               <p className="text-xs text-slate-400 font-bold">Infos l√©gales, Lieux & Catalogue</p>
             </div>
           </div>
           <button onClick={onClose} className="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-slate-200"><X size={20}/></button>
        </div>

        {/* Tabs */}
        <div className="flex p-1 rounded-2xl bg-slate-100 dark:bg-slate-800 mb-6 shrink-0 overflow-x-auto">
          <button 
            onClick={() => setActiveTab('info')}
            className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 whitespace-nowrap ${activeTab === 'info' ? 'bg-white dark:bg-slate-700 shadow-sm ' + themeHex : 'text-slate-400'}`}
          >
            <FileText size={14} /> Infos L√©gales
          </button>
          <button 
            onClick={() => setActiveTab('venues')}
            className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 whitespace-nowrap ${activeTab === 'venues' ? 'bg-white dark:bg-slate-700 shadow-sm ' + themeHex : 'text-slate-400'}`}
          >
            <MapPin size={14} /> Lieux
          </button>
          <button 
            onClick={() => setActiveTab('catalog')}
            className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 whitespace-nowrap ${activeTab === 'catalog' ? 'bg-white dark:bg-slate-700 shadow-sm ' + themeHex : 'text-slate-400'}`}
          >
            <Box size={14} /> Catalogue
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto no-scrollbar px-1">
          {activeTab === 'info' ? (
            <div className="space-y-6">
              {/* Identity */}
              <div className="space-y-3">
                <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Identit√© Entreprise</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                   <input type="text" placeholder="Nom de l'entreprise" value={localConfig.companyName} onChange={(e) => handleConfigChange('companyName', e.target.value)} className={`p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                   <input type="text" placeholder="SIRET" value={localConfig.siret} onChange={(e) => handleConfigChange('siret', e.target.value)} className={`p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                </div>
                <input type="text" placeholder="Adresse compl√®te" value={localConfig.address} onChange={(e) => handleConfigChange('address', e.target.value)} className={`w-full p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                   <input type="text" placeholder="TVA Intracom." value={localConfig.vatNumber} onChange={(e) => handleConfigChange('vatNumber', e.target.value)} className={`p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                   <input type="email" placeholder="Email Contact Facturation" value={localConfig.email} onChange={(e) => handleConfigChange('email', e.target.value)} className={`p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                </div>
              </div>

              {/* Bank */}
              <div className="space-y-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Coordonn√©es Bancaires</h3>
                <input type="text" placeholder="Nom de la Banque" value={localConfig.bankName} onChange={(e) => handleConfigChange('bankName', e.target.value)} className={`w-full p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                <div className="grid grid-cols-3 gap-3">
                   <input type="text" placeholder="IBAN" value={localConfig.iban} onChange={(e) => handleConfigChange('iban', e.target.value)} className={`col-span-2 p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                   <input type="text" placeholder="BIC" value={localConfig.bic} onChange={(e) => handleConfigChange('bic', e.target.value)} className={`col-span-1 p-4 rounded-2xl font-bold text-sm outline-none border-2 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-transparent focus:border-indigo-200'}`} />
                </div>
              </div>
            </div>
          ) : activeTab === 'venues' ? (
            <div className="space-y-4">
               <div className="flex justify-between items-center px-1">
                 <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Salles & Lieux</h3>
                 <button onClick={addVenue} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase flex items-center gap-1 ${themeBg} text-white`}>
                   <Plus size={12}/> Ajouter Lieu
                 </button>
               </div>
               
               <div className="space-y-2">
                 {localVenues.map(item => (
                   <div key={item.id} className={`p-3 rounded-2xl border flex items-center gap-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                      <div className={`p-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500`}>
                        <MapPin size={18}/>
                      </div>
                      <div className="flex-1 space-y-1">
                        <input 
                          type="text" 
                          value={item.name} 
                          onChange={(e) => handleVenueChange(item.id, 'name', e.target.value)}
                          placeholder="Nom de la salle"
                          className="bg-transparent font-bold text-sm outline-none w-full"
                        />
                        <div className="flex gap-2">
                           <input 
                            type="text" 
                            value={item.type} 
                            onChange={(e) => handleVenueChange(item.id, 'type', e.target.value)}
                            placeholder="Type (R√©union...)"
                            className="bg-transparent text-[10px] font-medium outline-none text-slate-400 w-24"
                           />
                           <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-900 rounded px-1.5">
                             <span className="text-[9px] text-slate-400">Cap.</span>
                             <input 
                              type="number" 
                              value={item.capacity} 
                              onChange={(e) => handleVenueChange(item.id, 'capacity', parseInt(e.target.value) || 0)}
                              className="bg-transparent text-[10px] font-bold outline-none w-8 text-center"
                             />
                           </div>
                        </div>
                      </div>
                      <button onClick={() => removeVenue(item.id)} className="p-2 text-slate-300 hover:text-red-500">
                        <Trash2 size={16}/>
                      </button>
                   </div>
                 ))}
                 {localVenues.length === 0 && (
                   <div className="p-8 text-center border-2 border-dashed border-slate-200 rounded-3xl">
                     <p className="text-slate-400 text-xs font-bold">Aucun lieu configur√©.</p>
                   </div>
                 )}
               </div>
            </div>
          ) : (
            <div className="space-y-4">
               <div className="flex justify-between items-center px-1">
                 <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Articles & Prestations</h3>
                 <button onClick={addCatalogItem} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase flex items-center gap-1 ${themeBg} text-white`}>
                   <Plus size={12}/> Ajouter Article
                 </button>
               </div>
               
               <div className="space-y-2">
                 {localCatalog.map(item => (
                   <div key={item.id} className={`p-3 rounded-2xl border flex flex-col gap-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                      <div className="flex gap-3 items-center">
                        <input 
                          type="text" 
                          value={item.name} 
                          onChange={(e) => handleCatalogChange(item.id, 'name', e.target.value)}
                          placeholder="Nom du produit"
                          className="bg-transparent font-bold text-sm outline-none flex-1"
                        />
                        <button onClick={() => removeCatalogItem(item.id)} className="p-2 text-slate-300 hover:text-red-500">
                          <Trash2 size={16}/>
                        </button>
                      </div>
                      
                      <div className="flex gap-2">
                        <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5 flex-1">
                           <span className="text-[9px] uppercase text-slate-400">Prix ‚Ç¨</span>
                           <input 
                            type="number" 
                            value={item.defaultPrice} 
                            onChange={(e) => handleCatalogChange(item.id, 'defaultPrice', parseFloat(e.target.value) || 0)}
                            className="w-full bg-transparent text-center font-bold outline-none text-xs"
                           />
                        </div>
                        <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5 flex-1">
                           <span className="text-[9px] uppercase text-slate-400">TVA %</span>
                           <input 
                            type="number" 
                            value={item.defaultVat} 
                            onChange={(e) => handleCatalogChange(item.id, 'defaultVat', parseFloat(e.target.value) || 0)}
                            className="w-full bg-transparent text-center font-bold outline-none text-xs"
                           />
                        </div>
                      </div>

                      {/* Default Venue & Time Range */}
                      <div className="flex gap-2 bg-slate-50 dark:bg-slate-900/50 p-2 rounded-xl">
                         <div className="flex-1">
                           <div className="flex items-center gap-1 mb-1">
                             <MapPin size={10} className="text-slate-400" />
                             <span className="text-[9px] uppercase font-bold text-slate-400">Lieu par d√©faut</span>
                           </div>
                           <select 
                              value={item.defaultVenueId || ''} 
                              onChange={(e) => handleCatalogChange(item.id, 'defaultVenueId', e.target.value)}
                              className="w-full bg-transparent text-[10px] font-bold outline-none"
                           >
                             <option value="">-- Aucun --</option>
                             {localVenues.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                           </select>
                         </div>
                         <div className="w-[1px] bg-slate-200 dark:bg-slate-700" />
                         <div className="flex-[1.5]">
                           <div className="flex items-center gap-1 mb-1">
                             <Clock size={10} className="text-slate-400" />
                             <span className="text-[9px] uppercase font-bold text-slate-400">Plage Horaire</span>
                           </div>
                           <div className="flex items-center gap-1">
                             <input 
                                type="time" 
                                value={item.defaultStartTime || ''} 
                                onChange={(e) => handleCatalogChange(item.id, 'defaultStartTime', e.target.value)}
                                className="bg-transparent text-[10px] font-bold outline-none w-12"
                             />
                             <span className="text-[10px] text-slate-400">-</span>
                             <input 
                                type="time" 
                                value={item.defaultEndTime || ''} 
                                onChange={(e) => handleCatalogChange(item.id, 'defaultEndTime', e.target.value)}
                                className="bg-transparent text-[10px] font-bold outline-none w-12"
                             />
                           </div>
                         </div>
                      </div>

                      <textarea 
                        placeholder="Description technique pour les √©quipes (ex: Boissons, Setup...)"
                        value={item.technicalDescription || ''}
                        onChange={(e) => handleCatalogChange(item.id, 'technicalDescription', e.target.value)}
                        className="w-full p-2 rounded-xl bg-slate-50 dark:bg-slate-700 text-[10px] font-medium outline-none resize-none h-16"
                      />
                   </div>
                 ))}
                 {localCatalog.length === 0 && (
                   <div className="p-8 text-center border-2 border-dashed border-slate-200 rounded-3xl">
                     <p className="text-slate-400 text-xs font-bold">Catalogue vide.</p>
                   </div>
                 )}
               </div>
            </div>
          )}
        </div>

        {/* Footer Actions */}
        <div className="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 flex justify-end">
           <button 
             onClick={saveAll}
             className={`px-8 py-4 rounded-[20px] text-white font-black uppercase tracking-widest text-xs shadow-lg flex items-center gap-2 ${themeBg}`}
           >
             <Save size={16} /> Enregistrer Configuration
           </button>
        </div>

      </div>
    </div>
  );
};

export default BusinessConfigModal;


import React, { useState, useMemo, useEffect } from 'react';
import { X, UsersRound, Search, Building2, User, Phone, Mail, MapPin, Briefcase, History, TrendingUp, Filter, Edit3, Save } from 'lucide-react';
import { Client, Group, UserSettings } from '../types';

interface ClientDatabaseModalProps {
  isOpen: boolean;
  onClose: () => void;
  clients: Client[];
  groups: Group[];
  userSettings: UserSettings;
  onUpdateClient?: (client: Client) => void;
}

const CATEGORIES = ['S√©minaire', 'Association', 'Loisir', 'Sportif', 'Affaires'];

const ClientDatabaseModal: React.FC<ClientDatabaseModalProps> = ({ isOpen, onClose, clients, groups, userSettings, onUpdateClient }) => {
  const [search, setSearch] = useState('');
  const [filterType, setFilterType] = useState<'ALL' | 'Entreprise' | 'Particulier'>('ALL');
  const [selectedClient, setSelectedClient] = useState<Client | null>(null);
  
  // Edit Mode State
  const [isEditing, setIsEditing] = useState(false);
  const [editData, setEditData] = useState<Client | null>(null);

  // Reset Edit state when selection changes
  useEffect(() => {
    setIsEditing(false);
    setEditData(null);
  }, [selectedClient]);

  const handleStartEdit = () => {
    if (selectedClient) {
        setEditData({ ...selectedClient });
        setIsEditing(true);
    }
  };

  const handleSaveEdit = () => {
    if (editData && onUpdateClient) {
        onUpdateClient(editData);
        setSelectedClient(editData); // Update local view
        setIsEditing(false);
        setEditData(null);
    }
  };

  const handleCancelEdit = () => {
    setIsEditing(false);
    setEditData(null);
  };

  // --- DERIVED DATA ---

  // 1. Enrich clients with KPI (Total Revenue & Last Booking)
  const enrichedClients = useMemo(() => {
    return clients.map(client => {
      const clientGroups = groups.filter(g => g.clientId === client.id);
      
      // Calculate Total Revenue
      let totalRevenue = 0;
      clientGroups.forEach(g => {
        if (g.status === 'confirmed') {
          let groupHT = 0;
          g.invoiceItems?.forEach(item => {
            groupHT += item.quantity * item.unitPrice;
          });
          totalRevenue += groupHT;
        }
      });

      // Find last booking
      const dates = clientGroups.map(g => new Date(g.startDate).getTime());
      const lastBooking = dates.length > 0 ? Math.max(...dates) : 0;

      return { ...client, totalRevenue, lastBooking, bookingCount: clientGroups.length };
    });
  }, [clients, groups]);

  // 2. Filter & Sort
  const filteredClients = useMemo(() => {
    return enrichedClients.filter(c => {
      const matchesSearch = c.name.toLowerCase().includes(search.toLowerCase()) || c.email.toLowerCase().includes(search.toLowerCase());
      const matchesType = filterType === 'ALL' || c.type === filterType;
      return matchesSearch && matchesType;
    }).sort((a, b) => b.lastBooking - a.lastBooking); // Most recent first
  }, [enrichedClients, search, filterType]);

  // 3. Get History for Selected Client
  const selectedClientHistory = useMemo(() => {
    if (!selectedClient) return [];
    return groups
      .filter(g => g.clientId === selectedClient.id)
      .sort((a, b) => new Date(b.startDate).getTime() - new Date(a.startDate).getTime());
  }, [selectedClient, groups]);

  if (!isOpen) return null;

  const themeHex = `text-${userSettings.themeColor}-600`;
  const themeBg = `bg-${userSettings.themeColor}-600`;

  return (
    <div className="fixed inset-0 z-[160] bg-black/80 flex items-center justify-center animate-in fade-in backdrop-blur-sm p-4">
      <div className={`w-full max-w-5xl rounded-[40px] shadow-2xl flex flex-col h-[90vh] overflow-hidden ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
        
        {/* Header */}
        <div className="p-8 pb-4 shrink-0 flex justify-between items-center border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 z-10">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-500/20">
              <UsersRound size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Base Clients</h2>
              <p className="text-xs font-bold text-slate-400">CRM & Historique</p>
            </div>
          </div>
          <button onClick={onClose} className="p-3 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:opacity-80"><X size={20}/></button>
        </div>

        <div className="flex flex-1 overflow-hidden">
          
          {/* LEFT: LIST & FILTERS */}
          <div className={`w-1/3 flex flex-col border-r border-slate-200 dark:border-slate-800 ${selectedClient ? 'hidden md:flex' : 'flex w-full'}`}>
             {/* Search Bar */}
             <div className="p-4 space-y-3">
                <div className={`flex items-center px-4 py-3 rounded-2xl border-2 transition-colors ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                   <Search size={18} className="text-slate-400 mr-2"/>
                   <input 
                     type="text" 
                     placeholder="Rechercher client..." 
                     value={search}
                     onChange={(e) => setSearch(e.target.value)}
                     className="bg-transparent outline-none font-bold text-sm w-full"
                   />
                </div>
                <div className="flex gap-2">
                   {(['ALL', 'Entreprise', 'Particulier'] as const).map(t => (
                     <button 
                       key={t}
                       onClick={() => setFilterType(t)}
                       className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${filterType === t ? 'bg-indigo-600 text-white shadow' : 'bg-slate-200 dark:bg-slate-800 text-slate-500'}`}
                     >
                       {t === 'ALL' ? 'Tous' : t}
                     </button>
                   ))}
                </div>
             </div>

             {/* Client List */}
             <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar">
                {filteredClients.map(client => (
                  <div 
                    key={client.id}
                    onClick={() => setSelectedClient(client)}
                    className={`p-4 rounded-2xl border cursor-pointer transition-all hover:shadow-md ${selectedClient?.id === client.id ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : 'border-transparent bg-white dark:bg-slate-800 hover:border-indigo-200'}`}
                  >
                     <div className="flex justify-between items-start mb-2">
                        <div className="flex items-center gap-2">
                           {client.type === 'Entreprise' ? <Building2 size={16} className="text-indigo-500"/> : <User size={16} className="text-emerald-500"/>}
                           <span className="font-bold text-sm truncate">{client.name}</span>
                        </div>
                        <span className="text-[10px] font-bold text-slate-400">{new Date(client.lastBooking).getFullYear() > 1970 ? new Date(client.lastBooking).toLocaleDateString() : 'Nouveau'}</span>
                     </div>
                     <div className="flex justify-between items-center text-[10px] font-medium text-slate-500">
                        <span>{client.bookingCount} Dossiers</span>
                        <span className="font-black text-slate-900 dark:text-white">{client.totalRevenue.toLocaleString()} ‚Ç¨</span>
                     </div>
                  </div>
                ))}
                {filteredClients.length === 0 && (
                  <div className="text-center py-10 opacity-50">
                    <UsersRound size={40} className="mx-auto mb-2"/>
                    <p className="text-xs font-bold">Aucun client trouv√©</p>
                  </div>
                )}
             </div>
          </div>

          {/* RIGHT: DETAIL VIEW */}
          <div className={`flex-1 flex-col overflow-y-auto bg-slate-50/50 dark:bg-slate-900/50 ${selectedClient ? 'flex' : 'hidden md:flex items-center justify-center'}`}>
             
             {selectedClient ? (
               <div className="p-8 animate-in slide-in-from-right-10 duration-300">
                  <div className="flex items-center justify-between mb-6 md:hidden">
                    <button onClick={() => setSelectedClient(null)} className="text-xs font-bold text-indigo-500 uppercase">Retour liste</button>
                  </div>

                  {/* Client Header Card */}
                  <div className="bg-white dark:bg-slate-800 rounded-[32px] p-6 shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                     <div className="flex justify-between items-start mb-4">
                        <div className="flex-1 mr-4">
                           {isEditing && editData ? (
                             <div className="space-y-3">
                               <div className="flex gap-2">
                                 <select 
                                   value={editData.type} 
                                   onChange={(e) => setEditData({...editData, type: e.target.value as any})}
                                   className="text-[10px] font-black uppercase tracking-widest px-2 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 border-none outline-none"
                                 >
                                   <option value="Entreprise">Entreprise</option>
                                   <option value="Particulier">Particulier</option>
                                 </select>
                                 <select 
                                   value={editData.category || ''} 
                                   onChange={(e) => setEditData({...editData, category: e.target.value})}
                                   className="text-[10px] font-black uppercase tracking-widest px-2 py-1.5 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 border-none outline-none"
                                 >
                                   <option value="">-- Cat√©gorie --</option>
                                   {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                 </select>
                               </div>
                               <input 
                                 type="text" 
                                 value={editData.name} 
                                 onChange={(e) => setEditData({...editData, name: e.target.value})}
                                 placeholder="Nom du Client / Contact"
                                 className="text-3xl font-black w-full bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none pb-1"
                               />
                               <input 
                                 type="text" 
                                 value={editData.companyName || ''} 
                                 onChange={(e) => setEditData({...editData, companyName: e.target.value})}
                                 placeholder="Nom de l'entreprise (si diff√©rent)"
                                 className="text-sm font-bold w-full bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none pb-1 text-slate-500"
                               />
                               <input 
                                 type="text" 
                                 value={editData.siret || ''} 
                                 onChange={(e) => setEditData({...editData, siret: e.target.value})}
                                 placeholder="SIRET"
                                 className="text-xs w-full bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none pb-1 font-mono"
                               />
                             </div>
                           ) : (
                             <>
                               <div className="flex gap-2 mb-2">
                                 <span className={`text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-lg inline-block ${selectedClient.type === 'Entreprise' ? 'bg-indigo-100 text-indigo-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                   {selectedClient.type}
                                 </span>
                                 {selectedClient.category && (
                                   <span className="text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 inline-block">
                                     {selectedClient.category}
                                   </span>
                                 )}
                               </div>
                               <h1 className="text-3xl font-black">{selectedClient.name}</h1>
                               {selectedClient.companyName && <p className="text-sm font-bold text-slate-500">{selectedClient.companyName}</p>}
                               {selectedClient.siret && <p className="text-xs text-slate-400 mt-1 font-mono">SIRET: {selectedClient.siret}</p>}
                             </>
                           )}
                        </div>
                        <div className="text-right flex flex-col items-end gap-2">
                           <div className="text-right">
                             <p className="text-[10px] font-black uppercase text-slate-400">Valeur Client</p>
                             <p className="text-2xl font-black text-indigo-600 dark:text-indigo-400">
                               {enrichedClients.find(c => c.id === selectedClient.id)?.totalRevenue.toLocaleString()} ‚Ç¨
                             </p>
                           </div>
                           
                           {!isEditing ? (
                             <button 
                               onClick={handleStartEdit}
                               className="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-indigo-600 transition-colors"
                               title="Modifier"
                             >
                               <Edit3 size={18} />
                             </button>
                           ) : (
                             <div className="flex gap-2">
                               <button 
                                 onClick={handleCancelEdit}
                                 className="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-xs font-bold"
                               >
                                 Annuler
                               </button>
                               <button 
                                 onClick={handleSaveEdit}
                                 className="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-bold flex items-center gap-1 shadow-lg"
                               >
                                 <Save size={14} /> Enregistrer
                               </button>
                             </div>
                           )}
                        </div>
                     </div>

                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                        <div className="flex items-center gap-3">
                           <div className="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500"><Mail size={16}/></div>
                           {isEditing && editData ? (
                             <input 
                               type="email" 
                               value={editData.email} 
                               onChange={(e) => setEditData({...editData, email: e.target.value})}
                               className="bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none w-full text-sm font-bold"
                             />
                           ) : (
                             <span className="text-sm font-bold">{selectedClient.email}</span>
                           )}
                        </div>
                        <div className="flex items-center gap-3">
                           <div className="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500"><Phone size={16}/></div>
                           {isEditing && editData ? (
                             <input 
                               type="tel" 
                               value={editData.phone} 
                               onChange={(e) => setEditData({...editData, phone: e.target.value})}
                               className="bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none w-full text-sm font-bold"
                             />
                           ) : (
                             <span className="text-sm font-bold">{selectedClient.phone}</span>
                           )}
                        </div>
                        <div className="flex items-center gap-3 md:col-span-2">
                           <div className="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500"><MapPin size={16}/></div>
                           {isEditing && editData ? (
                             <input 
                               type="text" 
                               value={editData.address} 
                               onChange={(e) => setEditData({...editData, address: e.target.value})}
                               className="bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none w-full text-sm font-bold"
                             />
                           ) : (
                             <span className="text-sm font-bold">{selectedClient.address}</span>
                           )}
                        </div>
                     </div>
                  </div>

                  {/* History Section */}
                  <h3 className="text-sm font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2">
                    <History size={16}/> Historique Dossiers
                  </h3>
                  
                  <div className="space-y-3">
                     {selectedClientHistory.map(group => (
                       <div key={group.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 flex items-center gap-4 hover:shadow-md transition-shadow">
                          <div className={`p-3 rounded-xl font-black text-xs text-center min-w-[3.5rem] ${group.status === 'confirmed' ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}`}>
                             <span className="block text-[8px] uppercase opacity-70">{new Date(group.startDate).toLocaleDateString('fr-FR', {month: 'short'})}</span>
                             <span className="text-lg">{new Date(group.startDate).getDate()}</span>
                          </div>
                          <div className="flex-1">
                             <div className="flex justify-between items-start">
                                <h4 className="font-bold text-sm">{group.name}</h4>
                                <span className="text-[10px] font-black uppercase text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">{group.category}</span>
                             </div>
                             <p className="text-xs text-slate-500 mt-1">{group.pax} PAX ‚Ä¢ {group.nights} Nuits</p>
                          </div>
                          <div className="text-right">
                             {/* Calculated total for this group */}
                             <p className="font-black text-sm">
                               {group.invoiceItems?.reduce((acc, item) => acc + (item.quantity * item.unitPrice), 0).toLocaleString()} ‚Ç¨
                             </p>
                             <p className="text-[9px] font-bold text-slate-400 uppercase">HT</p>
                          </div>
                       </div>
                     ))}
                     {selectedClientHistory.length === 0 && (
                       <div className="text-center py-8 text-slate-400 italic">Aucun dossier trouv√©.</div>
                     )}
                  </div>

               </div>
             ) : (
               <div className="text-center opacity-30">
                  <Briefcase size={64} className="mx-auto mb-4"/>
                  <p className="text-xl font-black">S√©lectionnez un client</p>
                  <p className="font-medium">pour voir son historique</p>
               </div>
             )}

          </div>
        </div>
      </div>
    </div>
  );
};

export default ClientDatabaseModal;

import React from 'react';
import { X, Phone, Mail, MessageCircle, MapPin, Edit3, Building, Briefcase, MessageSquare } from 'lucide-react';
import { Contact, UserSettings } from '../types';

interface ContactDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  contact: Contact | null;
  onEdit: (contact: Contact) => void;
  userSettings: UserSettings;
}

const ContactDetailModal: React.FC<ContactDetailModalProps> = ({ isOpen, onClose, contact, onEdit, userSettings }) => {
  if (!isOpen || !contact) return null;

  const themeHex = `text-${userSettings.themeColor}-600`;
  const themeBg = `bg-${userSettings.themeColor}-600`;

  const actions = [
    { icon: Phone, label: 'Appeler', value: `tel:${contact.phone}`, color: 'bg-blue-50 text-blue-600' },
    { icon: MessageSquare, label: 'SMS', value: `sms:${contact.phone}`, color: 'bg-emerald-50 text-emerald-600' },
    { icon: Mail, label: 'Email', value: `mailto:${contact.email}`, color: 'bg-amber-50 text-amber-600' },
    { icon: MessageCircle, label: 'WhatsApp', value: `https://wa.me/${contact.phone.replace(/[^0-9]/g, '')}`, color: 'bg-indigo-50 text-indigo-600' },
  ];

  return (
    <div className="absolute inset-0 z-[200] bg-black/70 flex items-end animate-in fade-in backdrop-blur-sm overflow-hidden">
      <div className={`w-full rounded-t-[40px] p-8 pb-12 animate-in slide-in-from-bottom-20 max-h-[90vh] overflow-y-auto no-scrollbar ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        {/* Header - Profile Style */}
        <div className="flex justify-between items-start mb-8">
          <div className="flex items-center gap-5">
            <div className={`h-20 w-20 rounded-[28px] flex items-center justify-center font-black text-3xl shadow-lg ${contact.color || 'bg-slate-200 text-slate-600'}`}>
              {contact.initials}
            </div>
            <div>
              <span className={`text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 mb-2 inline-block`}>
                {contact.category}
              </span>
              <h3 className="text-2xl font-black leading-tight">{contact.name}</h3>
            </div>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => onEdit(contact)}
              className="p-3 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white transition-colors"
            >
              <Edit3 size={20}/>
            </button>
            <button onClick={onClose} className="p-3 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400">
              <X size={20}/>
            </button>
          </div>
        </div>

        {/* Action Grid */}
        <div className="grid grid-cols-2 gap-4 mb-10">
          {actions.map((action, i) => (
            <a 
              key={i} 
              href={action.value} 
              target={action.label === 'WhatsApp' ? '_blank' : undefined}
              rel="noreferrer"
              className={`flex items-center gap-4 p-5 rounded-[28px] border border-slate-50 dark:border-slate-800 transition-transform active:scale-95 shadow-sm ${userSettings.darkMode ? 'bg-slate-800' : 'bg-white'}`}
            >
              <div className={`p-3 rounded-2xl ${action.color}`}>
                <action.icon size={20} />
              </div>
              <span className="text-sm font-black text-slate-600 dark:text-slate-300">{action.label}</span>
            </a>
          ))}
        </div>

        {/* Detailed Info Section */}
        <div className="space-y-6">
          <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Informations Professionnelles</h4>
          
          <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50/50 border-slate-100'}`}>
            <div className="space-y-5">
              <div className="flex items-start gap-4">
                <Briefcase size={20} className="text-slate-300 mt-1" />
                <div>
                  <p className="text-[9px] font-black uppercase text-slate-400 tracking-wider">Fonction</p>
                  <p className="text-base font-bold">{contact.role}</p>
                </div>
              </div>
              <div className="flex items-start gap-4">
                <Building size={20} className="text-slate-300 mt-1" />
                <div>
                  <p className="text-[9px] font-black uppercase text-slate-400 tracking-wider">Entreprise</p>
                  <p className="text-base font-bold">{contact.company}</p>
                </div>
              </div>
            </div>
          </div>

          <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 pt-2">Localisation</h4>
          <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50/50 border-slate-100'}`}>
            <div className="flex items-start gap-4">
              <MapPin size={20} className="text-slate-300 mt-1" />
              <div>
                <p className="text-[9px] font-black uppercase text-slate-400 tracking-wider">Adresse</p>
                <p className="text-base font-bold leading-relaxed">{contact.address || 'Non renseign√©e'}</p>
              </div>
            </div>
          </div>
        </div>

        <button 
          onClick={() => onEdit(contact)}
          className={`w-full py-5 rounded-[28px] text-white font-black uppercase tracking-widest mt-12 shadow-xl bg-slate-900`}
        >
          Modifier le contact
        </button>
      </div>
    </div>
  );
};

export default ContactDetailModal;
import React, { useState, useEffect } from 'react';
import { X, User, Building, Phone, Mail, MapPin, Briefcase } from 'lucide-react';
import { Contact, UserSettings } from '../types';
import { CONTACT_CATEGORIES } from '../constants';

interface ContactModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (contact: Contact) => void;
  userSettings: UserSettings;
  editContact?: Contact | null;
}

const ContactModal: React.FC<ContactModalProps> = ({ isOpen, onClose, onSave, userSettings, editContact }) => {
  const [form, setForm] = useState({
    name: '', 
    role: '', 
    company: '', 
    category: 'VIP', 
    phone: '', 
    email: '', 
    address: ''
  });

  useEffect(() => {
    if (editContact && isOpen) {
      setForm({
        name: editContact.name,
        role: editContact.role,
        company: editContact.company || '',
        category: editContact.category || 'VIP',
        phone: editContact.phone,
        email: editContact.email,
        address: editContact.address || ''
      });
    } else if (!editContact && isOpen) {
      setForm({
        name: '', role: '', company: '', category: 'VIP', 
        phone: '', email: '', address: ''
      });
    }
  }, [editContact, isOpen]);

  if (!isOpen) return null;

  const handleSave = () => {
    if (!form.name) return;
    const initials = form.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    const colors = ["bg-amber-100 text-amber-700", "bg-rose-100 text-rose-700", "bg-blue-100 text-blue-700", "bg-emerald-100 text-emerald-700", "bg-purple-100 text-purple-700"];
    
    onSave({
      id: editContact ? editContact.id : Date.now(),
      ...form,
      initials,
      vip: form.category === 'VIP',
      status: 'In House', // Default
      color: editContact ? editContact.color : colors[Math.floor(Math.random() * colors.length)]
    });
    
    onClose();
  };

  const themeHex = `text-${userSettings.themeColor}-600`;
  const themeBg = `bg-${userSettings.themeColor}-600`;
  const themeBorder = `border-${userSettings.themeColor}-600`;

  const inputGroupClass = `flex items-center gap-3 px-5 py-4 rounded-2xl border-2 shadow-sm transition-all ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 focus-within:border-indigo-400 focus-within:ring-2 focus-within:ring-indigo-100'}`;
  const inputBaseClass = `bg-transparent outline-none flex-1 font-bold text-base placeholder:text-slate-400 ${userSettings.darkMode ? 'text-white' : 'text-slate-950'}`;
  const labelBaseClass = `text-[10px] font-black uppercase tracking-[0.15em] ml-1 mb-1 block ${userSettings.darkMode ? 'text-slate-400' : 'text-slate-500'}`;

  return (
    <div className="absolute inset-0 z-[250] bg-black/60 flex items-end animate-in fade-in backdrop-blur-sm overflow-hidden">
      <div className={`w-full rounded-t-[40px] p-8 pb-12 animate-in slide-in-from-bottom-20 max-h-[92vh] overflow-y-auto no-scrollbar ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        {/* Header */}
        <div className="flex justify-between items-center mb-8">
          <h3 className="text-2xl font-black text-slate-900 dark:text-white">
            {editContact ? 'Modifier Contact' : 'Nouveau Contact'}
          </h3>
          <button onClick={onClose} className="p-3 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 hover:bg-slate-200 transition-colors">
            <X size={20}/>
          </button>
        </div>

        <div className="space-y-6">
          
          {/* Section: Identit√© */}
          <div className="space-y-4">
            <div>
              <label className={labelBaseClass}>Identit√©</label>
              <div className={inputGroupClass}>
                <User size={18} className="text-slate-400" />
                <input 
                  type="text" 
                  placeholder="Nom complet" 
                  value={form.name} 
                  onChange={(e) => setForm({...form, name: e.target.value})} 
                  className={inputBaseClass} 
                />
              </div>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className={labelBaseClass}>Fonction</label>
                <div className={inputGroupClass}>
                  <input 
                    type="text" 
                    placeholder="Chef, Dir..." 
                    value={form.role} 
                    onChange={(e) => setForm({...form, role: e.target.value})} 
                    className={inputBaseClass} 
                  />
                </div>
              </div>
              <div>
                <label className={labelBaseClass}>√âtablissement</label>
                <div className={inputGroupClass}>
                  <input 
                    type="text" 
                    placeholder="H√¥tel..." 
                    value={form.company} 
                    onChange={(e) => setForm({...form, company: e.target.value})} 
                    className={inputBaseClass} 
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Section: Coordonn√©es */}
          <div className="space-y-4">
            <label className={labelBaseClass}>Coordonn√©es</label>
            
            <div className={inputGroupClass}>
              <Phone size={18} className="text-slate-400" />
              <input 
                type="tel" 
                placeholder="+33..." 
                value={form.phone} 
                onChange={(e) => setForm({...form, phone: e.target.value})} 
                className={inputBaseClass} 
              />
            </div>

            <div className={inputGroupClass}>
              <Mail size={18} className="text-slate-400" />
              <input 
                type="email" 
                placeholder="email@hotel.com" 
                value={form.email} 
                onChange={(e) => setForm({...form, email: e.target.value})} 
                className={inputBaseClass} 
              />
            </div>

            <div className={inputGroupClass}>
              <MapPin size={18} className="text-slate-400" />
              <input 
                type="text" 
                placeholder="Bureau, local, adresse..." 
                value={form.address} 
                onChange={(e) => setForm({...form, address: e.target.value})} 
                className={inputBaseClass} 
              />
            </div>
          </div>

          {/* Section: Cat√©gorie */}
          <div className="space-y-3">
            <label className={labelBaseClass}>Cat√©gorie VIP</label>
            <div className="flex flex-wrap gap-2">
              {CONTACT_CATEGORIES.map(cat => (
                <button
                  key={cat}
                  type="button"
                  onClick={() => setForm({...form, category: cat})}
                  className={`px-5 py-3 rounded-2xl text-xs font-black transition-all border-2 ${form.category === cat ? `${themeBorder} ${themeHex} bg-${userSettings.themeColor}-50/50 shadow-sm` : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 text-slate-400'}`}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Final Submit Button */}
        <button 
          onClick={handleSave}
          className={`w-full py-6 rounded-[28px] text-white font-black uppercase tracking-[0.2em] mt-10 shadow-xl transition-all active:scale-95 ${themeBg} hover:opacity-90`}
        >
          {editContact ? 'Enregistrer les modifications' : 'Ajouter le contact'}
        </button>
      </div>
    </div>
  );
};

export default ContactModal;
import React, { useState } from 'react';
import { Contact, UserSettings } from '../types';
import { Plus, Search, Star, User, Trash2 } from 'lucide-react';

interface ContactsViewProps {
  contacts: Contact[];
  userSettings: UserSettings;
  onAdd: () => void;
  onContactClick: (contact: Contact) => void;
  onDelete: (id: number | string) => void;
}

const ContactsView: React.FC<ContactsViewProps> = ({ contacts, userSettings, onAdd, onContactClick, onDelete }) => {
  const [search, setSearch] = useState('');
  
  const filteredContacts = contacts.filter(c => 
    c.name.toLowerCase().includes(search.toLowerCase()) ||
    (c.company && c.company.toLowerCase().includes(search.toLowerCase())) ||
    c.role.toLowerCase().includes(search.toLowerCase())
  );

  const themeColor = userSettings.themeColor;

  const handleDeleteClick = (id: number | string, e: React.MouseEvent) => {
    e.stopPropagation();
    if (window.confirm("Supprimer ce contact de l'annuaire ?")) {
      onDelete(id);
    }
  };

  return (
    <div className={`h-full flex flex-col p-6 animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
        {/* Header */}
        <div className="flex justify-between items-center mb-6">
            <div>
                <h2 className="text-2xl font-black">Contacts</h2>
                <p className="text-xs font-bold text-slate-400">Annuaire VIP & Staff</p>
            </div>
            <button 
                onClick={onAdd}
                className={`p-3 rounded-xl shadow-lg text-white bg-${themeColor}-600 active:scale-95 transition-transform flex items-center gap-2 hover:opacity-90`}
            >
                <Plus size={20} /> <span className="hidden md:inline text-xs font-bold uppercase">Ajouter</span>
            </button>
        </div>

        {/* Search */}
        <div className="relative mb-6">
            <Search className="absolute left-4 top-3.5 text-slate-400" size={20} />
            <input 
                type="text" 
                placeholder="Rechercher nom, entreprise..." 
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className={`w-full pl-12 pr-4 py-3.5 rounded-2xl border outline-none font-bold text-sm transition-all ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 text-white placeholder:text-slate-500 focus:border-indigo-500' : 'bg-white border-slate-200 text-slate-900 focus:border-indigo-500'}`}
            />
        </div>

        {/* List */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20 overflow-y-auto no-scrollbar">
            {filteredContacts.map(contact => (
                <div 
                    key={contact.id}
                    onClick={() => onContactClick(contact)}
                    className={`p-4 rounded-2xl border cursor-pointer transition-all hover:shadow-md hover:-translate-y-0.5 flex items-center gap-4 group ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-750' : 'bg-white border-slate-100 hover:bg-slate-50'}`}
                >
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-sm shrink-0 shadow-sm ${contact.color || 'bg-slate-200 text-slate-500'}`}>
                        {contact.initials || <User size={20}/>}
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                            <h3 className="font-bold text-sm truncate pr-2">{contact.name}</h3>
                            {contact.vip && <Star size={12} className="text-amber-400 fill-amber-400 shrink-0 mt-0.5"/>}
                        </div>
                        <p className="text-xs text-slate-500 truncate">{contact.role}</p>
                        <div className="flex justify-between items-center mt-1">
                           <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wide truncate">{contact.company}</p>
                           <span className={`text-[8px] font-black px-1.5 py-0.5 rounded ${contact.status === 'In House' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400'}`}>
                             {contact.status}
                           </span>
                        </div>
                    </div>
                    
                    {/* Bouton de suppression */}
                    <button
                      onClick={(e) => handleDeleteClick(contact.id, e)}
                      className="p-2 text-slate-300 hover:text-red-500 transition-colors duration-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Supprimer"
                    >
                      <Trash2 size={16} />
                    </button>
                </div>
            ))}
            {filteredContacts.length === 0 && (
                <div className="col-span-full text-center py-12 opacity-50 flex flex-col items-center">
                    <User size={48} className="text-slate-300 mb-2" />
                    <p className="font-bold text-slate-400">Aucun contact trouv√©.</p>
                </div>
            )}
        </div>
    </div>
  );
};

export default ContactsView;
import React from 'react';
import { 
  CloudSun, ChevronRight, CalendarPlus, CheckSquare, 
  UserPlus, Calendar, Clock, User, Briefcase, Users, Video,
  TrendingUp, Inbox, AlertCircle, ArrowRight
} from 'lucide-react';
import { UserSettings, CalendarEvent, Task, Contact, Group, Lead, InboxItem } from '../types';

interface DashboardProps {
  userSettings: UserSettings;
  events: CalendarEvent[];
  todos: Task[];
  contacts: Contact[];
  groups: Group[];
  leads?: Lead[];
  inbox?: InboxItem[];
  onNavigate: (tab: string) => void;
  onTaskToggle: (id: string | number) => void;
  onTaskClick: (task: Task) => void;
  onEventClick: (event: CalendarEvent) => void;
  onGroupClick: (group: Group) => void;
  onOpenEventModal: () => void;
  onOpenTaskModal: () => void;
  onOpenContactModal: () => void;
}

const Dashboard: React.FC<DashboardProps> = ({ 
  userSettings, events, todos, contacts, groups, leads = [], inbox = [],
  onNavigate, onTaskToggle, onTaskClick, onEventClick, onGroupClick,
  onOpenEventModal, onOpenTaskModal, onOpenContactModal 
}) => {
  const today = new Date();
  
  const isSameDay = (d1: Date, d2: Date) => 
    d1.getDate() === d2.getDate() && 
    d1.getMonth() === d2.getMonth() && 
    d1.getFullYear() === d2.getFullYear();

  const isDateInRange = (d: Date, startStr: string, endStr: string) => {
    const checkDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const start = new Date(startStr);
    const end = new Date(endStr);
    start.setHours(0,0,0,0);
    end.setHours(0,0,0,0);
    return checkDate >= start && checkDate <= end;
  };

  const todaysEvents = events
    .filter(e => isSameDay(new Date(e.start), today))
    .sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());

  const activeGroups = groups.filter(g => isDateInRange(today, g.startDate, g.endDate));
  const pendingTasks = todos.filter(t => !t.done).slice(0, 3);

  const themeLight = `bg-${userSettings.themeColor}-50 text-${userSettings.themeColor}-600`;

  // Sales KPIs
  const salesKPIs = {
    pipeline: leads.filter(l => l.status === 'nouveau' || l.status === 'en_cours').length,
    newRequests: inbox.filter(i => i.status === 'to_process').length,
    urgentAction: leads.find(l => {
        // Simple logic: find a lead created > 7 days ago still 'nouveau'
        const d = new Date(l.requestDate);
        const diff = (today.getTime() - d.getTime()) / (1000 * 3600 * 24);
        return diff > 7 && l.status === 'nouveau';
    })?.contactName
  };

  return (
    <div className="p-4 md:px-6 md:py-4 space-y-6 animate-in fade-in duration-500 max-w-7xl mx-auto">
      {/* Header and Quick Actions Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-start">
        {/* Welcome */}
        <div className="flex justify-between items-center p-5 md:p-6 rounded-3xl bg-gradient-to-br from-indigo-500/5 to-purple-500/5 border border-slate-100 dark:border-slate-800">
          <div className="flex-1">
            <p className={`font-medium text-[10px] uppercase tracking-wider mb-0.5 ${userSettings.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
              {today.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}
            </p>
            <h1 className={`text-2xl md:text-3xl font-extrabold truncate pr-2 ${userSettings.darkMode ? 'text-white' : 'text-slate-900'}`}>
              Bonjour, {userSettings.userName}
            </h1>
          </div>
        </div>

        {/* Quick Action Buttons */}
        <div className="flex gap-3 md:gap-4 h-full">
          {[
            { icon: CalendarPlus, label: 'RDV', color: themeLight, onClick: onOpenEventModal },
            { icon: CheckSquare, label: 'T√¢che', color: 'bg-emerald-50 text-emerald-600', onClick: onOpenTaskModal },
            { icon: UserPlus, label: 'Contact', color: 'bg-amber-50 text-amber-600', onClick: onOpenContactModal },
          ].map((btn, i) => (
            <button 
              key={i} 
              onClick={btn.onClick}
              className={`flex-1 p-3 md:p-4 rounded-3xl flex flex-col items-center justify-center gap-2 md:gap-3 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-sm border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-100 text-slate-700'}`}
            >
              <div className={`p-2.5 md:p-3 rounded-full ${btn.color}`}>
                <btn.icon size={22} className="md:w-6 md:h-6" />
              </div>
              <span className="text-[10px] md:text-[11px] font-bold uppercase tracking-tight">{btn.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        {/* Today's Agenda Summary */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Agenda du jour</h2>
            <button onClick={() => onNavigate('agenda')} className={`text-xs font-bold text-${userSettings.themeColor}-600`}>Tout voir</button>
          </div>
          <div className="space-y-3 flex-1">
            {todaysEvents.length > 0 ? todaysEvents.map(evt => (
              <div 
                key={evt.id} 
                onClick={() => onEventClick(evt)}
                className={`p-4 rounded-2xl shadow-sm border flex items-center gap-4 cursor-pointer transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
              >
                <div className={`flex flex-col items-center justify-center min-w-[3.5rem] p-2.5 rounded-xl ${evt.type === 'pro' ? themeLight : 'bg-emerald-50 text-emerald-700'}`}>
                  <span className="text-xs font-bold">{evt.time}</span>
                  <span className="text-[9px] font-medium opacity-70">{evt.duration}</span>
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="font-bold text-sm leading-snug truncate">{evt.title}</h3>
                  {evt.linkedContactId && (
                    <p className="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5 truncate">
                      <User size={10} /> {contacts.find(c => c.id.toString() === evt.linkedContactId?.toString())?.name || 'Contact'}
                    </p>
                  )}
                  {evt.videoLink && (
                    <button 
                      onClick={(e) => { e.stopPropagation(); window.open(evt.videoLink, '_blank'); }}
                      className="mt-2 py-1 px-2.5 rounded-lg bg-blue-50 text-blue-600 text-[9px] font-black flex items-center gap-2 w-fit"
                    >
                      <Video size={12} /> VISIO
                    </button>
                  )}
                </div>
                <ChevronRight size={16} className="text-slate-300" />
              </div>
            )) : (
              <div className="p-8 text-center border-2 border-dashed rounded-3xl border-slate-200 h-full flex flex-col justify-center items-center">
                <p className="text-slate-400 text-xs font-medium">Aucun rendez-vous pr√©vu.</p>
              </div>
            )}
          </div>
        </section>

        {/* Pulse Commercial & Groups */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Performance Commerciale</h2>
            <button onClick={() => onNavigate('groups_crm')} className={`text-xs font-bold text-violet-600`}>CRM</button>
          </div>
          
          <div className="space-y-4 flex-1">
             {/* SALES PULSE WIDGET */}
             <div className={`p-5 rounded-[28px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                <div className="flex justify-between items-center mb-4">
                   <div className="flex items-center gap-2">
                      <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-xl">
                         <TrendingUp size={18} />
                      </div>
                      <span className="text-sm font-black">Pulse Commercial</span>
                   </div>
                   <button onClick={() => onNavigate('groups_crm')} className="p-2 text-slate-300 hover:text-indigo-500 transition-colors"><ArrowRight size={16}/></button>
                </div>
                
                <div className="space-y-3">
                   {/* KPI 1: Pipeline */}
                   <div className="flex items-center justify-between p-3 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 border border-transparent hover:border-indigo-200 transition-colors cursor-pointer" onClick={() => onNavigate('groups_crm')}>
                      <div className="flex items-center gap-3">
                         <div className="p-1.5 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-indigo-500"><Briefcase size={14}/></div>
                         <span className="text-xs font-bold text-indigo-900 dark:text-indigo-200">Dossiers actifs</span>
                      </div>
                      <span className="text-lg font-black text-indigo-600 dark:text-indigo-400">{salesKPIs.pipeline}</span>
                   </div>

                   {/* KPI 2: Inbox */}
                   <div className="flex items-center justify-between p-3 rounded-2xl bg-blue-50 dark:bg-blue-900/20 border border-transparent hover:border-blue-200 transition-colors cursor-pointer" onClick={() => onNavigate('groups_crm')}>
                      <div className="flex items-center gap-3">
                         <div className="p-1.5 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-blue-500"><Inbox size={14}/></div>
                         <span className="text-xs font-bold text-blue-900 dark:text-blue-200">Nouvelles demandes</span>
                      </div>
                      {salesKPIs.newRequests > 0 ? (
                        <span className="text-xs font-black bg-red-500 text-white px-2 py-0.5 rounded-full animate-pulse">{salesKPIs.newRequests}</span>
                      ) : (
                        <span className="text-xs font-bold text-blue-400">0</span>
                      )}
                   </div>

                   {/* KPI 3: Action */}
                   <div className="flex items-center gap-3 p-3 rounded-2xl bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800">
                      <AlertCircle size={14} className="text-orange-500 shrink-0"/>
                      <div className="flex-1 min-w-0">
                         <p className="text-[9px] font-bold uppercase text-orange-400">Action requise</p>
                         <p className="text-xs font-bold text-orange-900 dark:text-orange-200 truncate">
                           {salesKPIs.urgentAction ? `Relancer ${salesKPIs.urgentAction}` : 'Rien √† signaler'}
                         </p>
                      </div>
                   </div>
                </div>
             </div>

             {/* Groups List (Below Pulse) */}
             {activeGroups.length > 0 && (
                <div className="space-y-2">
                   <p className="text-[10px] font-bold uppercase text-slate-400 ml-1">Groupes en maison</p>
                   {activeGroups.map(group => (
                    <div 
                      key={group.id} 
                      onClick={() => onGroupClick(group)}
                      className={`p-4 rounded-2xl shadow-sm border-l-4 border-l-violet-500 border-y border-r flex items-center gap-4 cursor-pointer transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
                    >
                      <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-xs leading-snug truncate">{group.name}</h3>
                        <p className="text-[10px] text-slate-400 mt-0.5">{group.pax} PAX ‚Ä¢ {group.category}</p>
                      </div>
                    </div>
                  ))}
                </div>
             )}
          </div>
        </section>

        {/* Pending Tasks Summary */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Priorit√©s</h2>
            <button onClick={() => onNavigate('todo')} className={`text-xs font-bold text-${userSettings.themeColor}-600`}>Liste compl√®te</button>
          </div>
          <div className="space-y-3 flex-1">
            {pendingTasks.map(task => (
              <div 
                key={task.id} 
                className={`p-4 rounded-2xl shadow-sm border flex items-center gap-4 transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
              >
                <button 
                  onClick={() => onTaskToggle(task.id)}
                  className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${task.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}
                >
                  {task.done && <CheckSquare size={12} className="text-white" />}
                </button>
                <div className="flex-1 cursor-pointer min-w-0" onClick={() => onTaskClick(task)}>
                  <p className={`text-sm font-semibold truncate ${task.done ? 'line-through opacity-40' : ''}`}>{task.text}</p>
                  <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded-md mt-1 inline-block bg-${userSettings.themeColor}-50 text-${userSettings.themeColor}-700`}>{task.tag}</span>
                </div>
              </div>
            ))}
            {pendingTasks.length === 0 && (
              <div className="p-8 text-center border-2 border-dashed rounded-3xl border-emerald-100 bg-emerald-50/20 h-full flex flex-col justify-center items-center">
                <p className="text-emerald-500 text-xs font-bold">Tout est sous contr√¥le !</p>
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default Dashboard;

import React, { useState, useEffect } from 'react';
import { X, Calendar as CalendarIcon, Clock, MessageSquare, Video, ClipboardPaste, ChevronDown, Trash2 } from 'lucide-react';
import { Contact, CalendarEvent, UserSettings } from '../types';

interface EventModalProps {
  isOpen: boolean;
  onClose: () => void;
  contacts: Contact[];
  onSave: (event: CalendarEvent) => void;
  onDelete?: (id: number | string) => void;
  userSettings: UserSettings;
  editEvent?: CalendarEvent | null;
  onTriggerCommunication?: (contactId: string | number, text: string) => void;
}

const EventModal: React.FC<EventModalProps> = ({ isOpen, onClose, contacts, onSave, onDelete, userSettings, editEvent, onTriggerCommunication }) => {
  const [title, setTitle] = useState('');
  const [startDate, setStartDate] = useState('');
  const [startTime, setStartTime] = useState('09:00');
  const [duration, setDuration] = useState('1h');
  const [contactId, setContactId] = useState('');
  const [type, setType] = useState<'pro' | 'perso'>('pro');
  const [videoLink, setVideoLink] = useState<string>('');
  const [isSmsEditing, setIsSmsEditing] = useState(false);
  const [smsMessage, setSmsMessage] = useState('');

  // Pour le s√©lecteur d'heure personnalis√©
  const [showTimePicker, setShowTimePicker] = useState(false);
  const hours = Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0'));
  const minutes = ['00', '15', '30', '45'];

  const durationPresets = ['15min', '30min', '1h', '2h', '3h'];

  useEffect(() => {
    if (editEvent && isOpen) {
      setTitle(editEvent.title);
      const start = new Date(editEvent.start);
      if (!isNaN(start.getTime())) {
        setStartDate(start.toISOString().split('T')[0]);
        setStartTime(editEvent.time);
      }
      setDuration(editEvent.duration);
      setContactId(editEvent.linkedContactId?.toString() || '');
      setType(editEvent.type === 'google' ? 'pro' : editEvent.type as 'pro' | 'perso');
      setVideoLink(editEvent.videoLink || '');
    } else if (!editEvent && isOpen) {
      const now = new Date();
      now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
      if (now.getMinutes() >= 60) { now.setHours(now.getHours() + 1); now.setMinutes(0); }
      setStartDate(now.toISOString().split('T')[0]);
      setStartTime(`${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`);
      setTitle(''); setDuration('1h'); setContactId(''); setType('pro'); setVideoLink('');
    }
    setIsSmsEditing(false);
    setShowTimePicker(false);
  }, [editEvent, isOpen]);

  useEffect(() => {
    if (contactId && !isSmsEditing && isOpen) {
      const contact = contacts.find(c => c.id.toString() === contactId.toString());
      const d = new Date(startDate);
      const dateStr = !isNaN(d.getTime()) ? d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' }) : '...';
      setSmsMessage(`Bonjour ${contact?.name || ''}, je vous confirme notre RDV le ${dateStr} √† ${startTime} (Dur√©e: ${duration}). Objet: ${title || 'RDV'}${videoLink ? `\nLien Visio: ${videoLink}` : ''}`);
    }
  }, [contactId, startDate, startTime, duration, title, videoLink, contacts, isSmsEditing, isOpen]);

  if (!isOpen) return null;

  const handleSave = () => {
    if (!title || !startDate) return;
    onSave({
      id: editEvent ? editEvent.id : Date.now(),
      title, start: new Date(`${startDate}T${startTime}`), 
      time: startTime, duration, type, linkedContactId: contactId, videoLink: videoLink || undefined
    });
    onClose();
  };

  const handleDelete = () => {
    if (editEvent && onDelete) {
      if (window.confirm('Voulez-vous vraiment supprimer cet √©v√©nement ?')) {
        onDelete(editEvent.id);
      }
    }
  };

  const handleTimeSelect = (h: string, m: string) => {
    setStartTime(`${h}:${m}`);
    setShowTimePicker(false);
  };

  const themeBg = `bg-${userSettings.themeColor}-600`;
  const themeHex = `text-${userSettings.themeColor}-600`;

  return (
    <div className={`fixed inset-0 z-[120] bg-black/60 flex items-end md:items-center md:justify-center animate-in fade-in backdrop-blur-sm overflow-hidden ${userSettings.darkMode ? 'dark' : ''}`}>
      <div className={`w-full md:max-w-xl md:rounded-[40px] md:mx-4 rounded-t-[40px] p-6 pb-12 animate-in slide-in-from-bottom-20 md:slide-in-from-bottom-10 max-h-[95vh] overflow-y-auto no-scrollbar ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        <div className="relative mb-8 mt-2">
          <div className={`${userSettings.darkMode ? 'bg-slate-800' : 'bg-slate-900'} rounded-[32px] p-8 pr-16 shadow-xl`}>
             <input type="text" placeholder="Titre de l'√©v√©nement" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full text-2xl font-black bg-transparent border-none outline-none text-white placeholder:text-slate-500" />
          </div>
          <button type="button" onClick={onClose} className="absolute top-4 right-4 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full text-white transition-all flex items-center justify-center cursor-pointer border border-white/20 z-[150]"><X size={24} /></button>
        </div>

        <div className="space-y-6">
          <div className="grid grid-cols-2 gap-3 px-2">
             {/* Date Picker Fix: Overlay Method */}
             <div className="space-y-1">
               <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Date</label>
               <div className="relative h-[58px]">
                 <div className="absolute inset-0 p-4 rounded-2xl border-2 border-slate-50 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 flex items-center gap-3 shadow-sm hover:border-indigo-400 transition-colors">
                   <CalendarIcon size={18} className="text-indigo-500" />
                   <span className="font-black text-xs dark:text-white">
                      {startDate ? new Date(startDate).toLocaleDateString('fr-FR') : 'Choisir date'}
                   </span>
                 </div>
                 <input 
                    type="date" 
                    value={startDate} 
                    onChange={(e) => setStartDate(e.target.value)} 
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                 />
               </div>
             </div>

             {/* Time Picker 1/4 d'heure */}
             <div className="space-y-1 relative">
               <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Heure</label>
               <button 
                 type="button"
                 onClick={() => setShowTimePicker(!showTimePicker)}
                 className="w-full p-4 rounded-2xl border-2 border-slate-50 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 flex items-center justify-between shadow-sm hover:border-indigo-400 transition-colors"
               >
                 <div className="flex items-center gap-3">
                   <Clock size={18} className="text-indigo-500" />
                   <span className="font-black text-sm">{startTime}</span>
                 </div>
                 <ChevronDown size={16} className={`text-slate-400 transition-transform ${showTimePicker ? 'rotate-180' : ''}`} />
               </button>

               {showTimePicker && (
                 <div className="absolute top-full left-0 right-0 mt-2 p-3 bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-3xl shadow-2xl z-50 animate-in zoom-in-95">
                    <div className="grid grid-cols-4 gap-2 h-40 overflow-y-auto no-scrollbar py-2">
                      {hours.map(h => (
                        <div key={h} className="contents">
                          {minutes.map(m => (
                            <button 
                              key={`${h}:${m}`} 
                              onClick={() => handleTimeSelect(h, m)}
                              className={`p-2 rounded-xl text-[10px] font-black transition-all ${startTime === `${h}:${m}` ? 'bg-indigo-600 text-white' : 'hover:bg-indigo-50 dark:hover:bg-slate-700 text-slate-500'}`}
                            >
                              {h}:{m}
                            </button>
                          ))}
                        </div>
                      ))}
                    </div>
                 </div>
               )}
             </div>
          </div>

          <div className="px-2">
            <div className="flex justify-between gap-2 overflow-x-auto no-scrollbar">
              {durationPresets.map(p => (
                <button key={p} type="button" onClick={() => setDuration(p)} className={`flex-1 py-4 rounded-2xl border-2 text-[11px] font-black transition-all ${duration === p ? 'border-indigo-600 bg-indigo-50 text-indigo-600 dark:bg-slate-700 dark:text-indigo-400' : 'border-slate-50 dark:border-slate-800 text-slate-300'}`}>{p}</button>
              ))}
            </div>
          </div>

          <div className="px-2 space-y-3">
             <div className="flex justify-between items-center">
               <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Options de Visio</label>
               <div className="flex gap-2">
                 <button type="button" onClick={async () => {
                   try {
                     const t = await navigator.clipboard.readText();
                     if (t.includes('meet') || t.includes('teams')) setVideoLink(t);
                   } catch (err) {
                     console.warn("Clipboard access blocked");
                   }
                 }} className="px-3 py-1.5 rounded-lg bg-emerald-500 text-white text-[9px] font-black uppercase flex items-center gap-1"><ClipboardPaste size={12} /> R√©cup√©rer</button>
                 <button type="button" onClick={() => window.open('https://meet.google.com/new', '_blank')} className="px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[9px] font-black uppercase">Meet</button>
                 <button type="button" onClick={() => window.open('https://teams.microsoft.com/l/meeting/new', '_blank')} className="px-3 py-1.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-[9px] font-black uppercase">Teams</button>
               </div>
             </div>
             <div className="p-4 rounded-2xl border-2 flex items-center gap-3 bg-slate-50 dark:bg-slate-800 border-transparent">
               <Video size={18} className="text-slate-400" />
               <input type="text" placeholder="Lien de la r√©union..." value={videoLink} onChange={(e) => setVideoLink(e.target.value)} className="bg-transparent outline-none flex-1 font-bold text-sm dark:text-white" />
             </div>
          </div>

          <div className="px-2">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1 mb-2 block">Lier un contact (SMS)</label>
            <select value={contactId} onChange={(e) => setContactId(e.target.value)} className="w-full p-4 rounded-2xl border-2 bg-slate-50 dark:bg-slate-800 border-transparent font-bold text-sm dark:text-white">
              <option value="">S√©lectionner...</option>
              {contacts.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
            {contactId && (
              <div className="mt-4 space-y-3">
                <div className="flex justify-between items-center">
                   <span className="text-[10px] font-black uppercase text-slate-400">Message SMS</span>
                   <button type="button" onClick={() => setIsSmsEditing(!isSmsEditing)} className={`text-[10px] font-black uppercase underline ${themeHex}`}>{isSmsEditing ? 'OK' : 'Modifier'}</button>
                </div>
                {isSmsEditing ? 
                  <textarea value={smsMessage} onChange={(e) => setSmsMessage(e.target.value)} className="w-full p-4 rounded-2xl border-2 bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700 font-bold text-xs h-32 outline-none dark:text-white" /> :
                  <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 text-[11px] font-bold italic text-slate-400">{smsMessage}</div>
                }
                <button type="button" onClick={() => {
                  const c = contacts.find(con => con.id.toString() === contactId);
                  if (c) {
                    if (onTriggerCommunication) onTriggerCommunication(c.id, smsMessage);
                    window.open(`sms:${c.phone}?body=${encodeURIComponent(smsMessage)}`);
                  }
                }} className="w-full py-4 rounded-2xl bg-indigo-600 text-white font-black text-xs uppercase tracking-widest flex items-center justify-center gap-2 shadow-xl"><MessageSquare size={16}/> Envoyer Confirmation SMS</button>
              </div>
            )}
          </div>
        </div>

        <div className="mt-10 space-y-3">
          {editEvent && (
            <button 
              type="button" 
              onClick={handleDelete} 
              className="w-full py-4 rounded-2xl text-red-500 font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-2 border-2 border-red-50 hover:bg-red-50 transition-all"
            >
              <Trash2 size={16} /> Supprimer l'√©v√©nement
            </button>
          )}
          <button type="button" onClick={handleSave} className={`w-full py-6 rounded-[32px] text-white font-black uppercase tracking-[0.2em] shadow-xl shadow-2xl ${themeBg}`}>
            {editEvent ? 'Enregistrer les modifications' : 'Planifier l\'√©v√©nement'}
          </button>
        </div>
      </div>
    </div>
  );
};

export default EventModal;


import React, { useState, useEffect, useMemo } from 'react';
import { 
  X, Calendar, Users, Edit3, MessageSquare, FileText, Check, Utensils, 
  Coffee, MapPin, Wine, Briefcase, Receipt, Plus, Trash2, Printer, 
  LayoutList, Phone, Mail, User, FileCheck, FileSpreadsheet, ClipboardList, Clock,
  BedDouble, BedSingle, Home, AlertTriangle
} from 'lucide-react';
import { Group, UserSettings, Contact, InvoiceItem, PaymentSchedule, GroupOptions, BusinessConfig, CatalogItem, GroupRooms, Venue, Client } from '../types';

interface GroupDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  group: Group | null;
  allGroups?: Group[]; // Needed for conflict detection
  contacts: Contact[];
  clients?: Client[];
  onEdit: (group: Group) => void;
  onSave?: (group: Group) => void;
  userSettings: UserSettings;
  businessConfig: BusinessConfig;
  catalog: CatalogItem[];
  venues?: Venue[];
}

const GroupDetailModal: React.FC<GroupDetailModalProps> = ({ 
  isOpen, onClose, group, allGroups = [], contacts, clients = [], onEdit, onSave, userSettings, businessConfig, catalog, venues = []
}) => {
  const [activeTab, setActiveTab] = useState<'details' | 'billing'>('details');
  const [isSmsEditing, setIsSmsEditing] = useState(false);
  const [smsMessage, setSmsMessage] = useState('');
  
  // Editable Operational States
  const [localPax, setLocalPax] = useState<number>(0);
  const [localRooms, setLocalRooms] = useState<GroupRooms>({ single: 0, twin: 0, double: 0, family: 0 });

  // Billing States
  const [invoiceItems, setInvoiceItems] = useState<InvoiceItem[]>([]);
  const [paymentSchedule, setPaymentSchedule] = useState<PaymentSchedule[]>([]);
  const [showInvoicePreview, setShowInvoicePreview] = useState(false);
  const [documentType, setDocumentType] = useState<'quote' | 'invoice' | 'functionSheet'>('quote');

  useEffect(() => {
    if (group && isOpen) {
      setActiveTab('details');
      setIsSmsEditing(false);
      
      // Init Local States from Group
      setLocalPax(group.pax);
      setLocalRooms(group.rooms || { single: 0, twin: 0, double: 0, family: 0 });
      setInvoiceItems(group.invoiceItems || []);
      setPaymentSchedule(group.paymentSchedule || []);
      
      setShowInvoicePreview(false);
      
      // SMS Generation Logic
      const rmContact = contacts.find(c => c.id.toString() === group.rmContactId?.toString());
      const startDateFormatted = new Date(group.startDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
      const endDateFormatted = new Date(group.endDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
      const opts = group.options;
      const prestations = [];
      if (opts?.je) prestations.push("JE");
      if (opts?.demiJe) prestations.push("1/2 JE");
      if (opts?.lunch) prestations.push("D√©jeuner");
      if (opts?.dinner) prestations.push("D√Æner");
      if (opts?.pause) prestations.push("Pause");
      if (opts?.roomHire) prestations.push("Loc. Salle");
      if (opts?.cocktail) prestations.push("Cocktail");

      setSmsMessage(`Bonjour ${rmContact?.name.split(' ')[0] || 'Jean'},
Demande cotation pour : "${group.name}"
üìÖ ${startDateFormatted} - ${endDateFormatted} (${group.nights}N)
üë• ${group.pax} Pax
üìå Inclus : ${prestations.length > 0 ? prestations.join(", ") : "H√©bergement seul"}
Merci !`);
    }
  }, [group, isOpen, contacts]);

  // Handle Room Changes & Auto-Calc Pax & Sync Invoice
  const handleRoomChange = (type: keyof GroupRooms, value: string) => {
    const val = parseInt(value) || 0;
    const newRooms = { ...localRooms, [type]: val };
    setLocalRooms(newRooms);

    // Auto-calculate PAX based on standard occupancy
    // Single = 1, Twin/Double = 2, Family = 4
    const newPax = (newRooms.single * 1) + (newRooms.twin * 2) + (newRooms.double * 2) + (newRooms.family * 4);
    setLocalPax(newPax);

    // SYNC: Update quantities in Invoice Items automatically
    setInvoiceItems(prev => prev.map(item => {
       const descLower = item.description.toLowerCase();
       // Heuristic to identify room lines
       const isRoomLine = descLower.includes('chambre') || descLower.includes('h√©bergement') || descLower.includes('nuit');
       
       if (isRoomLine) {
         if (type === 'single' && descLower.includes('single')) return { ...item, quantity: val };
         if (type === 'twin' && descLower.includes('twin')) return { ...item, quantity: val };
         if (type === 'double' && descLower.includes('double')) return { ...item, quantity: val };
         if (type === 'family' && (descLower.includes('family') || descLower.includes('famille'))) return { ...item, quantity: val };
       }
       return item;
    }));
  };

  // Improved Conflict Detection Logic with Time Ranges
  const checkConflict = (item: InvoiceItem) => {
    if (!item.date || !item.location || !item.time) return null;
    
    // Normalize dates
    const itemDate = new Date(item.date).toDateString();
    
    // Helper to get minutes from "HH:MM"
    const getMinutes = (timeStr: string) => {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    };

    const startA = getMinutes(item.time);
    const endA = item.endTime ? getMinutes(item.endTime) : startA + 60; // Default 1h if no end time

    for (const otherGroup of allGroups) {
      if (otherGroup.id === group?.id) continue; // Skip self
      if (otherGroup.invoiceItems) {
        for (const otherItem of otherGroup.invoiceItems) {
          // Check Date & Venue
          if (otherItem.date && new Date(otherItem.date).toDateString() === itemDate) {
             if (otherItem.location === item.location) {
               // Check Time Overlap
               if (otherItem.time) {
                 const startB = getMinutes(otherItem.time);
                 const endB = otherItem.endTime ? getMinutes(otherItem.endTime) : startB + 60;

                 // Overlap formula: (StartA < EndB) and (EndA > StartB)
                 if (startA < endB && endA > startB) {
                   return `Occup√© par: ${otherGroup.name} (${otherItem.time} - ${otherItem.endTime || '?'})`;
                 }
               }
             }
          }
        }
      }
    }
    return null;
  };

  // Billing Calculations
  const totals = useMemo(() => {
    let totalHT = 0;
    let totalVAT = 0;
    
    invoiceItems.forEach(item => {
      const lineHT = item.quantity * item.unitPrice;
      const lineVAT = lineHT * (item.vatRate / 100);
      totalHT += lineHT;
      totalVAT += lineVAT;
    });

    return {
      ht: totalHT,
      vat: totalVAT,
      ttc: totalHT + totalVAT
    };
  }, [invoiceItems]);

  const paidAmount = useMemo(() => {
    return paymentSchedule
      .filter(p => p.paid)
      .reduce((acc, curr) => acc + (totals.ttc * curr.percentage / 100), 0);
  }, [paymentSchedule, totals.ttc]);

  // Client Data Retrieval
  const clientData = useMemo(() => {
    if (!group?.clientId) return null;
    return clients.find(c => c.id === group.clientId);
  }, [group, clients]);

  if (!isOpen || !group) return null;

  const rmContact = contacts.find(c => c.id.toString() === group.rmContactId?.toString());
  const themeBg = `bg-${userSettings.themeColor}-600`;
  const themeText = `text-${userSettings.themeColor}-600`;

  const handleSendSMS = () => {
    if (!rmContact) { alert("Aucun contact RM s√©lectionn√©."); return; }
    window.open(`sms:${rmContact.phone}?body=${encodeURIComponent(smsMessage)}`);
  };

  // Unified Save Function
  const handleSave = () => {
    if (onSave) {
      onSave({
        ...group,
        pax: localPax,
        rooms: localRooms,
        invoiceItems,
        paymentSchedule
      });
      alert("Dossier (D√©tails & Facturation) sauvegard√© !");
    }
  };

  const addItem = () => {
    setInvoiceItems([...invoiceItems, { 
      id: Date.now().toString(), 
      date: group.startDate,
      time: '09:00',
      endTime: '10:00',
      location: '',
      description: '', 
      setup: '',
      quantity: 1, 
      unitPrice: 0, 
      vatRate: 20,
      catalogId: '' 
    }]);
  };

  const handleCatalogSelection = (itemId: string, catalogId: string) => {
    if (!catalogId) {
      updateItem(itemId, 'catalogId', '');
      return;
    }
    const catItem = catalog.find(c => c.id === catalogId);
    if (catItem) {
      // Find venue name if ID is present
      const defaultVenueName = catItem.defaultVenueId 
        ? venues.find(v => v.id === catItem.defaultVenueId)?.name || '' 
        : '';

      setInvoiceItems(prev => prev.map(item => 
        item.id === itemId ? { 
          ...item, 
          catalogId: catalogId,
          description: catItem.name,
          unitPrice: catItem.defaultPrice,
          vatRate: catItem.defaultVat,
          setup: item.setup || catItem.technicalDescription || '',
          // Auto-fill venue and times
          location: defaultVenueName || item.location,
          time: catItem.defaultStartTime || item.time,
          endTime: catItem.defaultEndTime || item.endTime
        } : item
      ));
    }
  };

  const updateItem = (id: string, field: keyof InvoiceItem, value: any) => {
    setInvoiceItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  const removeItem = (id: string) => {
    setInvoiceItems(prev => prev.filter(item => item.id !== id));
  };

  const generateDefaultSchedule = () => {
    if (!group.startDate) return;
    const start = new Date(group.startDate);
    
    // Dates calculation
    const d30 = new Date(start); d30.setDate(d30.getDate() - 30);
    const d14 = new Date(start); d14.setDate(d14.getDate() - 14);

    setPaymentSchedule([
      { id: '1', label: 'Acompte 1 (30% - R√©servation)', percentage: 30, dueDate: new Date().toISOString().split('T')[0], paid: false },
      { id: '2', label: 'Acompte 2 (50% - J-30)', percentage: 50, dueDate: d30.toISOString().split('T')[0], paid: false },
      { id: '3', label: 'Solde (20% - J-14)', percentage: 20, dueDate: d14.toISOString().split('T')[0], paid: false },
    ]);
  };

  const updateSchedule = (id: string, field: keyof PaymentSchedule, value: any) => {
    setPaymentSchedule(prev => prev.map(p => p.id === id ? { ...p, [field]: value } : p));
  };

  const renderOptions = () => {
    const opts = group.options;
    const items = [
      { key: 'je', label: 'Journ√©e √âtude', icon: Briefcase },
      { key: 'demiJe', label: '1/2 Journ√©e', icon: Briefcase },
      { key: 'lunch', label: 'D√©jeuner', icon: Utensils },
      { key: 'dinner', label: 'D√Æner', icon: Utensils },
      { key: 'pause', label: 'Pauses', icon: Coffee },
      { key: 'roomHire', label: 'Loc. Salle', icon: MapPin },
      { key: 'cocktail', label: 'Cocktail', icon: Wine },
    ];
    
    const activeItems = items.filter(item => opts[item.key as keyof GroupOptions]);

    return (
      <div className={`p-4 rounded-[28px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
         <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3">Prestations Incluses</h4>
         <div className="flex flex-wrap gap-2">
            {activeItems.map(item => (
              <div key={item.key} className="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 flex items-center gap-2 text-xs font-bold shadow-sm">
                <item.icon size={14} className={themeText} /> {item.label}
              </div>
            ))}
            {activeItems.length === 0 && <span className="text-xs text-slate-400 italic font-medium px-1">H√©bergement seul (Room Only)</span>}
         </div>
      </div>
    );
  };

  const getSortedItemsForFF = () => {
    // Sort items by Date then Time
    const sorted = [...invoiceItems].sort((a, b) => {
      const dateA = a.date || group.startDate;
      const dateB = b.date || group.startDate;
      if (dateA !== dateB) return new Date(dateA).getTime() - new Date(dateB).getTime();
      return (a.time || '00:00').localeCompare(b.time || '00:00');
    });

    // Group by Date
    const grouped: Record<string, InvoiceItem[]> = {};
    sorted.forEach(item => {
      const d = item.date || group.startDate;
      if (!grouped[d]) grouped[d] = [];
      grouped[d].push(item);
    });

    return grouped;
  };

  return (
    <div className="fixed inset-0 z-[200] bg-black/70 flex items-end md:items-center md:justify-center animate-in fade-in backdrop-blur-sm overflow-hidden">
      <div className={`w-full md:max-w-4xl md:rounded-[40px] md:mx-4 rounded-t-[32px] p-6 pb-10 animate-in slide-in-from-bottom-20 max-h-[95vh] md:h-[85vh] flex flex-col ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        {/* Header */}
        <div className="flex justify-between items-start mb-6 shrink-0">
          <div className="flex flex-col gap-0.5 pt-1">
            <span className="text-[9px] font-black uppercase text-indigo-500 tracking-[0.15em]">{group.category}</span>
            <h3 className="text-2xl font-black leading-tight pr-4">{group.name}</h3>
          </div>
          <div className="flex gap-2">
            {!showInvoicePreview && (
              <button 
                onClick={() => onEdit(group)}
                className="p-2.5 rounded-2xl text-slate-700 bg-slate-100 shadow-sm transition-colors dark:bg-slate-800 dark:text-white hover:bg-slate-200"
                title="Modifier Groupe"
              >
                <Edit3 size={20}/>
              </button>
            )}
            <button onClick={onClose} className="p-2.5 rounded-full text-slate-400 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200"><X size={20}/></button>
          </div>
        </div>

        {/* Tab Navigation */}
        {!showInvoicePreview && (
          <div className="flex p-1 rounded-2xl bg-slate-100 dark:bg-slate-800 mb-6 shrink-0">
            <button 
              onClick={() => setActiveTab('details')}
              className={`flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'details' ? 'bg-white dark:bg-slate-700 shadow-sm ' + themeText : 'text-slate-400'}`}
            >
              <LayoutList size={14} className="inline mr-2 mb-0.5" /> D√©tails & Ops
            </button>
            <button 
              onClick={() => setActiveTab('billing')}
              className={`flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'billing' ? 'bg-white dark:bg-slate-700 shadow-sm ' + themeText : 'text-slate-400'}`}
            >
              <Receipt size={14} className="inline mr-2 mb-0.5" /> Facturation
            </button>
          </div>
        )}

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 px-1">
          
          {/* ---- DOCUMENT PREVIEW MODE (Invoice, Quote, Function Sheet) ---- */}
          {showInvoicePreview ? (
            <div id="printable-content" className="bg-white text-slate-900 p-8 rounded-3xl border shadow-xl max-w-3xl mx-auto h-full overflow-y-auto flex flex-col">
              
              {/* Document Type Toggle (Hidden in Print) */}
              <div className="flex justify-center mb-8 no-print">
                 <div className="flex p-1 bg-slate-100 rounded-xl overflow-x-auto">
                    <button 
                      onClick={() => setDocumentType('quote')} 
                      className={`px-4 py-2 rounded-lg text-xs font-black uppercase whitespace-nowrap transition-all ${documentType === 'quote' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}
                    >
                      Devis
                    </button>
                    <button 
                      onClick={() => setDocumentType('invoice')} 
                      className={`px-4 py-2 rounded-lg text-xs font-black uppercase whitespace-nowrap transition-all ${documentType === 'invoice' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}
                    >
                      Facture
                    </button>
                    <button 
                      onClick={() => setDocumentType('functionSheet')} 
                      className={`px-4 py-2 rounded-lg text-xs font-black uppercase whitespace-nowrap transition-all ${documentType === 'functionSheet' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}
                    >
                      Fiche de Fonction
                    </button>
                 </div>
              </div>

              {/* Document Header */}
              {documentType === 'functionSheet' ? (
                /* Header FF */
                <div className="mb-8">
                   <div className="flex justify-between items-end border-b-4 border-slate-800 pb-4 mb-4">
                      <div>
                        <h1 className="text-3xl font-black text-slate-900 uppercase leading-none">Fiche de Fonction</h1>
                        <p className="text-sm font-bold text-slate-500 mt-1">D√©tail des op√©rations</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xs font-bold text-slate-400 uppercase">Organisateur</p>
                        <p className="text-lg font-bold">{group.rmContactId ? contacts.find(c => c.id.toString() === group.rmContactId?.toString())?.name : 'Non assign√©'}</p>
                      </div>
                   </div>
                   <div className="bg-slate-50 p-4 rounded-xl flex justify-between items-center">
                      <div>
                         <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Groupe</p>
                         <p className="text-xl font-black text-indigo-900">{group.name}</p>
                      </div>
                      <div className="text-right">
                         <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Dates</p>
                         <p className="text-sm font-bold">{new Date(group.startDate).toLocaleDateString('fr-FR')} - {new Date(group.endDate).toLocaleDateString('fr-FR')}</p>
                         <p className="text-xs font-medium text-slate-500">{localPax} Personnes</p>
                      </div>
                   </div>
                </div>
              ) : (
                /* Header Quote/Invoice */
                <>
                  <div className="flex justify-between items-start mb-10 text-xs">
                    <div>
                      <h3 className="font-black text-lg uppercase text-slate-900 mb-1">{businessConfig.companyName}</h3>
                      <p className="text-slate-500">{businessConfig.address}</p>
                      <p className="text-slate-500">T√©l: {businessConfig.phone} - {businessConfig.email}</p>
                      {documentType === 'invoice' && (
                        <p className="text-slate-400 mt-2 text-[10px]">SIRET: {businessConfig.siret} - TVA: {businessConfig.vatNumber}</p>
                      )}
                    </div>
                    <div className="text-right">
                      <h1 className="text-3xl font-black uppercase tracking-tight text-indigo-900 opacity-20">
                        {documentType === 'quote' ? 'DEVIS' : 'FACTURE'}
                      </h1>
                      <p className="text-xs font-black text-indigo-900 mt-1">
                        N¬∞ {documentType === 'quote' ? 'DEV' : 'FAC'}-{new Date().getFullYear()}-{group.id}
                      </p>
                    </div>
                  </div>
                  <div className="flex justify-between items-start border-b pb-6 mb-6">
                    <div>
                      <p className="text-sm font-bold text-slate-400 mt-1 uppercase text-[10px]">Factur√© √†</p>
                      {clientData ? (
                        <>
                          <p className="font-bold text-slate-800">{clientData.name}</p>
                          {clientData.companyName && (
                             <p className="text-xs font-bold text-slate-600 uppercase mt-0.5">{clientData.companyName}</p>
                          )}
                          <p className="text-xs text-slate-500">{clientData.address}</p>
                          <p className="text-xs text-slate-500 mt-0.5">
                             {clientData.phone && `T√©l: ${clientData.phone}`}
                             {clientData.phone && clientData.email && ' | '}
                             {clientData.email && `Email: ${clientData.email}`}
                          </p>
                          {clientData.siret && <p className="text-xs text-slate-500 mt-0.5">SIRET: {clientData.siret}</p>}
                        </>
                      ) : (
                        <p className="font-bold text-slate-800">{group.name} (Client non li√©)</p>
                      )}
                    </div>
                    <div className="text-right">
                      <p className="text-sm font-bold text-slate-400 mt-1 uppercase text-[10px]">Date</p>
                      <p className="font-bold text-slate-800">{new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                  </div>
                </>
              )}

              {/* Main Content Body */}
              {documentType === 'functionSheet' ? (
                <div className="flex-1 space-y-8">
                   {/* Special Notes Section */}
                   {group.note && (
                     <div className="border-l-4 border-amber-400 bg-amber-50 p-4 rounded-r-xl">
                        <h3 className="font-black text-xs uppercase text-amber-600 mb-2 tracking-widest">Notes Sp√©ciales</h3>
                        <p className="text-sm font-medium text-slate-800 italic">{group.note}</p>
                     </div>
                   )}

                   {/* Rooming Summary for FF */}
                   <div className="bg-white border-2 border-indigo-50 rounded-xl p-4">
                      <h3 className="font-black text-[10px] uppercase text-indigo-400 mb-3 tracking-widest flex items-center gap-2">
                        <Home size={12}/> R√©partition H√©bergement
                      </h3>
                      <div className="grid grid-cols-4 gap-4 text-center">
                         <div className="border-r border-slate-100 last:border-0">
                            <span className="block text-[9px] text-slate-400 uppercase">Single</span>
                            <span className="text-lg font-black text-slate-800">{localRooms.single}</span>
                         </div>
                         <div className="border-r border-slate-100 last:border-0">
                            <span className="block text-[9px] text-slate-400 uppercase">Twin</span>
                            <span className="text-lg font-black text-slate-800">{localRooms.twin}</span>
                         </div>
                         <div className="border-r border-slate-100 last:border-0">
                            <span className="block text-[9px] text-slate-400 uppercase">Double</span>
                            <span className="text-lg font-black text-slate-800">{localRooms.double}</span>
                         </div>
                         <div>
                            <span className="block text-[9px] text-slate-400 uppercase">Family</span>
                            <span className="text-lg font-black text-slate-800">{localRooms.family}</span>
                         </div>
                      </div>
                   </div>

                   {/* Chronological Schedule */}
                   <div>
                      {Object.entries(getSortedItemsForFF()).map(([date, items]) => (
                        <div key={date} className="mb-6 break-inside-avoid">
                           <div className="bg-slate-900 text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
                              <span className="font-black text-sm uppercase tracking-wide">{new Date(date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
                           </div>
                           <div className="border-x border-b border-slate-200 rounded-b-xl overflow-hidden">
                              <table className="w-full text-sm">
                                <thead className="bg-slate-50 border-b border-slate-200">
                                   <tr>
                                      <th className="py-2 px-4 text-left w-20 text-[10px] uppercase text-slate-500 font-black">Heure</th>
                                      <th className="py-2 px-4 text-left text-[10px] uppercase text-slate-500 font-black">Prestation</th>
                                      <th className="py-2 px-4 text-left w-32 text-[10px] uppercase text-slate-500 font-black">Lieu</th>
                                      <th className="py-2 px-4 w-16 text-[10px] uppercase text-slate-500 font-black text-center">Qt√©</th>
                                   </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                   {items.map(item => (
                                      <tr key={item.id} className="group hover:bg-slate-50">
                                         <td className="py-3 px-4 font-black align-top text-slate-700">{item.time || '--:--'}</td>
                                         <td className="py-3 px-4 align-top">
                                            <p className="font-bold text-slate-900">{item.description}</p>
                                            {item.setup && (
                                              <p className="text-xs text-slate-500 mt-1 italic border-l-2 border-indigo-200 pl-2">{item.setup}</p>
                                            )}
                                         </td>
                                         <td className="py-3 px-4 font-medium text-slate-600 align-top">{item.location || '-'}</td>
                                         <td className="py-3 px-4 font-bold text-center align-top text-slate-900">{item.quantity}</td>
                                      </tr>
                                   ))}
                                </tbody>
                              </table>
                           </div>
                        </div>
                      ))}
                      {Object.keys(getSortedItemsForFF()).length === 0 && (
                        <div className="text-center py-8 text-slate-400 italic">Aucune prestation planifi√©e.</div>
                      )}
                   </div>
                </div>
              ) : (
                /* Invoice/Quote Table */
                <>
                  <div className="mb-8 flex-1">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b-2 border-slate-100">
                          <th className="text-left py-3 font-black uppercase text-[10px] tracking-wider text-slate-400">Description</th>
                          <th className="text-center py-3 font-black uppercase text-[10px] tracking-wider text-slate-400 w-16">Qt√©</th>
                          <th className="text-right py-3 font-black uppercase text-[10px] tracking-wider text-slate-400 w-24">PU HT</th>
                          <th className="text-right py-3 font-black uppercase text-[10px] tracking-wider text-slate-400 w-24">Total HT</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-50">
                        {invoiceItems && invoiceItems.length > 0 ? (
                            invoiceItems.map(item => (
                              <tr key={item.id}>
                                <td className="py-3 font-bold text-slate-800">
                                  {item.description || "Article sans nom"}
                                  {(item.date || item.time) && (
                                    <span className="block text-[10px] text-slate-400 font-normal mt-0.5">
                                      {item.date && new Date(item.date).toLocaleDateString('fr-FR')} {item.time ? `√† ${item.time}` : ''}
                                    </span>
                                  )}
                                </td>
                                <td className="py-3 text-center text-slate-600 font-medium">{item.quantity}</td>
                                <td className="py-3 text-right text-slate-600 font-medium">{Number(item.unitPrice).toFixed(2)} ‚Ç¨</td>
                                <td className="py-3 text-right font-black text-slate-800">{(item.quantity * item.unitPrice).toFixed(2)} ‚Ç¨</td>
                              </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={4} className="py-8 text-center text-slate-400 italic">Aucun article s√©lectionn√©.</td>
                            </tr>
                        )}
                      </tbody>
                    </table>
                  </div>

                  {/* Totals Section */}
                  <div className="flex justify-end mb-8">
                    <div className="w-1/2 space-y-2 bg-slate-50 p-4 rounded-xl">
                      <div className="flex justify-between text-xs">
                        <span className="font-bold text-slate-500">Total HT</span>
                        <span className="font-bold">{totals.ht.toFixed(2)} ‚Ç¨</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="font-bold text-slate-500">TVA ({totals.ht > 0 ? ((totals.vat / totals.ht) * 100).toFixed(1) : 0}%)</span>
                        <span className="font-bold">{totals.vat.toFixed(2)} ‚Ç¨</span>
                      </div>
                      <div className="flex justify-between text-lg pt-2 border-t border-slate-200 mt-2">
                        <span className="font-black text-indigo-900">Total TTC</span>
                        <span className="font-black text-indigo-600">{totals.ttc.toFixed(2)} ‚Ç¨</span>
                      </div>
                    </div>
                  </div>

                  {/* Conditions de paiement / Acomptes */}
                  {documentType === 'quote' ? (
                    <div className="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-5 mb-6">
                      <h3 className="font-black text-[10px] uppercase text-slate-400 mb-3 tracking-widest">√âch√©ancier pr√©visionnel</h3>
                      <div className="space-y-2">
                        {paymentSchedule.map(p => (
                          <div key={p.id} className="flex justify-between items-center text-xs">
                              <span className="font-medium text-slate-600">{p.label} ({p.percentage}%)</span>
                              <span className="font-bold">{(totals.ttc * p.percentage / 100).toFixed(2)} ‚Ç¨</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div className="bg-slate-50 border border-slate-100 rounded-2xl p-5 mb-6">
                      <h3 className="font-black text-[10px] uppercase text-slate-400 mb-3 tracking-widest">Paiements & Solde</h3>
                      <div className="space-y-2 mb-4">
                        <div className="flex justify-between items-center text-xs">
                            <span className="font-bold text-slate-600">Total TTC</span>
                            <span className="font-bold">{totals.ttc.toFixed(2)} ‚Ç¨</span>
                        </div>
                        {paymentSchedule.filter(p => p.paid).map(p => (
                          <div key={p.id} className="flex justify-between items-center text-xs text-emerald-600">
                              <span className="font-medium flex items-center gap-1"><Check size={12}/> {p.label} (Re√ßu)</span>
                              <span className="font-bold">- {(totals.ttc * p.percentage / 100).toFixed(2)} ‚Ç¨</span>
                          </div>
                        ))}
                      </div>
                      <div className="flex justify-between items-center pt-3 border-t border-slate-200">
                          <span className="font-black text-sm uppercase text-slate-900">Net √† payer</span>
                          <span className="font-black text-xl text-slate-900">{(totals.ttc - paidAmount).toFixed(2)} ‚Ç¨</span>
                      </div>
                    </div>
                  )}

                  {/* Bank Info Footer (Invoice Only) */}
                  {documentType === 'invoice' && (
                      <div className="text-[9px] text-slate-400 border-t pt-4 mt-auto">
                        <div className="grid grid-cols-3 gap-4">
                          <div>
                            <span className="font-bold block uppercase mb-0.5">Banque</span>
                            {businessConfig.bankName}
                          </div>
                          <div>
                            <span className="font-bold block uppercase mb-0.5">IBAN</span>
                            <span className="font-mono">{businessConfig.iban}</span>
                          </div>
                          <div>
                            <span className="font-bold block uppercase mb-0.5">BIC</span>
                            <span className="font-mono">{businessConfig.bic}</span>
                          </div>
                        </div>
                      </div>
                  )}
                </>
              )}
              
              <div className="flex gap-3 mt-8 no-print">
                <button onClick={() => window.print()} className="flex-1 py-3 rounded-xl bg-slate-900 text-white font-bold flex items-center justify-center gap-2 hover:bg-slate-800 transition-colors"><Printer size={16}/> Imprimer / PDF</button>
                <button onClick={() => setShowInvoicePreview(false)} className="flex-1 py-3 rounded-xl border-2 border-slate-200 font-bold hover:bg-slate-50 transition-colors">Fermer</button>
              </div>
            </div>
          ) : activeTab === 'details' ? (
            /* ---- DETAILS TAB (RESTORED & MERGED) ---- */
            <>
              {/* 1. Main Info Grid */}
              <div className="grid grid-cols-2 gap-3">
                <div className={`p-5 rounded-[28px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50/50 border-slate-100'}`}>
                  <div className="flex items-center gap-2 text-slate-400 mb-2">
                    <Calendar size={14} />
                    <span className="text-[9px] font-black uppercase tracking-widest">P√©riode</span>
                  </div>
                  <p className="text-sm font-black leading-tight">Du {new Date(group.startDate).toLocaleDateString('fr-FR')}</p>
                  <p className="text-sm font-black leading-tight">Au {new Date(group.endDate).toLocaleDateString('fr-FR')}</p>
                  <div className="mt-2 px-2 py-0.5 rounded-lg bg-indigo-100 text-indigo-700 text-[8px] font-black inline-block uppercase">{group.nights} Nuits</div>
                </div>
                <div className={`p-5 rounded-[28px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50/50 border-slate-100'}`}>
                  <div className="flex items-center gap-2 text-slate-400 mb-2">
                    <Users size={14} />
                    <span className="text-[9px] font-black uppercase tracking-widest">Effectif</span>
                  </div>
                  <input 
                    type="number"
                    value={localPax}
                    onChange={(e) => setLocalPax(parseInt(e.target.value) || 0)}
                    className={`text-4xl font-black w-full bg-transparent outline-none ${userSettings.darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}
                  />
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1 block">Pax total</span>
                </div>
              </div>

              {/* 2. Accommodation & Rooms (Editable Inputs) */}
              <div className="space-y-3">
                <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">H√©bergement</h4>
                <div className={`p-4 rounded-[28px] border grid grid-cols-2 gap-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                  {[
                    { key: 'single', label: 'Single', icon: BedSingle },
                    { key: 'twin', label: 'Twin', icon: BedDouble },
                    { key: 'double', label: 'Double', icon: BedDouble },
                    { key: 'family', label: 'Family', icon: Home }
                  ].map(r => (
                    <div key={r.key} className="flex justify-between items-center p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700">
                      <div className="flex items-center gap-2">
                         <r.icon size={14} className="text-indigo-400" />
                         <span className="text-xs font-bold text-slate-500">{r.label}</span>
                      </div>
                      <input 
                        type="number"
                        value={localRooms[r.key as keyof GroupRooms]}
                        onChange={(e) => handleRoomChange(r.key as keyof GroupRooms, e.target.value)}
                        className="w-12 bg-transparent text-right outline-none font-black text-lg"
                      />
                    </div>
                  ))}
                </div>
              </div>

              {/* 3. Prestations (Options) - RESTORED */}
              {renderOptions()}

              {/* 4. Notes */}
              <div className="space-y-3">
                <div className={`p-6 rounded-[28px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-indigo-50/20 border-indigo-50'}`}>
                  <div className="flex items-center gap-2 text-slate-400 mb-3">
                    <FileText size={14} />
                    <span className="text-[10px] font-black uppercase tracking-widest">Observations</span>
                  </div>
                  <p className="text-sm font-bold leading-relaxed text-slate-800 dark:text-slate-200">
                    {group.note || 'Pas d\'observation particuli√®re.'}
                  </p>
                </div>
              </div>

              {/* Actions Footer Details Tab */}
              <button onClick={handleSave} className={`w-full py-4 rounded-2xl text-white font-black text-xs uppercase tracking-widest shadow-lg ${themeBg}`}>
                 Sauvegarder modifications
              </button>

              {/* 5. Revenue Manager Communication - RESTORED & ENHANCED */}
              <div className="pt-2 pb-6 space-y-4 border-t border-slate-100 dark:border-slate-800 mt-4">
                 <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Revenue Management (RM)</h4>
                 
                 {/* RM Contact Card */}
                 <div className={`p-4 rounded-[28px] border flex items-center justify-between ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                    <div className="flex items-center gap-3">
                       <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${rmContact?.color || 'bg-slate-200 text-slate-600'}`}>
                          {rmContact ? rmContact.initials : <User size={20} />}
                       </div>
                       <div>
                          <p className="text-sm font-bold">{rmContact?.name || 'Non assign√©'}</p>
                          <p className="text-[10px] text-slate-400 font-medium">Responsable dossier</p>
                       </div>
                    </div>
                    {rmContact && (
                      <div className="flex gap-2">
                        <a href={`mailto:${rmContact.email}`} className="p-2 rounded-xl bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300"><Mail size={16} /></a>
                        <a href={`tel:${rmContact.phone}`} className="p-2 rounded-xl bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-300"><Phone size={16} /></a>
                      </div>
                    )}
                 </div>

                 {/* Quote Generator */}
                 {isSmsEditing ? (
                  <div className="space-y-3 animate-in fade-in">
                    <textarea 
                      value={smsMessage}
                      onChange={(e) => setSmsMessage(e.target.value)}
                      className={`w-full p-5 rounded-[28px] border font-bold text-sm h-40 resize-none leading-relaxed shadow-lg ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-800'}`}
                    />
                    <div className="flex gap-2">
                      <button onClick={() => setIsSmsEditing(false)} className="flex-1 py-4 rounded-2xl font-black text-xs bg-slate-100 dark:bg-slate-800 text-slate-400">Annuler</button>
                      <button onClick={handleSendSMS} className={`flex-[2] py-4 rounded-2xl text-white font-black text-xs shadow-xl flex items-center justify-center gap-2 ${themeBg}`}>
                        <Check size={18}/> Envoyer SMS
                      </button>
                    </div>
                  </div>
                ) : (
                  <button 
                    onClick={() => setIsSmsEditing(true)}
                    className={`w-full py-5 rounded-[24px] text-white font-black uppercase text-xs tracking-widest shadow-xl flex items-center justify-center gap-3 transition-transform active:scale-95 bg-slate-900`}
                  >
                    <MessageSquare size={20}/> G√©n√©rer message cotation
                  </button>
                )}
              </div>
            </>
          ) : (
            /* ---- BILLING TAB ---- */
            <div className="space-y-8 pb-10">
              
              {/* Products Table */}
              <div className="space-y-3">
                <div className="flex justify-between items-center px-1">
                   <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Produits & Services</h4>
                   <button onClick={addItem} className="text-indigo-500 flex items-center gap-1 text-[10px] font-black uppercase"><Plus size={12}/> Ajouter ligne</button>
                </div>
                
                <div className="space-y-4">
                  {invoiceItems.map(item => {
                    const conflictMessage = checkConflict(item);
                    return (
                    <div key={item.id} className={`p-4 rounded-2xl border flex flex-col gap-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                      
                      <div className="flex flex-col md:flex-row gap-3">
                        {/* Catalog Selector */}
                        <select 
                          value={item.catalogId || ''} 
                          onChange={(e) => handleCatalogSelection(item.id, e.target.value)}
                          className="bg-slate-50 dark:bg-slate-700 rounded-xl text-xs font-bold p-3 outline-none md:w-48 truncate border border-transparent focus:border-indigo-500 transition-all"
                        >
                           <option value="">-- S√©lectionner Article --</option>
                           {catalog.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>

                        <input 
                          type="text" 
                          value={item.description} 
                          onChange={(e) => updateItem(item.id, 'description', e.target.value)}
                          placeholder="Description de la prestation..."
                          className="bg-transparent font-bold text-sm outline-none flex-1 w-full border-b border-slate-200 dark:border-slate-700 pb-1 focus:border-indigo-500 transition-all"
                        />
                      </div>

                      {/* Operational Details Row */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                         <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700/50 rounded-xl px-3 py-2">
                            <Calendar size={14} className="text-slate-400"/>
                            <input 
                              type="date" 
                              value={item.date || ''} 
                              onChange={(e) => updateItem(item.id, 'date', e.target.value)}
                              className="bg-transparent text-xs font-bold outline-none w-full"
                            />
                         </div>
                         <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700/50 rounded-xl px-3 py-2">
                            <Clock size={14} className="text-slate-400"/>
                            <div className="flex items-center w-full">
                              <input 
                                type="time" 
                                value={item.time || ''} 
                                onChange={(e) => updateItem(item.id, 'time', e.target.value)}
                                className="bg-transparent text-xs font-bold outline-none w-10 text-center"
                              />
                              <span className="text-[10px] text-slate-400 mx-1">-</span>
                              <input 
                                type="time" 
                                value={item.endTime || ''} 
                                onChange={(e) => updateItem(item.id, 'endTime', e.target.value)}
                                className="bg-transparent text-xs font-bold outline-none w-10 text-center"
                              />
                            </div>
                         </div>
                         <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700/50 rounded-xl px-3 py-2 md:col-span-2 relative">
                            <MapPin size={14} className="text-slate-400"/>
                            {/* Venue Selector */}
                            <input 
                              list={`venues-${item.id}`}
                              type="text" 
                              placeholder="Lieu (ex: Salon Pascaline)"
                              value={item.location || ''} 
                              onChange={(e) => updateItem(item.id, 'location', e.target.value)}
                              className="bg-transparent text-xs font-bold outline-none w-full"
                            />
                            <datalist id={`venues-${item.id}`}>
                              {venues.map(v => <option key={v.id} value={v.name} />)}
                            </datalist>
                         </div>
                      </div>

                      {/* Conflict Alert */}
                      {conflictMessage && (
                        <div className="flex items-center gap-2 px-3 py-2 rounded-xl bg-orange-50 text-orange-600 text-[10px] font-bold border border-orange-100 animate-in fade-in">
                          <AlertTriangle size={14} />
                          {conflictMessage}
                        </div>
                      )}

                      {/* Comment/Setup Row */}
                      <div className="flex gap-3">
                         <div className="flex-1 bg-slate-50 dark:bg-slate-700/50 rounded-xl px-3 py-2 flex items-start gap-2">
                            <ClipboardList size={14} className="text-slate-400 mt-0.5 shrink-0"/>
                            <textarea 
                              placeholder="Setup technique, notes √©quipes..."
                              value={item.setup || ''} 
                              onChange={(e) => updateItem(item.id, 'setup', e.target.value)}
                              className="bg-transparent text-xs font-medium outline-none w-full resize-none h-auto bg-transparent"
                              rows={1}
                            />
                         </div>
                      </div>

                      {/* Financial Row */}
                      <div className="flex gap-2 items-center justify-end border-t border-slate-50 dark:border-slate-700 pt-2 mt-1">
                        <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5">
                           <span className="text-[9px] uppercase text-slate-400">Qt√©</span>
                           <input 
                            type="number" 
                            value={item.quantity} 
                            onChange={(e) => updateItem(item.id, 'quantity', parseFloat(e.target.value) || 0)}
                            className="w-12 bg-transparent text-center font-bold outline-none text-xs"
                           />
                        </div>
                        <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5">
                           <span className="text-[9px] uppercase text-slate-400">Prix HT</span>
                           <input 
                            type="number" 
                            value={item.unitPrice} 
                            onChange={(e) => updateItem(item.id, 'unitPrice', parseFloat(e.target.value) || 0)}
                            className="w-16 bg-transparent text-center font-bold outline-none text-xs"
                           />
                        </div>
                        <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5">
                           <span className="text-[9px] uppercase text-slate-400">TVA%</span>
                           <input 
                            type="number" 
                            value={item.vatRate} 
                            onChange={(e) => updateItem(item.id, 'vatRate', parseFloat(e.target.value) || 0)}
                            className="w-10 bg-transparent text-center font-bold outline-none text-xs"
                           />
                        </div>
                        <button onClick={() => removeItem(item.id)} className="p-2 text-slate-300 hover:text-red-500 ml-2"><Trash2 size={16}/></button>
                      </div>
                    </div>
                  );})}
                  {invoiceItems.length === 0 && (
                    <div className="text-center py-6 border-2 border-dashed rounded-2xl border-slate-200">
                      <p className="text-xs text-slate-400 font-bold">Aucun article factur√©</p>
                    </div>
                  )}
                </div>

                {/* Summary */}
                {invoiceItems.length > 0 && (
                   <div className={`p-5 rounded-[28px] border mt-4 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-indigo-50/30 border-indigo-50'}`}>
                      <div className="flex justify-between items-center mb-1">
                        <span className="text-xs font-bold text-slate-400">Total HT</span>
                        <span className="text-sm font-bold">{totals.ht.toFixed(2)} ‚Ç¨</span>
                      </div>
                      <div className="flex justify-between items-center mb-3">
                        <span className="text-xs font-bold text-slate-400">TVA</span>
                        <span className="text-sm font-bold">{totals.vat.toFixed(2)} ‚Ç¨</span>
                      </div>
                      <div className="flex justify-between items-center pt-3 border-t border-indigo-100 dark:border-slate-600">
                        <span className="text-sm font-black text-indigo-900 dark:text-indigo-300">TOTAL TTC</span>
                        <span className="text-xl font-black text-indigo-600 dark:text-indigo-400">{totals.ttc.toFixed(2)} ‚Ç¨</span>
                      </div>
                   </div>
                )}
              </div>

              {/* Payment Schedule */}
              <div className="space-y-3">
                 <div className="flex justify-between items-center px-1">
                   <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">√âch√©ancier & Acomptes</h4>
                   {paymentSchedule.length === 0 && (
                     <button onClick={generateDefaultSchedule} className="text-indigo-500 flex items-center gap-1 text-[10px] font-black uppercase"><LayoutList size={12}/> G√©n√©rer (30/50/20)</button>
                   )}
                </div>
                
                <div className="space-y-2">
                  {paymentSchedule.map(p => {
                    const amount = (totals.ttc * p.percentage / 100);
                    return (
                      <div key={p.id} className={`p-4 rounded-2xl border flex flex-col gap-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                         <div className="flex justify-between items-start">
                           <input 
                              value={p.label}
                              onChange={(e) => updateSchedule(p.id, 'label', e.target.value)}
                              className="font-bold text-xs bg-transparent outline-none flex-1"
                           />
                           <div className="flex items-center gap-2">
                              <span className="text-[10px] font-black uppercase text-slate-400">Re√ßu</span>
                              <button 
                                onClick={() => updateSchedule(p.id, 'paid', !p.paid)}
                                className={`w-5 h-5 rounded-md border flex items-center justify-center transition-colors ${p.paid ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}
                              >
                                {p.paid && <Check size={14}/>}
                              </button>
                           </div>
                         </div>
                         <div className="flex gap-2">
                            <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5 flex-1">
                               <span className="text-[9px] uppercase text-slate-400">%</span>
                               <input 
                                type="number" 
                                value={p.percentage} 
                                onChange={(e) => updateSchedule(p.id, 'percentage', parseFloat(e.target.value) || 0)}
                                className="w-10 bg-transparent text-center font-bold outline-none text-xs"
                               />
                            </div>
                             <div className="flex items-center gap-1 bg-slate-50 dark:bg-slate-700 rounded-lg px-2 py-1.5 flex-[2]">
                               <Calendar size={12} className="text-slate-400" />
                               <input 
                                type="date" 
                                value={p.dueDate} 
                                onChange={(e) => updateSchedule(p.id, 'dueDate', e.target.value)}
                                className="bg-transparent font-bold outline-none text-xs w-full"
                               />
                            </div>
                         </div>
                         <div className="text-right">
                           <span className={`text-sm font-black ${p.paid ? 'text-emerald-500 line-through' : 'text-slate-900 dark:text-white'}`}>{amount.toFixed(2)} ‚Ç¨</span>
                         </div>
                      </div>
                    );
                  })}
                </div>
                
                {paymentSchedule.length > 0 && (
                   <div className="flex justify-between items-center px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                      <span className="text-xs font-bold text-slate-500 uppercase">Reste √† payer</span>
                      <span className="font-black text-rose-500">{Math.max(0, totals.ttc - paidAmount).toFixed(2)} ‚Ç¨</span>
                   </div>
                )}
              </div>

              {/* Actions */}
              <div className="flex flex-col gap-3 pt-4">
                 <button onClick={handleSave} className={`w-full py-4 rounded-2xl text-white font-black text-xs uppercase tracking-widest shadow-lg ${themeBg}`}>
                   Sauvegarder les donn√©es
                 </button>
                 <div className="grid grid-cols-2 gap-3">
                    <button 
                      onClick={() => { setDocumentType('quote'); setShowInvoicePreview(true); }} 
                      className="py-4 rounded-2xl border-2 border-slate-900 text-slate-900 dark:border-white dark:text-white font-black text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                    >
                      <FileSpreadsheet size={16}/> G√©n√©rer Devis
                    </button>
                    <button 
                      onClick={() => { setDocumentType('invoice'); setShowInvoicePreview(true); }} 
                      className="py-4 rounded-2xl bg-slate-900 text-white font-black text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors"
                    >
                      <FileCheck size={16}/> G√©n√©rer Facture
                    </button>
                 </div>
                 <button 
                    onClick={() => { setDocumentType('functionSheet'); setShowInvoicePreview(true); }} 
                    className="w-full py-4 rounded-2xl border-2 border-indigo-600 text-indigo-600 dark:border-indigo-400 dark:text-indigo-400 font-black text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors"
                 >
                    <ClipboardList size={16}/> G√©n√©rer Fiche de Fonction (√âquipes)
                 </button>
              </div>

            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default GroupDetailModal;

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { X, Calendar, Users, MessageSquare, Moon, CheckCircle2, Clock, Building2, Search, Plus, Mail, Phone, MapPin, FileText, UserPlus, Tag } from 'lucide-react';
import { Contact, Group, UserSettings, GroupOptions, Client } from '../types';
import { GROUP_CATEGORIES } from '../constants';

interface GroupModalProps {
  isOpen: boolean;
  onClose: () => void;
  contacts: Contact[];
  onSave: (group: Group) => void;
  userSettings: UserSettings;
  editGroup?: Group | null;
  onTriggerCommunication?: (contactId: string | number, text: string) => void;
  clients?: Client[];
  onSaveClient?: (client: Client) => void;
}

const CLIENT_CATEGORIES = ['S√©minaire', 'Association', 'Loisir', 'Sportif', 'Affaires'];

const GroupModal: React.FC<GroupModalProps> = ({ isOpen, onClose, contacts, onSave, userSettings, editGroup, onTriggerCommunication, clients = [], onSaveClient }) => {
  const [name, setName] = useState('');
  const [clientId, setClientId] = useState('');
  const [clientSearch, setClientSearch] = useState('');
  const [showClientDropdown, setShowClientDropdown] = useState(false);
  
  // New Client Creation State
  const [isNewClient, setIsNewClient] = useState(false);
  const [newClientData, setNewClientData] = useState({
    email: '',
    phone: '',
    address: '',
    siret: '',
    companyName: '',
    category: ''
  });

  const [cat, setCat] = useState('S√©minaire');
  const [status, setStatus] = useState<'option' | 'confirmed'>('option');
  const [start, setStart] = useState('');
  const [end, setEnd] = useState('');
  const [pax, setPax] = useState<number>(0);
  const [rooms, setRooms] = useState({ single: 0, twin: 0, double: 0, family: 0 });
  const [options, setOptions] = useState<GroupOptions>({ je: false, demiJe: false, dinner: false, lunch: false, pause: false, roomHire: false, cocktail: false });
  const [rmContactId, setRmContactId] = useState<string | number>('');
  const [smsMessage, setSmsMessage] = useState('');
  const [isSmsEditing, setIsSmsEditing] = useState(false);

  const clientDropdownRef = useRef<HTMLDivElement>(null);

  // Calcul dynamique des nuit√©es
  const nightsCount = useMemo(() => {
    if (!start || !end) return 0;
    const d1 = new Date(start);
    const d2 = new Date(end);
    const diff = d2.getTime() - d1.getTime();
    return Math.max(0, Math.ceil(diff / (1000 * 3600 * 24)));
  }, [start, end]);

  // Filtre Clients
  const filteredClients = useMemo(() => {
    if (!clientSearch) return [];
    return clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));
  }, [clientSearch, clients]);

  // Detect if we should show new client form
  useEffect(() => {
    // If search has text but no ID selected, check if it's a new name
    if (clientSearch && !clientId) {
        const exactMatch = clients.find(c => c.name.toLowerCase() === clientSearch.toLowerCase());
        if (!exactMatch) {
            setIsNewClient(true);
        } else {
            setIsNewClient(false);
        }
    } else {
        setIsNewClient(false);
    }
  }, [clientSearch, clientId, clients]);

  useEffect(() => {
    if (editGroup && isOpen) {
      setName(editGroup.name || ''); 
      setClientId(editGroup.clientId || '');
      // Find client name for search input
      const linkedClient = clients.find(c => c.id === editGroup.clientId);
      if (linkedClient) setClientSearch(linkedClient.name);
      else setClientSearch('');

      setCat(editGroup.category || 'S√©minaire'); 
      setStatus(editGroup.status || 'option'); 
      setStart(editGroup.startDate || ''); 
      setEnd(editGroup.endDate || '');
      setPax(editGroup.pax || 0);
      setRooms(editGroup.rooms || { single: 0, twin: 0, double: 0, family: 0 }); 
      setOptions(editGroup.options || { je: false, demiJe: false, dinner: false, lunch: false, pause: false, roomHire: false, cocktail: false });
      setRmContactId(editGroup.rmContactId || '');
    } else if (!editGroup && isOpen) {
      // Reset form for new group
      setName(''); setClientId(''); setClientSearch(''); setCat('S√©minaire'); setStatus('option'); setStart(''); setEnd(''); setPax(0);
      setRooms({ single: 0, twin: 0, double: 0, family: 0 });
      setOptions({ je: false, demiJe: false, dinner: false, lunch: false, pause: false, roomHire: false, cocktail: false }); setRmContactId('');
      setNewClientData({ email: '', phone: '', address: '', siret: '', companyName: '', category: '' });
      setIsNewClient(false);
    }
    setIsSmsEditing(false);
    setShowClientDropdown(false);
  }, [editGroup, isOpen, clients]);

  const handleSelectClient = (client: Client) => {
    setClientId(client.id);
    setClientSearch(client.name);
    // Auto-fill group name if empty
    if (!name) setName(`S√©minaire ${client.name}`);
    setShowClientDropdown(false);
    setIsNewClient(false);
  };

  // Fermer dropdown au click outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (clientDropdownRef.current && !clientDropdownRef.current.contains(event.target as Node)) {
        setShowClientDropdown(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // G√©n√©ration automatique du message SMS
  useEffect(() => {
    if (rmContactId && !isSmsEditing && isOpen) {
      const c = contacts.find(con => con.id.toString() === rmContactId.toString());
      const startDateFmt = start ? new Date(start).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '...';
      const endDateFmt = end ? new Date(end).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '...';
      
      const prestations = [];
      if (options.je) prestations.push("JE");
      if (options.demiJe) prestations.push("1/2 JE");
      if (options.lunch) prestations.push("D√©jeuner");
      if (options.dinner) prestations.push("D√Æner");
      if (options.pause) prestations.push("Pause");
      if (options.roomHire) prestations.push("Loc. Salle");
      if (options.cocktail) prestations.push("Cocktail");

      const roomDetails = [];
      if (rooms.single > 0) roomDetails.push(`SGL:${rooms.single}`);
      if (rooms.twin > 0) roomDetails.push(`TWN:${rooms.twin}`);
      if (rooms.double > 0) roomDetails.push(`DBL:${rooms.double}`);
      if (rooms.family > 0) roomDetails.push(`FAM:${rooms.family}`);

      const message = `Bonjour ${c?.name || ''}, demande de cotation pour "${name || 'Groupe'}" (${status.toUpperCase()})
üìÖ Dates : ${startDateFmt} au ${endDateFmt} (${nightsCount} nuits)
üë• PAX : ${pax}
üõè Chambres : ${roomDetails.length > 0 ? roomDetails.join(" / ") : "√Ä d√©finir"}
üìå Prestations : ${prestations.length > 0 ? prestations.join(", ") : "H√©bergement seul"}
Merci !`;

      setSmsMessage(message);
    }
  }, [name, start, end, nightsCount, pax, rooms, options, status, rmContactId, contacts, isSmsEditing, isOpen]);

  const handleSave = () => {
    console.log("Tentative de sauvegarde du groupe...");
    // 1. Validation
    if (!name) { 
      alert("Le nom du groupe est requis."); 
      return; 
    }
    if (!start || !end) { 
      alert("Veuillez s√©lectionner les dates d'arriv√©e et de d√©part."); 
      return; 
    }

    let finalClientId = clientId;

    // 2. Client Creation Logic
    // If we are in "New Client" mode (search term exists, no ID selected)
    if (isNewClient && clientSearch && onSaveClient) {
      console.log("Cr√©ation nouveau client:", clientSearch);
      const newId = `cl-${Date.now()}`;
      const newClient: Client = {
        id: newId,
        name: clientSearch, // Use the search term as name
        type: 'Entreprise', // Default
        email: newClientData.email,
        phone: newClientData.phone,
        address: newClientData.address,
        siret: newClientData.siret,
        companyName: newClientData.companyName,
        category: newClientData.category,
        vat: '', 
        notes: 'Cr√©√© via Nouveau Groupe',
        createdAt: new Date().toISOString()
      };
      
      // Save to global client DB
      onSaveClient(newClient);
      finalClientId = newId;
    }

    // 3. Construct Group Object
    const newGroup: Group = {
      id: editGroup ? editGroup.id : Date.now(),
      name, 
      clientId: finalClientId, 
      category: cat, 
      status, 
      startDate: start, 
      endDate: end,
      nights: nightsCount, 
      pax: pax, 
      rooms, 
      options, 
      note: editGroup?.note || '', 
      rmContactId,
      // Initialize billing arrays if new to ensure invoicing tab works immediately
      invoiceItems: editGroup?.invoiceItems || [], 
      paymentSchedule: editGroup?.paymentSchedule || [],
      createdAt: editGroup?.createdAt || new Date().toISOString()
    };

    console.log("Groupe pr√™t √† √™tre sauvegard√©:", newGroup);
    
    // 4. Trigger Save in App.tsx
    onSave(newGroup);
    
    // 5. Close Modal (redirection handled in App.tsx)
    onClose();
  };

  if (!isOpen) return null;

  const themeHex = `text-${userSettings.themeColor}-600`;

  return (
    <div className={`fixed inset-0 z-[110] bg-black/60 flex items-end animate-in fade-in backdrop-blur-sm overflow-hidden ${userSettings.darkMode ? 'dark' : ''}`}>
      <div className={`w-full rounded-t-[40px] p-6 pb-10 animate-in slide-in-from-bottom-20 max-h-[95%] flex flex-col ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        <div className="flex justify-between items-center mb-6 px-2">
          <h3 className="text-xl font-black uppercase tracking-tight">{editGroup ? 'Modifier Groupe' : 'Nouveau Groupe'}</h3>
          <button onClick={onClose} className="p-2.5 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400"><X size={20}/></button>
        </div>

        <div className="flex-1 overflow-y-auto no-scrollbar space-y-7 px-2 pt-2 pb-10">
          
          {/* Section Client & Nom */}
          <div className="space-y-4">
            
            {/* Client Search */}
            <div className="relative z-50" ref={clientDropdownRef}>
               <label className="text-[10px] font-black uppercase text-slate-400 block mb-1">Client / Compte</label>
               <div className={`flex items-center gap-2 p-4 rounded-2xl border-2 transition-colors shadow-sm ${isNewClient ? 'bg-indigo-50 dark:bg-indigo-900/10 border-indigo-200 dark:border-indigo-800' : 'bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`}>
                  {isNewClient ? <UserPlus size={18} className="text-indigo-500"/> : <Building2 size={18} className="text-slate-400"/>}
                  <input 
                    type="text" 
                    placeholder="Rechercher ou cr√©er client..." 
                    value={clientSearch} 
                    onChange={(e) => { 
                      setClientSearch(e.target.value); 
                      setShowClientDropdown(true); 
                      setClientId(''); 
                      // If typing, auto-fill group name if it was empty or matched previous client
                      if (!name || name.startsWith('S√©minaire')) {
                         setName(e.target.value ? `S√©minaire ${e.target.value}` : '');
                      }
                    }}
                    onFocus={() => setShowClientDropdown(true)}
                    className="w-full bg-transparent outline-none font-bold text-sm dark:text-white"
                  />
                  {isNewClient && <span className="text-[9px] bg-indigo-500 text-white px-2 py-1 rounded font-bold uppercase animate-in fade-in">Nouveau</span>}
               </div>
               
               {/* Dropdown Suggestions */}
               {showClientDropdown && clientSearch && filteredClients.length > 0 && !clientId && (
                 <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden max-h-48 overflow-y-auto z-[60]">
                    {filteredClients.map(client => (
                      <div 
                        key={client.id}
                        onClick={() => handleSelectClient(client)}
                        className="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex justify-between items-center"
                      >
                         <span className="font-bold text-sm">{client.name}</span>
                         <span className="text-[9px] uppercase font-bold text-slate-400">{client.type}</span>
                      </div>
                    ))}
                 </div>
               )}

               {/* Inline Client Creation Form */}
               {isNewClient && (
                 <div className="mt-2 p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-2 border-dashed border-indigo-200 dark:border-indigo-900/50 space-y-3 animate-in fade-in slide-in-from-top-2">
                    <p className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mb-1">Cr√©ation Fiche Client Rapide</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                       <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                          <Mail size={14} className="text-slate-400"/>
                          <input 
                            type="email" 
                            placeholder="Email" 
                            value={newClientData.email}
                            onChange={(e) => setNewClientData({...newClientData, email: e.target.value})}
                            className="bg-transparent text-xs font-bold w-full outline-none"
                          />
                       </div>
                       <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                          <Phone size={14} className="text-slate-400"/>
                          <input 
                            type="tel" 
                            placeholder="T√©l√©phone" 
                            value={newClientData.phone}
                            onChange={(e) => setNewClientData({...newClientData, phone: e.target.value})}
                            className="bg-transparent text-xs font-bold w-full outline-none"
                          />
                       </div>
                    </div>
                    <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                       <MapPin size={14} className="text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="Adresse compl√®te" 
                         value={newClientData.address}
                         onChange={(e) => setNewClientData({...newClientData, address: e.target.value})}
                         className="bg-transparent text-xs font-bold w-full outline-none"
                       />
                    </div>
                    
                    {/* Nouveaux Champs : SIRET, Entreprise, Cat√©gorie */}
                    <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                       <FileText size={14} className="text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="SIRET (Optionnel)" 
                         value={newClientData.siret}
                         onChange={(e) => setNewClientData({...newClientData, siret: e.target.value})}
                         className="bg-transparent text-xs font-bold w-full outline-none"
                       />
                    </div>
                    <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                       <Building2 size={14} className="text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="Nom de l'entreprise (Optionnel)" 
                         value={newClientData.companyName}
                         onChange={(e) => setNewClientData({...newClientData, companyName: e.target.value})}
                         className="bg-transparent text-xs font-bold w-full outline-none"
                       />
                    </div>
                    <div className="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                       <Tag size={14} className="text-slate-400"/>
                       <select 
                         value={newClientData.category}
                         onChange={(e) => setNewClientData({...newClientData, category: e.target.value})}
                         className="bg-transparent text-xs font-bold w-full outline-none dark:text-white"
                       >
                         <option value="">S√©lectionner Cat√©gorie Client...</option>
                         {CLIENT_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                       </select>
                    </div>
                 </div>
               )}
            </div>

            <div className="p-4 rounded-2xl border-2 bg-slate-50 dark:bg-slate-800 border-transparent hover:border-indigo-400 transition-colors shadow-sm">
              <label className="text-[10px] font-black uppercase text-slate-400 block mb-1">Nom du Dossier (Groupe)</label>
              <input type="text" placeholder="Ex: S√©minaire L'Or√©al" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-transparent outline-none font-bold text-lg dark:text-white" />
            </div>

            <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-2xl">
              <button 
                onClick={() => setStatus('option')} 
                className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2 transition-all ${status === 'option' ? 'bg-amber-400 text-white shadow-md' : 'text-slate-400'}`}
              >
                <Clock size={14} /> Option
              </button>
              <button 
                onClick={() => setStatus('confirmed')} 
                className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2 transition-all ${status === 'confirmed' ? 'bg-emerald-500 text-white shadow-md' : 'text-slate-400'}`}
              >
                <CheckCircle2 size={14} /> Confirm√©
              </button>
            </div>
          </div>

          {/* Cat√©gories */}
          <div className="space-y-2">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Type de groupe</label>
            <div className="flex flex-wrap gap-2">
              {GROUP_CATEGORIES.map(category => (
                <button 
                  key={category}
                  onClick={() => setCat(category)}
                  className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase border-2 transition-all ${cat === category ? 'border-indigo-600 bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30' : 'border-slate-50 dark:border-slate-800 text-slate-400'}`}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>

          {/* Dates Fix: Overlay Method */}
          <div className="space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 relative z-10">
              {/* Arriv√©e */}
              <div className="relative h-[80px]">
                <div className="absolute inset-0 p-5 rounded-3xl bg-slate-50 dark:bg-slate-800 border-2 border-transparent hover:border-indigo-400 transition-all shadow-sm flex flex-col gap-1">
                   <div className="flex items-center gap-2">
                     <Calendar size={14} className="text-indigo-500" />
                     <label className="text-[10px] font-black uppercase text-slate-400">Arriv√©e</label>
                   </div>
                   <span className="font-black text-xs dark:text-white mt-1">
                      {start ? new Date(start).toLocaleDateString('fr-FR') : 'D√©finir'}
                   </span>
                </div>
                <input 
                  type="date" 
                  value={start} 
                  onChange={(e) => setStart(e.target.value)} 
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                />
              </div>

              {/* D√©part */}
              <div className="relative h-[80px]">
                <div className="absolute inset-0 p-5 rounded-3xl bg-slate-50 dark:bg-slate-800 border-2 border-transparent hover:border-indigo-400 transition-all shadow-sm flex flex-col gap-1">
                   <div className="flex items-center gap-2">
                     <Calendar size={14} className="text-indigo-500" />
                     <label className="text-[10px] font-black uppercase text-slate-400">D√©part</label>
                   </div>
                   <span className="font-black text-xs dark:text-white mt-1">
                      {end ? new Date(end).toLocaleDateString('fr-FR') : 'D√©finir'}
                   </span>
                </div>
                <input 
                  type="date" 
                  value={end} 
                  onChange={(e) => setEnd(e.target.value)} 
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                />
              </div>
            </div>

            {/* Badge Nuit√©es */}
            {nightsCount > 0 && (
              <div className="flex justify-center -mt-6 relative z-20">
                <div className="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-5 py-2 rounded-full text-[10px] font-black shadow-xl border-4 border-white dark:border-slate-900 flex items-center gap-2 animate-in zoom-in">
                  <Moon size={12} fill="currentColor" /> {nightsCount} {nightsCount > 1 ? 'NUITS' : 'NUIT'}
                </div>
              </div>
            )}
          </div>

          {/* Nombre de PAX (Saisie manuelle) */}
          <div className="space-y-2">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Effectif du groupe</label>
            <div className="p-4 rounded-3xl bg-slate-50 dark:bg-slate-800 border-2 border-transparent hover:border-indigo-400 transition-all shadow-sm flex items-center gap-4">
              <div className="p-3 rounded-2xl bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30">
                <Users size={20} />
              </div>
              <div className="flex-1">
                <label className="text-[9px] font-black uppercase text-slate-400 block mb-0.5">Nombre total de PAX</label>
                <input 
                  type="number" 
                  placeholder="Ex: 25" 
                  value={pax || ''} 
                  onChange={(e) => setPax(parseInt(e.target.value) || 0)}
                  className="w-full bg-transparent outline-none font-black text-xl dark:text-white"
                />
              </div>
            </div>
          </div>

          {/* R√©partition Chambres */}
          <div className="space-y-3">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">R√©partition (Allotement)</label>
            <div className="grid grid-cols-4 gap-2">
              {(['single', 'twin', 'double', 'family'] as const).map(k => (
                <div key={k} className="p-4 rounded-3xl bg-slate-50 dark:bg-slate-800 text-center border-2 border-transparent focus-within:border-indigo-500 transition-all shadow-sm">
                  <label className="text-[9px] font-black uppercase text-slate-400 block mb-1">{k}</label>
                  <input 
                    type="number" 
                    placeholder="0"
                    value={rooms[k] || ''} 
                    onChange={(e) => setRooms({...rooms, [k]: parseInt(e.target.value) || 0})} 
                    className="w-full bg-transparent text-center outline-none font-black dark:text-white text-lg" 
                  />
                </div>
              ))}
            </div>
          </div>

          {/* Prestations */}
          <div className="space-y-3">
             <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Prestations incluses</label>
             <div className="flex flex-wrap gap-2">
               {Object.keys(options).map(o => (
                 <button 
                  key={o} 
                  type="button"
                  onClick={() => setOptions({...options, [o as keyof GroupOptions]: !options[o as keyof GroupOptions]})} 
                  className={`px-4 py-2.5 rounded-2xl text-[10px] font-black uppercase border-2 transition-all ${options[o as keyof GroupOptions] ? 'border-indigo-600 bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'border-slate-50 dark:border-slate-800 text-slate-400 shadow-sm'}`}
                 >
                   {o === 'demiJe' ? '1/2 JE' : o === 'roomHire' ? 'Loc. Salle' : o}
                 </button>
               ))}
             </div>
          </div>

          {/* SMS RM */}
          <div className="space-y-3 pt-6 border-t border-slate-100 dark:border-slate-800">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Revenue Manager (RM)</label>
            <select value={rmContactId} onChange={(e) => setRmContactId(e.target.value)} className="w-full p-5 rounded-3xl bg-slate-50 dark:bg-slate-800 font-bold text-sm dark:text-white border-none outline-none shadow-sm appearance-none">
              <option value="">S√©lectionner un contact...</option>
              {contacts.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
            {rmContactId && (
              <div className="mt-4 space-y-4 animate-in fade-in slide-in-from-top-4">
                <div className="flex justify-between items-center px-1">
                   <span className="text-[10px] font-black uppercase text-slate-400">Message de Cotation</span>
                   <button type="button" onClick={() => setIsSmsEditing(!isSmsEditing)} className={`text-[10px] font-black uppercase underline ${themeHex}`}>{isSmsEditing ? 'Enregistrer' : 'Modifier'}</button>
                </div>
                
                {isSmsEditing ? 
                  <textarea 
                    value={smsMessage} 
                    onChange={(e) => setSmsMessage(e.target.value)} 
                    className="w-full p-5 rounded-3xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 font-bold text-xs h-48 outline-none dark:text-white shadow-inner leading-relaxed" 
                  /> :
                  <div className="p-6 rounded-3xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700/50 shadow-sm">
                    <pre className="whitespace-pre-wrap font-sans text-[11px] font-bold italic text-slate-500 dark:text-slate-400 leading-relaxed">
                      {smsMessage}
                    </pre>
                  </div>
                }
                
                <button 
                  type="button" 
                  onClick={() => {
                    const c = contacts.find(con => con.id.toString() === rmContactId.toString());
                    if (c) {
                      if (onTriggerCommunication) onTriggerCommunication(c.id, smsMessage);
                      window.open(`sms:${c.phone}?body=${encodeURIComponent(smsMessage)}`);
                    }
                  }} 
                  className="w-full py-5 rounded-[28px] bg-slate-900 text-white font-black text-xs uppercase tracking-widest flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all"
                >
                  <MessageSquare size={18}/> Envoyer au RM par SMS
                </button>
              </div>
            )}
          </div>
        </div>

        <div className="px-2 pt-6">
          <button onClick={handleSave} className="w-full py-6 rounded-[32px] bg-indigo-600 text-white font-black uppercase tracking-[0.2em] shadow-xl active:scale-[0.98] transition-all hover:bg-indigo-700">Enregistrer le groupe</button>
        </div>
      </div>
    </div>
  );
};

export default GroupModal;

import React, { useState, useMemo } from 'react';
import { 
  Plus, Users, Calendar, Briefcase, 
  Trash2, AlertTriangle, AlertCircle, Clock,
  ChevronRight, ArrowUpRight, Settings, Cog, MapPin, Mail, Bell, CheckCircle2, Wallet,
  Utensils
} from 'lucide-react';
import { Group, UserSettings, Contact, Venue } from '../types';
import VenueCalendarModal from './VenueCalendarModal';

interface GroupsViewProps {
  groups: Group[];
  userSettings: UserSettings;
  contacts: Contact[];
  onAdd: () => void;
  onEdit: (group: Group) => void;
  onGroupClick: (group: Group) => void;
  onDelete: (id: string | number) => void;
  onOpenBusinessConfig: () => void;
  venues?: Venue[];
}

const GroupsView: React.FC<GroupsViewProps> = ({ groups, userSettings, contacts, onAdd, onEdit, onGroupClick, onDelete, onOpenBusinessConfig, venues = [] }) => {
  const themeColor = userSettings.themeColor;
  const [showVenueCalendar, setShowVenueCalendar] = useState(false);

  // --- LOGIC: Notifications & Alerts ---
  
  // 1. Weekly Planning (Next 7 days)
  const upcomingGroups = useMemo(() => {
    const today = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    
    return groups.filter(g => {
      const start = new Date(g.startDate);
      return start >= today && start <= nextWeek;
    }).sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());
  }, [groups]);

  const upcomingPayments = useMemo(() => {
    const today = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    const alerts: { groupName: string, amount: string, label: string, date: string }[] = [];

    groups.forEach(g => {
      if (g.paymentSchedule) {
        g.paymentSchedule.forEach(p => {
          if (!p.paid) {
            const due = new Date(p.dueDate);
            if (due >= today && due <= nextWeek) {
              // Calculate amount approx
              let totalHT = 0;
              let totalVAT = 0;
              g.invoiceItems?.forEach(item => {
                const lineHT = item.quantity * item.unitPrice;
                totalHT += lineHT;
                totalVAT += lineHT * (item.vatRate / 100);
              });
              const totalTTC = totalHT + totalVAT;
              const amount = (totalTTC * p.percentage / 100).toFixed(0);

              alerts.push({
                groupName: g.name,
                amount: `${amount} ‚Ç¨`,
                label: p.label,
                date: due.toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'})
              });
            }
          }
        });
      }
    });
    return alerts;
  }, [groups]);

  // 2. Alert Logic per Group
  const getGroupAlerts = (group: Group) => {
    const alerts = [];
    const created = group.createdAt ? new Date(group.createdAt) : new Date(); // Fallback if old data
    const now = new Date();
    const daysSinceCreation = Math.floor((now.getTime() - created.getTime()) / (1000 * 3600 * 24));

    // A. Option > 10 days
    if (group.status === 'option' && daysSinceCreation > 10) {
      alerts.push({
        type: 'expired_option',
        label: `Option +${daysSinceCreation}j`,
        actionLabel: 'Relancer client',
        color: 'red',
        icon: Clock,
        emailSubject: `Relance option - ${group.name}`,
        emailBody: `Bonjour,\n\nSauf erreur de notre part, l'option pour votre groupe "${group.name}" est arriv√©e √† √©ch√©ance.\nPouvons-nous proc√©der √† la confirmation ?\n\nCordialement,`
      });
    }

    // B. Completeness (Missing Invoice Items or Payment Schedule)
    const hasInvoiceItems = group.invoiceItems && group.invoiceItems.length > 0;
    const hasPaymentSchedule = group.paymentSchedule && group.paymentSchedule.length > 0;
    
    if (!hasInvoiceItems) {
      alerts.push({
        type: 'missing_info',
        label: 'Prestations vides',
        actionLabel: 'Compl√©ter',
        color: 'orange',
        icon: AlertTriangle,
        emailSubject: `Informations manquantes - ${group.name}`,
        emailBody: `Bonjour,\n\nPour finaliser l'organisation de votre groupe "${group.name}", nous avons besoin de valider les prestations (repas, salles).\nMerci de nous revenir rapidement.\n\nCordialement,`
      });
    } else if (!hasPaymentSchedule && group.status === 'confirmed') {
       alerts.push({
        type: 'missing_payment',
        label: '√âch√©ancier manquant',
        actionLabel: 'Cr√©er',
        color: 'orange',
        icon: Wallet,
        emailSubject: `Facturation - ${group.name}`,
        emailBody: `Bonjour,\n\nNous devons mettre en place l'√©ch√©ancier pour le groupe "${group.name}".\n\nCordialement,`
      });
    }

    return alerts;
  };

  const handleEmailAction = (contactId: string | number | undefined, subject: string, body: string) => {
    if (!contactId) {
      alert("Pas de contact li√© √† ce groupe. Veuillez en assigner un dans les d√©tails.");
      return;
    }
    const contact = contacts.find(c => c.id.toString() === contactId.toString());
    if (contact && contact.email) {
      window.open(`mailto:${contact.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
    } else {
      alert("Le contact li√© n'a pas d'email valide.");
    }
  };

  return (
    <div className="px-6 py-6 space-y-8 animate-in fade-in pb-32">
      
      {/* Header */}
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-3">
          <h2 className="text-2xl font-black">RM Groupes</h2>
          <button 
            onClick={onOpenBusinessConfig}
            className={`p-2 rounded-xl text-slate-400 hover:text-${themeColor}-600 hover:bg-${themeColor}-50 transition-colors`}
            title="Configuration Business"
          >
            <Cog size={20} />
          </button>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={() => setShowVenueCalendar(true)}
            className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wide border-2 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center gap-2`}
          >
            <MapPin size={14} /> Calendrier Lieux
          </button>
          <button 
            onClick={onAdd}
            className={`p-2 rounded-xl text-white bg-${themeColor}-600 shadow-lg hover:opacity-90 active:scale-95 transition-all`}
          >
            <Plus size={20} />
          </button>
        </div>
      </div>

      {/* Planning de la semaine (Notification Module) */}
      {(upcomingGroups.length > 0 || upcomingPayments.length > 0) && (
        <div className={`p-5 rounded-[28px] border-2 border-indigo-100 dark:border-indigo-900 bg-indigo-50/50 dark:bg-indigo-900/20`}>
           <div className="flex items-center gap-2 mb-4">
             <div className="p-1.5 bg-indigo-500 rounded-lg text-white">
               <Bell size={14} /> 
             </div>
             <h3 className="text-sm font-black uppercase tracking-widest text-indigo-900 dark:text-indigo-300">√Ä faire cette semaine</h3>
           </div>
           
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Arrivals */}
              {upcomingGroups.length > 0 && (
                <div className="space-y-2">
                  <p className="text-[10px] font-bold uppercase text-slate-400">Arriv√©es imminentes</p>
                  {upcomingGroups.map(g => (
                    <div key={g.id} onClick={() => onGroupClick(g)} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-2xl cursor-pointer hover:shadow-md transition-all border border-transparent hover:border-indigo-200">
                       <div className="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center font-black text-xs">
                         {new Date(g.startDate).getDate()}
                       </div>
                       <div className="flex-1 min-w-0">
                         <p className="font-bold text-sm truncate">{g.name}</p>
                         <p className="text-[10px] text-slate-500">{g.pax} Pax ‚Ä¢ {g.category}</p>
                       </div>
                       <ArrowUpRight size={14} className="text-slate-300"/>
                    </div>
                  ))}
                </div>
              )}

              {/* Payments */}
              {upcomingPayments.length > 0 && (
                <div className="space-y-2">
                  <p className="text-[10px] font-bold uppercase text-slate-400">R√®glements attendus</p>
                  {upcomingPayments.map((p, idx) => (
                    <div key={idx} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-2xl border border-transparent">
                       <div className="w-10 h-10 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center">
                         <Wallet size={18} />
                       </div>
                       <div className="flex-1 min-w-0">
                         <div className="flex justify-between">
                            <p className="font-bold text-sm truncate">{p.groupName}</p>
                            <p className="font-black text-sm text-emerald-600">{p.amount}</p>
                         </div>
                         <p className="text-[10px] text-slate-500">{p.label} ‚Ä¢ {p.date}</p>
                       </div>
                    </div>
                  ))}
                </div>
              )}
           </div>
        </div>
      )}

      {/* Groups Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {groups.map(group => {
          const alerts = getGroupAlerts(group);
          return (
          <div 
            key={group.id} 
            onClick={() => onGroupClick(group)}
            className={`p-5 rounded-3xl border shadow-sm relative overflow-hidden cursor-pointer transition-all hover:-translate-y-1 hover:shadow-md ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
          >
            {/* Corner Status Badge */}
            <div className={`absolute top-0 right-0 px-4 py-1.5 rounded-bl-2xl text-[9px] font-black uppercase tracking-widest ${group.status === 'confirmed' ? 'bg-emerald-500 text-white' : 'bg-amber-400 text-white'}`}>
              {group.status === 'confirmed' ? 'Confirm√©' : 'Option'}
            </div>

            <div className="flex justify-between items-start mb-4 pr-16">
              <div>
                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">{group.category}</span>
                <h3 className="font-extrabold text-lg leading-tight">{group.name}</h3>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4 mb-5">
              <div className="flex items-center gap-3">
                <div className={`w-10 h-10 rounded-2xl flex items-center justify-center bg-${themeColor}-50 text-${themeColor}-600`}>
                  <Calendar size={18} />
                </div>
                <div>
                  <p className="text-[10px] font-bold text-slate-400 uppercase">Dates</p>
                  <p className="text-xs font-bold whitespace-nowrap">
                    {new Date(group.startDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'})} - {new Date(group.endDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'})}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-2xl flex items-center justify-center bg-indigo-50 text-indigo-600">
                  <Users size={18} />
                </div>
                <div>
                  <p className="text-[10px] font-bold text-slate-400 uppercase">Volume</p>
                  <p className="text-xs font-bold">{group.pax} PAX ‚Ä¢ {group.nights}N</p>
                </div>
              </div>
            </div>

            <div className={`p-4 rounded-2xl border mb-4 grid grid-cols-4 gap-2 text-center ${userSettings.darkMode ? 'bg-slate-700/30 border-slate-600' : 'bg-slate-50 border-slate-50'}`}>
              {[
                { label: 'SGL', val: group.rooms.single },
                { label: 'TWN', val: group.rooms.twin },
                { label: 'DBL', val: group.rooms.double },
                { label: 'FAM', val: group.rooms.family },
              ].map(r => (
                <div key={r.label}>
                  <p className="text-[8px] font-black text-slate-400 uppercase">{r.label}</p>
                  <p className="text-sm font-black">{r.val}</p>
                </div>
              ))}
            </div>

            {/* Alerts & Actions Section */}
            {alerts.length > 0 ? (
              <div className="space-y-2 mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                {alerts.map((alert, i) => (
                  <div key={i} className={`flex items-center justify-between p-2 rounded-xl ${alert.color === 'red' ? 'bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'}`}>
                     <div className="flex items-center gap-2">
                       <alert.icon size={14} />
                       <span className="text-[10px] font-bold uppercase">{alert.label}</span>
                     </div>
                     <button 
                       onClick={(e) => { 
                         e.stopPropagation(); 
                         if (alert.type === 'missing_info' || alert.type === 'missing_payment') {
                           onGroupClick(group); // Open details
                         } else {
                           handleEmailAction(group.rmContactId, alert.emailSubject, alert.emailBody);
                         }
                       }}
                       className="px-3 py-1 bg-white dark:bg-slate-800 rounded-lg text-[9px] font-black uppercase shadow-sm flex items-center gap-1 hover:scale-105 transition-transform"
                     >
                       {alert.type === 'expired_option' ? <Mail size={10} /> : <ArrowUpRight size={10} />}
                       {alert.actionLabel}
                     </button>
                  </div>
                ))}
              </div>
            ) : (
              <div className="flex justify-between items-center mt-2">
                <div className="flex gap-2">
                  {group.options.je && <span title="Journ√©e √âtude" className="p-1.5 rounded-lg bg-slate-100 text-slate-500"><Briefcase size={12}/></span>}
                  {group.options.dinner && <span title="D√Æner" className="p-1.5 rounded-lg bg-slate-100 text-slate-500"><Utensils size={12}/></span>}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={(e) => { e.stopPropagation(); onDelete(group.id); }} 
                    className="p-2 rounded-xl text-slate-300 hover:text-red-500 transition-colors"
                  >
                    <Trash2 size={16} />
                  </button>
                  <div className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-1 bg-${themeColor}-600 text-white shadow-sm`}>
                    D√©tails <ArrowUpRight size={12} />
                  </div>
                </div>
              </div>
            )}
          </div>
        )})}
      </div>
      
      {groups.length === 0 && (
        <div className="p-12 text-center text-slate-400 flex flex-col items-center justify-center min-h-[50vh]">
          <Briefcase size={64} className="mb-4 opacity-20" />
          <p className="text-lg font-medium">Aucun groupe r√©pertori√©.</p>
        </div>
      )}

      {/* Venue Calendar Modal */}
      <VenueCalendarModal 
        isOpen={showVenueCalendar}
        onClose={() => setShowVenueCalendar(false)}
        groups={groups}
        venues={venues}
        userSettings={userSettings}
        onGroupClick={onGroupClick}
      />
    </div>
  );
};

export default GroupsView;

import React, { useState, useRef, useMemo } from 'react';
import { 
  BedDouble, AlertTriangle, RefreshCw, Check, Camera, Plus, Trash2, Printer, 
  ArrowLeft, Shirt, FileText, Download, X, Settings, Edit3, Save, Filter, ArrowUpDown, Calendar, Loader2
} from 'lucide-react';
import { Room, LaundryIssue, UserSettings, RoomStatusHK, RoomStatusFront, LaundryType } from '../types';

interface HousekeepingViewProps {
  userSettings: UserSettings;
  rooms: Room[];
  onUpdateRooms: (rooms: Room[]) => void;
  laundryIssues: LaundryIssue[];
  onUpdateLaundry: (issues: LaundryIssue[]) => void;
  onNavigate: (tab: string) => void;
}

const LAUNDRY_TYPES: LaundryType[] = ['Drap plat', 'Housse couette', 'Taie', 'Serviette bain', 'Tapis', 'Peignoir', 'Autre'];

const HousekeepingView: React.FC<HousekeepingViewProps> = ({ 
  userSettings, rooms, onUpdateRooms, laundryIssues, onUpdateLaundry, onNavigate 
}) => {
  const [activeTab, setActiveTab] = useState<'rooms' | 'laundry'>('rooms');
  
  // --- ROOMS STATE ---
  const [isEditMode, setIsEditMode] = useState(false); // Mode √©dition global
  const [showAddRoom, setShowAddRoom] = useState(false);
  const [newRoomNumber, setNewRoomNumber] = useState('');
  
  // Rename Modal State
  const [roomToRename, setRoomToRename] = useState<Room | null>(null);
  const [renameValue, setRenameValue] = useState('');

  // --- LAUNDRY STATE ---
  const [showIssueModal, setShowIssueModal] = useState(false);
  const [issueForm, setIssueForm] = useState<{ type: LaundryType, qty: number, comment: string, photo: string | null }>({
    type: 'Drap plat', qty: 1, comment: '', photo: null
  });
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [showReportPreview, setShowReportPreview] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  // --- LAUNDRY FILTERS STATE ---
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM
  const [selectedType, setSelectedType] = useState<LaundryType | 'ALL'>('ALL');
  const [sortOrder, setSortOrder] = useState<'desc' | 'asc'>('desc');

  // --- ROOMS LOGIC ---

  const handleResetDay = () => {
    if (confirm("R√©initialiser le statut Housekeeping de toutes les chambres pour une nouvelle journ√©e ?")) {
      const resetRooms = rooms.map(r => ({
        ...r,
        statusHK: 'not_started' as RoomStatusHK,
        statusFront: 'stayover' as RoomStatusFront // Default back to stayover, reception must update departures
      }));
      onUpdateRooms(resetRooms);
    }
  };

  const cycleHKStatus = (room: Room) => {
    if (isEditMode) return; // Prevent status change in edit mode
    const nextStatus: Record<RoomStatusHK, RoomStatusHK> = {
      'not_started': 'in_progress',
      'in_progress': 'ready',
      'ready': 'not_started'
    };
    const updated = rooms.map(r => r.id === room.id ? { ...r, statusHK: nextStatus[r.statusHK] } : r);
    onUpdateRooms(updated);
  };

  const cycleFrontStatus = (room: Room) => {
    if (isEditMode) return; // Prevent status change in edit mode
    const nextStatus: Record<RoomStatusFront, RoomStatusFront> = {
      'stayover': 'departure',
      'departure': 'arrival',
      'arrival': 'vacant',
      'vacant': 'stayover'
    };
    const updated = rooms.map(r => r.id === room.id ? { ...r, statusFront: nextStatus[r.statusFront] } : r);
    onUpdateRooms(updated);
  };

  const handleAddRoom = () => {
    if (newRoomNumber) {
      const newRoom: Room = {
        id: `rm-${Date.now()}`, // Unique ID based on timestamp to avoid collision
        number: newRoomNumber,
        floor: parseInt(newRoomNumber.replace(/\D/g, '')[0]) || 1, // Try to guess floor from number
        type: 'Double', // Default
        statusFront: 'stayover',
        statusHK: 'not_started'
      };
      // Add and re-sort by room number naturally
      onUpdateRooms([...rooms, newRoom].sort((a, b) => a.number.localeCompare(b.number, undefined, { numeric: true })));
      setNewRoomNumber('');
      setShowAddRoom(false);
    }
  };

  const handleDeleteRoom = (id: string, number: string) => {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer la chambre ${number} d√©finitivement ?`)) {
      onUpdateRooms(rooms.filter(r => r.id !== id));
    }
  };

  const openRenameModal = (room: Room) => {
    setRoomToRename(room);
    setRenameValue(room.number);
  };

  const handleRenameRoom = () => {
    if (roomToRename && renameValue) {
      const updated = rooms.map(r => r.id === roomToRename.id ? { ...r, number: renameValue } : r)
                           .sort((a, b) => a.number.localeCompare(b.number, undefined, { numeric: true }));
      onUpdateRooms(updated);
      setRoomToRename(null);
      setRenameValue('');
    }
  };

  const getHKColor = (status: RoomStatusHK) => {
    switch (status) {
      case 'not_started': return 'bg-red-500 text-white border-red-600';
      case 'in_progress': return 'bg-orange-400 text-white border-orange-500';
      case 'ready': return 'bg-emerald-500 text-white border-emerald-600';
      default: return 'bg-slate-200 text-slate-500';
    }
  };

  const getFrontLabel = (status: RoomStatusFront) => {
    switch (status) {
      case 'stayover': return 'Recouche';
      case 'departure': return 'D√©part';
      case 'arrival': return 'Arriv√©e';
      case 'vacant': return 'Libre';
    }
  };

  // --- LAUNDRY LOGIC ---

  // Filtered Laundry Data
  const filteredIssues = useMemo(() => {
    return laundryIssues.filter(issue => {
      // Filter by Month
      const issueDate = new Date(issue.date);
      const issueMonth = issueDate.toISOString().slice(0, 7); // YYYY-MM
      const matchMonth = issueMonth === selectedMonth;

      // Filter by Type
      const matchType = selectedType === 'ALL' || issue.type === selectedType;

      return matchMonth && matchType;
    }).sort((a, b) => {
      const dateA = new Date(a.date).getTime();
      const dateB = new Date(b.date).getTime();
      return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });
  }, [laundryIssues, selectedMonth, selectedType, sortOrder]);

  const totalLosses = useMemo(() => filteredIssues.reduce((acc, curr) => acc + curr.quantity, 0), [filteredIssues]);

  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validation
    if (!file.type.startsWith('image/')) {
        alert("Fichier non valide. Image requise.");
        return;
    }
    if (file.size > 5 * 1024 * 1024) {
        alert("Image trop lourde (Max 5Mo).");
        return;
    }

    setIsUploading(true);

    try {
        const base64 = await new Promise<string>((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result as string);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
        setIssueForm(prev => ({ ...prev, photo: base64 }));
    } catch (error) {
        console.error("Erreur upload:", error);
        alert("Erreur lors de l'upload.");
    } finally {
        setIsUploading(false);
        if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const handleSaveIssue = () => {
    const newIssue: LaundryIssue = {
      id: `li-${Date.now()}`,
      date: new Date().toISOString(),
      type: issueForm.type,
      quantity: issueForm.qty,
      comment: issueForm.comment,
      photoUrl: issueForm.photo || undefined
    };
    onUpdateLaundry([newIssue, ...laundryIssues]);
    setShowIssueModal(false);
    setIssueForm({ type: 'Drap plat', qty: 1, comment: '', photo: null });
  };

  const deleteIssue = (id: string) => {
    if (confirm("Supprimer ce signalement ?")) {
      onUpdateLaundry(laundryIssues.filter(i => i.id !== id));
    }
  };

  const formatPeriod = (isoMonth: string) => {
    const [year, month] = isoMonth.split('-');
    const date = new Date(parseInt(year), parseInt(month) - 1);
    return date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  };

  return (
    <div className={`h-full flex flex-col overflow-hidden animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* HEADER */}
      <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="flex items-center gap-4">
            <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
              <BedDouble size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">H√©bergement</h2>
              <p className="text-xs font-bold text-slate-400">Housekeeping & Linge</p>
            </div>
         </div>
         <button 
           onClick={() => onNavigate('dashboard')}
           className="px-4 py-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 font-black text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
         >
           <ArrowLeft size={14}/> Accueil
         </button>
      </div>

      {/* TABS */}
      <div className="px-6 py-4">
         <div className="flex p-1 rounded-2xl bg-slate-200 dark:bg-slate-800 w-fit overflow-x-auto whitespace-nowrap max-w-full no-scrollbar px-2">
            <button 
              onClick={() => setActiveTab('rooms')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'rooms' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
            >
              <BedDouble size={14}/> Tableau des Chambres
            </button>
            <button 
              onClick={() => setActiveTab('laundry')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'laundry' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
            >
              <Shirt size={14}/> Linge Non-Conforme
            </button>
         </div>
      </div>

      {/* CONTENT */}
      <div className="flex-1 overflow-y-auto px-6 pb-20 no-scrollbar">
         
         {/* --- ROOMS TAB --- */}
         {activeTab === 'rooms' && (
           <div className="space-y-6 pt-4">
              <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                 <div className="flex items-center gap-2">
                    <h3 className="text-lg font-black uppercase tracking-tight flex items-center gap-2">
                      Statut √âtages
                      <span className="text-xs bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500">{rooms.length}</span>
                    </h3>
                    <button 
                      onClick={() => setIsEditMode(!isEditMode)}
                      className={`ml-2 p-2 rounded-xl border-2 transition-all ${isEditMode ? 'bg-amber-100 border-amber-300 text-amber-600 animate-pulse' : 'border-transparent text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}
                      title="G√©rer les chambres (Ajout/Suppression)"
                    >
                      <Settings size={18} />
                    </button>
                 </div>

                 <div className="flex gap-2 w-full md:w-auto">
                    {/* Add Room Button - Enhanced in Edit Mode */}
                    <button 
                      onClick={() => setShowAddRoom(!showAddRoom)} 
                      className={`flex-1 md:flex-none p-2 rounded-xl border-2 transition-colors flex items-center justify-center gap-2 ${isEditMode || showAddRoom ? 'bg-indigo-50 border-indigo-200 text-indigo-600 dark:bg-indigo-900/20 dark:border-indigo-800' : 'border-slate-200 dark:border-slate-700 text-slate-400 hover:text-violet-500 hover:border-violet-200'}`}
                    >
                       <Plus size={20}/> {isEditMode && <span className="text-xs font-bold uppercase pr-2">Ajouter Chambre</span>}
                    </button>
                    {!isEditMode && (
                      <button 
                        onClick={handleResetDay}
                        className="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold text-xs uppercase flex items-center gap-2 shadow-lg hover:bg-slate-800 transition-colors"
                      >
                        <RefreshCw size={14}/> Nouvelle Journ√©e
                      </button>
                    )}
                 </div>
              </div>

              {/* Add Room Inline */}
              {showAddRoom && (
                <div className="flex gap-2 p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl animate-in fade-in slide-in-from-top-2 border-2 border-dashed border-slate-300 dark:border-slate-700">
                   <input 
                     type="text" 
                     placeholder="N¬∞ Chambre (ex: 101)" 
                     value={newRoomNumber}
                     onChange={(e) => setNewRoomNumber(e.target.value)}
                     className="flex-1 p-2 rounded-xl bg-white dark:bg-slate-900 font-bold outline-none border-2 border-transparent focus:border-violet-500"
                     autoFocus
                   />
                   <button onClick={handleAddRoom} className="px-4 bg-violet-600 text-white rounded-xl font-bold uppercase text-xs">Ajouter</button>
                </div>
              )}

              {/* Rename Modal */}
              {roomToRename && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                   <div className={`w-full max-w-sm rounded-[32px] p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
                      <h3 className="text-lg font-black mb-4">Modifier Chambre</h3>
                      <input 
                        type="text" 
                        value={renameValue}
                        onChange={(e) => setRenameValue(e.target.value)}
                        className="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-800 font-black text-xl mb-4 border-2 border-transparent focus:border-indigo-500 outline-none"
                      />
                      <div className="flex gap-2 justify-end">
                         <button onClick={() => setRoomToRename(null)} className="px-4 py-2 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">Annuler</button>
                         <button onClick={handleRenameRoom} className="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow-lg">Enregistrer</button>
                      </div>
                   </div>
                </div>
              )}

              {/* Rooms Grid */}
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                 {rooms.map(room => (
                   <div key={room.id} className={`rounded-3xl overflow-hidden shadow-sm border-2 transition-all relative ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                      
                      {/* EDIT MODE OVERLAY ACTIONS */}
                      {isEditMode && (
                        <div className="absolute top-2 right-2 flex gap-1 z-10">
                           <button 
                             onClick={(e) => { e.stopPropagation(); openRenameModal(room); }}
                             className="p-1.5 bg-white dark:bg-slate-700 text-slate-500 hover:text-indigo-500 rounded-full shadow-sm border border-slate-100 dark:border-slate-600"
                           >
                             <Edit3 size={12}/>
                           </button>
                           <button 
                             onClick={(e) => { e.stopPropagation(); handleDeleteRoom(room.id, room.number); }}
                             className="p-1.5 bg-white dark:bg-slate-700 text-slate-500 hover:text-red-500 rounded-full shadow-sm border border-slate-100 dark:border-slate-600"
                           >
                             <Trash2 size={12}/>
                           </button>
                        </div>
                      )}

                      {/* Top: Front Desk Status */}
                      <div 
                        onClick={() => cycleFrontStatus(room)}
                        className={`p-3 text-center cursor-pointer transition-opacity border-b-2 border-dashed ${isEditMode ? 'cursor-default opacity-50' : 'hover:opacity-80'} ${userSettings.darkMode ? 'border-slate-700' : 'border-slate-100'}`}
                      >
                         <h4 className="text-2xl font-black">{room.number}</h4>
                         <span className={`text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full ${
                           room.statusFront === 'departure' ? 'bg-amber-100 text-amber-700' :
                           room.statusFront === 'arrival' ? 'bg-blue-100 text-blue-700' :
                           room.statusFront === 'vacant' ? 'bg-slate-100 text-slate-500' :
                           'bg-indigo-100 text-indigo-700'
                         }`}>
                           {getFrontLabel(room.statusFront)}
                         </span>
                      </div>

                      {/* Bottom: HK Status */}
                      <div 
                        onClick={() => cycleHKStatus(room)}
                        className={`p-4 flex items-center justify-center cursor-pointer transition-colors ${isEditMode ? 'cursor-default opacity-80' : ''} ${getHKColor(room.statusHK)}`}
                      >
                         {room.statusHK === 'ready' ? <Check size={24}/> : (
                           <span className="text-[10px] font-black uppercase tracking-widest">
                             {room.statusHK === 'in_progress' ? 'En cours' : 'Pas fait'}
                           </span>
                         )}
                      </div>
                   </div>
                 ))}
              </div>
           </div>
         )}

         {/* --- LAUNDRY TAB --- */}
         {activeTab === 'laundry' && (
           <div className="h-full flex flex-col pt-6">
              
              {/* FILTERS TOOLBAR */}
              <div className={`flex flex-col md:flex-row gap-4 justify-between items-center p-4 rounded-3xl border mb-6 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <div className="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    {/* Period Picker */}
                    <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 p-2 rounded-xl border border-slate-200 dark:border-slate-700">
                       <Calendar size={16} className="text-slate-400 ml-1"/>
                       <input 
                         type="month" 
                         value={selectedMonth}
                         onChange={(e) => setSelectedMonth(e.target.value)}
                         className="bg-transparent text-xs font-bold uppercase outline-none text-slate-700 dark:text-slate-200"
                       />
                    </div>

                    {/* Type Filter */}
                    <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 p-2 rounded-xl border border-slate-200 dark:border-slate-700">
                       <Filter size={16} className="text-slate-400 ml-1"/>
                       <select 
                         value={selectedType}
                         onChange={(e) => setSelectedType(e.target.value as LaundryType | 'ALL')}
                         className="bg-transparent text-xs font-bold outline-none uppercase text-slate-700 dark:text-slate-200 w-32 cursor-pointer"
                       >
                          <option value="ALL">Tous types</option>
                          {LAUNDRY_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                       </select>
                    </div>

                    {/* Sort Order */}
                    <button 
                      onClick={() => setSortOrder(prev => prev === 'desc' ? 'asc' : 'desc')}
                      className="p-2.5 rounded-xl bg-slate-50 dark:bg-slate-900 text-slate-500 hover:text-indigo-500 border border-slate-200 dark:border-slate-700 transition-colors"
                      title="Inverser le tri"
                    >
                       <ArrowUpDown size={16}/>
                    </button>

                    {/* Stats */}
                    <div className="flex items-center px-4 py-2 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800">
                       <span className="text-[10px] font-black uppercase text-indigo-400 mr-2">Total sur la p√©riode</span>
                       <span className="text-sm font-black text-indigo-700 dark:text-indigo-300">{totalLosses} articles</span>
                    </div>
                 </div>

                 <div className="flex gap-2 w-full md:w-auto justify-end">
                    <button 
                      onClick={() => setShowReportPreview(true)}
                      className="px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 font-bold text-xs uppercase text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center gap-2"
                    >
                        <Printer size={16}/> √âditer Rapport
                    </button>
                    <button 
                      onClick={() => setShowIssueModal(true)}
                      className="px-6 py-3 rounded-xl bg-violet-600 text-white font-bold text-xs uppercase flex items-center gap-2 shadow-lg hover:bg-violet-700 transition-colors"
                    >
                        <Plus size={16}/> Signaler Linge
                    </button>
                 </div>
              </div>

              {/* List */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 {filteredIssues.map(issue => (
                   <div key={issue.id} className={`p-4 rounded-3xl border flex gap-4 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                      {/* Thumbnail */}
                      <div className="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-900 overflow-hidden flex-shrink-0 border border-slate-200 dark:border-slate-700">
                         {issue.photoUrl ? (
                           <img src={issue.photoUrl} alt="Preuve" className="w-full h-full object-cover" />
                         ) : (
                           <div className="w-full h-full flex items-center justify-center text-slate-300">
                             <Camera size={24}/>
                           </div>
                         )}
                      </div>
                      
                      {/* Details */}
                      <div className="flex-1 min-w-0">
                         <div className="flex justify-between items-start">
                            <span className="text-[10px] font-black uppercase text-slate-400">{new Date(issue.date).toLocaleDateString()}</span>
                            <button onClick={() => deleteIssue(issue.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>
                         </div>
                         <h4 className="font-bold text-sm truncate">{issue.type}</h4>
                         <p className="text-xs text-slate-500 dark:text-slate-400 font-medium mt-1 line-clamp-2">
                           {issue.quantity}x ‚Äî {issue.comment || 'Aucun commentaire'}
                         </p>
                      </div>
                   </div>
                 ))}
                 {filteredIssues.length === 0 && (
                   <div className="col-span-full py-20 text-center opacity-40">
                      <Shirt size={48} className="mx-auto mb-4 text-slate-400"/>
                      <p className="font-bold text-slate-500">Aucun linge signal√© pour cette p√©riode.</p>
                   </div>
                 )}
              </div>
           </div>
         )}

      </div>

      {/* --- MODAL SIGNALEMENT --- */}
      {showIssueModal && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className={`w-full max-w-lg rounded-[32px] p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-xl font-black">Nouveau Signalement</h3>
                 <button onClick={() => setShowIssueModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>

              <div className="space-y-4">
                 <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1">
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Type</label>
                       <select 
                         value={issueForm.type}
                         onChange={(e) => setIssueForm({...issueForm, type: e.target.value as LaundryType})}
                         className="w-full p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none dark:text-white"
                       >
                          {LAUNDRY_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                       </select>
                    </div>
                    <div className="space-y-1">
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Quantit√©</label>
                       <input 
                         type="number"
                         min="1"
                         value={issueForm.qty}
                         onChange={(e) => setIssueForm({...issueForm, qty: parseInt(e.target.value) || 1})}
                         className="w-full p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none dark:text-white"
                       />
                    </div>
                 </div>

                 <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Commentaire</label>
                    <textarea 
                      placeholder="D√©tails (tache, d√©chirure...)"
                      value={issueForm.comment}
                      onChange={(e) => setIssueForm({...issueForm, comment: e.target.value})}
                      className="w-full p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none dark:text-white resize-none h-24"
                    />
                 </div>

                 <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Photo Preuve</label>
                    <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                    <div 
                      onClick={() => fileInputRef.current?.click()}
                      className="w-full h-32 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors overflow-hidden relative"
                    >
                       {isUploading ? (
                         <Loader2 size={24} className="text-indigo-500 animate-spin" />
                       ) : issueForm.photo ? (
                         <img src={issueForm.photo} alt="Preview" className="w-full h-full object-cover" />
                       ) : (
                         <>
                           <Camera size={24} className="text-slate-400 mb-2"/>
                           <span className="text-xs font-bold text-slate-400">Prendre / Choisir photo</span>
                         </>
                       )}
                    </div>
                 </div>

                 <button 
                   onClick={handleSaveIssue} 
                   disabled={isUploading}
                   className="w-full py-4 rounded-2xl bg-violet-600 text-white font-black uppercase text-xs tracking-widest shadow-lg mt-2 disabled:opacity-50"
                 >
                    {isUploading ? 'Traitement...' : 'Enregistrer le litige'}
                 </button>
              </div>
           </div>
        </div>
      )}

      {/* --- REPORT PRINT PREVIEW --- */}
      {showReportPreview && (
        <div className="fixed inset-0 z-[200] bg-white text-slate-900 overflow-y-auto">
           {/* Close Button (Hidden in Print) */}
           <div className="fixed top-4 right-4 z-50 no-print flex gap-2">
              <button onClick={() => window.print()} className="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><Printer size={16}/> Imprimer PDF</button>
              <button onClick={() => setShowReportPreview(false)} className="px-6 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold"><X size={16}/></button>
           </div>

           {/* Printable Content */}
           <div id="printable-content" className="max-w-3xl mx-auto p-12">
              <div className="flex justify-between items-end border-b-4 border-slate-900 pb-6 mb-10">
                 <div>
                    <h1 className="text-4xl font-black uppercase tracking-tight mb-2">Rapport de Non-Conformit√©</h1>
                    <p className="text-lg font-bold text-indigo-600 uppercase tracking-widest">{formatPeriod(selectedMonth)}</p>
                    <p className="text-sm font-medium text-slate-500 mt-1">Service Gouvernante</p>
                 </div>
                 <div className="text-right">
                    <p className="font-bold text-sm text-slate-400 uppercase">Date d'√©dition</p>
                    <p className="font-black text-xl">{new Date().toLocaleDateString()}</p>
                 </div>
              </div>

              <div className="space-y-8">
                 {filteredIssues.length > 0 ? (
                   <table className="w-full text-left border-collapse">
                      <thead>
                         <tr className="border-b-2 border-slate-200">
                            <th className="py-4 font-black uppercase text-xs text-slate-500 w-24">Date</th>
                            <th className="py-4 font-black uppercase text-xs text-slate-500 w-32">Photo</th>
                            <th className="py-4 font-black uppercase text-xs text-slate-500">Article</th>
                            <th className="py-4 font-black uppercase text-xs text-slate-500 text-center w-16">Qt√©</th>
                            <th className="py-4 font-black uppercase text-xs text-slate-500">D√©tails</th>
                         </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                         {filteredIssues.map(issue => (
                           <tr key={issue.id} className="break-inside-avoid">
                              <td className="py-4 align-top text-sm font-bold text-slate-600">{new Date(issue.date).toLocaleDateString()}</td>
                              <td className="py-4 align-top">
                                 {issue.photoUrl && (
                                   <div className="w-20 h-20 rounded-lg border border-slate-200 overflow-hidden bg-slate-50">
                                      <img src={issue.photoUrl} className="w-full h-full object-cover" alt="preuve"/>
                                   </div>
                                 )}
                              </td>
                              <td className="py-4 align-top font-black text-slate-900">{issue.type}</td>
                              {/* FORCE BLACK COLOR FOR QUANTITY IN PRINT */}
                              <td className="py-4 align-top text-center font-black text-lg text-black">{issue.quantity}</td>
                              <td className="py-4 align-top text-sm italic text-slate-600 bg-slate-50/50 rounded p-2">{issue.comment}</td>
                           </tr>
                         ))}
                      </tbody>
                   </table>
                 ) : (
                   <div className="text-center py-20 border-2 border-dashed border-slate-200 rounded-3xl">
                      <p className="font-bold text-slate-400">Aucun litige enregistr√© sur cette p√©riode.</p>
                   </div>
                 )}
              </div>

              <div className="mt-20 pt-8 border-t border-slate-200 text-center text-xs text-slate-400 uppercase font-bold tracking-widest">
                 Document g√©n√©r√© par HotelOS - {filteredIssues.length} articles non-conformes
              </div>
           </div>
        </div>
      )}

    </div>
  );
};

export default HousekeepingView;

import React, { useState, useEffect } from 'react';
import { Download, X, Share } from 'lucide-react';

const InstallPwaPrompt: React.FC = () => {
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);
  const [showPrompt, setShowPrompt] = useState(false);
  const [isIOS, setIsIOS] = useState(false);

  useEffect(() => {
    // D√©tection iOS
    const isIosDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream;
    setIsIOS(isIosDevice);

    // V√©rifier si d√©j√† install√© (Standalone mode)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || (navigator as any).standalone;
    if (isStandalone) return;

    // Gestion de l'√©v√©nement d'installation (Android / Chrome Desktop)
    const handler = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e);
      setShowPrompt(true);
    };

    window.addEventListener('beforeinstallprompt', handler);

    // Pour iOS, on affiche le prompt si on est sur mobile mais pas en standalone
    if (isIosDevice && !isStandalone) {
        setShowPrompt(true);
    }

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const handleInstallClick = async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      setShowPrompt(false);
    }
    setDeferredPrompt(null);
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed bottom-4 left-4 right-4 z-[300] bg-slate-900 text-white p-4 rounded-2xl shadow-2xl border border-slate-700 animate-in slide-in-from-bottom-10 fade-in duration-500">
      <div className="flex items-start justify-between gap-4">
        <div className="flex gap-3">
           <div className="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center shrink-0 shadow-lg">
              <Download size={20} className="text-white" />
           </div>
           <div>
              <h4 className="font-bold text-sm">Installer HotelOS</h4>
              <p className="text-xs text-slate-400 mt-1 leading-snug">
                {isIOS 
                  ? "Pour installer, appuyez sur Partager puis 'Sur l'√©cran d'accueil'." 
                  : "Ajoutez l'application sur votre √©cran d'accueil pour un acc√®s rapide."}
              </p>
           </div>
        </div>
        <button onClick={() => setShowPrompt(false)} className="p-1 text-slate-400 hover:text-white">
           <X size={16}/>
        </button>
      </div>
      
      {!isIOS && deferredPrompt && (
        <button 
          onClick={handleInstallClick}
          className="mt-4 w-full py-3 bg-white text-slate-900 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-slate-100 transition-colors shadow-lg"
        >
          üì≤ Installer l'application
        </button>
      )}
      
      {isIOS && (
         <div className="mt-3 flex items-center justify-center gap-2 text-[10px] font-bold text-slate-400 bg-slate-800/50 py-2 rounded-lg">
            <Share size={12} /> Appuyez sur le bouton de partage ci-dessous
         </div>
      )}
    </div>
  );
};

export default InstallPwaPrompt;

import React, { useState, useMemo, useEffect, useRef } from 'react';
import { 
  ClipboardList, Plus, Save, Download, Archive, ChevronDown, 
  Trash2, Coffee, Wine, Utensils, GlassWater, AlertCircle, FileSpreadsheet, Filter,
  ArrowRight, Check, X, Table, Users
} from 'lucide-react';
import { UserSettings, MonthlyInventory, InventoryItem, InventoryCategory } from '../types';

interface InventoryViewProps {
  userSettings: UserSettings;
  inventoryData: Record<string, MonthlyInventory>;
  onUpdateInventory: (data: Record<string, MonthlyInventory>) => void;
  canManage: boolean; // Permission check
}

const CATEGORIES: { id: InventoryCategory, icon: any, color: string }[] = [
  { id: 'Cuisine', icon: Utensils, color: 'bg-orange-500' },
  { id: 'Petit D√©jeuner', icon: Coffee, color: 'bg-amber-500' },
  { id: 'Boissons sans alcool', icon: GlassWater, color: 'bg-blue-500' },
  { id: 'Boissons avec alcool', icon: Wine, color: 'bg-purple-500' },
];

const InventoryView: React.FC<InventoryViewProps> = ({ userSettings, inventoryData, onUpdateInventory, canManage }) => {
  // Init default month to current or latest available
  const getCurrentMonthId = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  };

  const [selectedMonth, setSelectedMonth] = useState(getCurrentMonthId());
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState<string>('ALL');
  
  // Ref for File Input
  const fileInputRef = useRef<HTMLInputElement>(null);

  // --- CSV IMPORT STATE ---
  const [showImportModal, setShowImportModal] = useState(false);
  const [csvHeaders, setCsvHeaders] = useState<string[]>([]);
  const [csvRawData, setCsvRawData] = useState<Record<string, string>[]>([]);
  const [columnMapping, setColumnMapping] = useState({
    name: '',
    category: '',
    packaging: '',
    supplier: '',
    qty: '',
    cost: ''
  });
  const [defaultImportCategory, setDefaultImportCategory] = useState<InventoryCategory>('Cuisine');
  
  // Create current month if not exists in local state view (but don't save yet unless action)
  const currentData = useMemo(() => {
    if (inventoryData[selectedMonth]) return inventoryData[selectedMonth];
    return { monthId: selectedMonth, status: 'open', items: [] } as MonthlyInventory;
  }, [inventoryData, selectedMonth]);

  const isClosed = currentData.status === 'closed';
  const isMonthCurrent = selectedMonth === getCurrentMonthId();

  // --- ACTIONS ---

  const handleUpdateItem = (itemId: string, field: keyof InventoryItem, value: any) => {
    if (isClosed || !canManage) return;
    
    const updatedItems = currentData.items.map(item => 
      item.id === itemId ? { ...item, [field]: value } : item
    );
    
    onUpdateInventory({
      ...inventoryData,
      [selectedMonth]: { ...currentData, items: updatedItems }
    });
  };

  const handleAddItem = () => {
    if (isClosed || !canManage) return;
    const newItem: InventoryItem = {
      id: `inv-${Date.now()}`,
      name: 'Nouveau Produit',
      category: categoryFilter !== 'ALL' ? categoryFilter as InventoryCategory : 'Cuisine', // Auto-set category if filtered
      packaging: 'Unit√©',
      supplier: '',
      initialQty: 0,
      initialUnitCost: 0,
      unitCost: 0,
      currentQty: 0
    };
    onUpdateInventory({
      ...inventoryData,
      [selectedMonth]: { ...currentData, items: [...currentData.items, newItem] }
    });
  };

  const handleDeleteItem = (itemId: string) => {
    if (isClosed || !canManage) return;
    
    const updatedItems = currentData.items.filter(item => item.id !== itemId);
    onUpdateInventory({
      ...inventoryData,
      [selectedMonth]: { ...currentData, items: updatedItems }
    });
  };

  const handleCloseMonth = () => {
    if (!canManage) return;
    if (!window.confirm("√ätes-vous s√ªr de vouloir cl√¥turer le mois ? Cette action est irr√©versible et g√©n√©rera le stock initial du mois suivant.")) return;

    // 1. Close current
    const closedMonth: MonthlyInventory = { ...currentData, status: 'closed', closedAt: new Date().toISOString() };
    
    // 2. Prepare next month ID
    const [year, month] = selectedMonth.split('-').map(Number);
    const d = new Date(year, month - 1); // JS Month is 0-indexed
    d.setMonth(d.getMonth() + 1);
    const nextMonthId = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

    // 3. Create next month data with carry-over
    const nextMonthItems = currentData.items.map(item => ({
      ...item,
      id: `inv-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      initialQty: item.currentQty, // CARRY OVER STOCK
      initialUnitCost: item.unitCost, // CARRY OVER PRICE AS INITIAL
      unitCost: item.unitCost, // DEFAULT CURRENT PRICE TO PREVIOUS
      currentQty: item.currentQty, // DEFAULT STOCK
    }));

    const nextMonth: MonthlyInventory = {
      monthId: nextMonthId,
      status: 'open',
      items: nextMonthItems
    };

    onUpdateInventory({
      ...inventoryData,
      [selectedMonth]: closedMonth,
      [nextMonthId]: nextMonth
    });

    // Switch view to next month
    setSelectedMonth(nextMonthId);
  };

  // --- CSV IMPORT LOGIC ---

  const handleImportClick = () => {
    if (isClosed || !canManage) return;
    fileInputRef.current?.click();
  };

  // Step 1: Parse File but don't import yet
  const handleFileAnalysis = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target?.result as string;
      if (!text) return;

      const lines = text.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) {
        alert("Fichier vide ou format incorrect.");
        return;
      }

      // Detect separator
      const firstLine = lines[0];
      const separator = firstLine.includes(';') ? ';' : ',';
      
      // Extract headers
      const headers = firstLine.split(separator).map(h => h.trim().replace(/"/g, ''));
      setCsvHeaders(headers);

      // Extract Data objects
      const data = lines.slice(1).map(line => {
        const values = line.split(separator).map(v => v.trim().replace(/"/g, ''));
        const obj: Record<string, string> = {};
        headers.forEach((h, i) => {
          obj[h] = values[i] || '';
        });
        return obj;
      });
      setCsvRawData(data);

      // Auto-guess mapping based on keywords
      const newMapping = { name: '', category: '', packaging: '', supplier: '', qty: '', cost: '' };
      
      const findHeader = (keywords: string[]) => headers.find(h => keywords.some(k => h.toLowerCase().includes(k))) || '';
      
      newMapping.name = findHeader(['nom', 'produit', 'article', 'd√©signation', 'libell√©']);
      newMapping.category = findHeader(['cat', 'famille', 'type']);
      newMapping.packaging = findHeader(['cond', 'pack', 'unit√©']);
      newMapping.supplier = findHeader(['fourn', 'supp', 'vend']);
      newMapping.qty = findHeader(['qt', 'stock', 'initial']);
      newMapping.cost = findHeader(['cout', 'co√ªt', 'prix', 'price', 'unit']);

      setColumnMapping(newMapping);
      setShowImportModal(true);
      
      // Reset input
      if (fileInputRef.current) fileInputRef.current.value = '';
    };
    reader.readAsText(file);
  };

  // Step 2: Confirm Mapping and Process
  const handleConfirmImport = () => {
    if (!columnMapping.name) {
      alert("Veuillez au moins associer la colonne 'Nom du Produit'.");
      return;
    }

    const newItems: InventoryItem[] = csvRawData.map((row, idx) => {
      // 1. Resolve Name
      const name = row[columnMapping.name] || 'Article sans nom';
      
      // 2. Resolve Category
      let category: InventoryCategory = defaultImportCategory;
      const rawCat = columnMapping.category ? row[columnMapping.category] : '';
      
      if (rawCat) {
        const lowerCat = rawCat.toLowerCase();
        if (lowerCat.includes('sans alcool') || (lowerCat.includes('boisson') && !lowerCat.includes('alcool'))) category = 'Boissons sans alcool';
        else if (lowerCat.includes('alcool') || lowerCat.includes('vin') || lowerCat.includes('cave')) category = 'Boissons avec alcool';
        else if (lowerCat.includes('d√©j') || lowerCat.includes('dej') || lowerCat.includes('matin')) category = 'Petit D√©jeuner';
        else if (lowerCat.includes('cuis') || lowerCat.includes('food') || lowerCat.includes('alim')) category = 'Cuisine';
      }

      // 3. Resolve Numbers
      const parseNum = (val: string) => {
        if (!val) return 0;
        // Replace comma with dot, remove currency symbols or spaces if basic clean needed
        const clean = val.replace(',', '.').replace(/[^\d.-]/g, ''); 
        return parseFloat(clean) || 0;
      };

      const cost = columnMapping.cost ? parseNum(row[columnMapping.cost]) : 0;
      const qty = columnMapping.qty ? parseNum(row[columnMapping.qty]) : 0;

      return {
        id: `imp-${Date.now()}-${idx}`,
        name: name,
        category: category,
        packaging: columnMapping.packaging ? row[columnMapping.packaging] : 'Unit√©',
        supplier: columnMapping.supplier ? row[columnMapping.supplier] : '',
        initialQty: qty,
        initialUnitCost: cost,
        unitCost: cost,
        currentQty: qty
      };
    });

    onUpdateInventory({
      ...inventoryData,
      [selectedMonth]: { ...currentData, items: [...currentData.items, ...newItems] }
    });

    setShowImportModal(false);
  };

  // --- FILTERING & SORTING ---
  const filteredItems = useMemo(() => {
    return currentData.items.filter(i => {
      const matchesSearch = i.name.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = categoryFilter === 'ALL' || i.category === categoryFilter;
      return matchesSearch && matchesCategory;
    }).sort((a, b) => a.category.localeCompare(b.category));
  }, [currentData, searchTerm, categoryFilter]);

  // --- STATS DYNAMIC (Based on filteredItems) ---
  const stats = useMemo(() => {
    const s: Record<string, number> = { total: 0 };
    CATEGORIES.forEach(c => s[c.id] = 0);
    
    filteredItems.forEach(item => {
      const val = item.currentQty * item.unitCost;
      s.total += val;
      if (s[item.category] !== undefined) s[item.category] += val;
    });
    return s;
  }, [filteredItems]);

  // Group by category for display
  const groupedItems = useMemo(() => {
    const groups: Record<string, InventoryItem[]> = {};
    if (categoryFilter === 'ALL') {
        CATEGORIES.forEach(c => groups[c.id] = []);
    } else {
        groups[categoryFilter] = [];
    }

    filteredItems.forEach(item => {
      if (groups[item.category]) groups[item.category].push(item);
    });
    return groups;
  }, [filteredItems, categoryFilter]);

  const availableMonths = Object.keys(inventoryData).sort().reverse();
  if (!availableMonths.includes(selectedMonth)) availableMonths.unshift(selectedMonth);

  return (
    <div className="flex flex-col h-full overflow-hidden animate-in fade-in">
      
      {/* 1. TOP DASHBOARD (Header) */}
      <div className={`p-6 border-b z-20 ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="max-w-7xl mx-auto w-full">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
               <div className="flex items-center gap-3">
                  <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
                    <ClipboardList size={24} />
                  </div>
                  <div>
                    <h2 className="text-2xl font-black">Inventaire F&B</h2>
                    <p className="text-xs font-bold text-slate-400">Suivi des stocks & Co√ªts</p>
                  </div>
               </div>

               {/* Month Selection Moved Here for Better Visibility */}
               <div className="flex items-center gap-3 bg-white dark:bg-slate-800 p-1.5 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                  <span className="text-[10px] font-black uppercase text-slate-400 pl-2">P√©riode :</span>
                  <div className="relative">
                    <select 
                      value={selectedMonth} 
                      onChange={(e) => setSelectedMonth(e.target.value)}
                      className="appearance-none bg-transparent font-black text-sm outline-none pr-8 cursor-pointer dark:text-white py-1"
                    >
                      {availableMonths.map(m => (
                        <option key={m} value={m}>{m} {inventoryData[m]?.status === 'closed' ? 'üîí' : '‚úèÔ∏è'}</option>
                      ))}
                    </select>
                    <ChevronDown size={12} className="absolute right-0 top-2.5 pointer-events-none text-slate-400"/>
                  </div>
               </div>
            </div>

            {/* KPI Cards (Dynamic Update) */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
               {CATEGORIES.map(cat => (
                 <div key={cat.id} className={`p-4 rounded-2xl border relative overflow-hidden transition-all duration-300 ${categoryFilter !== 'ALL' && categoryFilter !== cat.id ? 'opacity-40 grayscale' : ''} ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                    <div className="flex justify-between items-start mb-2">
                       <div className={`p-2 rounded-lg ${cat.color} text-white`}>
                         <cat.icon size={16}/>
                       </div>
                       <span className="text-[9px] font-black uppercase text-slate-400 text-right leading-tight max-w-[60%]">{cat.id}</span>
                    </div>
                    <div className="text-xl font-black text-slate-900 dark:text-white">{stats[cat.id].toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}</div>
                 </div>
               ))}
            </div>
         </div>
      </div>

      {/* 2. FILTERS & ACTIONS TOOLBAR */}
      <div className={`px-6 py-4 flex flex-col gap-4 border-b ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="max-w-7xl mx-auto w-full flex flex-col md:flex-row justify-between items-center gap-4">
            
            {/* Filters Group */}
            <div className="flex flex-1 gap-3 w-full md:w-auto">
                <div className={`flex items-center px-4 py-2.5 rounded-xl border-2 w-full md:w-64 transition-colors ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 focus-within:border-violet-500' : 'bg-white border-slate-200 focus-within:border-violet-500'}`}>
                    <input 
                    type="text" 
                    placeholder="Rechercher produit..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="bg-transparent text-sm font-bold outline-none w-full dark:text-white"
                    />
                </div>

                <div className="relative min-w-[150px]">
                    <div className={`flex items-center px-3 py-2.5 rounded-xl border-2 w-full transition-colors ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                        <Filter size={14} className="text-slate-400 mr-2"/>
                        <select 
                            value={categoryFilter}
                            onChange={(e) => setCategoryFilter(e.target.value)}
                            className="bg-transparent text-xs font-bold outline-none w-full appearance-none dark:text-white cursor-pointer"
                        >
                            <option value="ALL">Toutes cat√©gories</option>
                            {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.id}</option>)}
                        </select>
                        <ChevronDown size={12} className="absolute right-3 top-3.5 pointer-events-none text-slate-400"/>
                    </div>
                </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-2 w-full md:w-auto overflow-x-auto no-scrollbar justify-end">
               {canManage && !isClosed && (
                 <>
                   <button onClick={handleAddItem} className="px-4 py-2.5 rounded-xl bg-violet-600 text-white font-bold text-xs flex items-center gap-2 hover:bg-violet-700 transition-colors shadow-lg whitespace-nowrap">
                     <Plus size={16}/> <span className="hidden md:inline">Ajouter</span> Article
                   </button>
                   
                   {/* Hidden File Input */}
                   <input 
                     type="file" 
                     ref={fileInputRef} 
                     onChange={handleFileAnalysis} // Changed handler
                     accept=".csv, .txt" 
                     className="hidden" 
                   />
                   <button onClick={handleImportClick} className="px-4 py-2.5 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-500 font-bold text-xs flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors whitespace-nowrap">
                     <FileSpreadsheet size={16}/> Import <span className="hidden md:inline">CSV</span>
                   </button>
                 </>
               )}
               
               {canManage && !isClosed && (
                 <button onClick={handleCloseMonth} className="px-4 py-2.5 rounded-xl bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold text-xs flex items-center gap-2 hover:opacity-90 transition-opacity shadow-lg ml-2 whitespace-nowrap">
                   <Archive size={16}/> Cl√¥turer <span className="hidden md:inline">le mois</span>
                 </button>
               )}
               {isClosed && (
                 <div className="px-4 py-2.5 rounded-xl bg-slate-200 dark:bg-slate-800 text-slate-500 font-bold text-xs flex items-center gap-2 cursor-not-allowed">
                   <Archive size={16}/> Mois Cl√¥tur√©
                 </div>
               )}
            </div>
         </div>
      </div>

      {/* 3. MAIN TABLE CONTENT */}
      <div className="flex-1 overflow-y-auto px-4 md:px-6 pb-20 no-scrollbar pt-6">
         <div className="max-w-7xl mx-auto w-full space-y-8">
            {Object.keys(groupedItems).map(catId => {
              const items = groupedItems[catId];
              const catConfig = CATEGORIES.find(c => c.id === catId);
              if (items.length === 0) return null;

              return (
                <div key={catId} className="space-y-3">
                   {/* Category Header */}
                   <div className="flex items-center gap-2">
                      <div className={`w-2 h-6 rounded-full ${catConfig?.color}`} />
                      <h3 className="text-sm font-black uppercase tracking-widest text-slate-500">{catId}</h3>
                   </div>
                   
                   {/* 
                      ADAPTIVE TABLE CONTAINER
                      Desktop: White rounded box with table
                      Mobile: Transparent container with cards
                   */}
                   <div className={`md:rounded-3xl md:border md:overflow-hidden ${userSettings.darkMode ? 'md:bg-slate-800 md:border-slate-700' : 'md:bg-white md:border-slate-200 md:shadow-sm'}`}>
                      
                      {/* TABLE HEADER (Desktop Only) */}
                      <div className={`hidden md:flex text-[10px] font-black uppercase text-slate-400 ${userSettings.darkMode ? 'bg-slate-800/50' : 'bg-slate-50'}`}>
                         <div className="py-4 px-6 text-left flex-1 min-w-[200px]">Article / Condit.</div>
                         <div className="py-4 px-4 text-left w-32">Fournisseur</div>
                         <div className="py-4 px-4 text-center w-24">Initial (Stock)</div>
                         <div className="py-4 px-4 text-center w-24">Initial (Prix)</div>
                         <div className="py-4 px-4 text-center w-24">Prix Actuel</div>
                         <div className="py-4 px-4 text-center w-24">Stock Actuel</div>
                         <div className="py-4 px-6 text-right w-28">Valeur Stock</div>
                         {!isClosed && canManage && <div className="py-4 px-4 w-10"></div>}
                      </div>

                      {/* ITEMS LIST */}
                      <div className="flex flex-col md:block">
                         {items.map(item => (
                           <div 
                             key={item.id} 
                             className={`flex flex-col md:flex-row md:items-center relative p-4 mb-3 md:p-0 md:mb-0 md:border-b last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 rounded-2xl' : 'bg-white shadow-sm md:shadow-none border border-slate-200 md:border-slate-100 rounded-2xl md:rounded-none'}`}
                           >
                              
                              {/* 1. Article Info */}
                              <div className="md:flex-1 md:min-w-[200px] md:py-3 md:px-6 mb-3 md:mb-0">
                                 {isClosed ? (
                                   <>
                                     <div className="font-bold text-slate-900 dark:text-white">{item.name}</div>
                                     <div className="text-[10px] font-medium text-slate-400">{item.packaging}</div>
                                   </>
                                 ) : (
                                   <div className="flex flex-col gap-1">
                                     <input 
                                       type="text" 
                                       value={item.name}
                                       onChange={(e) => handleUpdateItem(item.id, 'name', e.target.value)}
                                       className="font-bold text-slate-900 dark:text-white bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-violet-500 placeholder:text-slate-400 transition-colors w-full"
                                       placeholder="Nom Produit"
                                     />
                                     <input 
                                       type="text" 
                                       value={item.packaging}
                                       onChange={(e) => handleUpdateItem(item.id, 'packaging', e.target.value)}
                                       className="text-[10px] font-medium text-slate-500 bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-violet-500 placeholder:text-slate-300 w-full"
                                       placeholder="Conditionnement"
                                     />
                                   </div>
                                 )}
                              </div>

                              {/* 2. Supplier (Hidden on Mobile) */}
                              <div className="hidden md:block w-32 px-4 py-3">
                                 {isClosed ? (
                                   <span className="text-xs font-medium text-slate-500">{item.supplier || '-'}</span>
                                 ) : (
                                   <input 
                                     type="text" 
                                     value={item.supplier}
                                     onChange={(e) => handleUpdateItem(item.id, 'supplier', e.target.value)}
                                     className="text-xs font-medium text-slate-500 bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-violet-500 placeholder:text-slate-300 w-full"
                                     placeholder="Fournisseur"
                                   />
                                 )}
                              </div>

                              {/* 3. Initial Values (Hidden on Mobile) */}
                              <div className="hidden md:block w-24 text-center px-4 py-3">
                                 <span className="text-xs font-bold text-slate-400">{item.initialQty}</span>
                              </div>
                              <div className="hidden md:block w-24 text-center px-4 py-3">
                                 <span className="text-xs font-bold text-slate-400">{item.initialUnitCost !== undefined ? item.initialUnitCost : '-'} ‚Ç¨</span>
                              </div>

                              {/* 4. Inputs Grid (Mobile Friendly) */}
                              <div className="grid grid-cols-2 gap-4 md:flex md:items-center md:gap-0 w-full md:w-auto">
                                 
                                 {/* Price Input */}
                                 <div className="md:w-24 md:px-4 md:py-3 flex flex-col items-center">
                                    <span className="md:hidden text-[10px] font-bold text-slate-400 uppercase mb-1">Prix Unitaire</span>
                                    {isClosed ? (
                                       <span className="font-black text-slate-900 dark:text-white">{item.unitCost} ‚Ç¨</span>
                                    ) : (
                                       <input 
                                          type="number" 
                                          value={item.unitCost}
                                          onChange={(e) => handleUpdateItem(item.id, 'unitCost', parseFloat(e.target.value) || 0)}
                                          className="w-full md:w-20 text-center bg-slate-100 dark:bg-slate-900 rounded-lg py-2 px-2 font-black outline-none focus:ring-2 focus:ring-violet-500 text-slate-900 dark:text-white"
                                       />
                                    )}
                                 </div>

                                 {/* Stock Input */}
                                 <div className="md:w-24 md:px-4 md:py-3 flex flex-col items-center">
                                    <span className="md:hidden text-[10px] font-bold text-slate-400 uppercase mb-1">Stock R√©el</span>
                                    {isClosed ? (
                                       <span className="font-black text-slate-900 dark:text-white">{item.currentQty}</span>
                                    ) : (
                                       <input 
                                          type="number" 
                                          value={item.currentQty}
                                          onChange={(e) => handleUpdateItem(item.id, 'currentQty', parseFloat(e.target.value) || 0)}
                                          className="w-full md:w-20 text-center bg-violet-50 dark:bg-violet-900/20 text-slate-900 dark:text-white rounded-lg py-2 px-2 font-black outline-none focus:ring-2 focus:ring-violet-500"
                                       />
                                    )}
                                 </div>
                              </div>

                              {/* 5. Total Value */}
                              <div className="col-span-2 md:w-28 md:px-6 md:py-3 text-right flex justify-between md:block items-center mt-3 md:mt-0 pt-3 md:pt-0 border-t md:border-0 border-slate-100 dark:border-slate-700">
                                 <span className="md:hidden text-xs font-bold text-slate-500">Valeur Totale</span>
                                 <span className="font-black text-slate-900 dark:text-white">{(item.currentQty * item.unitCost).toFixed(2)} ‚Ç¨</span>
                              </div>

                              {/* 6. Delete Action - Z-Index FIX for Mobile */}
                              {!isClosed && canManage && (
                                <div className="absolute top-3 right-3 z-10 md:z-auto md:relative md:top-auto md:right-auto md:w-10 md:px-4 md:py-3 md:text-right">
                                   <button 
                                     onClick={(e) => {
                                       e.preventDefault(); // Bloque le comportement par d√©faut
                                       e.stopPropagation(); // BLOQUE L'OUVERTURE DE LA CARTE
                                       if (window.confirm("Voulez-vous vraiment supprimer cet article ?")) {
                                         // Force la suppression avec l'ID de l'article courant
                                         handleDeleteItem(item.id);
                                       }
                                     }}
                                     className="p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 z-50 md:p-2 md:text-slate-300 md:bg-transparent md:hover:text-red-500 md:hover:bg-transparent"
                                     title="Supprimer"
                                   >
                                     <Trash2 size={20} className="md:w-4 md:h-4"/>
                                   </button>
                                </div>
                              )}

                           </div>
                         ))}
                      </div>
                   </div>
                </div>
              );
            })}
            
            {filteredItems.length === 0 && (
              <div className="py-20 text-center opacity-50">
                 <ClipboardList size={48} className="mx-auto mb-4 text-slate-300"/>
                 <p className="font-bold text-slate-400">Aucun article trouv√©.</p>
                 {!isClosed && searchTerm === '' && categoryFilter === 'ALL' && <p className="text-xs mt-2">Utilisez "Ajouter Article" ou "Import CSV" pour commencer.</p>}
              </div>
            )}
         </div>
      </div>

      {/* --- MAPPING MODAL --- */}
      {showImportModal && (
        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center animate-in fade-in backdrop-blur-sm p-4">
           <div className={`w-full max-w-4xl rounded-[32px] shadow-2xl flex flex-col max-h-[90vh] ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
              
              {/* Modal Header */}
              <div className="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                 <div className="flex items-center gap-3">
                    <div className="p-2 bg-indigo-600 rounded-xl text-white">
                       <FileSpreadsheet size={24} />
                    </div>
                    <div>
                       <h3 className="text-xl font-black">Correspondance CSV</h3>
                       <p className="text-xs text-slate-400 font-bold">Associez les colonnes de votre fichier</p>
                    </div>
                 </div>
                 <button onClick={() => setShowImportModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 hover:text-slate-600"><X size={20}/></button>
              </div>

              {/* Modal Body */}
              <div className="flex-1 overflow-y-auto p-6 space-y-8">
                 
                 {/* Mapping Grid */}
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="space-y-4">
                       <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest border-b pb-2 mb-4">Champs requis</h4>
                       {[
                         { key: 'name', label: 'Nom du Produit *', icon: ClipboardList },
                         { key: 'supplier', label: 'Fournisseur', icon: Users },
                         { key: 'category', label: 'Cat√©gorie', icon: Filter },
                         { key: 'packaging', label: 'Conditionnement', icon: Archive },
                         { key: 'qty', label: 'Quantit√© Initiale', icon: ChevronDown },
                         { key: 'cost', label: 'Co√ªt HT', icon: AlertCircle },
                       ].map(field => (
                         <div key={field.key} className="flex items-center justify-between group">
                            <div className="flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-300">
                               <field.icon size={16} className="text-slate-400"/> {field.label}
                            </div>
                            <div className="flex items-center gap-2">
                               <ArrowRight size={14} className="text-slate-300"/>
                               <select 
                                 value={columnMapping[field.key as keyof typeof columnMapping]} 
                                 onChange={(e) => setColumnMapping({...columnMapping, [field.key]: e.target.value})}
                                 className={`w-40 py-2 px-3 rounded-xl text-xs font-bold outline-none border-2 transition-colors ${columnMapping[field.key as keyof typeof columnMapping] ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300' : 'border-slate-200 dark:border-slate-700 bg-transparent text-slate-400'}`}
                               >
                                 <option value="">Ignorer</option>
                                 {csvHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                               </select>
                            </div>
                         </div>
                       ))}
                    </div>

                    <div className="space-y-6">
                       <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest border-b pb-2 mb-4">Options</h4>
                       
                       <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                          <label className="text-[10px] font-black uppercase text-slate-400 mb-2 block">Cat√©gorie par d√©faut</label>
                          <p className="text-[10px] text-slate-500 mb-3 leading-relaxed">
                             Si la cat√©gorie du fichier est vide ou inconnue, utiliser :
                          </p>
                          <select 
                            value={defaultImportCategory}
                            onChange={(e) => setDefaultImportCategory(e.target.value as InventoryCategory)}
                            className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 font-bold text-sm outline-none border border-slate-200 dark:border-slate-700"
                          >
                             {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.id}</option>)}
                          </select>
                       </div>

                       <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl flex gap-3 items-start">
                          <AlertCircle size={18} className="text-blue-500 mt-0.5 shrink-0" />
                          <p className="text-[10px] text-blue-700 dark:text-blue-300 font-medium leading-relaxed">
                             V√©rifiez l'aper√ßu ci-dessous. Les d√©cimales (virgules) seront automatiquement converties en points. Les nouvelles lignes seront ajout√©es √† la liste existante.
                          </p>
                       </div>
                    </div>
                 </div>

                 {/* Preview Table */}
                 <div>
                    <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2"><Table size={14}/> Aper√ßu des donn√©es (3 premi√®res lignes)</h4>
                    <div className="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
                       <table className="w-full text-xs">
                          <thead className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 font-black text-slate-500 uppercase">
                             <tr>
                                <th className="p-3 text-left">Produit</th>
                                <th className="p-3 text-left">Cat√©gorie</th>
                                <th className="p-3 text-left">Fournisseur</th>
                                <th className="p-3 text-right">Qt√©</th>
                                <th className="p-3 text-right">Co√ªt</th>
                             </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                             {csvRawData.slice(0, 3).map((row, i) => (
                               <tr key={i}>
                                  <td className="p-3 font-bold text-slate-900 dark:text-white">{columnMapping.name ? row[columnMapping.name] : '-'}</td>
                                  <td className="p-3 text-slate-500">{columnMapping.category ? row[columnMapping.category] : defaultImportCategory}</td>
                                  <td className="p-3 text-slate-500">{columnMapping.supplier ? row[columnMapping.supplier] : '-'}</td>
                                  <td className="p-3 text-right font-mono">{columnMapping.qty ? row[columnMapping.qty] : '0'}</td>
                                  <td className="p-3 text-right font-mono font-bold text-slate-900 dark:text-white">{columnMapping.cost ? row[columnMapping.cost] : '0'}</td>
                               </tr>
                             ))}
                          </tbody>
                       </table>
                    </div>
                 </div>

              </div>

              {/* Footer Actions */}
              <div className="p-6 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-3 bg-slate-50 dark:bg-slate-900/50 rounded-b-[32px]">
                 <button 
                   onClick={() => setShowImportModal(false)}
                   className="px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                 >
                   Annuler
                 </button>
                 <button 
                   onClick={handleConfirmImport}
                   className="px-8 py-3 rounded-xl bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-lg flex items-center gap-2 hover:bg-indigo-700 transition-colors"
                 >
                   <Check size={16} /> Valider l'import
                 </button>
              </div>

           </div>
        </div>
      )}

    </div>
  );
};

export default InventoryView;

import React, { useRef } from 'react';
import { Task, UserSettings, Group } from '../types';
import { CheckSquare, AlertCircle, Calendar, Paperclip, Briefcase, Tag } from 'lucide-react';

interface KanbanViewProps {
  tasks: Task[];
  userSettings: UserSettings;
  groups: Group[];
  onTaskClick: (task: Task) => void;
  onStatusChange: (taskId: string | number, status: 'Pas commenc√©' | 'En cours' | 'Termin√©') => void;
}

const KanbanView: React.FC<KanbanViewProps> = ({ tasks, userSettings, groups, onTaskClick, onStatusChange }) => {
  const themeColor = userSettings.themeColor;

  const columns: { id: 'Pas commenc√©' | 'En cours' | 'Termin√©', label: string, color: string }[] = [
    { id: 'Pas commenc√©', label: '√Ä Faire', color: 'bg-slate-100 text-slate-500' },
    { id: 'En cours', label: 'En Cours', color: 'bg-amber-100 text-amber-600' },
    { id: 'Termin√©', label: 'Termin√©', color: 'bg-emerald-100 text-emerald-600' }
  ];

  const handleDragStart = (e: React.DragEvent, taskId: string | number) => {
    e.dataTransfer.setData('taskId', taskId.toString());
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
  };

  const handleDrop = (e: React.DragEvent, newStatus: 'Pas commenc√©' | 'En cours' | 'Termin√©') => {
    const taskId = e.dataTransfer.getData('taskId');
    if (taskId) {
      // Tente de convertir en nombre si c'est un ID num√©rique legacy, sinon garde la string
      const parsedId = !isNaN(Number(taskId)) && !taskId.includes('-') ? Number(taskId) : taskId;
      onStatusChange(parsedId, newStatus);
    }
  };

  const getPriorityColor = (p?: string) => {
    switch (p) {
      case 'High': return 'bg-red-500';
      case 'Medium': return 'bg-violet-500';
      default: return 'bg-slate-300';
    }
  };

  return (
    <div className="flex gap-4 h-full overflow-x-auto pb-4 snap-x">
      {columns.map(col => (
        <div 
          key={col.id} 
          className="flex-1 min-w-[280px] snap-center flex flex-col h-full rounded-3xl bg-slate-50/50 dark:bg-slate-800/30 border-2 border-slate-100 dark:border-slate-800"
          onDragOver={handleDragOver}
          onDrop={(e) => handleDrop(e, col.id)}
        >
          {/* Header Column */}
          <div className="p-4 flex items-center justify-between sticky top-0 bg-transparent z-10">
             <div className={`px-3 py-1.5 rounded-xl text-[9px] font-black uppercase tracking-widest ${col.color}`}>
               {col.label}
             </div>
             <span className="text-xs font-bold text-slate-400">{tasks.filter(t => t.status === col.id).length}</span>
          </div>

          {/* Task List */}
          <div className="flex-1 overflow-y-auto px-2 pb-4 space-y-3 no-scrollbar">
            {tasks.filter(t => t.status === col.id).map(task => {
                const linkedGroup = groups.find(g => g.id.toString() === task.linkedGroupId?.toString());
                return (
                  <div 
                    key={task.id}
                    draggable
                    onDragStart={(e) => handleDragStart(e, task.id)}
                    onClick={() => onTaskClick(task)}
                    className={`p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 cursor-grab active:cursor-grabbing hover:shadow-md transition-all group relative overflow-hidden`}
                  >
                    {/* Priority Indicator Bar */}
                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${getPriorityColor(task.priority)}`} />

                    <div className="pl-2">
                        {/* Linked Group Badge */}
                        {linkedGroup && (
                            <div className="flex items-center gap-1 text-[8px] font-black text-indigo-500 uppercase mb-2 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-lg w-fit">
                                <Briefcase size={10} /> {linkedGroup.name}
                            </div>
                        )}

                        <p className={`text-xs font-bold leading-snug ${task.done ? 'line-through opacity-50' : 'text-slate-700 dark:text-slate-200'}`}>
                            {task.text}
                        </p>

                        <div className="flex flex-wrap gap-2 mt-3 items-center">
                            <span className="text-[8px] font-bold text-slate-400 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded flex items-center gap-1">
                                <Tag size={8} /> {task.tag}
                            </span>
                            {task.date && (
                                <span className="text-[8px] font-bold text-slate-400 flex items-center gap-1">
                                    <Calendar size={8} /> {new Date(task.date).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'})}
                                </span>
                            )}
                            {task.attachments && task.attachments.length > 0 && (
                                <span className="text-[8px] font-bold text-indigo-400 flex items-center gap-1">
                                    <Paperclip size={8} />
                                </span>
                            )}
                        </div>
                    </div>
                  </div>
                );
            })}
            {tasks.filter(t => t.status === col.id).length === 0 && (
                <div className="h-24 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl flex items-center justify-center opacity-50">
                    <span className="text-[9px] font-bold text-slate-400">Vide</span>
                </div>
            )}
          </div>
        </div>
      ))}
    </div>
  );
};

export default KanbanView;
import React, { useState, useMemo } from 'react';
import { 
  ChefHat, Calculator, ArrowLeft, Plus, Search, Trash2, 
  Save, Utensils, Euro, FileText, PieChart, AlertCircle, BookOpen, Settings, Filter, X
} from 'lucide-react';
import { UserSettings, Recipe, RecipeIngredient, InventoryItem, MonthlyInventory, RatioItem } from '../types';

interface KitchenEngineeringViewProps {
  userSettings: UserSettings;
  recipes: Recipe[];
  onUpdateRecipes: (recipes: Recipe[]) => void;
  onNavigate: (tab: string) => void;
  inventoryData: Record<string, MonthlyInventory>;
  
  // New Props for Ratio Catalog
  ratioItems: RatioItem[];
  onUpdateRatioItems: (items: RatioItem[]) => void;
  customCategories: string[];
  onUpdateCategories: (cats: string[]) => void;
}

const UNITS = ['kg', 'g', 'L', 'ml', 'cl', 'Pi√®ce', 'Portion'];

const KitchenEngineeringView: React.FC<KitchenEngineeringViewProps> = ({ 
  userSettings, recipes, onUpdateRecipes, onNavigate, inventoryData,
  ratioItems, onUpdateRatioItems, customCategories, onUpdateCategories
}) => {
  const [activeTab, setActiveTab] = useState<'calculator' | 'recipes' | 'catalog'>('calculator');
  const [selectedRecipe, setSelectedRecipe] = useState<Recipe | null>(null);
  
  // --- CALCULATOR STATE ---
  const [calcCost, setCalcCost] = useState<string>('');
  const [calcVat, setCalcVat] = useState<string>('10');
  const [calcTargetPercent, setCalcTargetPercent] = useState<string>('30'); 

  // --- RECIPE EDIT STATE ---
  const [recipeSearch, setRecipeSearch] = useState('');
  const [filterCategory, setFilterCategory] = useState<'ALL' | 'Entr√©e' | 'Plat' | 'Dessert'>('ALL');
  const [isEditing, setIsEditing] = useState(false);
  const [editRecipe, setEditRecipe] = useState<Recipe | null>(null);
  const [ingredientSearch, setIngredientSearch] = useState('');

  // --- CATALOG STATE ---
  const [catalogSearch, setCatalogSearch] = useState('');
  const [activeCatalogFilter, setActiveCatalogFilter] = useState('ALL');
  const [isManagingCats, setIsManagingCats] = useState(false);
  const [newCatName, setNewCatName] = useState('');

  // Get latest inventory items for autocomplete (used in both Recipes and Catalog)
  const inventoryItems = useMemo(() => {
    const monthIds = Object.keys(inventoryData).sort().reverse();
    if (monthIds.length === 0) return [];
    return inventoryData[monthIds[0]].items;
  }, [inventoryData]);

  // --- CALCULATOR LOGIC ---
  const calculatedPrice = useMemo(() => {
    const cost = parseFloat(calcCost.replace(',', '.')) || 0;
    const targetPercent = parseFloat(calcTargetPercent) || 0;
    const vat = parseFloat(calcVat) || 0;
    
    let priceHT = 0;
    if (targetPercent > 0) {
      priceHT = cost / (targetPercent / 100);
    }
    
    const priceTTC = priceHT * (1 + vat / 100);
    const margin = priceHT - cost;
    
    return { priceHT, priceTTC, margin };
  }, [calcCost, calcTargetPercent, calcVat]);

  // --- RECIPE LOGIC ---
  const filteredRecipes = useMemo(() => {
    return recipes.filter(r => {
      const matchesSearch = r.name.toLowerCase().includes(recipeSearch.toLowerCase());
      const matchesCat = filterCategory === 'ALL' || r.category === filterCategory;
      return matchesSearch && matchesCat;
    });
  }, [recipes, recipeSearch, filterCategory]);

  const handleCreateRecipe = () => {
    const newRecipe: Recipe = {
      id: `rec-${Date.now()}`,
      name: 'Nouvelle Recette',
      category: 'Plat',
      portions: 1,
      targetCostPercent: 30, // Default 30%
      vatRate: 10,
      lastUpdated: new Date().toISOString(),
      ingredients: []
    };
    setEditRecipe(newRecipe);
    setIsEditing(true);
    setSelectedRecipe(null);
  };

  const handleSelectRecipe = (r: Recipe) => {
    setSelectedRecipe(r);
    setEditRecipe({ ...r }); // Clone for editing
    setIsEditing(true);
  };

  const handleAddIngredient = (invItem?: InventoryItem) => {
    if (!editRecipe) return;
    
    const newIng: RecipeIngredient = {
      id: `ring-${Date.now()}`,
      inventoryItemId: invItem?.id,
      name: invItem ? invItem.name : 'Nouvel ingr√©dient',
      unit: invItem ? (invItem.packaging.includes('kg') ? 'kg' : 'Pi√®ce') : 'kg',
      unitPrice: invItem ? invItem.unitCost : 0,
      quantity: 1,
      supplier: invItem?.supplier
    };

    setEditRecipe({
      ...editRecipe,
      ingredients: [...editRecipe.ingredients, newIng]
    });
    setIngredientSearch('');
  };

  const updateIngredient = (id: string, field: keyof RecipeIngredient, value: any) => {
    if (!editRecipe) return;
    const newIngredients = editRecipe.ingredients.map(ing => 
      ing.id === id ? { ...ing, [field]: value } : ing
    );
    setEditRecipe({ ...editRecipe, ingredients: newIngredients });
  };

  const removeIngredient = (id: string) => {
    if (!editRecipe) return;
    setEditRecipe({
      ...editRecipe,
      ingredients: editRecipe.ingredients.filter(i => i.id !== id)
    });
  };

  const saveRecipe = () => {
    if (!editRecipe) return;
    const exists = recipes.find(r => r.id === editRecipe.id);
    let newRecipes;
    if (exists) {
      newRecipes = recipes.map(r => r.id === editRecipe.id ? { ...editRecipe, lastUpdated: new Date().toISOString() } : r);
    } else {
      newRecipes = [...recipes, { ...editRecipe, lastUpdated: new Date().toISOString() }];
    }
    onUpdateRecipes(newRecipes);
    setSelectedRecipe(editRecipe);
    alert("Recette sauvegard√©e !");
  };

  // Recipe Costs Calculation
  const recipeCosts = useMemo(() => {
    if (!editRecipe) return { rawCost: 0, waste: 0, totalCost: 0, recommendedPrice: 0, margin: 0 };
    
    let rawCost = 0;
    editRecipe.ingredients.forEach(ing => {
      rawCost += ing.quantity * ing.unitPrice;
    });

    const waste = rawCost * 0.10; // 10% perte
    const totalCost = rawCost + waste;
    
    let priceHT = 0;
    const targetPercent = editRecipe.targetCostPercent || 30;
    
    if (targetPercent > 0) {
      priceHT = totalCost / (targetPercent / 100);
    }

    const priceTTC = priceHT * (1 + editRecipe.vatRate / 100);

    return { rawCost, waste, totalCost, recommendedPrice: priceTTC, margin: priceHT - totalCost };
  }, [editRecipe]);

  // --- CATALOG LOGIC ---

  const handleAddRatioItem = () => {
    const newItem: RatioItem = {
      id: `rat-${Date.now()}`,
      name: 'Nouveau Produit',
      category: 'Food',
      manualCost: 0,
      targetPercent: 30,
      vatRate: 10
    };
    onUpdateRatioItems([newItem, ...ratioItems]);
  };

  const handleUpdateRatioItem = (id: string, field: keyof RatioItem, value: any) => {
    onUpdateRatioItems(ratioItems.map(item => {
      if (item.id === id) {
        // Special handling for inventory link
        if (field === 'inventoryId') {
           if (value) {
             const invItem = inventoryItems.find(i => i.id === value);
             if (invItem) {
               // HYBRID SYSTEM: Import Name, Category, and reset Manual Cost
               return { 
                   ...item, 
                   inventoryId: value, 
                   name: invItem.name, 
                   manualCost: 0,
                   category: invItem.category // Auto-import category from inventory
               }; 
             }
           } else {
             return { ...item, inventoryId: undefined }; // Unlink to allow manual edit
           }
        }
        return { ...item, [field]: value };
      }
      return item;
    }));
  };

  const handleDeleteRatioItem = (id: string) => {
    if (window.confirm('Supprimer ce produit ?')) {
      onUpdateRatioItems(ratioItems.filter(i => i.id !== id));
    }
  };

  const handleAddCategory = () => {
    if (newCatName && !customCategories.includes(newCatName)) {
      onUpdateCategories([...customCategories, newCatName]);
      setNewCatName('');
    }
  };

  const handleDeleteCategory = (cat: string) => {
    if (window.confirm(`Supprimer la cat√©gorie "${cat}" ?`)) {
      onUpdateCategories(customCategories.filter(c => c !== cat));
    }
  };

  // Filter Ratio Items
  const filteredRatioItems = useMemo(() => {
    return ratioItems.filter(item => {
      const matchesSearch = item.name.toLowerCase().includes(catalogSearch.toLowerCase());
      const matchesCat = activeCatalogFilter === 'ALL' || item.category === activeCatalogFilter;
      return matchesSearch && matchesCat;
    });
  }, [ratioItems, catalogSearch, activeCatalogFilter]);

  return (
    <div className={`h-full flex flex-col overflow-hidden animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* HEADER */}
      <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="flex items-center gap-4">
            <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
              <ChefHat size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Ing√©nierie Cuisine</h2>
              <p className="text-xs font-bold text-slate-400">Pricing & Fiches Techniques</p>
            </div>
         </div>
         <button 
           onClick={() => onNavigate('dashboard')}
           className="px-4 py-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 font-black text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
         >
           <ArrowLeft size={14}/> Retour Accueil
         </button>
      </div>

      {/* TABS */}
      <div className="px-6 py-4">
         <div className="flex p-1 rounded-2xl bg-slate-200 dark:bg-slate-800 w-fit overflow-x-auto whitespace-nowrap max-w-full no-scrollbar px-2">
            <button 
              onClick={() => setActiveTab('calculator')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'calculator' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
            >
              <Calculator size={14}/> Calculateur Rapide
            </button>
            <button 
              onClick={() => setActiveTab('recipes')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'recipes' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
            >
              <Utensils size={14}/> Fiches Techniques
            </button>
            <button 
              onClick={() => setActiveTab('catalog')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'catalog' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
            >
              <BookOpen size={14}/> Catalogue des Ratios
            </button>
         </div>
      </div>

      {/* CONTENT */}
      <div className="flex-1 overflow-y-auto px-6 pb-20">
         
         {/* --- CALCULATOR TAB --- */}
         {activeTab === 'calculator' && (
           <div className="max-w-4xl mx-auto mt-10 grid grid-cols-1 md:grid-cols-2 gap-10">
              {/* Inputs */}
              <div className={`p-8 rounded-[32px] border shadow-sm space-y-6 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                 <h3 className="text-lg font-black uppercase tracking-tight mb-6">Param√®tres</h3>
                 <div className="space-y-2">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Co√ªt Mati√®re HT (‚Ç¨)</label>
                    <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus-within:border-violet-500 transition-all flex items-center gap-3">
                       <Euro size={20} className="text-slate-400"/>
                       <input 
                         type="text" 
                         value={calcCost}
                         onChange={(e) => setCalcCost(e.target.value)}
                         placeholder="Ex: 10.50"
                         className="bg-transparent font-black text-2xl outline-none w-full"
                       />
                    </div>
                 </div>
                 <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Co√ªt Mati√®re Cible (%)</label>
                       <div className="relative">
                         <input 
                           type="number" 
                           value={calcTargetPercent}
                           onChange={(e) => setCalcTargetPercent(e.target.value)}
                           className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 font-black text-xl outline-none border-2 border-transparent focus:border-violet-500 transition-all text-center pr-8"
                         />
                         <span className="absolute right-4 top-5 font-black text-slate-400">%</span>
                       </div>
                    </div>
                    <div className="space-y-2">
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">TVA (%)</label>
                       <select 
                         value={calcVat}
                         onChange={(e) => setCalcVat(e.target.value)}
                         className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 font-black text-xl outline-none border-2 border-transparent focus:border-violet-500 transition-all text-center appearance-none"
                       >
                         <option value="5.5">5.5 %</option>
                         <option value="10">10 %</option>
                         <option value="20">20 %</option>
                       </select>
                    </div>
                 </div>
                 <div className="pt-4">
                    <p className="text-xs text-slate-400 italic">
                       Formule : (Co√ªt HT / % Cible) x (1 + TVA)
                    </p>
                 </div>
              </div>
              {/* Results */}
              <div className="flex flex-col gap-6">
                 <div className="flex-1 p-8 rounded-[32px] bg-violet-600 text-white shadow-xl shadow-violet-500/30 flex flex-col justify-center items-center text-center relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20"></div>
                    <p className="text-sm font-bold uppercase tracking-widest opacity-80 mb-2">Prix de Vente Conseill√© (TTC)</p>
                    <h1 className="text-6xl font-black">{calculatedPrice.priceTTC.toFixed(2)} ‚Ç¨</h1>
                    <p className="mt-4 text-sm font-medium bg-white/20 px-3 py-1 rounded-lg">HT : {calculatedPrice.priceHT.toFixed(2)} ‚Ç¨</p>
                 </div>
                 <div className={`p-6 rounded-[28px] border flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                    <div>
                       <p className="text-[10px] font-black uppercase text-slate-400">Marge Brute (HT)</p>
                       <p className="text-2xl font-black text-emerald-500">+{calculatedPrice.margin.toFixed(2)} ‚Ç¨</p>
                    </div>
                    <div className="h-10 w-[1px] bg-slate-200 dark:bg-slate-700"></div>
                    <div className="text-right">
                       <p className="text-[10px] font-black uppercase text-slate-400">Ratio Mati√®re</p>
                       <p className="text-2xl font-black text-slate-900 dark:text-white">
                         {parseFloat(calcCost.replace(',', '.')) > 0 && calculatedPrice.priceHT > 0 
                           ? ((parseFloat(calcCost.replace(',', '.')) / calculatedPrice.priceHT) * 100).toFixed(1) 
                           : '0.0'} %
                       </p>
                    </div>
                 </div>
              </div>
           </div>
         )}

         {/* --- RECIPES TAB --- */}
         {activeTab === 'recipes' && (
           <div className="flex flex-col md:flex-row h-full gap-4 md:gap-6">
              {/* Left: Recipe List */}
              <div className={`w-full md:w-1/3 flex flex-col rounded-[32px] border overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <div className="p-4 border-b border-slate-100 dark:border-slate-700 space-y-3">
                    <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 p-3 rounded-xl">
                       <Search size={16} className="text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="Rechercher recette..." 
                         value={recipeSearch}
                         onChange={(e) => setRecipeSearch(e.target.value)}
                         className="bg-transparent outline-none text-xs font-bold w-full"
                       />
                    </div>
                    <div className="flex gap-2">
                       {['ALL', 'Entr√©e', 'Plat', 'Dessert'].map(c => (
                         <button 
                           key={c}
                           onClick={() => setFilterCategory(c as any)}
                           className={`flex-1 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${filterCategory === c ? 'bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-300' : 'bg-slate-100 dark:bg-slate-900 text-slate-500'}`}
                         >
                           {c}
                         </button>
                       ))}
                    </div>
                    <button 
                      onClick={handleCreateRecipe}
                      className="w-full py-3 rounded-xl bg-slate-900 text-white font-bold text-xs uppercase flex items-center justify-center gap-2 hover:bg-slate-800 transition-colors"
                    >
                      <Plus size={14}/> Cr√©er Recette
                    </button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
                    {filteredRecipes.map(r => (
                      <div 
                        key={r.id} 
                        onClick={() => handleSelectRecipe(r)}
                        className={`p-3 rounded-xl cursor-pointer border transition-all ${selectedRecipe?.id === r.id ? 'border-violet-500 bg-violet-50 dark:bg-violet-900/20' : 'border-transparent hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}
                      >
                         <div className="flex justify-between items-center mb-1">
                            <span className="font-bold text-sm">{r.name}</span>
                            <span className="text-[9px] font-black bg-white dark:bg-slate-800 px-2 py-0.5 rounded shadow-sm text-slate-500">{r.category}</span>
                         </div>
                         <div className="flex justify-between items-center text-[10px] text-slate-400 font-medium">
                            <span>{r.ingredients.length} ingr√©dients</span>
                            <span>Cible: {r.targetCostPercent}%</span>
                         </div>
                      </div>
                    ))}
                 </div>
              </div>

              {/* Right: Recipe Editor */}
              <div className={`flex-1 rounded-[32px] border overflow-hidden flex flex-col ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 {isEditing && editRecipe ? (
                   <>
                     {/* Editor Header */}
                     <div className="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-start gap-4">
                        <div className="flex-1 space-y-4 w-full">
                           <div className="flex gap-3">
                              <input 
                                type="text" 
                                value={editRecipe.name} 
                                onChange={(e) => setEditRecipe({...editRecipe, name: e.target.value})}
                                className="text-2xl font-black bg-transparent outline-none border-b border-dashed border-slate-300 focus:border-violet-500 w-full pb-1 text-slate-900 dark:text-white"
                                placeholder="Nom de la recette"
                              />
                              <select 
                                value={editRecipe.category}
                                onChange={(e) => setEditRecipe({...editRecipe, category: e.target.value as any})}
                                className="bg-slate-100 dark:bg-slate-900 rounded-lg text-xs font-bold px-3 outline-none text-slate-900 dark:text-white"
                              >
                                <option value="Entr√©e">Entr√©e</option>
                                <option value="Plat">Plat</option>
                                <option value="Dessert">Dessert</option>
                                <option value="Autre">Autre</option>
                              </select>
                           </div>
                           <div className="flex gap-4">
                              <div className="flex items-center gap-2">
                                 <label className="text-[10px] font-black uppercase text-slate-400">Cible %</label>
                                 <input 
                                   type="number" 
                                   value={editRecipe.targetCostPercent} 
                                   onChange={(e) => setEditRecipe({...editRecipe, targetCostPercent: parseFloat(e.target.value) || 0})}
                                   className="w-16 p-2 rounded-lg bg-slate-50 dark:bg-slate-900 font-bold text-center text-sm outline-none text-slate-900 dark:text-white"
                                 />
                              </div>
                              <div className="flex items-center gap-2">
                                 <label className="text-[10px] font-black uppercase text-slate-400">TVA</label>
                                 <select 
                                   value={editRecipe.vatRate} 
                                   onChange={(e) => setEditRecipe({...editRecipe, vatRate: parseFloat(e.target.value) || 0})}
                                   className="p-2 rounded-lg bg-slate-50 dark:bg-slate-900 font-bold text-center text-sm outline-none text-slate-900 dark:text-white"
                                 >
                                   <option value="5.5">5.5%</option>
                                   <option value="10">10%</option>
                                   <option value="20">20%</option>
                                 </select>
                              </div>
                              <div className="flex items-center gap-2">
                                 <label className="text-[10px] font-black uppercase text-slate-400">Portions</label>
                                 <input 
                                   type="number" 
                                   value={editRecipe.portions} 
                                   onChange={(e) => setEditRecipe({...editRecipe, portions: parseFloat(e.target.value) || 1})}
                                   className="w-14 p-2 rounded-lg bg-slate-50 dark:bg-slate-900 font-bold text-center text-sm outline-none text-slate-900 dark:text-white"
                                 />
                              </div>
                           </div>
                        </div>
                        <button onClick={saveRecipe} className="w-full md:w-auto px-6 py-3 rounded-xl bg-emerald-500 text-white font-bold text-xs uppercase flex items-center justify-center gap-2 shadow-lg hover:bg-emerald-600 transition-colors">
                           <Save size={16}/> Sauvegarder
                        </button>
                     </div>

                     {/* Ingredients List (IMPROVED TABLE) */}
                     <div className="flex-1 overflow-y-auto p-6 space-y-4">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-2 gap-2">
                           <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Composition ({editRecipe.ingredients.length})</h4>
                           
                           {/* Add Ingredient Dropdown */}
                           <div className="relative group w-full md:w-auto">
                              <div className="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-xl border border-transparent focus-within:border-violet-500 transition-colors w-full">
                                 <Plus size={14} className="text-slate-400"/>
                                 <input 
                                   type="text" 
                                   placeholder="Ajouter ingr√©dient..." 
                                   className="bg-transparent outline-none text-xs font-bold w-full md:w-40 text-slate-900 dark:text-white"
                                   value={ingredientSearch}
                                   onChange={(e) => setIngredientSearch(e.target.value)}
                                 />
                              </div>
                              {/* Autocomplete Results */}
                              {ingredientSearch && (
                                <div className="absolute top-full right-0 mt-2 w-full md:w-64 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-50">
                                   <div onClick={() => handleAddIngredient()} className="p-3 text-xs font-bold text-violet-500 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700">
                                      + Cr√©er "{ingredientSearch}" (Manuel)
                                   </div>
                                   {inventoryItems
                                     .filter(i => i.name.toLowerCase().includes(ingredientSearch.toLowerCase()))
                                     .slice(0, 5)
                                     .map(item => (
                                       <div key={item.id} onClick={() => handleAddIngredient(item)} className="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex justify-between items-center group/item">
                                          <div>
                                             <p className="text-xs font-bold">{item.name}</p>
                                             <p className="text-[9px] text-slate-400">{item.packaging}</p>
                                          </div>
                                          <p className="text-xs font-bold">{item.unitCost}‚Ç¨</p>
                                       </div>
                                     ))
                                   }
                                </div>
                              )}
                           </div>
                        </div>

                        {/* NEW TABLE HEADER */}
                        <div className="hidden md:grid grid-cols-12 gap-3 pb-2 border-b border-slate-200 dark:border-slate-700 text-[9px] font-black uppercase text-slate-400">
                           <div className="col-span-4">Ingr√©dient</div>
                           <div className="col-span-2 text-center">Quantit√©</div>
                           <div className="col-span-2">Unit√©</div>
                           <div className="col-span-2 text-right">Prix Unit.</div>
                           <div className="col-span-2 text-right">Total HT</div>
                        </div>

                        <div className="space-y-2">
                           {editRecipe.ingredients.map(ing => (
                             <div key={ing.id} className="grid grid-cols-12 gap-3 items-center p-3 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 hover:border-violet-200 transition-colors">
                                {/* Name */}
                                <div className="col-span-12 md:col-span-4">
                                   <input 
                                     value={ing.name} 
                                     onChange={(e) => updateIngredient(ing.id, 'name', e.target.value)}
                                     className="bg-transparent font-bold text-sm outline-none w-full text-slate-900 dark:text-white"
                                     placeholder="Nom ingr√©dient"
                                   />
                                   {ing.supplier && <p className="text-[9px] text-slate-400 truncate">{ing.supplier}</p>}
                                </div>
                                
                                {/* Quantity */}
                                <div className="col-span-4 md:col-span-2 flex justify-center">
                                   <input 
                                     type="number"
                                     step="any"
                                     value={ing.quantity} 
                                     onChange={(e) => updateIngredient(ing.id, 'quantity', parseFloat(e.target.value.replace(',', '.')) || 0)}
                                     className="w-16 bg-white dark:bg-slate-800 rounded-lg p-1.5 text-center font-bold text-sm outline-none text-slate-900 dark:text-white border border-transparent focus:border-violet-500 transition-colors"
                                   />
                                </div>

                                {/* Unit Selector */}
                                <div className="col-span-4 md:col-span-2">
                                   <select 
                                     value={ing.unit} 
                                     onChange={(e) => updateIngredient(ing.id, 'unit', e.target.value)}
                                     className="w-full bg-transparent text-xs font-bold text-slate-600 dark:text-slate-300 outline-none cursor-pointer"
                                   >
                                      {UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                   </select>
                                </div>

                                {/* Unit Price */}
                                <div className="col-span-4 md:col-span-2 flex items-center justify-end gap-1">
                                   <input 
                                     type="number"
                                     step="any"
                                     value={ing.unitPrice} 
                                     onChange={(e) => updateIngredient(ing.id, 'unitPrice', parseFloat(e.target.value.replace(',', '.')) || 0)}
                                     className="w-16 bg-transparent text-right font-bold text-sm outline-none text-slate-900 dark:text-white border-b border-dashed border-slate-300 focus:border-violet-500"
                                   />
                                   <span className="text-[10px] text-slate-400">‚Ç¨</span>
                                </div>

                                {/* Total Line Cost & Actions */}
                                <div className="col-span-12 md:col-span-2 flex items-center justify-end gap-3 pt-2 md:pt-0 border-t md:border-t-0 border-slate-200 dark:border-slate-700 mt-2 md:mt-0">
                                   <span className="text-sm font-black text-slate-900 dark:text-white">
                                     {(ing.quantity * ing.unitPrice).toFixed(2)} ‚Ç¨
                                   </span>
                                   <button onClick={() => removeIngredient(ing.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={14}/></button>
                                </div>
                             </div>
                           ))}
                           {editRecipe.ingredients.length === 0 && (
                             <div className="text-center py-10 opacity-40">
                                <Utensils size={40} className="mx-auto mb-2"/>
                                <p className="text-xs font-bold">Aucun ingr√©dient</p>
                             </div>
                           )}
                        </div>
                     </div>

                     {/* Footer Stats */}
                     <div className={`p-6 border-t ${userSettings.darkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-100'}`}>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                           <div>
                              <p className="text-[9px] font-black uppercase text-slate-400">Co√ªt Mati√®re Brut</p>
                              <p className="text-lg font-bold text-slate-900 dark:text-white">{recipeCosts.rawCost.toFixed(2)} ‚Ç¨</p>
                           </div>
                           <div>
                              <p className="text-[9px] font-black uppercase text-amber-500 flex items-center gap-1"><AlertCircle size={10}/> Pertes (10%)</p>
                              <p className="text-lg font-bold text-amber-600">{recipeCosts.waste.toFixed(2)} ‚Ç¨</p>
                           </div>
                           <div>
                              <p className="text-[9px] font-black uppercase text-slate-400">Co√ªt de Revient Total</p>
                              <p className="text-lg font-black text-slate-900 dark:text-white">{recipeCosts.totalCost.toFixed(2)} ‚Ç¨</p>
                           </div>
                           <div className="bg-violet-600 rounded-xl p-3 text-white shadow-lg text-center transform scale-110 -mt-2">
                              <p className="text-[9px] font-black uppercase opacity-80">Prix Conseill√© TTC</p>
                              <p className="text-2xl font-black">{recipeCosts.recommendedPrice.toFixed(2)} ‚Ç¨</p>
                           </div>
                        </div>
                     </div>
                   </>
                 ) : (
                   <div className="flex-1 flex flex-col items-center justify-center opacity-30">
                      <ChefHat size={64} className="mb-4 text-slate-400"/>
                      <p className="text-xl font-black text-slate-500">S√©lectionnez ou cr√©ez une recette</p>
                   </div>
                 )}
              </div>
           </div>
         )}

         {/* --- CATALOGUE DES RATIOS TAB --- */}
         {activeTab === 'catalog' && (
           <div className="h-full flex flex-col space-y-4">
              
              {/* Controls */}
              <div className="flex flex-col md:flex-row gap-4 items-center justify-between bg-white dark:bg-slate-800 p-4 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                 <div className="flex items-center gap-2 w-full md:w-auto flex-1">
                    <div className="relative w-full md:w-64">
                       <Search size={16} className="absolute left-3 top-3 text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="Rechercher produit..." 
                         value={catalogSearch}
                         onChange={(e) => setCatalogSearch(e.target.value)}
                         className="w-full bg-slate-50 dark:bg-slate-900 pl-10 pr-4 py-2.5 rounded-xl text-xs font-bold outline-none text-slate-900 dark:text-white"
                       />
                    </div>
                    <div className="relative group">
                       <button className="p-2.5 bg-slate-50 dark:bg-slate-900 rounded-xl text-slate-500 hover:text-indigo-500 transition-colors border border-transparent hover:border-indigo-200">
                          <Filter size={16}/>
                       </button>
                       {/* Dropdown Filters */}
                       <div className="absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-20 hidden group-hover:block">
                          <div 
                            onClick={() => setActiveCatalogFilter('ALL')}
                            className="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer text-xs font-bold border-b border-slate-50 dark:border-slate-700"
                          >
                             Tout voir
                          </div>
                          {customCategories.map(cat => (
                            <div 
                              key={cat}
                              onClick={() => setActiveCatalogFilter(cat)}
                              className="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer text-xs font-bold text-slate-600 dark:text-slate-300 flex justify-between items-center"
                            >
                               {cat}
                               {activeCatalogFilter === cat && <div className="w-2 h-2 rounded-full bg-indigo-500"></div>}
                            </div>
                          ))}
                       </div>
                    </div>
                 </div>

                 <div className="flex gap-2 w-full md:w-auto">
                    <button 
                      onClick={() => setIsManagingCats(true)} 
                      className="flex-1 md:flex-none px-4 py-2.5 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-500 font-bold text-xs hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2"
                    >
                       <Settings size={14}/> G√©rer Cat√©gories
                    </button>
                    <button 
                      onClick={handleAddRatioItem}
                      className="flex-1 md:flex-none px-4 py-2.5 rounded-xl bg-slate-900 text-white font-bold text-xs uppercase flex items-center justify-center gap-2 shadow-lg hover:bg-slate-800 transition-colors"
                    >
                       <Plus size={14}/> Ajouter Produit
                    </button>
                 </div>
              </div>

              {/* Table */}
              <div className={`flex-1 rounded-[32px] border overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                       <thead className="bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 text-[10px] font-black uppercase text-slate-400">
                          <tr>
                             <th className="py-4 px-6 text-left w-64">Produit / Article</th>
                             <th className="py-4 px-4 text-left w-40">Cat√©gorie</th>
                             <th className="py-4 px-4 text-center w-28">Co√ªt HT</th>
                             <th className="py-4 px-4 text-center w-28">Cible %</th>
                             <th className="py-4 px-4 text-center w-24">TVA</th>
                             <th className="py-4 px-4 text-right w-32">Prix Vente TTC</th>
                             <th className="py-4 px-4 w-16"></th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                          {filteredRatioItems.map(item => {
                             // Dynamic Cost Calculation
                             let currentCost = item.manualCost;
                             if (item.inventoryId) {
                               const linkedInv = inventoryItems.find(i => i.id === item.inventoryId);
                               if (linkedInv) currentCost = linkedInv.unitCost;
                             }

                             // Price Calculation: Cost / (Target%/100) * (1+VAT%/100)
                             let priceHT = 0;
                             if (item.targetPercent > 0) priceHT = currentCost / (item.targetPercent / 100);
                             const priceTTC = priceHT * (1 + item.vatRate / 100);

                             return (
                               <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                  <td className="py-3 px-6">
                                     <div className="flex flex-col gap-1">
                                        <input 
                                          type="text" 
                                          value={item.name} 
                                          onChange={(e) => handleUpdateRatioItem(item.id, 'name', e.target.value)}
                                          className="font-black text-sm bg-transparent outline-none w-full border-b border-transparent focus:border-indigo-500 placeholder:text-slate-400 text-slate-900 dark:text-white transition-all"
                                          placeholder="Nom du produit (Saisie libre)"
                                        />
                                        {/* Inventory Linker */}
                                        <select 
                                          value={item.inventoryId || ''} 
                                          onChange={(e) => handleUpdateRatioItem(item.id, 'inventoryId', e.target.value)}
                                          className="text-[10px] font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 outline-none cursor-pointer rounded px-2 py-1 w-fit border border-indigo-100 dark:border-indigo-800 hover:bg-indigo-100 transition-colors"
                                        >
                                           <option value="">+ Lier Stock (Auto-Update)</option>
                                           {inventoryItems.map(inv => <option key={inv.id} value={inv.id}>{inv.name} ({inv.unitCost}‚Ç¨)</option>)}
                                        </select>
                                     </div>
                                  </td>
                                  <td className="py-3 px-4">
                                     <select 
                                       value={item.category}
                                       onChange={(e) => handleUpdateRatioItem(item.id, 'category', e.target.value)}
                                       className="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1.5 text-xs font-black text-slate-900 dark:text-white outline-none w-full shadow-sm focus:ring-2 focus:ring-indigo-500/20"
                                     >
                                        {customCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                     </select>
                                  </td>
                                  <td className="py-3 px-4 text-center">
                                     {item.inventoryId ? (
                                       <div className="flex flex-col items-center justify-center">
                                          <span className="font-black text-slate-900 dark:text-white text-sm">
                                             {currentCost.toFixed(2)} ‚Ç¨
                                          </span>
                                          <span className="text-[8px] font-black uppercase bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded flex items-center gap-1">
                                             LINK
                                          </span>
                                       </div>
                                     ) : (
                                       <div className="relative">
                                          <input 
                                            type="number" 
                                            value={item.manualCost} 
                                            onChange={(e) => handleUpdateRatioItem(item.id, 'manualCost', parseFloat(e.target.value))}
                                            className="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg py-1.5 text-center font-black text-slate-900 dark:text-white outline-none shadow-sm focus:border-indigo-500"
                                            placeholder="0.00"
                                          />
                                          <span className="absolute right-8 top-1.5 text-[9px] font-bold text-slate-400 pointer-events-none">‚Ç¨</span>
                                       </div>
                                     )}
                                  </td>
                                  <td className="py-3 px-4 text-center">
                                     <div className="relative w-20 mx-auto">
                                        <input 
                                          type="number" 
                                          value={item.targetPercent} 
                                          onChange={(e) => handleUpdateRatioItem(item.id, 'targetPercent', parseFloat(e.target.value))}
                                          className="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg py-1.5 text-center font-black text-slate-900 dark:text-white outline-none shadow-sm focus:border-indigo-500"
                                        />
                                        <span className="absolute right-2 top-2 text-[9px] font-black text-indigo-300">%</span>
                                     </div>
                                  </td>
                                  <td className="py-3 px-4 text-center">
                                     <select 
                                       value={item.vatRate} 
                                       onChange={(e) => handleUpdateRatioItem(item.id, 'vatRate', parseFloat(e.target.value))}
                                       className="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg py-1.5 px-1 text-xs font-black text-slate-900 dark:text-white outline-none text-center shadow-sm w-full"
                                     >
                                        <option value="5.5">5.5%</option>
                                        <option value="10">10%</option>
                                        <option value="20">20%</option>
                                     </select>
                                  </td>
                                  <td className="py-3 px-6 text-right">
                                     <span className="text-lg font-black text-slate-900 dark:text-white">{priceTTC.toFixed(2)} ‚Ç¨</span>
                                  </td>
                                  <td className="py-3 px-4 text-right">
                                     <button onClick={() => handleDeleteRatioItem(item.id)} className="p-2 text-slate-300 hover:text-red-500 transition-colors">
                                        <Trash2 size={16}/>
                                     </button>
                                  </td>
                               </tr>
                             );
                          })}
                       </tbody>
                    </table>
                 </div>
                 {filteredRatioItems.length === 0 && (
                   <div className="text-center py-12 opacity-50">
                      <p className="text-sm font-bold text-slate-400">Aucun produit dans le catalogue.</p>
                   </div>
                 )}
              </div>

              {/* Category Manager Modal */}
              {isManagingCats && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                   <div className={`w-full max-w-md rounded-3xl p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
                      <div className="flex justify-between items-center mb-4">
                         <h3 className="font-black text-lg">G√©rer les cat√©gories</h3>
                         <button onClick={() => setIsManagingCats(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={16}/></button>
                      </div>
                      
                      <div className="flex gap-2 mb-4">
                         <input 
                           type="text" 
                           placeholder="Nouvelle cat√©gorie..." 
                           value={newCatName}
                           onChange={(e) => setNewCatName(e.target.value)}
                           className="flex-1 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 py-2 text-sm font-bold outline-none text-slate-900 dark:text-white"
                         />
                         <button onClick={handleAddCategory} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold text-xs uppercase">Ajouter</button>
                      </div>

                      <div className="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                         {customCategories.map(cat => (
                           <div key={cat} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                              <span className="font-bold text-sm">{cat}</span>
                              <button onClick={() => handleDeleteCategory(cat)} className="text-slate-400 hover:text-red-500"><Trash2 size={14}/></button>
                           </div>
                         ))}
                      </div>
                   </div>
                </div>
              )}

           </div>
         )}

      </div>
    </div>
  );
};

export default KitchenEngineeringView;

import React, { useState } from 'react';
import { useAuth } from '../services/authContext';
import { Loader2, Lock, Mail, ArrowRight, User, Eye, EyeOff } from 'lucide-react';

const LoginPage: React.FC = () => {
  const { login, signup, loading, error, clearError } = useAuth();
  
  // Modes: Login vs Signup
  const [isLogin, setIsLogin] = useState(true);
  
  // Form States
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  
  // UI States
  const [showPassword, setShowPassword] = useState(false);
  const [rememberMe, setRememberMe] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (isLogin) {
      if (!email || !password) return;
      await login(email, password, rememberMe);
    } else {
      if (!email || !password || !name) return;
      if (password !== confirmPassword) {
        alert("Les mots de passe ne correspondent pas.");
        return;
      }
      await signup(email, password, name);
    }
  };

  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-slate-50 dark:bg-slate-900 p-6 font-sans transition-colors duration-300">
      <div className="w-full max-w-md animate-in slide-in-from-bottom-10 fade-in duration-500">
        
        {/* Logo Header */}
        <div className="text-center mb-10">
          <div className="w-24 h-24 mx-auto mb-6 text-indigo-600 flex items-center justify-center transform hover:scale-105 transition-transform duration-500">
             <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="1" />
                <path d="M8 7v10M16 7v10" stroke="currentColor" strokeWidth="1" strokeLinecap="round" />
                <circle cx="12" cy="12" r="4" stroke="currentColor" strokeWidth="1" />
             </svg>
          </div>
          <h1 className="text-4xl font-black text-slate-900 dark:text-white mb-2 tracking-tight">HotelOS</h1>
          <p className="text-slate-500 dark:text-slate-400 font-medium">Plateforme de Gestion H√¥teli√®re</p>
        </div>

        {/* Card */}
        <div className="bg-white dark:bg-slate-800 rounded-[40px] shadow-2xl p-8 border border-slate-100 dark:border-slate-700/50 relative overflow-hidden transition-all duration-300">
          <h2 className="text-xl font-black mb-8 dark:text-white">{isLogin ? 'Connexion' : 'Cr√©ation de compte'}</h2>
          
          <form onSubmit={handleSubmit} className="space-y-5">
            
            {/* SIGN UP: Name Field */}
            {!isLogin && (
              <div className="space-y-2 animate-in slide-in-from-right-10 fade-in">
                <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-2">Nom & Pr√©nom</label>
                <div className="flex items-center gap-4 px-5 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-700 focus-within:border-indigo-500 dark:focus-within:border-indigo-500 transition-colors">
                  <User size={20} className="text-slate-400" />
                  <input 
                    type="text" 
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Jean Dupont"
                    className="bg-transparent outline-none flex-1 font-bold text-slate-900 dark:text-white placeholder:text-slate-400"
                    required={!isLogin}
                  />
                </div>
              </div>
            )}

            {/* Email Field */}
            <div className="space-y-2">
              <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-2">Email Professionnel</label>
              <div className="flex items-center gap-4 px-5 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-700 focus-within:border-indigo-500 dark:focus-within:border-indigo-500 transition-colors">
                <Mail size={20} className="text-slate-400" />
                <input 
                  type="email" 
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="nom@hotel.com"
                  className="bg-transparent outline-none flex-1 font-bold text-slate-900 dark:text-white placeholder:text-slate-400"
                  required
                />
              </div>
            </div>

            {/* Password Field */}
            <div className="space-y-2">
              <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-2">Mot de passe</label>
              <div className="flex items-center gap-4 px-5 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-700 focus-within:border-indigo-500 dark:focus-within:border-indigo-500 transition-colors">
                <Lock size={20} className="text-slate-400" />
                <input 
                  type={showPassword ? "text" : "password"}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  className="bg-transparent outline-none flex-1 font-bold text-slate-900 dark:text-white placeholder:text-slate-400"
                  required
                />
                <button type="button" onClick={() => setShowPassword(!showPassword)} className="text-slate-400 hover:text-indigo-500 transition-colors">
                  {showPassword ? <EyeOff size={18}/> : <Eye size={18}/>}
                </button>
              </div>
            </div>

            {/* SIGN UP: Confirm Password */}
            {!isLogin && (
              <div className="space-y-2 animate-in slide-in-from-right-10 fade-in">
                <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-2">Confirmer le mot de passe</label>
                <div className="flex items-center gap-4 px-5 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-700 focus-within:border-indigo-500 dark:focus-within:border-indigo-500 transition-colors">
                  <Lock size={20} className="text-slate-400" />
                  <input 
                    type={showPassword ? "text" : "password"}
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    className="bg-transparent outline-none flex-1 font-bold text-slate-900 dark:text-white placeholder:text-slate-400"
                    required={!isLogin}
                  />
                </div>
              </div>
            )}

            {/* LOGIN ONLY: Remember Me */}
            {isLogin && (
              <div className="flex items-center gap-3 px-2">
                 <label className="relative flex items-center gap-3 cursor-pointer group">
                    <input 
                      type="checkbox" 
                      className="peer sr-only" 
                      checked={rememberMe} 
                      onChange={(e) => setRememberMe(e.target.checked)}
                    />
                    <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center transition-all ${rememberMe ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 group-hover:border-indigo-400'}`}>
                       <svg className={`w-3 h-3 text-white transition-transform ${rememberMe ? 'scale-100' : 'scale-0'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span className="text-xs font-bold text-slate-500 dark:text-slate-400 group-hover:text-indigo-600 transition-colors">Se souvenir de moi</span>
                 </label>
              </div>
            )}

            {error && (
              <div className="p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-bold text-center animate-in shake">
                {error}
              </div>
            )}

            <button 
              type="submit" 
              disabled={loading}
              className="w-full py-5 rounded-[24px] bg-indigo-600 hover:bg-indigo-700 text-white font-black uppercase tracking-[0.2em] shadow-xl shadow-indigo-600/20 active:scale-95 transition-all flex items-center justify-center gap-3 mt-4 disabled:opacity-70 disabled:cursor-not-allowed"
            >
              {loading ? <Loader2 size={20} className="animate-spin" /> : <>{isLogin ? 'Se connecter' : 'S\'inscrire'} <ArrowRight size={20} /></>}
            </button>
          </form>
          
          {/* Switch Mode */}
          <div className="mt-6 text-center">
            <button 
              type="button"
              onClick={() => { setIsLogin(!isLogin); clearError(); }}
              className="text-xs font-bold text-slate-400 hover:text-indigo-600 transition-colors"
            >
              {isLogin ? "Pas encore de compte ? Cr√©er un acc√®s" : "D√©j√† un compte ? Se connecter"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default LoginPage;

import React from 'react';
import { 
  CloudSun, ChevronRight, CalendarPlus, CheckSquare, 
  UserPlus, Calendar, Clock, User, Briefcase, Users, Video,
  TrendingUp, Inbox, AlertCircle, ArrowRight
} from 'lucide-react';
import { UserSettings, CalendarEvent, Task, Contact, Group, Lead, InboxItem } from '../types';

interface MainDashboardProps {
  userSettings: UserSettings;
  events: CalendarEvent[];
  todos: Task[];
  contacts: Contact[];
  groups: Group[];
  leads?: Lead[];
  inbox?: InboxItem[];
  onNavigate: (tab: string) => void;
  onTaskToggle: (id: string | number) => void;
  onTaskClick: (task: Task) => void;
  onEventClick: (event: CalendarEvent) => void;
  onGroupClick: (group: Group) => void;
  onOpenEventModal: () => void;
  onOpenTaskModal: () => void;
  onOpenContactModal: () => void;
}

const MainDashboard: React.FC<MainDashboardProps> = ({ 
  userSettings, events, todos, contacts, groups, leads = [], inbox = [],
  onNavigate, onTaskToggle, onTaskClick, onEventClick, onGroupClick,
  onOpenEventModal, onOpenTaskModal, onOpenContactModal 
}) => {
  const today = new Date();
  
  const isSameDay = (d1: Date, d2: Date) => 
    d1.getDate() === d2.getDate() && 
    d1.getMonth() === d2.getMonth() && 
    d1.getFullYear() === d2.getFullYear();

  const isDateInRange = (d: Date, startStr: string, endStr: string) => {
    const checkDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const start = new Date(startStr);
    const end = new Date(endStr);
    start.setHours(0,0,0,0);
    end.setHours(0,0,0,0);
    return checkDate >= start && checkDate <= end;
  };

  const todaysEvents = events
    .filter(e => isSameDay(new Date(e.start), today))
    .sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());

  const activeGroups = groups.filter(g => isDateInRange(today, g.startDate, g.endDate));
  const pendingTasks = todos.filter(t => !t.done).slice(0, 3);

  const themeLight = `bg-${userSettings.themeColor}-50 text-${userSettings.themeColor}-600`;

  // Sales KPIs
  const salesKPIs = {
    pipeline: leads.filter(l => l.status === 'nouveau' || l.status === 'en_cours').length,
    newRequests: inbox.filter(i => i.status === 'to_process').length,
    urgentAction: leads.find(l => {
        // Simple logic: find a lead created > 7 days ago still 'nouveau'
        const d = new Date(l.requestDate);
        const diff = (today.getTime() - d.getTime()) / (1000 * 3600 * 24);
        return diff > 7 && l.status === 'nouveau';
    })?.contactName
  };

  return (
    <div className="p-4 md:px-6 md:py-4 space-y-6 animate-in fade-in duration-500 max-w-7xl mx-auto">
      {/* Header and Quick Actions Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-start">
        {/* Welcome */}
        <div className="flex justify-between items-center p-5 md:p-6 rounded-3xl bg-gradient-to-br from-indigo-500/5 to-purple-500/5 border border-slate-100 dark:border-slate-800">
          <div className="flex-1">
            <p className={`font-medium text-[10px] uppercase tracking-wider mb-0.5 ${userSettings.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
              {today.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}
            </p>
            <h1 className={`text-2xl md:text-3xl font-extrabold truncate pr-2 ${userSettings.darkMode ? 'text-white' : 'text-slate-900'}`}>
              Bonjour, {userSettings.userName}
            </h1>
          </div>
        </div>

        {/* Quick Action Buttons */}
        <div className="flex gap-3 md:gap-4 h-full">
          {[
            { icon: CalendarPlus, label: 'RDV', color: themeLight, onClick: onOpenEventModal },
            { icon: CheckSquare, label: 'T√¢che', color: 'bg-emerald-50 text-emerald-600', onClick: onOpenTaskModal },
            { icon: UserPlus, label: 'Contact', color: 'bg-amber-50 text-amber-600', onClick: onOpenContactModal },
          ].map((btn, i) => (
            <button 
              key={i} 
              onClick={btn.onClick}
              className={`flex-1 p-3 md:p-4 rounded-3xl flex flex-col items-center justify-center gap-2 md:gap-3 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-sm border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-100 text-slate-700'}`}
            >
              <div className={`p-2.5 md:p-3 rounded-full ${btn.color}`}>
                <btn.icon size={22} className="md:w-6 md:h-6" />
              </div>
              <span className="text-[10px] md:text-[11px] font-bold uppercase tracking-tight">{btn.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        {/* Today's Agenda Summary */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Agenda du jour</h2>
            <button onClick={() => onNavigate('agenda')} className={`text-xs font-bold text-${userSettings.themeColor}-600`}>Tout voir</button>
          </div>
          <div className="space-y-3 flex-1">
            {todaysEvents.length > 0 ? todaysEvents.map(evt => (
              <div 
                key={evt.id} 
                onClick={() => onEventClick(evt)}
                className={`p-4 rounded-2xl shadow-sm border flex items-center gap-4 cursor-pointer transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
              >
                <div className={`flex flex-col items-center justify-center min-w-[3.5rem] p-2.5 rounded-xl ${evt.type === 'pro' ? themeLight : 'bg-emerald-50 text-emerald-700'}`}>
                  <span className="text-xs font-bold">{evt.time}</span>
                  <span className="text-[9px] font-medium opacity-70">{evt.duration}</span>
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="font-bold text-sm leading-snug truncate">{evt.title}</h3>
                  {evt.linkedContactId && (
                    <p className="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5 truncate">
                      <User size={10} /> {contacts.find(c => c.id.toString() === evt.linkedContactId?.toString())?.name || 'Contact'}
                    </p>
                  )}
                  {evt.videoLink && (
                    <button 
                      onClick={(e) => { e.stopPropagation(); window.open(evt.videoLink, '_blank'); }}
                      className="mt-2 py-1 px-2.5 rounded-lg bg-blue-50 text-blue-600 text-[9px] font-black flex items-center gap-2 w-fit"
                    >
                      <Video size={12} /> VISIO
                    </button>
                  )}
                </div>
                <ChevronRight size={16} className="text-slate-300" />
              </div>
            )) : (
              <div className="p-8 text-center border-2 border-dashed rounded-3xl border-slate-200 h-full flex flex-col justify-center items-center">
                <p className="text-slate-400 text-xs font-medium">Aucun rendez-vous pr√©vu.</p>
              </div>
            )}
          </div>
        </section>

        {/* Pulse Commercial & Groups */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Performance Commerciale</h2>
            <button onClick={() => onNavigate('groups_crm')} className={`text-xs font-bold text-violet-600`}>CRM</button>
          </div>
          
          <div className="space-y-4 flex-1">
             {/* SALES PULSE WIDGET */}
             <div className={`p-5 rounded-[28px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                <div className="flex justify-between items-center mb-4">
                   <div className="flex items-center gap-2">
                      <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-xl">
                         <TrendingUp size={18} />
                      </div>
                      <span className="text-sm font-black">Pulse Commercial</span>
                   </div>
                   <button onClick={() => onNavigate('groups_crm')} className="p-2 text-slate-300 hover:text-indigo-500 transition-colors"><ArrowRight size={16}/></button>
                </div>
                
                <div className="space-y-3">
                   {/* KPI 1: Pipeline */}
                   <div className="flex items-center justify-between p-3 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 border border-transparent hover:border-indigo-200 transition-colors cursor-pointer" onClick={() => onNavigate('groups_crm')}>
                      <div className="flex items-center gap-3">
                         <div className="p-1.5 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-indigo-500"><Briefcase size={14}/></div>
                         <span className="text-xs font-bold text-indigo-900 dark:text-indigo-200">Dossiers actifs</span>
                      </div>
                      <span className="text-lg font-black text-indigo-600 dark:text-indigo-400">{salesKPIs.pipeline}</span>
                   </div>

                   {/* KPI 2: Inbox */}
                   <div className="flex items-center justify-between p-3 rounded-2xl bg-blue-50 dark:bg-blue-900/20 border border-transparent hover:border-blue-200 transition-colors cursor-pointer" onClick={() => onNavigate('groups_crm')}>
                      <div className="flex items-center gap-3">
                         <div className="p-1.5 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-blue-500"><Inbox size={14}/></div>
                         <span className="text-xs font-bold text-blue-900 dark:text-blue-200">Nouvelles demandes</span>
                      </div>
                      {salesKPIs.newRequests > 0 ? (
                        <span className="text-xs font-black bg-red-500 text-white px-2 py-0.5 rounded-full animate-pulse">{salesKPIs.newRequests}</span>
                      ) : (
                        <span className="text-xs font-bold text-blue-400">0</span>
                      )}
                   </div>

                   {/* KPI 3: Action */}
                   <div className="flex items-center gap-3 p-3 rounded-2xl bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800">
                      <AlertCircle size={14} className="text-orange-500 shrink-0"/>
                      <div className="flex-1 min-w-0">
                         <p className="text-[9px] font-bold uppercase text-orange-400">Action requise</p>
                         <p className="text-xs font-bold text-orange-900 dark:text-orange-200 truncate">
                           {salesKPIs.urgentAction ? `Relancer ${salesKPIs.urgentAction}` : 'Rien √† signaler'}
                         </p>
                      </div>
                   </div>
                </div>
             </div>

             {/* Groups List (Below Pulse) */}
             {activeGroups.length > 0 && (
                <div className="space-y-2">
                   <p className="text-[10px] font-bold uppercase text-slate-400 ml-1">Groupes en maison</p>
                   {activeGroups.map(group => (
                    <div 
                      key={group.id} 
                      onClick={() => onGroupClick(group)}
                      className={`p-4 rounded-2xl shadow-sm border-l-4 border-l-violet-500 border-y border-r flex items-center gap-4 cursor-pointer transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
                    >
                      <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-xs leading-snug truncate">{group.name}</h3>
                        <p className="text-[10px] text-slate-400 mt-0.5">{group.pax} PAX ‚Ä¢ {group.category}</p>
                      </div>
                    </div>
                  ))}
                </div>
             )}
          </div>
        </section>

        {/* Pending Tasks Summary */}
        <section className={`col-span-1 lg:col-span-1 flex flex-col h-full`}>
          <div className="flex justify-between items-end mb-4 px-1">
            <h2 className="text-sm font-bold uppercase tracking-widest opacity-60">Priorit√©s</h2>
            <button onClick={() => onNavigate('todo')} className={`text-xs font-bold text-${userSettings.themeColor}-600`}>Liste compl√®te</button>
          </div>
          <div className="space-y-3 flex-1">
            {pendingTasks.map(task => (
              <div 
                key={task.id} 
                className={`p-4 rounded-2xl shadow-sm border flex items-center gap-4 transition-transform hover:translate-x-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
              >
                <button 
                  onClick={() => onTaskToggle(task.id)}
                  className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${task.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}
                >
                  {task.done && <CheckSquare size={12} className="text-white" />}
                </button>
                <div className="flex-1 cursor-pointer min-w-0" onClick={() => onTaskClick(task)}>
                  <p className={`text-sm font-semibold truncate ${task.done ? 'line-through opacity-40' : ''}`}>{task.text}</p>
                  <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded-md mt-1 inline-block bg-${userSettings.themeColor}-50 text-${userSettings.themeColor}-700`}>{task.tag}</span>
                </div>
              </div>
            ))}
            {pendingTasks.length === 0 && (
              <div className="p-8 text-center border-2 border-dashed rounded-3xl border-emerald-100 bg-emerald-50/20 h-full flex flex-col justify-center items-center">
                <p className="text-emerald-500 text-xs font-bold">Tout est sous contr√¥le !</p>
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default MainDashboard;
import React, { useState, useRef, useMemo } from 'react';
import { 
  Wrench, FileText, Plus, Search, Trash2, Camera, Check, 
  AlertTriangle, Calendar, Phone, Mail, Clock, ArrowRight, ArrowUpRight,
  Building2, Globe, FileSignature, Siren, Save, Edit3, X, ChevronLeft, ArrowLeft, Loader2,
  LayoutList, CalendarDays, ChevronRight, Filter
} from 'lucide-react';
import { MaintenanceTicket, MaintenanceContract, UserSettings, UserRole, MaintenanceLocation, MaintenanceStatus, ContractStatus } from '../types';

interface MaintenanceViewProps {
  userSettings: UserSettings;
  userRole: UserRole;
  tickets: MaintenanceTicket[];
  contracts: MaintenanceContract[];
  onUpdateTickets: (tickets: MaintenanceTicket[]) => void;
  onUpdateContracts: (contracts: MaintenanceContract[]) => void;
  onNavigate: (tab: string) => void;
}

const LOCATIONS: MaintenanceLocation[] = ['Chambres', 'Hall', 'Cuisine', 'Ext√©rieur', 'Spa', 'Technique', 'Autre'];

const MaintenanceView: React.FC<MaintenanceViewProps> = ({ 
  userSettings, userRole, tickets, contracts, onUpdateTickets, onUpdateContracts, onNavigate 
}) => {
  const [activeTab, setActiveTab] = useState<'tickets' | 'contracts'>('tickets');
  
  // --- TICKET STATE ---
  const [showNewTicket, setShowNewTicket] = useState(false);
  const [newTicket, setNewTicket] = useState<{ location: MaintenanceLocation, desc: string, photo: string | null }>({
    location: 'Chambres', desc: '', photo: null
  });
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [filterStatus, setFilterStatus] = useState<'all' | MaintenanceStatus>('all');

  // --- CONTRACT STATE ---
  const [showNewContract, setShowNewContract] = useState(false);
  const [selectedContractId, setSelectedContractId] = useState<string | null>(null);
  const [isEditingContract, setIsEditingContract] = useState(false);
  
  // View Modes
  const [contractViewMode, setContractViewMode] = useState<'list' | 'calendar'>('list');
  const [calendarDate, setCalendarDate] = useState(new Date());

  // Create / Edit Form State
  const [contractForm, setContractForm] = useState<Partial<MaintenanceContract>>({
    status: 'active', subject: '', providerName: '', 
    salesContact: { name: '', phone: '', email: '' },
    technicalContact: { name: '', phone: '' }
  });

  const canManageContracts = userRole === 'admin' || userRole === 'manager';
  const selectedContract = contracts.find(c => c.id === selectedContractId);

  // --- TICKET LOGIC ---
  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 1. Validation
    const MAX_SIZE = 5 * 1024 * 1024; // 5Mo
    if (!file.type.startsWith('image/')) {
        alert("Veuillez s√©lectionner une image valide.");
        return;
    }
    if (file.size > MAX_SIZE) {
        alert("L'image est trop lourde (Max 5Mo).");
        return;
    }

    setIsUploading(true);

    try {
        // 2. Traitement s√©curis√©
        const base64 = await new Promise<string>((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result as string);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        setNewTicket(prev => ({ ...prev, photo: base64 }));
    } catch (error) {
        console.error("Erreur lecture fichier:", error);
        alert("Impossible de lire le fichier. R√©essayez.");
    } finally {
        setIsUploading(false);
        if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const createTicket = () => {
    if (!newTicket.desc) return;
    const ticket: MaintenanceTicket = {
      id: `mt-${Date.now()}`,
      location: newTicket.location,
      description: newTicket.desc,
      status: 'open',
      createdAt: new Date().toISOString(),
      photoUrl: newTicket.photo || undefined
    };
    onUpdateTickets([ticket, ...tickets]);
    setShowNewTicket(false);
    setNewTicket({ location: 'Chambres', desc: '', photo: null });
  };

  const updateTicketStatus = (id: string, status: MaintenanceStatus) => {
    onUpdateTickets(tickets.map(t => t.id === id ? { ...t, status } : t));
  };

  // --- CONTRACT LOGIC ---
  const handleCreateContract = () => {
    if (!contractForm.providerName || !contractForm.subject) return;
    const contract: MaintenanceContract = {
      id: `mc-${Date.now()}`,
      providerName: contractForm.providerName || '',
      subject: contractForm.subject || '',
      contactPhone: contractForm.contactPhone || '',
      contactEmail: contractForm.contactEmail || '',
      status: contractForm.status as ContractStatus || 'active',
      lastIntervention: contractForm.lastIntervention,
      nextIntervention: contractForm.nextIntervention,
      // Enhanced Fields
      address: contractForm.address,
      website: contractForm.website,
      siret: contractForm.siret,
      salesContact: contractForm.salesContact,
      technicalContact: contractForm.technicalContact,
      startDate: contractForm.startDate,
      endDate: contractForm.endDate,
      frequency: contractForm.frequency,
      annualCost: contractForm.annualCost
    };
    onUpdateContracts([...contracts, contract]);
    setShowNewContract(false);
    resetContractForm();
  };

  const handleUpdateContract = () => {
    if (!selectedContractId || !contractForm.providerName) return;
    const updatedContracts = contracts.map(c => c.id === selectedContractId ? { ...c, ...contractForm } as MaintenanceContract : c);
    onUpdateContracts(updatedContracts);
    setIsEditingContract(false);
  };

  const deleteContract = (id: string) => {
    if (confirm("Supprimer ce contrat ?")) {
      onUpdateContracts(contracts.filter(c => c.id !== id));
      if (selectedContractId === id) setSelectedContractId(null);
    }
  };

  const resetContractForm = () => {
    setContractForm({
      status: 'active', subject: '', providerName: '',
      salesContact: { name: '', phone: '', email: '' },
      technicalContact: { name: '', phone: '' }
    });
  };

  const startEditContract = (c: MaintenanceContract) => {
    setContractForm({ ...c });
    setIsEditingContract(true);
  };

  // Calendar Helpers
  const changeMonth = (dir: number) => {
    const newDate = new Date(calendarDate);
    newDate.setMonth(newDate.getMonth() + dir);
    setCalendarDate(newDate);
  };

  const getDaysInMonth = (date: Date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const days = [];
    
    let startDay = firstDay.getDay(); 
    startDay = startDay === 0 ? 6 : startDay - 1; // Mon=0
    for(let i=0; i<startDay; i++) days.push(null);
    
    for(let i=1; i<=lastDay.getDate(); i++) days.push(new Date(year, month, i));
    
    return days;
  };

  // Derived Data for Detail View
  const contractHistory = useMemo(() => {
    if (!selectedContract) return [];
    // Simulate finding linked tickets by matching provider name in description (Basic Search)
    return tickets.filter(t => 
      t.description.toLowerCase().includes(selectedContract.providerName.toLowerCase()) ||
      t.description.toLowerCase().includes(selectedContract.subject.toLowerCase())
    );
  }, [selectedContract, tickets]);

  const getAlertLevel = (dateStr?: string) => {
    if (!dateStr) return 'normal';
    const nextDate = new Date(dateStr);
    const today = new Date();
    const diffTime = nextDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) return 'expired';
    if (diffDays <= 7) return 'urgent';
    return 'normal';
  };

  // Filter & Sort Tickets Logic
  const filteredTickets = useMemo(() => {
    return tickets
      .filter(t => filterStatus === 'all' || t.status === filterStatus)
      .sort((a, b) => {
        // Score: Open (3) > In Progress (2) > Resolved (1)
        const score = (s: string) => s === 'open' ? 3 : s === 'in_progress' ? 2 : 1;
        const scoreDiff = score(b.status) - score(a.status);
        
        // If same status, sort by date (newest first)
        if (scoreDiff !== 0) return scoreDiff;
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      });
  }, [tickets, filterStatus]);

  // --- RENDER HELPERS ---

  const renderContractFormFields = () => (
    <div className="space-y-4">
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="space-y-3">
             <h4 className="text-xs font-black uppercase text-slate-400">Identit√©</h4>
             <input type="text" placeholder="Prestataire *" value={contractForm.providerName} onChange={(e) => setContractForm({...contractForm, providerName: e.target.value})} className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none text-sm font-bold" />
             <input type="text" placeholder="Objet du contrat *" value={contractForm.subject} onChange={(e) => setContractForm({...contractForm, subject: e.target.value})} className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none text-sm font-bold" />
             <input type="text" placeholder="Adresse" value={contractForm.address || ''} onChange={(e) => setContractForm({...contractForm, address: e.target.value})} className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none text-sm" />
             <div className="flex gap-2">
                <input type="text" placeholder="SIRET" value={contractForm.siret || ''} onChange={(e) => setContractForm({...contractForm, siret: e.target.value})} className="flex-1 p-3 rounded-xl bg-white dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none text-sm" />
                <input type="text" placeholder="Site Web" value={contractForm.website || ''} onChange={(e) => setContractForm({...contractForm, website: e.target.value})} className="flex-1 p-3 rounded-xl bg-white dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none text-sm" />
             </div>
          </div>
          <div className="space-y-3">
             <h4 className="text-xs font-black uppercase text-slate-400">Contacts Cl√©s</h4>
             <div className="p-3 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
                <p className="text-[10px] font-bold uppercase text-slate-400 mb-2">Commercial</p>
                <input type="text" placeholder="Nom" value={contractForm.salesContact?.name || ''} onChange={(e) => setContractForm({...contractForm, salesContact: { ...contractForm.salesContact!, name: e.target.value }})} className="w-full mb-2 bg-transparent border-b border-slate-200 dark:border-slate-700 outline-none text-sm" />
                <input type="text" placeholder="T√©l" value={contractForm.salesContact?.phone || ''} onChange={(e) => setContractForm({...contractForm, salesContact: { ...contractForm.salesContact!, phone: e.target.value }})} className="w-full mb-2 bg-transparent border-b border-slate-200 dark:border-slate-700 outline-none text-sm" />
                <input type="text" placeholder="Email" value={contractForm.salesContact?.email || ''} onChange={(e) => setContractForm({...contractForm, salesContact: { ...contractForm.salesContact!, email: e.target.value }})} className="w-full bg-transparent border-b border-slate-200 dark:border-slate-700 outline-none text-sm" />
             </div>
             <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-900">
                <p className="text-[10px] font-bold uppercase text-red-500 mb-2 flex items-center gap-1"><Siren size={12}/> Urgence / Technique</p>
                <input type="text" placeholder="Nom / Service" value={contractForm.technicalContact?.name || ''} onChange={(e) => setContractForm({...contractForm, technicalContact: { ...contractForm.technicalContact!, name: e.target.value }})} className="w-full mb-2 bg-transparent border-b border-red-200 dark:border-red-800 outline-none text-sm placeholder:text-red-300" />
                <input type="text" placeholder="T√©l 24/7" value={contractForm.technicalContact?.phone || ''} onChange={(e) => setContractForm({...contractForm, technicalContact: { ...contractForm.technicalContact!, phone: e.target.value }})} className="w-full bg-transparent border-b border-red-200 dark:border-red-800 outline-none text-sm font-black text-red-600 placeholder:text-red-300" />
             </div>
          </div>
       </div>
       <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-slate-200 dark:border-slate-700">
          <div>
             <label className="text-[9px] font-bold text-slate-400">D√©but</label>
             <input type="date" value={contractForm.startDate || ''} onChange={(e) => setContractForm({...contractForm, startDate: e.target.value})} className="w-full p-2 bg-white dark:bg-slate-900 rounded-lg text-sm font-bold outline-none" />
          </div>
          <div>
             <label className="text-[9px] font-bold text-slate-400">Fin</label>
             <input type="date" value={contractForm.endDate || ''} onChange={(e) => setContractForm({...contractForm, endDate: e.target.value})} className="w-full p-2 bg-white dark:bg-slate-900 rounded-lg text-sm font-bold outline-none" />
          </div>
          <div>
             <label className="text-[9px] font-bold text-slate-400">Prochain Passage</label>
             <input type="date" value={contractForm.nextIntervention || ''} onChange={(e) => setContractForm({...contractForm, nextIntervention: e.target.value})} className="w-full p-2 bg-white dark:bg-slate-900 rounded-lg text-sm font-bold outline-none" />
          </div>
          <div>
             <label className="text-[9px] font-bold text-slate-400">Co√ªt Annuel</label>
             <input type="number" value={contractForm.annualCost || ''} onChange={(e) => setContractForm({...contractForm, annualCost: parseFloat(e.target.value)})} className="w-full p-2 bg-white dark:bg-slate-900 rounded-lg text-sm font-bold outline-none" placeholder="‚Ç¨" />
          </div>
       </div>
    </div>
  );

  return (
    <div className={`h-full flex flex-col overflow-hidden animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* HEADER */}
      <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="flex items-center gap-4">
            <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
              <Wrench size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Maintenance</h2>
              <p className="text-xs font-bold text-slate-400">Technique & S√©curit√©</p>
            </div>
         </div>
         <button 
           onClick={() => onNavigate('dashboard')}
           className="px-4 py-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 font-black text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
         >
           <ArrowRight size={14}/> Retour
         </button>
      </div>

      {/* TABS (Only show if no contract selected) */}
      {!selectedContractId && (
        <div className="px-6 py-4">
           <div className="flex p-1 rounded-2xl bg-slate-200 dark:bg-slate-800 w-fit overflow-x-auto whitespace-nowrap max-w-full no-scrollbar px-2">
              <button 
                onClick={() => setActiveTab('tickets')}
                className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'tickets' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
              >
                <AlertTriangle size={14}/> Interventions
              </button>
              <button 
                onClick={() => setActiveTab('contracts')}
                className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'contracts' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}
              >
                <FileText size={14}/> Contrats & Carnet
              </button>
           </div>
        </div>
      )}

      {/* CONTENT */}
      <div className="flex-1 overflow-y-auto px-6 pb-20 no-scrollbar">
         
         {/* --- TICKETS TAB --- */}
         {activeTab === 'tickets' && !selectedContractId && (
           <div className="space-y-6 pt-4">
              <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                 <h3 className="text-lg font-black uppercase tracking-tight flex items-center gap-2">
                   Interventions
                   <span className="text-xs bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full text-slate-500">{filteredTickets.length}</span>
                 </h3>
                 
                 {/* FILTERS BAR */}
                 <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 w-full md:w-auto">
                    {[
                      { id: 'all', label: 'Tous' },
                      { id: 'open', label: '√Ä faire' },
                      { id: 'in_progress', label: 'En cours' },
                      { id: 'resolved', label: 'Termin√©s' }
                    ].map(filter => (
                      <button 
                        key={filter.id}
                        onClick={() => setFilterStatus(filter.id as any)}
                        className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all border-2 whitespace-nowrap ${
                          filterStatus === filter.id 
                            ? 'border-indigo-600 bg-indigo-50 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-300' 
                            : 'border-slate-100 dark:border-slate-800 text-slate-400 bg-white dark:bg-slate-800 hover:border-slate-200'
                        }`}
                      >
                        {filter.label}
                      </button>
                    ))}
                 </div>

                 <button 
                   onClick={() => setShowNewTicket(true)}
                   className="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold text-xs uppercase flex items-center gap-2 shadow-lg hover:bg-slate-800 transition-colors whitespace-nowrap"
                 >
                    <Plus size={14}/> Cr√©er Ticket
                 </button>
              </div>

              {/* Ticket Creation Form */}
              {showNewTicket && (
                <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-3xl animate-in fade-in slide-in-from-top-4 border-2 border-dashed border-slate-300 dark:border-slate-700">
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                         <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Lieu</label>
                         <select 
                           value={newTicket.location}
                           onChange={(e) => setNewTicket({...newTicket, location: e.target.value as MaintenanceLocation})}
                           className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 font-bold text-sm outline-none"
                         >
                            {LOCATIONS.map(l => <option key={l} value={l}>{l}</option>)}
                         </select>
                      </div>
                      <div>
                         <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Photo (Optionnel)</label>
                         <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                         <button 
                           onClick={() => fileInputRef.current?.click()}
                           disabled={isUploading}
                           className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 font-bold text-xs text-slate-500 flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors disabled:opacity-50"
                         >
                            {isUploading ? <Loader2 size={14} className="animate-spin" /> : (newTicket.photo ? <Check size={14} className="text-green-500"/> : <Camera size={14}/>)}
                            {isUploading ? 'Traitement...' : (newTicket.photo ? 'Photo ajout√©e' : 'Ajouter photo')}
                         </button>
                      </div>
                   </div>
                   <textarea 
                     placeholder="Description du probl√®me (ex: Fuite d'eau sous lavabo...)"
                     value={newTicket.desc}
                     onChange={(e) => setNewTicket({...newTicket, desc: e.target.value})}
                     className="w-full p-3 rounded-xl bg-white dark:bg-slate-900 font-bold text-sm outline-none resize-none h-20 mb-3"
                   />
                   <div className="flex justify-end gap-2">
                      <button onClick={() => setShowNewTicket(false)} className="px-4 py-2 text-xs font-bold text-slate-500">Annuler</button>
                      <button onClick={createTicket} className="px-6 py-2 bg-violet-600 text-white rounded-xl text-xs font-black uppercase shadow-lg">Valider</button>
                   </div>
                </div>
              )}

              {/* Tickets Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 {filteredTickets.map(ticket => (
                   <div key={ticket.id} className={`group p-4 rounded-3xl border transition-all ${ticket.status === 'resolved' ? 'opacity-60 grayscale hover:grayscale-0 hover:opacity-100 bg-slate-50 dark:bg-slate-800/50' : 'bg-white dark:bg-slate-800 shadow-sm'} ${userSettings.darkMode ? 'border-slate-700' : 'border-slate-100'}`}>
                      <div className="flex gap-4">
                         {/* Photo or Icon */}
                         <div className="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-900 overflow-hidden flex-shrink-0 border border-slate-200 dark:border-slate-700 relative">
                            {ticket.photoUrl ? (
                              <img src={ticket.photoUrl} alt="Preuve" className="w-full h-full object-cover" />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center text-slate-300">
                                <Wrench size={24}/>
                              </div>
                            )}
                         </div>
                         
                         <div className="flex-1 min-w-0 flex flex-col justify-between">
                            <div>
                               <div className="flex justify-between items-start">
                                  <span className="text-[9px] font-black uppercase tracking-widest text-slate-400 bg-slate-50 dark:bg-slate-700 px-2 py-0.5 rounded mb-1 inline-block">{ticket.location}</span>
                                  <span className="text-[9px] text-slate-300 font-medium">{new Date(ticket.createdAt).toLocaleDateString()}</span>
                               </div>
                               <p className="font-bold text-sm leading-snug line-clamp-2">{ticket.description}</p>
                            </div>
                            
                            <div className="mt-2">
                               <select 
                                 value={ticket.status}
                                 onChange={(e) => updateTicketStatus(ticket.id, e.target.value as MaintenanceStatus)}
                                 className={`w-full p-2 rounded-xl text-[10px] font-black uppercase outline-none border-2 cursor-pointer transition-colors appearance-none text-center ${
                                   ticket.status === 'open' ? 'border-red-200 text-red-600 bg-red-50 dark:bg-red-900/20 dark:border-red-800 hover:bg-red-100' :
                                   ticket.status === 'in_progress' ? 'border-orange-200 text-orange-600 bg-orange-50 dark:bg-orange-900/20 dark:border-orange-800 hover:bg-orange-100' :
                                   'border-emerald-200 text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 dark:border-emerald-800 hover:bg-emerald-100'
                                 }`}
                               >
                                 <option value="open">üî¥ Pas commenc√©</option>
                                 <option value="in_progress">üü† En cours</option>
                                 <option value="resolved">üü¢ Termin√©</option>
                               </select>
                            </div>
                         </div>
                      </div>
                   </div>
                 ))}
                 {filteredTickets.length === 0 && (
                   <div className="col-span-full py-12 text-center opacity-40">
                      <Wrench size={48} className="mx-auto mb-4 text-slate-400"/>
                      <p className="font-bold text-slate-500">Aucun ticket correspondant trouv√©.</p>
                   </div>
                 )}
              </div>
           </div>
         )}

         {/* --- CONTRACTS TAB (LIST VIEW) --- */}
         {activeTab === 'contracts' && !selectedContractId && (
           <div className="space-y-6 pt-4">
              <div className="flex justify-between items-center">
                 <h3 className="text-lg font-black uppercase tracking-tight flex items-center gap-2">
                   R√©pertoire Prestataires
                 </h3>
                 <div className="flex items-center gap-2">
                    {/* TOGGLE VIEW */}
                    <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mr-2">
                        <button onClick={() => setContractViewMode('list')} className={`p-2 rounded-lg transition-all ${contractViewMode === 'list' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}>
                            <LayoutList size={16}/>
                        </button>
                        <button onClick={() => setContractViewMode('calendar')} className={`p-2 rounded-lg transition-all ${contractViewMode === 'calendar' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}>
                            <CalendarDays size={16}/>
                        </button>
                    </div>

                    {canManageContracts && (
                    <button 
                        onClick={() => setShowNewContract(true)}
                        className="px-4 py-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-xs uppercase flex items-center gap-2 transition-colors"
                    >
                        <Plus size={14}/> Ajouter Contrat
                    </button>
                    )}
                 </div>
              </div>

              {/* NEW CONTRACT FORM (Simplified Inline) */}
              {showNewContract && (
                <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-3xl animate-in fade-in slide-in-from-top-4 border-2 border-dashed border-slate-300 dark:border-slate-700 mb-6">
                   <h4 className="text-xs font-black uppercase text-slate-500 mb-3">Nouveau Prestataire (Rapide)</h4>
                   {renderContractFormFields()}
                   <div className="flex justify-end gap-2 mt-4">
                      <button onClick={() => { setShowNewContract(false); resetContractForm(); }} className="px-4 py-2 text-xs font-bold text-slate-500">Annuler</button>
                      <button onClick={handleCreateContract} className="px-6 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black uppercase shadow-lg">Ajouter</button>
                   </div>
                </div>
              )}

              {/* VUE LISTE */}
              {contractViewMode === 'list' && (
                <div className="space-y-3">
                    {contracts.map(contract => {
                    const alertLevel = getAlertLevel(contract.nextIntervention);
                    return (
                        <div 
                        key={contract.id} 
                        onClick={() => setSelectedContractId(contract.id)}
                        className={`p-4 rounded-3xl border flex flex-col md:flex-row items-start md:items-center gap-4 hover:shadow-lg hover:scale-[1.01] cursor-pointer transition-all ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-750' : 'bg-white border-slate-100 hover:border-slate-200'}`}
                        >
                            {/* Status Icon */}
                            <div className={`p-3 rounded-2xl flex-shrink-0 ${contract.status === 'active' ? 'bg-emerald-100 text-emerald-600' : contract.status === 'renew' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-400'}`}>
                            <Building2 size={20}/>
                            </div>

                            {/* Info */}
                            <div className="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-3 gap-4 w-full items-center">
                            <div>
                                <h4 className="font-black text-sm">{contract.providerName}</h4>
                                <p className="text-xs text-slate-500 font-medium">{contract.subject}</p>
                            </div>

                            {/* Next Intervention */}
                            <div className="flex items-center gap-3">
                                <Calendar size={16} className={`shrink-0 ${alertLevel === 'urgent' || alertLevel === 'expired' ? 'text-red-500' : 'text-slate-400'}`}/>
                                <div className="flex flex-col">
                                    <span className={`text-[9px] font-bold uppercase ${alertLevel === 'urgent' || alertLevel === 'expired' ? 'text-red-500' : 'text-slate-400'}`}>Prochain Passage</span>
                                    <span className={`text-xs font-bold ${alertLevel === 'urgent' || alertLevel === 'expired' ? 'text-red-600' : ''}`}>
                                    {contract.nextIntervention ? new Date(contract.nextIntervention).toLocaleDateString() : '-'}
                                    </span>
                                </div>
                            </div>

                            {/* Status Badge & Arrow */}
                            <div className="flex items-center justify-between md:justify-end gap-3">
                                <span className={`px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${
                                    contract.status === 'active' ? 'bg-emerald-50 text-emerald-600' :
                                    contract.status === 'renew' ? 'bg-amber-50 text-amber-600' :
                                    'bg-slate-100 text-slate-500'
                                }`}>
                                    {contract.status === 'active' ? 'Actif' : contract.status === 'renew' ? '√Ä Renouveler' : 'R√©sili√©'}
                                </span>
                                <ChevronLeft size={16} className="text-slate-300 rotate-180"/>
                            </div>
                            </div>
                        </div>
                    );
                    })}
                    {contracts.length === 0 && (
                    <div className="text-center py-12 opacity-40">
                        <FileText size={48} className="mx-auto mb-4 text-slate-400"/>
                        <p className="font-bold text-slate-500">Aucun contrat enregistr√©.</p>
                    </div>
                    )}
                </div>
              )}

              {/* VUE CALENDRIER */}
              {contractViewMode === 'calendar' && (
                <div className="bg-white dark:bg-slate-800 rounded-[32px] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm">
                    {/* Calendar Header */}
                    <div className="flex justify-between items-center p-4 border-b border-slate-100 dark:border-slate-700">
                        <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><ChevronLeft size={16}/></button>
                        <h4 className="font-black text-sm uppercase">{calendarDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h4>
                        <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><ChevronRight size={16}/></button>
                    </div>

                    <div className="grid grid-cols-7 text-center border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                        {['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].map(d => (
                            <div key={d} className="py-2 text-[10px] font-black uppercase text-slate-400">{d}</div>
                        ))}
                    </div>

                    <div className="grid grid-cols-7 auto-rows-fr">
                        {getDaysInMonth(calendarDate).map((date, idx) => {
                            if (!date) return <div key={`empty-${idx}`} className="min-h-[100px] border-b border-r border-slate-100 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-800/20"></div>;
                            
                            const dateStr = date.toISOString().split('T')[0];
                            const interventions = contracts.filter(c => c.nextIntervention === dateStr);
                            const expirations = contracts.filter(c => c.endDate === dateStr);
                            
                            return (
                                <div key={idx} className="min-h-[100px] border-b border-r border-slate-100 dark:border-slate-700 p-1 relative hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                    <span className={`text-xs font-bold p-1 block ${date.toDateString() === new Date().toDateString() ? 'text-indigo-600' : 'text-slate-400'}`}>
                                        {date.getDate()}
                                    </span>
                                    <div className="space-y-1">
                                        {interventions.map(c => (
                                            <div 
                                                key={`int-${c.id}`} 
                                                onClick={() => setSelectedContractId(c.id)}
                                                className="text-[8px] font-bold bg-indigo-100 text-indigo-700 px-1 py-0.5 rounded truncate cursor-pointer hover:opacity-80"
                                                title={`Passage : ${c.providerName}`}
                                            >
                                                üîß {c.providerName}
                                            </div>
                                        ))}
                                        {expirations.map(c => (
                                            <div 
                                                key={`exp-${c.id}`} 
                                                onClick={() => setSelectedContractId(c.id)}
                                                className="text-[8px] font-bold bg-red-100 text-red-700 px-1 py-0.5 rounded truncate cursor-pointer hover:opacity-80"
                                                title={`Fin contrat : ${c.providerName}`}
                                            >
                                                üèÅ Fin: {c.providerName}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
              )}
           </div>
         )}

         {/* --- DETAILED CONTRACT VIEW --- */}
         {selectedContractId && selectedContract && (
           <div className="h-full pt-4 animate-in slide-in-from-right-10">
              
              {/* Detail Header */}
              <div className="flex items-center gap-4 mb-6">
                 <button 
                   onClick={() => { setSelectedContractId(null); setIsEditingContract(false); }}
                   className="p-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-400 hover:text-slate-600 hover:border-slate-300 transition-colors"
                 >
                    <ArrowLeft size={18}/>
                 </button>
                 <div className="flex-1">
                    <h3 className="text-2xl font-black">{selectedContract.providerName}</h3>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{selectedContract.subject}</p>
                 </div>
                 {canManageContracts && (
                   <div className="flex gap-2">
                      <button onClick={() => deleteContract(selectedContract.id)} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={20}/></button>
                      <button onClick={() => startEditContract(selectedContract)} className="p-2 text-slate-300 hover:text-indigo-500 transition-colors"><Edit3 size={20}/></button>
                   </div>
                 )}
              </div>

              {isEditingContract ? (
                <div className="bg-white dark:bg-slate-800 p-6 rounded-[32px] shadow-lg border border-slate-100 dark:border-slate-700">
                   <h4 className="text-lg font-black mb-4">√âditer le profil prestataire</h4>
                   {renderContractFormFields()}
                   <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100 dark:border-slate-700">
                      <button onClick={() => setIsEditingContract(false)} className="px-6 py-3 rounded-xl font-bold text-xs uppercase text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700">Annuler</button>
                      <button onClick={handleUpdateContract} className="px-8 py-3 rounded-xl bg-indigo-600 text-white font-black text-xs uppercase shadow-lg hover:bg-indigo-700 flex items-center gap-2">
                         <Save size={16}/> Enregistrer
                      </button>
                   </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                   
                   {/* Left Col: Info & Contacts */}
                   <div className="space-y-6">
                      
                      {/* Identity Card */}
                      <div className={`p-6 rounded-[32px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                         <div className="flex justify-between items-start mb-4">
                            <div className="p-4 bg-slate-50 dark:bg-slate-700 rounded-2xl">
                               <Building2 size={32} className="text-slate-400"/>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${
                                selectedContract.status === 'active' ? 'bg-emerald-100 text-emerald-600' :
                                selectedContract.status === 'renew' ? 'bg-amber-100 text-amber-600' :
                                'bg-slate-100 text-slate-500'
                              }`}>
                                {selectedContract.status === 'active' ? 'Actif' : selectedContract.status === 'renew' ? '√Ä Renouveler' : 'R√©sili√©'}
                            </span>
                         </div>
                         <div className="space-y-2 text-sm">
                            {selectedContract.address && <p className="font-bold text-slate-700 dark:text-slate-200">{selectedContract.address}</p>}
                            {selectedContract.website && (
                              <a href={selectedContract.website.startsWith('http') ? selectedContract.website : `https://${selectedContract.website}`} target="_blank" rel="noreferrer" className="flex items-center gap-2 text-indigo-500 font-bold hover:underline">
                                <Globe size={14}/> Site Web
                              </a>
                            )}
                            {selectedContract.siret && <p className="text-xs text-slate-400">SIRET: {selectedContract.siret}</p>}
                         </div>
                      </div>

                      {/* Contacts Card */}
                      <div className={`p-6 rounded-[32px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                         <h4 className="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Contacts Cl√©s</h4>
                         
                         <div className="space-y-4">
                            {/* Commercial */}
                            <div className="p-3 rounded-2xl bg-slate-50 dark:bg-slate-700/50 border border-slate-100 dark:border-slate-700">
                               <p className="text-[9px] font-black uppercase text-slate-400 mb-1">Commercial</p>
                               <p className="font-bold text-sm">{selectedContract.salesContact?.name || selectedContract.providerName}</p>
                               <div className="flex gap-2 mt-2">
                                  {selectedContract.salesContact?.phone && (
                                    <a href={`tel:${selectedContract.salesContact.phone}`} className="flex-1 py-1.5 rounded-lg bg-white dark:bg-slate-600 text-center text-xs font-bold text-slate-600 dark:text-slate-200 shadow-sm border border-slate-100 dark:border-slate-500"><Phone size={12} className="inline mr-1"/> Appeler</a>
                                  )}
                                  {selectedContract.salesContact?.email && (
                                    <a href={`mailto:${selectedContract.salesContact.email}`} className="flex-1 py-1.5 rounded-lg bg-white dark:bg-slate-600 text-center text-xs font-bold text-slate-600 dark:text-slate-200 shadow-sm border border-slate-100 dark:border-slate-500"><Mail size={12} className="inline mr-1"/> Email</a>
                                  )}
                               </div>
                            </div>

                            {/* Technical / Emergency */}
                            <div className="p-3 rounded-2xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/50">
                               <p className="text-[9px] font-black uppercase text-red-400 mb-1 flex items-center gap-1"><Siren size={10}/> Urgence Technique</p>
                               <p className="font-bold text-sm text-red-900 dark:text-red-100">{selectedContract.technicalContact?.name || 'Astreinte'}</p>
                               {selectedContract.technicalContact?.phone ? (
                                 <a href={`tel:${selectedContract.technicalContact.phone}`} className="block mt-2 py-2 rounded-lg bg-red-500 text-white text-center text-sm font-black shadow-md hover:bg-red-600 transition-colors">
                                    <Phone size={14} className="inline mr-2"/> {selectedContract.technicalContact.phone}
                                 </a>
                               ) : (
                                 <p className="text-xs text-red-400 italic mt-1">Num√©ro non renseign√©</p>
                               )}
                            </div>
                         </div>
                      </div>
                   </div>

                   {/* Right Col: Contract Details & History */}
                   <div className="lg:col-span-2 space-y-6">
                      
                      {/* Contract Specs */}
                      <div className={`p-6 rounded-[32px] border shadow-sm ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                         <h4 className="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest flex items-center gap-2"><FileSignature size={14}/> D√©tails du contrat</h4>
                         <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                               <p className="text-[9px] text-slate-400 uppercase font-bold">D√©but</p>
                               <p className="font-bold text-sm">{selectedContract.startDate ? new Date(selectedContract.startDate).toLocaleDateString() : '-'}</p>
                            </div>
                            <div className="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                               <p className="text-[9px] text-slate-400 uppercase font-bold">Fin</p>
                               <p className="font-bold text-sm">{selectedContract.endDate ? new Date(selectedContract.endDate).toLocaleDateString() : '-'}</p>
                            </div>
                            <div className="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                               <p className="text-[9px] text-slate-400 uppercase font-bold">Fr√©quence</p>
                               <p className="font-bold text-sm">{selectedContract.frequency || '-'}</p>
                            </div>
                            <div className="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                               <p className="text-[9px] text-slate-400 uppercase font-bold">Co√ªt Annuel</p>
                               <p className="font-bold text-sm">{selectedContract.annualCost ? `${selectedContract.annualCost} ‚Ç¨` : '-'}</p>
                            </div>
                         </div>
                      </div>

                      {/* Intervention History */}
                      <div className={`p-6 rounded-[32px] border shadow-sm flex-1 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                         <div className="flex justify-between items-center mb-4">
                            <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2"><Clock size={14}/> Historique Interventions</h4>
                            <span className="text-[9px] font-bold bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500">{contractHistory.length}</span>
                         </div>
                         
                         <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            {contractHistory.map(ticket => (
                              <div key={ticket.id} className="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                                 <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 ${ticket.status === 'resolved' ? 'bg-emerald-500' : 'bg-amber-500'}`} />
                                 <div>
                                    <p className="text-xs font-bold text-slate-700 dark:text-slate-200 line-clamp-2">{ticket.description}</p>
                                    <p className="text-[9px] text-slate-400 mt-1">{new Date(ticket.createdAt).toLocaleDateString()} ‚Ä¢ {ticket.location}</p>
                                 </div>
                              </div>
                            ))}
                            {contractHistory.length === 0 && (
                              <p className="text-xs text-slate-400 italic text-center py-4">Aucune intervention li√©e trouv√©e.</p>
                            )}
                         </div>
                      </div>

                   </div>
                </div>
              )}
           </div>
         )}

      </div>
    </div>
  );
};

export default MaintenanceView;
import React, { Component, useState, useRef, useEffect, useMemo, ErrorInfo, ReactNode } from 'react';
import { ChatChannel, ChatMessage, Contact, UserSettings, UserProfile, Attachment } from '../types';
import { 
  Send, Plus, Search, Paperclip, MoreVertical, Hash, User, 
  CheckSquare, Smile, X, Image as ImageIcon, MessageSquare, 
  LogOut, Trash2, Info, FileImage, Shield, UserPlus, MinusCircle,
  AlertTriangle, Loader2, RefreshCw, ArrowLeft, Download
} from 'lucide-react';

interface MessagingViewProps {
  channels: ChatChannel[];
  onUpdateChannels: (channels: ChatChannel[]) => void;
  users: UserProfile[]; 
  contacts: Contact[]; 
  userSettings: UserSettings;
  currentUser: UserProfile | null;
  onSendMessage: (channelId: string, message: ChatMessage) => void;
  onCreateTask: (text: string) => void;
}

// --- ERROR BOUNDARY COMPONENT ---
interface ErrorBoundaryProps {
  children?: ReactNode;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

class MessagingErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {
  public state: ErrorBoundaryState = { hasError: false, error: null };

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error("MessagingView Crashed:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="h-full flex flex-col items-center justify-center p-8 text-center bg-slate-50 dark:bg-slate-900 animate-in fade-in">
          <AlertTriangle size={48} className="text-red-500 mb-4" />
          <h2 className="text-xl font-black text-slate-800 dark:text-white mb-2">Oups !</h2>
          <p className="text-sm text-slate-500 mb-6">Le module de messagerie a rencontr√© un probl√®me.</p>
          <button 
            onClick={() => { this.setState({ hasError: false, error: null }); window.location.reload(); }}
            className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs uppercase shadow-lg"
          >
            Recharger
          </button>
        </div>
      );
    }
    return this.props.children;
  }
}

// --- MAIN CONTENT COMPONENT ---
const MessagingContent: React.FC<MessagingViewProps> = ({ 
  channels = [], 
  onUpdateChannels, 
  users = [], 
  userSettings, 
  currentUser, 
  onSendMessage, 
  onCreateTask 
}) => {
  const safeChannels = useMemo(() => Array.isArray(channels) ? channels : [], [channels]);
  const safeUsers = useMemo(() => Array.isArray(users) ? users : [], [users]);

  // Loading State
  if (!channels && !users) {
     return (
        <div className="h-full flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900">
           <Loader2 size={40} className="text-indigo-500 animate-spin mb-4" />
           <p className="text-sm font-bold text-slate-500 uppercase tracking-widest">Chargement...</p>
        </div>
     );
  }

  const [selectedChannelId, setSelectedChannelId] = useState<string | null>(null);
  const [inputText, setInputText] = useState('');
  const [showNewChannelModal, setShowNewChannelModal] = useState(false);
  const [search, setSearch] = useState('');
  const [isMobileList, setIsMobileList] = useState(true); 
  const [isUploading, setIsUploading] = useState(false);
  
  // Options & Modals State
  const [showOptionsDropdown, setShowOptionsDropdown] = useState(false);
  const [showGroupInfoModal, setShowGroupInfoModal] = useState(false);
  const [showMediaModal, setShowMediaModal] = useState(false);
  const [showUserProfileModal, setShowUserProfileModal] = useState<UserProfile | null>(null);

  // New Channel Form
  const [newChannelName, setNewChannelName] = useState('');
  const [newChannelType, setNewChannelType] = useState<'group' | 'direct'>('group');
  const [selectedMembers, setSelectedMembers] = useState<string[]>([]);

  // Refs
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);

  const activeChannel = safeChannels.find(c => c.id === selectedChannelId);
  const potentialDMs = safeUsers.filter(u => u.uid !== currentUser?.uid);
  const canManageGroup = currentUser?.role === 'admin' || currentUser?.role === 'manager';

  // --- DERIVED DATA ---
  const filteredChannels = safeChannels.filter(c => (c.name || '').toLowerCase().includes(search.toLowerCase()));
  
  const groupMembers = useMemo(() => {
    if (!activeChannel) return [];
    return safeUsers.filter(u => activeChannel.participants.includes(u.uid));
  }, [activeChannel, safeUsers]);

  const nonMembers = useMemo(() => {
    if (!activeChannel) return [];
    return safeUsers.filter(u => !activeChannel.participants.includes(u.uid));
  }, [activeChannel, safeUsers]);

  const channelMedia = useMemo(() => {
    if (!activeChannel) return [];
    const media: Attachment[] = [];
    activeChannel.messages?.forEach(m => {
      if (m.attachments) media.push(...m.attachments);
    });
    return media;
  }, [activeChannel]);

  // --- EFFECTS ---
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setShowOptionsDropdown(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    if (selectedChannelId && activeChannel) {
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      if (activeChannel.unreadCount > 0) {
        const updated = safeChannels.map(c => c.id === selectedChannelId ? { ...c, unreadCount: 0 } : c);
        onUpdateChannels(updated);
      }
    }
  }, [selectedChannelId, activeChannel?.messages?.length]);

  // --- HANDLERS ---
  const handleSend = () => {
    if ((!inputText.trim()) || !selectedChannelId || !currentUser) return;
    const newMessage: ChatMessage = {
      id: `msg-${Date.now()}`,
      senderId: currentUser.uid,
      senderName: currentUser.displayName,
      text: inputText,
      timestamp: new Date().toISOString(),
      reactions: []
    };
    onSendMessage(selectedChannelId, newMessage);
    setInputText('');
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !selectedChannelId || !currentUser) return;

    if (file.size > 5 * 1024 * 1024) {
      alert("Fichier trop volumineux (Max 5 Mo).");
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }

    setIsUploading(true);
    try {
      const base64 = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result as string);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const attachment: Attachment = {
        id: `att-${Date.now()}`,
        name: file.name,
        type: file.type,
        url: base64
      };
      
      const newMessage: ChatMessage = {
        id: `msg-${Date.now()}`,
        senderId: currentUser.uid,
        senderName: currentUser.displayName,
        text: "Pi√®ce jointe",
        timestamp: new Date().toISOString(),
        attachments: [attachment],
        reactions: []
      };
      onSendMessage(selectedChannelId, newMessage);
    } catch (error) {
      console.error("Erreur upload:", error);
      alert("√âchec de l'envoi du fichier.");
    } finally {
      setIsUploading(false);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const handleCreateChannel = () => {
    if (!newChannelName && newChannelType === 'group') return;
    
    if (newChannelType === 'direct') {
       const existing = safeChannels.find(c => c.type === 'direct' && c.participants.includes(selectedMembers[0]));
       if (existing) {
         setSelectedChannelId(existing.id);
         setIsMobileList(false);
         setShowNewChannelModal(false);
         return;
       }
    }

    const newChannel: ChatChannel = {
      id: `ch-${Date.now()}`,
      type: newChannelType,
      name: newChannelName || safeUsers.find(u => u.uid === selectedMembers[0])?.displayName || 'Chat',
      participants: [...selectedMembers, currentUser?.uid || ''],
      messages: [],
      unreadCount: 0,
      lastUpdate: new Date().toISOString(),
      isOnline: Math.random() > 0.5
    };

    onUpdateChannels([newChannel, ...safeChannels]);
    setSelectedChannelId(newChannel.id);
    setIsMobileList(false);
    setShowNewChannelModal(false);
    setNewChannelName('');
    setSelectedMembers([]);
  };

  const handleLeaveGroup = () => {
    if (!activeChannel || !currentUser) return;
    if (window.confirm("Voulez-vous vraiment quitter ce groupe ?")) {
      const updatedChannels = safeChannels.filter(c => c.id !== activeChannel.id); 
      onUpdateChannels(updatedChannels);
      setSelectedChannelId(null);
      setIsMobileList(true);
    }
  };

  const handleClearConversation = () => {
    if (!activeChannel) return;
    if (window.confirm("Effacer tout l'historique de cette conversation ?")) {
      const updatedChannels = safeChannels.map(c => c.id === activeChannel.id ? { ...c, messages: [], lastMessage: '' } : c);
      onUpdateChannels(updatedChannels);
    }
  };

  const handleAddMember = (uid: string) => {
    if (!activeChannel) return;
    if (!activeChannel.participants.includes(uid)) {
      const updatedChannel = { ...activeChannel, participants: [...activeChannel.participants, uid] };
      onUpdateChannels(safeChannels.map(c => c.id === activeChannel.id ? updatedChannel : c));
    }
  };

  const handleRemoveMember = (uid: string) => {
    if (!activeChannel) return;
    const updatedChannel = { ...activeChannel, participants: activeChannel.participants.filter(id => id !== uid) };
    onUpdateChannels(safeChannels.map(c => c.id === activeChannel.id ? updatedChannel : c));
  };

  const handleReaction = (msgId: string, emoji: string) => {
    if (!activeChannel) return;
    const updatedMessages = activeChannel.messages.map(msg => {
      if (msg.id === msgId) {
        const existingReaction = msg.reactions?.find(r => r.emoji === emoji);
        let newReactions = msg.reactions || [];
        if (existingReaction) {
          newReactions = newReactions.map(r => r.emoji === emoji ? { ...r, count: r.count + 1 } : r);
        } else {
          newReactions = [...newReactions, { emoji, count: 1, users: [currentUser?.uid || ''] }];
        }
        return { ...msg, reactions: newReactions };
      }
      return msg;
    });
    const updatedChannels = safeChannels.map(c => c.id === activeChannel.id ? { ...c, messages: updatedMessages } : c);
    onUpdateChannels(updatedChannels);
  };

  return (
    <div className="flex h-full w-full bg-white dark:bg-slate-950 overflow-hidden relative">
      
      {/* --- SIDEBAR (Liste Conversations) --- */}
      <div className={`
        flex-col border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 h-full transition-all duration-300
        ${isMobileList ? 'flex w-full' : 'hidden'} md:flex md:w-80 lg:w-96
      `}>
         {/* Sidebar Header */}
         <div className="p-4 border-b border-slate-100 dark:border-slate-800">
            <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-black text-slate-900 dark:text-white">Discussions</h2>
               <button 
                 onClick={() => setShowNewChannelModal(true)}
                 className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-full hover:bg-indigo-100 transition-colors"
               >
                 <Plus size={20}/>
               </button>
            </div>
            <div className="flex items-center px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl border border-transparent focus-within:border-indigo-500 transition-all">
               <Search size={16} className="text-slate-400 mr-2"/>
               <input 
                 type="text" 
                 placeholder="Rechercher..." 
                 value={search}
                 onChange={(e) => setSearch(e.target.value)}
                 className="bg-transparent outline-none text-xs font-bold w-full text-slate-900 dark:text-white placeholder:text-slate-400"
               />
            </div>
         </div>

         {/* Channel List */}
         <div className="flex-1 overflow-y-auto p-2 space-y-1">
            {filteredChannels.map(channel => {
              const isSelected = selectedChannelId === channel.id;
              const isGroup = channel.type === 'group';
              return (
                <div 
                  key={channel.id}
                  onClick={() => { setSelectedChannelId(channel.id); setIsMobileList(false); }}
                  className={`p-3 rounded-2xl cursor-pointer flex items-center gap-3 transition-colors ${isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                >
                   {/* Avatar */}
                   <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 font-bold text-sm shadow-sm relative ${isGroup ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-200'}`}>
                      {isGroup ? <Hash size={20}/> : channel.name.slice(0, 2).toUpperCase()}
                      {!isGroup && channel.isOnline && <span className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-slate-900 rounded-full"></span>}
                   </div>
                   
                   {/* Info */}
                   <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-center mb-0.5">
                         <h3 className={`font-bold text-sm truncate ${isSelected ? 'text-indigo-900 dark:text-indigo-100' : 'text-slate-900 dark:text-white'}`}>{channel.name}</h3>
                         <span className="text-[10px] text-slate-400">{new Date(channel.lastUpdate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                      </div>
                      <div className="flex justify-between items-center">
                         <p className={`text-xs truncate ${channel.unreadCount > 0 ? 'font-bold text-slate-800 dark:text-slate-200' : 'text-slate-500 dark:text-slate-400'}`}>
                           {channel.lastMessage || (channel.type === 'group' ? 'Discussion de groupe' : 'Nouvelle discussion')}
                         </p>
                         {channel.unreadCount > 0 && (
                           <span className="min-w-[1.25rem] h-5 flex items-center justify-center bg-indigo-600 text-white text-[10px] font-bold rounded-full px-1.5 ml-2">
                             {channel.unreadCount}
                           </span>
                         )}
                      </div>
                   </div>
                </div>
              );
            })}
            
            {filteredChannels.length === 0 && (
              <div className="flex flex-col items-center justify-center h-40 text-slate-400 opacity-60">
                 <MessageSquare size={32} className="mb-2"/>
                 <p className="text-xs font-bold">Aucune discussion</p>
              </div>
            )}
         </div>
      </div>

      {/* --- CHAT AREA --- */}
      <div className={`
        flex-1 flex-col h-full bg-slate-50 dark:bg-slate-950 relative transition-all duration-300
        ${!isMobileList ? 'flex w-full' : 'hidden md:flex'}
      `}>
         {activeChannel ? (
           <>
             {/* Chat Header */}
             <div className="h-16 px-4 flex items-center justify-between bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm z-20 shrink-0">
                <div className="flex items-center gap-3">
                   <button 
                     onClick={() => setIsMobileList(true)}
                     className="md:hidden p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500"
                   >
                      <ArrowLeft size={20}/>
                   </button>
                   <div className="flex items-center gap-3 cursor-pointer" onClick={() => activeChannel.type === 'group' ? setShowGroupInfoModal(true) : null}>
                      {activeChannel.type === 'group' ? (
                        <div className="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600"><Hash size={20}/></div>
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center font-bold text-sm text-slate-600 dark:text-slate-200">
                           {activeChannel.name.slice(0, 2).toUpperCase()}
                        </div>
                      )}
                      <div>
                         <h3 className="font-bold text-sm text-slate-900 dark:text-white leading-tight">{activeChannel.name}</h3>
                         <p className="text-[10px] font-medium text-slate-500 dark:text-slate-400">
                           {activeChannel.type === 'group' ? `${activeChannel.participants.length} membres` : (activeChannel.isOnline ? 'En ligne' : 'Absent')}
                         </p>
                      </div>
                   </div>
                </div>

                <div className="relative" ref={dropdownRef}>
                   <button 
                     onClick={() => setShowOptionsDropdown(!showOptionsDropdown)}
                     className="p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
                   >
                     <MoreVertical size={20}/>
                   </button>
                   
                   {/* Dropdown Menu */}
                   {showOptionsDropdown && (
                     <div className="absolute right-0 top-full mt-2 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-50 animate-in fade-in zoom-in-95 origin-top-right">
                        {activeChannel.type === 'group' ? (
                          <>
                            <button onClick={() => { setShowGroupInfoModal(true); setShowOptionsDropdown(false); }} className="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-xs font-bold text-slate-700 dark:text-slate-200">
                               <Info size={16}/> Infos du groupe
                            </button>
                            <button onClick={() => { setShowMediaModal(true); setShowOptionsDropdown(false); }} className="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-xs font-bold text-slate-700 dark:text-slate-200">
                               <FileImage size={16}/> M√©dias & Documents
                            </button>
                            <div className="h-px bg-slate-100 dark:bg-slate-700 mx-2"></div>
                            <button onClick={() => { handleLeaveGroup(); setShowOptionsDropdown(false); }} className="w-full text-left px-4 py-3 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 text-xs font-bold text-red-500">
                               <LogOut size={16}/> Quitter le groupe
                            </button>
                          </>
                        ) : (
                          <>
                            <button onClick={() => { setShowMediaModal(true); setShowOptionsDropdown(false); }} className="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-xs font-bold text-slate-700 dark:text-slate-200">
                               <FileImage size={16}/> M√©dias partag√©s
                            </button>
                            <div className="h-px bg-slate-100 dark:bg-slate-700 mx-2"></div>
                            <button onClick={() => { handleClearConversation(); setShowOptionsDropdown(false); }} className="w-full text-left px-4 py-3 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 text-xs font-bold text-red-500">
                               <Trash2 size={16}/> Effacer conversation
                            </button>
                          </>
                        )}
                     </div>
                   )}
                </div>
             </div>

             {/* Messages List Area */}
             <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 dark:bg-slate-950">
                {(activeChannel.messages || []).map((msg, idx) => {
                  const isMe = msg.senderId === currentUser?.uid;
                  const showAvatar = !isMe && (idx === 0 || activeChannel.messages[idx-1]?.senderId !== msg.senderId);
                  
                  return (
                    <div key={msg.id} className={`flex group w-full ${isMe ? 'justify-end' : 'justify-start'}`}>
                       
                       {/* Avatar for Others */}
                       {!isMe && (
                         <div className="w-8 mr-2 flex-shrink-0 flex flex-col justify-end">
                            {showAvatar ? (
                              <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center font-bold text-[10px] text-slate-600 dark:text-slate-300">
                                 {msg.senderName?.slice(0, 2).toUpperCase()}
                              </div>
                            ) : <div className="w-8"/>}
                         </div>
                       )}

                       {/* Message Bubble Container */}
                       <div className={`max-w-[75%] relative flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                          
                          {/* Sender Name (Only for others in groups) */}
                          {!isMe && showAvatar && activeChannel.type === 'group' && (
                             <span className="text-[10px] text-slate-400 font-bold ml-1 mb-1">{msg.senderName}</span>
                          )}

                          {/* The Bubble */}
                          <div className={`
                             p-3 shadow-sm text-sm relative break-words
                             ${isMe 
                               ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-sm' 
                               : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 border border-slate-100 dark:border-slate-700 rounded-2xl rounded-tl-sm'
                             }
                          `}>
                             {msg.attachments && msg.attachments.length > 0 && (
                               <div className="mb-2 space-y-2">
                                  {msg.attachments.map(att => (
                                    <div key={att.id} className="rounded-lg overflow-hidden border border-black/10 dark:border-white/10 relative group/img">
                                       {att.type.startsWith('image/') ? (
                                         <>
                                           <img src={att.url} alt="attachment" className="max-w-full h-auto object-cover max-h-60" />
                                           <a 
                                             href={att.url} 
                                             download={att.name}
                                             className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition-opacity"
                                           >
                                              <Download size={24} className="text-white drop-shadow-md"/>
                                           </a>
                                         </>
                                       ) : (
                                         <div className="flex items-center gap-2 p-3 bg-slate-100 dark:bg-slate-700">
                                            <Paperclip size={16}/> 
                                            <span className="text-xs font-bold truncate max-w-[150px]">{att.name}</span>
                                         </div>
                                       )}
                                    </div>
                                  ))}
                               </div>
                             )}
                             <p className="whitespace-pre-wrap leading-relaxed">{msg.text}</p>
                          </div>

                          {/* Reactions & Timestamp Row */}
                          <div className={`flex items-center gap-2 mt-1 px-1 ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                             {/* Reactions */}
                             {msg.reactions && msg.reactions.length > 0 && (
                               <div className="flex gap-1">
                                  {msg.reactions.map((r, i) => (
                                    <button 
                                      key={i} 
                                      onClick={() => handleReaction(msg.id, r.emoji)}
                                      className="text-[10px] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-1.5 py-0.5 rounded-full shadow-sm hover:scale-110 transition-transform"
                                    >
                                      {r.emoji} <span className="font-bold">{r.count > 1 ? r.count : ''}</span>
                                    </button>
                                  ))}
                               </div>
                             )}
                             
                             {/* Timestamp */}
                             <span className="text-[9px] text-slate-400 font-medium">
                               {new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                             </span>
                          </div>

                          {/* Hover Actions (Floating on side) */}
                          <div className={`
                             absolute top-0 h-full flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 px-2
                             ${isMe ? '-left-24 justify-end' : '-right-24 justify-start'}
                          `}>
                             <button onClick={() => handleReaction(msg.id, 'üëç')} className="p-1.5 bg-white dark:bg-slate-800 rounded-full shadow border border-slate-100 dark:border-slate-700 text-slate-400 hover:text-amber-500 transition-colors transform hover:scale-110">üëç</button>
                             <button onClick={() => handleReaction(msg.id, '‚ù§Ô∏è')} className="p-1.5 bg-white dark:bg-slate-800 rounded-full shadow border border-slate-100 dark:border-slate-700 text-slate-400 hover:text-red-500 transition-colors transform hover:scale-110">‚ù§Ô∏è</button>
                             <button 
                               onClick={() => onCreateTask(msg.text)}
                               className="p-1.5 bg-white dark:bg-slate-800 rounded-full shadow border border-slate-100 dark:border-slate-700 text-slate-400 hover:text-indigo-600 transition-colors transform hover:scale-110"
                               title="Cr√©er une t√¢che"
                             >
                               <CheckSquare size={14}/>
                             </button>
                          </div>

                       </div>
                    </div>
                  );
                })}
                <div ref={messagesEndRef} />
             </div>

             {/* Input Area (Bottom Fixed) */}
             <div className="p-3 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shrink-0">
                <div className="flex items-end gap-2 max-w-4xl mx-auto">
                   
                   {/* File Upload Button */}
                   <button 
                     onClick={() => fileInputRef.current?.click()}
                     disabled={isUploading}
                     className="p-3 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors disabled:opacity-50"
                   >
                      {isUploading ? <Loader2 size={20} className="animate-spin"/> : <Paperclip size={20}/>}
                   </button>
                   <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept="image/*" />

                   {/* Text Input */}
                   <div className="flex-1 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center px-4 border border-transparent focus-within:border-indigo-500 transition-all">
                      <textarea 
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSend();
                          }
                        }}
                        placeholder="√âcrivez un message..."
                        className="flex-1 bg-transparent outline-none text-sm py-3 max-h-32 min-h-[44px] resize-none text-slate-900 dark:text-white placeholder:text-slate-400 custom-scrollbar"
                        rows={1}
                        disabled={isUploading}
                      />
                      <button className="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                         <Smile size={20}/>
                      </button>
                   </div>

                   {/* Send Button */}
                   <button 
                     onClick={handleSend}
                     disabled={!inputText.trim() || isUploading}
                     className={`p-3 rounded-full shadow-lg transition-all transform active:scale-95 ${inputText.trim() ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-200 dark:bg-slate-800 text-slate-400'}`}
                   >
                      <Send size={20}/>
                   </button>
                </div>
             </div>
           </>
         ) : (
           <div className="flex-1 flex flex-col items-center justify-center text-slate-300 dark:text-slate-600 p-8 text-center bg-slate-50 dark:bg-slate-950">
              <div className="w-20 h-20 bg-slate-100 dark:bg-slate-900 rounded-full flex items-center justify-center mb-6 animate-in zoom-in duration-500">
                 <MessageSquare size={40} className="text-slate-300 dark:text-slate-700"/>
              </div>
              <h3 className="text-xl font-black text-slate-400 dark:text-slate-500 mb-2">Vos Messages</h3>
              <p className="text-sm font-medium max-w-xs text-slate-400">S√©lectionnez une discussion pour commencer √† √©changer avec votre √©quipe.</p>
           </div>
         )}
      </div>

      {/* --- MODALS (Restored logic) --- */}

      {/* 1. New Channel Modal */}
      {showNewChannelModal && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className="bg-white dark:bg-slate-900 rounded-[32px] w-full max-w-md p-6 shadow-2xl">
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-xl font-black">Nouvelle Discussion</h3>
                 <button onClick={() => setShowNewChannelModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>

              <div className="space-y-4">
                 <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-xl">
                    <button 
                      onClick={() => setNewChannelType('group')}
                      className={`flex-1 py-2 rounded-lg text-xs font-black uppercase transition-all ${newChannelType === 'group' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}
                    >
                      Groupe / Service
                    </button>
                    <button 
                      onClick={() => setNewChannelType('direct')}
                      className={`flex-1 py-2 rounded-lg text-xs font-black uppercase transition-all ${newChannelType === 'direct' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}
                    >
                      Message Priv√©
                    </button>
                 </div>

                 {newChannelType === 'group' && (
                   <div>
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Nom du Groupe</label>
                      <input 
                        type="text" 
                        placeholder="Ex: Maintenance, Cuisine..."
                        value={newChannelName}
                        onChange={(e) => setNewChannelName(e.target.value)}
                        className="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl font-bold text-sm outline-none border-2 border-transparent focus:border-indigo-500 transition-colors"
                      />
                   </div>
                 )}

                 <div>
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Participants</label>
                    <div className="max-h-48 overflow-y-auto space-y-1 mt-1 bg-slate-50 dark:bg-slate-800 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                       {potentialDMs.map(u => (
                         <div 
                           key={u.uid}
                           onClick={() => {
                             if (newChannelType === 'direct') {
                               setSelectedMembers([u.uid]);
                             } else {
                               if (selectedMembers.includes(u.uid)) setSelectedMembers(selectedMembers.filter(id => id !== u.uid));
                               else setSelectedMembers([...selectedMembers, u.uid]);
                             }
                           }}
                           className={`p-2 rounded-lg flex items-center justify-between cursor-pointer ${selectedMembers.includes(u.uid) ? 'bg-indigo-100 dark:bg-indigo-900/30 border border-indigo-200' : 'hover:bg-white dark:hover:bg-slate-700'}`}
                         >
                            <div className="flex items-center gap-2">
                               <div className="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-[10px] font-bold">{u.displayName.slice(0,2).toUpperCase()}</div>
                               <span className="text-xs font-bold">{u.displayName}</span>
                            </div>
                            {selectedMembers.includes(u.uid) && <div className="w-2 h-2 bg-indigo-500 rounded-full"></div>}
                         </div>
                       ))}
                    </div>
                 </div>

                 <button 
                   onClick={handleCreateChannel}
                   disabled={selectedMembers.length === 0 || (newChannelType === 'group' && !newChannelName)}
                   className="w-full py-4 rounded-xl bg-indigo-600 text-white font-black uppercase text-xs tracking-widest shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                 >
                   Cr√©er {newChannelType === 'group' ? 'le groupe' : 'la discussion'}
                 </button>
              </div>
           </div>
        </div>
      )}

      {/* 2. Group Info Modal */}
      {showGroupInfoModal && activeChannel && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className="bg-white dark:bg-slate-900 rounded-[32px] w-full max-w-md p-6 shadow-2xl flex flex-col max-h-[80vh]">
              <div className="flex justify-between items-center mb-6">
                 <div>
                   <h3 className="text-xl font-black">{activeChannel.name}</h3>
                   <p className="text-xs text-slate-400 font-bold">{activeChannel.participants.length} membres</p>
                 </div>
                 <button onClick={() => setShowGroupInfoModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>

              <div className="flex-1 overflow-y-auto space-y-4">
                 <div className="space-y-2">
                    <h4 className="text-[10px] font-black uppercase text-slate-400">Membres</h4>
                    {groupMembers.map(u => (
                      <div key={u.uid} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                         <div className="flex items-center gap-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-slate-200 text-slate-600'}`}>
                               {u.displayName.slice(0,2).toUpperCase()}
                            </div>
                            <div>
                               <p className="text-sm font-bold">{u.displayName}</p>
                               <p className="text-[10px] text-slate-400 capitalize">{u.role}</p>
                            </div>
                         </div>
                         {canManageGroup && u.uid !== currentUser?.uid && (
                           <button onClick={() => handleRemoveMember(u.uid)} className="p-2 text-slate-300 hover:text-red-500 rounded-lg hover:bg-white dark:hover:bg-slate-700">
                              <MinusCircle size={16}/>
                           </button>
                         )}
                      </div>
                    ))}
                 </div>

                 {canManageGroup && (
                   <div className="space-y-2 pt-4 border-t border-slate-100 dark:border-slate-800">
                      <h4 className="text-[10px] font-black uppercase text-slate-400">Ajouter des membres</h4>
                      <div className="max-h-32 overflow-y-auto pr-1">
                        {nonMembers.map(u => (
                          <div key={u.uid} className="flex justify-between items-center p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg cursor-pointer" onClick={() => handleAddMember(u.uid)}>
                             <span className="text-sm font-bold pl-2">{u.displayName}</span>
                             <UserPlus size={16} className="text-indigo-500"/>
                          </div>
                        ))}
                      </div>
                   </div>
                 )}
              </div>
           </div>
        </div>
      )}

      {/* 3. Media Modal */}
      {showMediaModal && activeChannel && (
        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className="bg-white dark:bg-slate-900 rounded-[32px] w-full max-w-2xl p-6 shadow-2xl flex flex-col h-[80vh]">
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-xl font-black">M√©dias & Documents</h3>
                 <button onClick={() => setShowMediaModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>
              
              <div className="flex-1 overflow-y-auto custom-scrollbar">
                 {channelMedia.length > 0 ? (
                   <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                      {channelMedia.map(att => (
                        <div key={att.id} className="group relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 aspect-square bg-slate-50 dark:bg-slate-800">
                           {att.type.startsWith('image/') ? (
                             <img src={att.url} alt={att.name} className="w-full h-full object-cover" />
                           ) : (
                             <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                <Paperclip size={32} />
                                <span className="text-xs font-bold mt-2 px-2 text-center truncate w-full">{att.name}</span>
                             </div>
                           )}
                           <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                              <a href={att.url} download={att.name} className="p-2 bg-white rounded-full text-indigo-600 hover:scale-110 transition-transform"><Download size={16}/></a>
                           </div>
                        </div>
                      ))}
                   </div>
                 ) : (
                   <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-50">
                      <ImageIcon size={48} className="mb-4"/>
                      <p className="font-bold">Aucun m√©dia partag√©</p>
                   </div>
                 )}
              </div>
           </div>
        </div>
      )}

    </div>
  );
};

// --- ERROR BOUNDARY WRAPPER ---
const MessagingView: React.FC<MessagingViewProps> = (props) => (
  <MessagingErrorBoundary>
    <MessagingContent {...props} />
  </MessagingErrorBoundary>
);

export default MessagingView;
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Bell, AlertTriangle, CheckCircle2, Clock, Car, Search, Plus, 
  Trash2, User, Eye, MapPin, Camera, X, ClipboardList, BedDouble, 
  MessageSquare, ShieldAlert, ArrowRight, Check, Filter, Archive, RotateCcw, Box, Loader2
} from 'lucide-react';
import { UserSettings, Room, LogEntry, WakeUpCall, TaxiBooking, LostItem, UserProfile, LogPriority, LogTarget, LostItemStatus } from '../types';
import { useAuth } from '../services/authContext';

interface ReceptionViewProps {
  userSettings: UserSettings;
  rooms: Room[]; // From App state (HK link)
  logs: LogEntry[];
  onUpdateLogs: (logs: LogEntry[]) => void;
  wakeups: WakeUpCall[];
  onUpdateWakeups: (w: WakeUpCall[]) => void;
  taxis: TaxiBooking[];
  onUpdateTaxis: (t: TaxiBooking[]) => void;
  lostItems: LostItem[];
  onUpdateLostItems: (l: LostItem[]) => void;
}

const ReceptionView: React.FC<ReceptionViewProps> = ({ 
  userSettings, rooms, logs, onUpdateLogs, wakeups, onUpdateWakeups, taxis, onUpdateTaxis, lostItems, onUpdateLostItems 
}) => {
  const { user, getAllUsers } = useAuth();
  const [activeTab, setActiveTab] = useState<'main_courante' | 'concierge' | 'lost_found'>('main_courante');
  
  // --- STATE: Main Courante ---
  const [logMessage, setLogMessage] = useState('');
  const [logPriority, setLogPriority] = useState<LogPriority>('info');
  const [logTarget, setLogTarget] = useState<LogTarget>('all');
  const [manualAuthor, setManualAuthor] = useState('');
  
  // Staff list for manual author selection
  const staffMembers = useMemo(() => getAllUsers(), []);

  // Sync manualAuthor with current user on mount/change
  useEffect(() => {
    if (user?.displayName) {
      setManualAuthor(user.displayName);
    }
  }, [user]);
  
  // Nouveaux √©tats pour filtres Main Courante
  const [logSearch, setLogSearch] = useState('');
  const [logFilter, setLogFilter] = useState<'ALL' | 'URGENT' | 'IMPORTANT' | 'MINE'>('ALL');
  const [showArchives, setShowArchives] = useState(false);

  // --- STATE: Concierge ---
  const [newWakeup, setNewWakeup] = useState({ room: '', time: '' });
  const [newTaxi, setNewTaxi] = useState({ name: '', time: '', dest: '', company: '' });
  
  // --- STATE: Lost & Found ---
  const [showLostItemModal, setShowLostItemModal] = useState(false);
  const [newItemForm, setNewItemForm] = useState<{ desc: string, loc: string, date: string, finder: string, photo: string | null }>({
    desc: '', loc: '', date: new Date().toISOString().split('T')[0], finder: '', photo: null
  });
  const [lostFilter, setLostFilter] = useState<'all' | 'stored' | 'returned'>('all');
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [showReportPreview, setShowReportPreview] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  // --- WIDGET DATA (Housekeeping) ---
  const hkStats = {
    ready: rooms.filter(r => r.statusHK === 'ready').length,
    dirty: rooms.filter(r => r.statusHK === 'not_started').length,
    progress: rooms.filter(r => r.statusHK === 'in_progress').length,
    total: rooms.length
  };

  // --- HELPERS ---
  const getRelativeTime = (dateStr: string) => {
    try {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now.getTime() - date.getTime()) / 1000);
      
      if (diff < 60) return "√Ä l'instant";
      if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
      if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)} h`;
      return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
    } catch (e) {
      return dateStr;
    }
  };

  // --- LOGIC: Main Courante ---
  const handlePostLog = () => {
    if (!logMessage.trim()) return;
    
    // Determine Author: Manual selection > Logged User > Default
    const finalAuthor = manualAuthor || user?.displayName || 'R√©ception';

    const newLog: LogEntry = {
      id: `log-${Date.now()}`,
      author: finalAuthor,
      message: logMessage,
      priority: logPriority,
      target: logTarget,
      status: 'active', // Toujours actif √† la cr√©ation
      timestamp: new Date().toISOString(),
      readBy: []
    };
    onUpdateLogs([newLog, ...logs]); // Newest first
    setLogMessage('');
    setLogPriority('info');
  };

  const handleReadLog = (logId: string) => {
    if (!user) return;
    const updated = logs.map(l => {
      if (l.id === logId && !l.readBy.includes(user.uid)) {
        return { ...l, readBy: [...l.readBy, user.uid] };
      }
      return l;
    });
    onUpdateLogs(updated);
  };

  const handleToggleArchiveLog = (logId: string) => {
    // S√âCURIT√â : On ne supprime jamais, on change juste le statut
    const updated = logs.map(l => {
      if (l.id === logId) {
        return { ...l, status: l.status === 'active' ? 'archived' as const : 'active' as const };
      }
      return l;
    });
    onUpdateLogs(updated);
  };

  // FILTRAGE AVANC√â LOGS
  const filteredLogs = useMemo(() => {
    return logs.filter(log => {
      // 1. Filtre Archives vs Actifs
      if (showArchives) {
        if (log.status !== 'archived') return false;
      } else {
        if (log.status === 'archived') return false;
      }

      // 2. Recherche Texte
      if (logSearch) {
        const lowerSearch = logSearch.toLowerCase();
        if (!log.message.toLowerCase().includes(lowerSearch) && !log.author.toLowerCase().includes(lowerSearch)) {
          return false;
        }
      }

      // 3. Filtres Rapides (Chips)
      if (logFilter === 'URGENT' && log.priority !== 'urgent') return false;
      if (logFilter === 'IMPORTANT' && log.priority !== 'important') return false;
      if (logFilter === 'MINE' && log.author !== (user?.displayName || '')) return false;

      return true;
    });
  }, [logs, logSearch, logFilter, showArchives, user]);

  // --- LOGIC: Concierge ---
  const addWakeup = () => {
    if (!newWakeup.room || !newWakeup.time) return;
    const call: WakeUpCall = {
      id: `wk-${Date.now()}`,
      roomNumber: newWakeup.room,
      time: newWakeup.time,
      completed: false
    };
    onUpdateWakeups([...wakeups, call].sort((a, b) => a.time.localeCompare(b.time)));
    setNewWakeup({ room: '', time: '' });
  };

  const toggleWakeup = (id: string) => {
    onUpdateWakeups(wakeups.map(w => w.id === id ? { ...w, completed: !w.completed } : w));
  };

  const addTaxi = () => {
    if (!newTaxi.name || !newTaxi.time) return;
    const taxi: TaxiBooking = {
      id: `tx-${Date.now()}`,
      guestName: newTaxi.name,
      time: newTaxi.time,
      destination: newTaxi.dest,
      company: newTaxi.company,
      completed: false
    };
    onUpdateTaxis([...taxis, taxi].sort((a, b) => a.time.localeCompare(b.time)));
    setNewTaxi({ name: '', time: '', dest: '', company: '' });
  };

  const toggleTaxi = (id: string) => {
    onUpdateTaxis(taxis.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
  };

  // --- LOGIC: Lost & Found ---
  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validation
    if (!file.type.startsWith('image/')) {
        alert("Fichier invalide.");
        return;
    }
    if (file.size > 5 * 1024 * 1024) {
        alert("Image trop lourde (Max 5Mo).");
        return;
    }

    setIsUploading(true);

    try {
        const base64 = await new Promise<string>((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result as string);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
        setNewItemForm(prev => ({ ...prev, photo: base64 }));
    } catch (error) {
        console.error("Erreur upload:", error);
        alert("Erreur lors de l'upload.");
    } finally {
        setIsUploading(false);
        if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const saveLostItem = () => {
    if (!newItemForm.desc) return;
    const item: LostItem = {
      id: `li-${Date.now()}`,
      description: newItemForm.desc,
      location: newItemForm.loc,
      dateFound: newItemForm.date,
      finder: newItemForm.finder,
      status: 'stored',
      photoUrl: newItemForm.photo || undefined
    };
    onUpdateLostItems([item, ...lostItems]);
    setShowLostItemModal(false);
    setNewItemForm({ desc: '', loc: '', date: new Date().toISOString().split('T')[0], finder: '', photo: null });
  };

  const updateItemStatus = (id: string, status: LostItemStatus) => {
    onUpdateLostItems(lostItems.map(i => i.id === id ? { ...i, status } : i));
  };

  // LOGIQUE DE FILTRE OBJETS TROUV√âS
  const filteredLostItems = useMemo(() => {
    return lostItems
      .filter(obj => lostFilter === 'all' || obj.status === lostFilter)
      .sort((a, b) => new Date(b.dateFound).getTime() - new Date(a.dateFound).getTime());
  }, [lostItems, lostFilter]);

  const getPriorityColor = (p: LogPriority, isArchived: boolean) => {
    if (isArchived) return 'bg-slate-100 text-slate-400 border-slate-200 dark:bg-slate-700 dark:text-slate-500';
    switch (p) {
      case 'urgent': return 'bg-red-100 text-red-600 border-red-200 dark:bg-red-900/30';
      case 'important': return 'bg-amber-100 text-amber-600 border-amber-200 dark:bg-amber-900/30';
      default: return 'bg-blue-50 text-blue-600 border-blue-100 dark:bg-blue-900/30 dark:text-blue-300';
    }
  };

  return (
    <div className={`h-full flex flex-col md:flex-row overflow-hidden animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* MAIN CONTENT LEFT */}
      <div className="flex-1 flex flex-col h-full overflow-hidden">
         
         {/* HEADER */}
         <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
            <div className="flex items-center gap-4">
               <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
                 <Bell size={28} />
               </div>
               <div>
                 <h2 className="text-2xl font-black">R√©ception</h2>
                 <p className="text-xs font-bold text-slate-400">Front Desk & Conciergerie</p>
               </div>
            </div>
         </div>

         {/* TABS */}
         <div className="px-6 py-4">
            <div className="flex p-1 rounded-2xl bg-slate-200 dark:bg-slate-800 w-fit overflow-x-auto whitespace-nowrap max-w-full no-scrollbar px-2">
               <button onClick={() => setActiveTab('main_courante')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'main_courante' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}>
                 <MessageSquare size={14}/> Main Courante
               </button>
               <button onClick={() => setActiveTab('concierge')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'concierge' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}>
                 <Clock size={14}/> Conciergerie
               </button>
               <button onClick={() => setActiveTab('lost_found')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'lost_found' ? 'bg-white dark:bg-slate-700 shadow text-violet-600' : 'text-slate-500'}`}>
                 <Search size={14}/> Objets Trouv√©s
               </button>
            </div>
         </div>

         {/* TAB CONTENT */}
         <div className="flex-1 overflow-y-auto px-6 pb-20 no-scrollbar">
            
            {/* 1. MAIN COURANTE */}
            {activeTab === 'main_courante' && (
              <div className="space-y-6 pt-2">
                 
                 {/* Input Box */}
                 <div className="p-4 bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <textarea 
                      value={logMessage}
                      onChange={(e) => setLogMessage(e.target.value)}
                      placeholder="Nouveau message de transmission..."
                      className="w-full bg-transparent outline-none text-sm font-medium resize-none h-20 mb-3 placeholder:text-slate-400"
                    />
                    <div className="flex justify-between items-center">
                       <div className="flex gap-2">
                          {/* AUTHOR SELECTION */}
                          <div className="relative">
                             <select
                               value={manualAuthor}
                               onChange={(e) => setManualAuthor(e.target.value)}
                               className="bg-slate-100 dark:bg-slate-700 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer max-w-[120px] truncate"
                               title="Auteur du message"
                             >
                               {staffMembers.map(u => (
                                 <option key={u.uid} value={u.displayName}>{u.displayName}</option>
                               ))}
                               {!staffMembers.some(u => u.displayName === manualAuthor) && manualAuthor && (
                                 <option value={manualAuthor}>{manualAuthor}</option>
                               )}
                             </select>
                          </div>

                          <select 
                            value={logPriority} 
                            onChange={(e) => setLogPriority(e.target.value as LogPriority)}
                            className="bg-slate-100 dark:bg-slate-700 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer"
                          >
                             <option value="info">Info</option>
                             <option value="important">‚ö†Ô∏è Important</option>
                             <option value="urgent">üö® URGENCE</option>
                          </select>
                          <select 
                            value={logTarget} 
                            onChange={(e) => setLogTarget(e.target.value as LogTarget)}
                            className="bg-slate-100 dark:bg-slate-700 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer"
                          >
                             <option value="all">Tout le monde</option>
                             <option value="management">Direction</option>
                             <option value="housekeeping">Gouvernante</option>
                             <option value="maintenance">Maintenance</option>
                          </select>
                       </div>
                       <button onClick={handlePostLog} disabled={!logMessage.trim()} className="px-6 py-2 bg-violet-600 text-white rounded-xl text-xs font-black uppercase shadow-lg disabled:opacity-50">
                          Publier
                       </button>
                    </div>
                 </div>

                 {/* FILTRES & RECHERCHE */}
                 <div className="flex flex-col md:flex-row gap-3 items-center bg-slate-100 dark:bg-slate-800/50 p-2 rounded-2xl">
                    {/* Recherche */}
                    <div className="flex items-center bg-white dark:bg-slate-900 rounded-xl px-3 py-2 flex-1 border border-slate-200 dark:border-slate-700 focus-within:border-violet-500 w-full">
                       <Search size={14} className="text-slate-400 mr-2"/>
                       <input 
                         type="text" 
                         placeholder="Rechercher (ex: Cl√©, 204)..." 
                         value={logSearch}
                         onChange={(e) => setLogSearch(e.target.value)}
                         className="bg-transparent outline-none text-xs font-bold w-full"
                       />
                    </div>

                    {/* Chips Filtres */}
                    <div className="flex gap-2 overflow-x-auto no-scrollbar w-full md:w-auto">
                       <button 
                         onClick={() => setLogFilter('ALL')}
                         className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border transition-all ${logFilter === 'ALL' ? 'bg-slate-900 text-white border-slate-900 dark:bg-white dark:text-slate-900' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500'}`}
                       >
                         Tout
                       </button>
                       <button 
                         onClick={() => setLogFilter('URGENT')}
                         className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border transition-all ${logFilter === 'URGENT' ? 'bg-red-500 text-white border-red-500' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500 hover:text-red-500'}`}
                       >
                         üö® Urgences
                       </button>
                       <button 
                         onClick={() => setLogFilter('IMPORTANT')}
                         className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border transition-all ${logFilter === 'IMPORTANT' ? 'bg-amber-500 text-white border-amber-500' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500 hover:text-amber-500'}`}
                       >
                         ‚ö†Ô∏è Important
                       </button>
                       <button 
                         onClick={() => setLogFilter('MINE')}
                         className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border transition-all ${logFilter === 'MINE' ? 'bg-violet-500 text-white border-violet-500' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500'}`}
                       >
                         Mes messages
                       </button>
                    </div>

                    {/* Toggle Archives */}
                    <button 
                      onClick={() => setShowArchives(!showArchives)}
                      className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border flex items-center gap-2 transition-all ${showArchives ? 'bg-slate-300 dark:bg-slate-700 text-slate-700 dark:text-white border-slate-400' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-400'}`}
                    >
                       <Archive size={12}/> {showArchives ? 'Masquer Archives' : 'Voir Archives'}
                    </button>
                 </div>

                 {/* Feed */}
                 <div className="space-y-4">
                    {filteredLogs.map(log => {
                      const isArchived = log.status === 'archived';
                      const authorName = log.author || 'Anonyme';
                      return (
                        <div key={log.id} className={`p-5 rounded-3xl border transition-all duration-300 ${isArchived ? 'opacity-60 bg-slate-50 dark:bg-slate-900/50 border-slate-200 grayscale' : userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                           <div className="flex justify-between items-start mb-2">
                              <div className="flex items-center gap-2">
                                 <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${isArchived ? 'bg-slate-200 text-slate-500' : 'bg-slate-200 dark:bg-slate-700'}`}>
                                    {authorName.slice(0, 2).toUpperCase()}
                                 </div>
                                 <div>
                                    <span className="text-xs font-black block">{authorName}</span>
                                    <span className="text-[10px] text-slate-400">
                                      {getRelativeTime(log.timestamp)}
                                    </span>
                                 </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className={`px-2 py-1 rounded-lg text-[9px] font-black uppercase border ${getPriorityColor(log.priority, isArchived)}`}>
                                   {log.priority}
                                </span>
                                {isArchived && <span className="px-2 py-1 rounded-lg text-[9px] font-black uppercase border bg-slate-200 text-slate-500 border-slate-300">Archiv√©</span>}
                              </div>
                           </div>
                           <p className={`text-sm font-medium leading-relaxed mb-4 pl-10 ${isArchived ? 'line-through text-slate-400' : ''}`}>{log.message}</p>
                           
                           <div className="flex items-center justify-between pl-10 border-t border-slate-100 dark:border-slate-700 pt-3">
                              <div className="flex items-center gap-1">
                                 {log.readBy.length > 0 && <span className="text-[10px] text-slate-400 mr-2">Vu par :</span>}
                                 {log.readBy.map((uid, i) => (
                                   <div key={i} className="w-5 h-5 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center text-[8px] font-bold border border-white dark:border-slate-800 -ml-1">
                                      <Check size={10}/>
                                   </div>
                                 ))}
                              </div>
                              
                              <div className="flex gap-3">
                                {/* Bouton J'ai lu */}
                                {!isArchived && !log.readBy.includes(user?.uid || '') && (
                                  <button onClick={() => handleReadLog(log.id)} className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-emerald-500 transition-colors">
                                     <CheckCircle2 size={14}/> J'ai pris l'info
                                  </button>
                                )}

                                {/* Bouton Archiver/D√©sarchiver */}
                                <button 
                                  onClick={() => handleToggleArchiveLog(log.id)}
                                  className={`flex items-center gap-1 text-[10px] font-black uppercase px-3 py-1.5 rounded-lg transition-colors ${isArchived ? 'bg-slate-200 text-slate-600 hover:bg-slate-300' : 'bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600'}`}
                                  title={isArchived ? "Restaurer le message" : "Archiver le message (Trait√©)"}
                                >
                                   {isArchived ? <RotateCcw size={12}/> : <Box size={12}/>}
                                   {isArchived ? 'Restaurer' : 'Traiter / Archiver'}
                                </button>
                              </div>
                           </div>
                        </div>
                      );
                    })}
                    {filteredLogs.length === 0 && (
                      <div className="text-center py-10 opacity-40">
                         <MessageSquare size={32} className="mx-auto mb-2 text-slate-300"/>
                         <p className="text-xs font-bold text-slate-400">Aucun message ne correspond aux crit√®res.</p>
                      </div>
                    )}
                 </div>
              </div>
            )}

            {/* 2. CONCIERGERIE */}
            {activeTab === 'concierge' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-2">
                 
                 {/* WAKE-UP CALLS */}
                 <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                    <h3 className="text-sm font-black uppercase text-slate-400 mb-4 flex items-center gap-2"><Clock size={16}/> R√©veils</h3>
                    
                    <div className="flex gap-2 mb-4">
                       <input type="text" placeholder="Chb" value={newWakeup.room} onChange={e => setNewWakeup({...newWakeup, room: e.target.value})} className="w-16 p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold text-center"/>
                       <input type="time" value={newWakeup.time} onChange={e => setNewWakeup({...newWakeup, time: e.target.value})} className="flex-1 p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold"/>
                       <button onClick={addWakeup} className="p-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl"><Plus size={16}/></button>
                    </div>

                    <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                       {wakeups.map(w => (
                         <div key={w.id} className={`flex items-center justify-between p-3 rounded-xl border ${w.completed ? 'bg-slate-50 dark:bg-slate-800/50 opacity-50' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`}>
                            <div className="flex items-center gap-3">
                               <span className="text-lg font-black">{w.time}</span>
                               <span className="text-xs font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">Ch {w.roomNumber}</span>
                            </div>
                            <button onClick={() => toggleWakeup(w.id)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${w.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}>
                               {w.completed && <Check size={12}/>}
                            </button>
                         </div>
                       ))}
                       {wakeups.length === 0 && <p className="text-xs text-slate-400 italic text-center py-4">Aucun r√©veil programm√©.</p>}
                    </div>
                 </div>

                 {/* TAXIS */}
                 <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                    <h3 className="text-sm font-black uppercase text-slate-400 mb-4 flex items-center gap-2"><Car size={16}/> Commandes Taxis</h3>
                    
                    <div className="grid grid-cols-2 gap-2 mb-4">
                       <input type="text" placeholder="Nom Client" value={newTaxi.name} onChange={e => setNewTaxi({...newTaxi, name: e.target.value})} className="p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold"/>
                       <input type="time" value={newTaxi.time} onChange={e => setNewTaxi({...newTaxi, time: e.target.value})} className="p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold"/>
                       <input type="text" placeholder="Destination" value={newTaxi.dest} onChange={e => setNewTaxi({...newTaxi, dest: e.target.value})} className="p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold"/>
                       <div className="flex gap-2">
                          <input type="text" placeholder="Compagnie" value={newTaxi.company} onChange={e => setNewTaxi({...newTaxi, company: e.target.value})} className="flex-1 p-2 rounded-xl bg-slate-50 dark:bg-slate-900 outline-none text-xs font-bold"/>
                          <button onClick={addTaxi} className="p-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl"><Plus size={16}/></button>
                       </div>
                    </div>

                    <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                       {taxis.map(t => (
                         <div key={t.id} className={`p-3 rounded-xl border flex justify-between items-center ${t.completed ? 'bg-slate-50 dark:bg-slate-800/50 opacity-50' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`}>
                            <div>
                               <p className="text-xs font-bold">{t.guestName} <span className="text-slate-400">({t.time})</span></p>
                               <p className="text-[10px] text-slate-500">{t.destination} ‚Ä¢ {t.company}</p>
                            </div>
                            <button onClick={() => toggleTaxi(t.id)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}>
                               {t.completed && <Check size={12}/>}
                            </button>
                         </div>
                       ))}
                       {taxis.length === 0 && <p className="text-xs text-slate-400 italic text-center py-4">Aucune commande.</p>}
                    </div>
                 </div>

                 {/* CHECKLIST */}
                 <div className={`col-span-full p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                    <h3 className="text-sm font-black uppercase text-slate-400 mb-4 flex items-center gap-2"><ClipboardList size={16}/> Flux Divers</h3>
                    <div className="flex gap-4 overflow-x-auto no-scrollbar">
                       {['Journaux re√ßus', 'Musique Hall ON', 'Fonds de caisse compt√©', 'Cl√©s v√©rifi√©es', 'Briefing lu'].map((item, i) => (
                         <label key={i} className="flex items-center gap-2 p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                            <input type="checkbox" className="w-4 h-4 accent-violet-600 rounded"/>
                            <span className="text-xs font-bold whitespace-nowrap">{item}</span>
                         </label>
                       ))}
                    </div>
                 </div>
              </div>
            )}

            {/* 3. LOST & FOUND */}
            {activeTab === 'lost_found' && (
              <div className="space-y-6 pt-2">
                 <div className="flex justify-between items-center">
                    {/* FILTRES OBJETS TROUV√âS */}
                    <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                       <button 
                         onClick={() => setLostFilter('all')}
                         className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${lostFilter === 'all' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
                       >
                         Tous
                       </button>
                       <button 
                         onClick={() => setLostFilter('stored')}
                         className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${lostFilter === 'stored' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
                       >
                         En stock
                       </button>
                       <button 
                         onClick={() => setLostFilter('returned')}
                         className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${lostFilter === 'returned' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
                       >
                         Rendu au client
                       </button>
                    </div>

                    <button onClick={() => setShowLostItemModal(true)} className="px-6 py-3 bg-violet-600 text-white rounded-xl text-xs font-black uppercase shadow-lg flex items-center gap-2">
                       <Plus size={16}/> Nouvel Objet
                    </button>
                 </div>

                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {filteredLostItems.map(item => (
                      <div key={item.id} className={`p-4 rounded-3xl border flex gap-4 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                         <div className="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-900 overflow-hidden flex-shrink-0 border border-slate-200 dark:border-slate-700 relative">
                            {item.photoUrl ? (
                              <img src={item.photoUrl} alt="Objet" className="w-full h-full object-cover" />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center text-slate-300">
                                <Search size={24}/>
                              </div>
                            )}
                         </div>
                         <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start mb-1">
                               <span className="text-[10px] font-black uppercase text-slate-400">{new Date(item.dateFound).toLocaleDateString()}</span>
                               <select 
                                 value={item.status} 
                                 onChange={(e) => updateItemStatus(item.id, e.target.value as LostItemStatus)}
                                 className={`text-[9px] font-bold uppercase rounded px-1.5 py-0.5 outline-none cursor-pointer border ${
                                   item.status === 'stored' ? 'bg-blue-100 text-blue-700 border-blue-200' :
                                   item.status === 'returned' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' :
                                   item.status === 'contacted' ? 'bg-amber-100 text-amber-700 border-amber-200' :
                                   'bg-slate-100 text-slate-500 border-slate-200'
                                 }`}
                               >
                                  <option value="stored">Stock√©</option>
                                  <option value="contacted">Client contact√©</option>
                                  <option value="returned">Rendu</option>
                                  <option value="donated">Donn√©</option>
                               </select>
                            </div>
                            <h4 className="font-bold text-sm truncate mb-1">{item.description}</h4>
                            <p className="text-xs text-slate-500 dark:text-slate-400">
                               Trouv√© : {item.location} (par {item.finder})
                            </p>
                         </div>
                      </div>
                    ))}
                    {filteredLostItems.length === 0 && (
                      <div className="col-span-full text-center py-20 opacity-40">
                         <p className="font-bold text-slate-500">Aucun objet trouv√©.</p>
                      </div>
                    )}
                 </div>
              </div>
            )}

         </div>
      </div>

      {/* SIDEBAR WIDGET: HOUSEKEEPING STATUS */}
      <div className={`w-full md:w-80 border-l p-6 flex-shrink-0 bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-800 ${userSettings.darkMode ? 'text-white' : 'text-slate-900'}`}>
         <h3 className="text-sm font-black uppercase text-slate-400 mb-6 tracking-widest flex items-center gap-2">
            <BedDouble size={16}/> √âtat des Chambres
         </h3>

         <div className="space-y-4">
            <div className="p-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
               <div>
                  <p className="text-xs font-bold text-slate-500 mb-1">Pr√™tes (Propres)</p>
                  <p className="text-2xl font-black text-emerald-500">{hkStats.ready}</p>
               </div>
               <div className="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                  <Check size={20}/>
               </div>
            </div>

            <div className="p-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
               <div>
                  <p className="text-xs font-bold text-slate-500 mb-1">En cours</p>
                  <p className="text-2xl font-black text-orange-500">{hkStats.progress}</p>
               </div>
               <div className="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                  <Clock size={20}/>
               </div>
            </div>

            <div className="p-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
               <div>
                  <p className="text-xs font-bold text-slate-500 mb-1">√Ä faire (Sales)</p>
                  <p className="text-2xl font-black text-red-500">{hkStats.dirty}</p>
               </div>
               <div className="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center">
                  <ShieldAlert size={20}/>
               </div>
            </div>

            <div className="pt-6 mt-6 border-t border-slate-200 dark:border-slate-800">
               <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 overflow-hidden">
                  <div 
                    className="bg-emerald-500 h-full transition-all duration-1000" 
                    style={{ width: `${(hkStats.ready / hkStats.total) * 100}%` }}
                  />
               </div>
               <p className="text-center text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-wider">
                  {Math.round((hkStats.ready / hkStats.total) * 100)}% du parc disponible
               </p>
            </div>
         </div>
      </div>

      {/* MODAL NEW LOST ITEM */}
      {showLostItemModal && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className={`w-full max-w-md rounded-[32px] p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-xl font-black">Objet Trouv√©</h3>
                 <button onClick={() => setShowLostItemModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>
              <div className="space-y-4">
                 <input type="text" placeholder="Description (ex: Parapluie noir)" value={newItemForm.desc} onChange={e => setNewItemForm({...newItemForm, desc: e.target.value})} className="w-full p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 outline-none text-sm font-bold"/>
                 <div className="grid grid-cols-2 gap-4">
                    <input type="text" placeholder="Lieu (ex: Ch 104)" value={newItemForm.loc} onChange={e => setNewItemForm({...newItemForm, loc: e.target.value})} className="p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 outline-none text-sm font-bold"/>
                    <input type="date" value={newItemForm.date} onChange={e => setNewItemForm({...newItemForm, date: e.target.value})} className="p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 outline-none text-sm font-bold"/>
                 </div>
                 <input type="text" placeholder="Trouv√© par (Nom)" value={newItemForm.finder} onChange={e => setNewItemForm({...newItemForm, finder: e.target.value})} className="w-full p-3 rounded-2xl bg-slate-50 dark:bg-slate-800 outline-none text-sm font-bold"/>
                 
                 <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Photo</label>
                    <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                    <div 
                      onClick={() => fileInputRef.current?.click()}
                      className="w-full h-32 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors overflow-hidden relative"
                    >
                       {isUploading ? (
                         <Loader2 size={24} className="text-indigo-500 animate-spin" />
                       ) : newItemForm.photo ? (
                         <img src={newItemForm.photo} alt="Preview" className="w-full h-full object-cover" />
                       ) : (
                         <>
                           <Camera size={24} className="text-slate-400 mb-2"/>
                           <span className="text-xs font-bold text-slate-400">Ajouter photo</span>
                         </>
                       )}
                    </div>
                 </div>

                 <button 
                   onClick={saveLostItem} 
                   disabled={isUploading}
                   className="w-full py-4 rounded-2xl bg-violet-600 text-white font-black uppercase text-xs tracking-widest shadow-lg mt-2 disabled:opacity-50"
                 >
                    {isUploading ? 'Traitement...' : 'Enregistrer'}
                 </button>
              </div>
           </div>
        </div>
      )}

    </div>
  );
};

export default ReceptionView;
import React, { useState, useMemo } from 'react';
import { 
  Briefcase, Plus, User, Phone, Mail, Calendar, 
  CheckSquare, AlertTriangle, ArrowRight, ArrowLeft, Filter,
  Clock, CheckCircle2, XCircle, Search, Save, FileText, Inbox, Users, Globe, Eye,
  Archive, Download, Table, ArrowDownUp, SortAsc, AlertCircle, Check,
  LayoutList, CalendarDays, ChevronLeft, ChevronRight, Trash2
} from 'lucide-react';
import { Lead, UserSettings, UserProfile, LeadStatus, InboxItem, Client, InboxSource } from '../types';

interface SalesCRMViewProps {
  userSettings: UserSettings;
  leads: Lead[];
  onUpdateLeads: (leads: Lead[]) => void;
  inbox?: InboxItem[];
  onUpdateInbox?: (items: InboxItem[]) => void;
  clients?: Client[];
  onUpdateClients?: (clients: Client[]) => void;
  users: UserProfile[]; // For owner assignment
  onNavigate: (tab: string) => void;
}

// --- SAFE UTILS ---
const safeLower = (str: any) => (typeof str === 'string' ? str.toLowerCase() : '');
const safeDate = (date: any) => {
    if (!date) return 0;
    const d = new Date(date);
    return isNaN(d.getTime()) ? 0 : d.getTime();
};

const SalesCRMView: React.FC<SalesCRMViewProps> = ({ 
  userSettings, leads, onUpdateLeads, inbox = [], onUpdateInbox, clients = [], onUpdateClients, users, onNavigate 
}) => {
  const [activeTab, setActiveTab] = useState<'pipeline' | 'inbox' | 'contacts' | 'new_lead' | 'archives'>('pipeline');
  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);
  const [selectedContact, setSelectedContact] = useState<Client | null>(null);
  const [toastMessage, setToastMessage] = useState<string | null>(null);
  
  // --- PIPELINE VIEW STATES ---
  const [pipelineViewMode, setPipelineViewMode] = useState<'list' | 'calendar'>('list');
  const [pipelineSearch, setPipelineSearch] = useState('');
  const [pipelineSort, setPipelineSort] = useState<'event_asc' | 'urgency' | 'created_desc' | 'alpha'>('event_asc');
  const [pipelineFilter, setPipelineFilter] = useState<string>('ALL');
  
  // Calendar Navigation State
  const [calendarDate, setCalendarDate] = useState(new Date());

  // --- INBOX VIEW STATES ---
  const [inboxSearch, setInboxSearch] = useState('');
  const [inboxSort, setInboxSort] = useState<'date_desc' | 'date_asc' | 'urgency' | 'event_date' | 'alpha'>('date_desc');
  const [inboxFilter, setInboxFilter] = useState<'ALL' | 'URGENT' | 'EMAIL' | 'PHONE' | 'WEB' | 'THIS_MONTH'>('ALL');

  // New Lead Form State
  const [form, setForm] = useState<Partial<Lead>>({
    groupName: '', contactName: '', email: '', phone: '', pax: 0, note: '', startDate: '', endDate: ''
  });

  // Inbox Form State
  const [inboxForm, setInboxForm] = useState<{ 
    contactName: string, 
    companyName: string, 
    email: string, 
    phone: string, 
    source: InboxSource,
    eventStartDate: string,
    eventEndDate: string,
    note: string
  }>({
    contactName: '', 
    companyName: '', 
    email: '', 
    phone: '', 
    source: 'email',
    eventStartDate: '',
    eventEndDate: '',
    note: ''
  });

  // Contacts Search
  const [contactSearch, setContactSearch] = useState('');

  // --- ACTIONS CONTACTS ---
  const handleDeleteClient = (id: string) => {
    // Convert to String to ensure safe comparison regardless of data type (number vs string)
    const targetId = String(id);
    
    if (confirm("Supprimer ce contact d√©finitivement ?")) {
      if (onUpdateClients) {
        onUpdateClients(clients.filter(c => String(c.id) !== targetId));
      }
      // If the currently viewed contact is the one being deleted, close the view
      if (selectedContact && String(selectedContact.id) === targetId) {
        setSelectedContact(null);
      }
    }
  };

  const handleExportContacts = () => {
    const headers = "Nom,Type,Entreprise,Email,T√©l√©phone,Date Ajout\n";
    const rows = filteredContacts.map(c => 
      `"${c.name}","${c.type}","${c.companyName || ''}","${c.email}","${c.phone}","${new Date(c.createdAt).toLocaleDateString()}"`
    ).join("\n");
    
    const csvContent = "data:text/csv;charset=utf-8," + encodeURIComponent(headers + rows);
    const link = document.createElement("a");
    link.setAttribute("href", csvContent);
    link.setAttribute("download", `contacts_crm_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- INBOX LOGIC ---

  const handleSaveInbox = () => {
    if (!inboxForm.contactName || !onUpdateInbox) return;

    // 1. Create Inbox Item
    const newItem: InboxItem = {
      id: `req-${Date.now()}`,
      contactName: inboxForm.contactName,
      companyName: inboxForm.companyName,
      email: inboxForm.email,
      phone: inboxForm.phone,
      requestDate: new Date().toISOString(),
      source: inboxForm.source,
      status: 'to_process',
      eventStartDate: inboxForm.eventStartDate,
      eventEndDate: inboxForm.eventEndDate,
      note: inboxForm.note,
      quoteSent: false
    };
    onUpdateInbox([newItem, ...inbox]);

    // 2. Check/Update Contacts (Automated Database)
    if (onUpdateClients && clients) {
      const existingClient = clients.find(c => 
        (c.email && c.email.toLowerCase() === inboxForm.email.toLowerCase()) || 
        (c.name.toLowerCase() === inboxForm.contactName.toLowerCase())
      );

      if (existingClient) {
        // Update existing if phone missing
        if (!existingClient.phone && inboxForm.phone) {
           const updated = clients.map(c => c.id === existingClient.id ? { ...c, phone: inboxForm.phone } : c);
           onUpdateClients(updated);
        }
      } else {
        // Create new contact
        const newClient: Client = {
          id: `cl-${Date.now()}`,
          name: inboxForm.contactName,
          companyName: inboxForm.companyName,
          type: inboxForm.companyName ? 'Entreprise' : 'Particulier',
          email: inboxForm.email,
          phone: inboxForm.phone,
          address: '',
          createdAt: new Date().toISOString()
        };
        onUpdateClients([newClient, ...clients]);
      }
    }

    setInboxForm({ 
      contactName: '', companyName: '', email: '', phone: '', source: 'email',
      eventStartDate: '', eventEndDate: '', note: '' 
    });
  };

  const handleValidateRequest = (item: InboxItem) => {
    // 1. Pre-fill Lead Form - CRITIQUE: Mapping Dates
    setForm({
      groupName: item.companyName ? `Groupe ${item.companyName}` : `Event ${item.contactName}`,
      contactName: item.contactName,
      email: item.email,
      phone: item.phone,
      startDate: item.eventStartDate || '', // START DATE
      endDate: item.eventEndDate || '',     // END DATE
      note: `${item.note ? item.note + '\n\n' : ''}Source: ${item.source.toUpperCase()}. Demande du ${new Date(item.requestDate).toLocaleDateString()}`
    });
    
    // 2. Mark as processed (Soft Delete from active view)
    if (onUpdateInbox) {
      const updatedInbox = inbox.map(i => i.id === item.id ? { ...i, status: 'processed' as const } : i);
      onUpdateInbox(updatedInbox);
    }

    // 3. Switch to New Lead Tab
    setActiveTab('new_lead');
  };

  const handleArchiveRequest = (id: string) => {
    if (onUpdateInbox) {
      // LOGIQUE : Soft delete (changement de statut) pour retrait imm√©diat de la liste
      const updatedInbox = inbox.map(i => i.id === id ? { ...i, status: 'archived' as const } : i);
      onUpdateInbox(updatedInbox);
      
      // FEEDBACK : Notification Toast
      setToastMessage("Demande archiv√©e avec succ√®s");
      setTimeout(() => setToastMessage(null), 3000);
    }
  };

  const handleUpdateLastFollowUp = (id: string, date: string) => {
    if (onUpdateInbox) {
        onUpdateInbox(inbox.map(i => i.id === id ? { ...i, lastFollowUp: date } : i));
    }
  };

  const handleToggleQuoteSent = (id: string) => {
    if (onUpdateInbox) {
        onUpdateInbox(inbox.map(i => i.id === id ? { ...i, quoteSent: !i.quoteSent } : i));
    }
  };

  // --- LEADS LOGIC ---

  const handleCreateLead = () => {
    if (!form.groupName || !form.contactName) return;
    
    const newLead: Lead = {
      id: `lead-${Date.now()}`,
      groupName: form.groupName,
      contactName: form.contactName,
      email: form.email || '',
      phone: form.phone || '',
      requestDate: new Date().toISOString(),
      startDate: form.startDate || '',
      endDate: form.endDate || '',
      pax: form.pax || 0,
      note: form.note || '',
      status: 'nouveau',
      checklist: { roomSetup: false, menu: false, roomingList: false },
      ownerId: ''
    };

    onUpdateLeads([newLead, ...leads]);
    setForm({ groupName: '', contactName: '', email: '', phone: '', pax: 0, note: '', startDate: '', endDate: '' });
    setActiveTab('pipeline');
  };

  const handleUpdateLead = (lead: Lead) => {
    onUpdateLeads(leads.map(l => l.id === lead.id ? lead : l));
    setSelectedLead(lead); // Update view
  };

  const handleDeleteLead = (id: string) => {
    if(confirm("Supprimer ce lead ?")) {
        onUpdateLeads(leads.filter(l => l.id !== id));
        setSelectedLead(null);
    }
  };

  const checkAlerts = (lead: Lead) => {
    try {
      const now = new Date();
      const reqDate = lead.requestDate ? new Date(lead.requestDate) : new Date();
      const evtDate = lead.startDate ? new Date(lead.startDate) : (lead.eventDate ? new Date(lead.eventDate) : null);
      
      const alerts = [];

      // Alert: Relance (> 7 days in 'en_cours' or 'nouveau')
      const diffDays = Math.ceil((now.getTime() - reqDate.getTime()) / (1000 * 3600 * 24));
      if ((lead.status === 'nouveau' || lead.status === 'en_cours') && diffDays > 7) {
        alerts.push({ type: 'followup', label: 'Relance', color: 'text-amber-500 bg-amber-50' });
      }

      // Alert: Urgent Arrival (< 30 days)
      if (evtDate && lead.status !== 'perdu' && !isNaN(evtDate.getTime())) {
         const diffEvt = Math.ceil((evtDate.getTime() - now.getTime()) / (1000 * 3600 * 24));
         if (diffEvt > 0 && diffEvt < 30) {
           alerts.push({ type: 'urgent', label: 'J-' + diffEvt, color: 'text-red-500 bg-red-50' });
         }
      }

      return alerts;
    } catch (e) {
      return [];
    }
  };

  // --- FILTERS & SORTING (PIPELINE) ---

  const processedLeads = useMemo(() => {
    if (!leads) return [];
    
    let items = [...leads];

    // 1. Search (Safe)
    if (pipelineSearch) {
      const lower = safeLower(pipelineSearch);
      items = items.filter(l => 
        safeLower(l.groupName).includes(lower) ||
        safeLower(l.contactName).includes(lower) ||
        safeLower(l.email).includes(lower)
      );
    }

    // 2. Filter (Status OR Alert) - Safe Logic
    if (pipelineFilter !== 'ALL') {
      try {
        if (['nouveau', 'en_cours', 'valide', 'perdu'].includes(pipelineFilter)) {
          items = items.filter(l => l.status === pipelineFilter);
        } else if (pipelineFilter === 'URGENT_ARRIVAL') {
          const now = new Date();
          items = items.filter(l => {
            const dateStr = l.startDate || l.eventDate;
            if (!dateStr || l.status === 'perdu') return false;
            const evtDate = new Date(dateStr);
            if (isNaN(evtDate.getTime())) return false;
            const diff = (evtDate.getTime() - now.getTime()) / (1000 * 3600 * 24);
            return diff > 0 && diff < 30;
          });
        } else if (pipelineFilter === 'LATE_FOLLOWUP') {
          const now = new Date();
          items = items.filter(l => {
            if (l.status === 'valide' || l.status === 'perdu') return false;
            if (!l.requestDate) return false;
            const reqDate = new Date(l.requestDate);
            if (isNaN(reqDate.getTime())) return false;
            const diff = (now.getTime() - reqDate.getTime()) / (1000 * 3600 * 24);
            return diff > 7;
          });
        } else if (pipelineFilter === 'THIS_MONTH') {
          const now = new Date();
          items = items.filter(l => {
            const dateStr = l.startDate || l.eventDate;
            if (!dateStr) return false;
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return false;
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
          });
        }
      } catch (e) {
        console.error("Filter error", e);
        // On error, we fallback to showing items or continue (don't crash)
      }
    }

    // 3. Sorting (Safe)
    items.sort((a, b) => {
      try {
        switch (pipelineSort) {
          case 'event_asc': {
            const dateA = safeDate(a.startDate || a.eventDate);
            const dateB = safeDate(b.startDate || b.eventDate);
            if (!dateA) return 1;
            if (!dateB) return -1;
            return dateA - dateB;
          }
          case 'created_desc':
            return safeDate(b.requestDate) - safeDate(a.requestDate);
          
          case 'alpha':
            return safeLower(a.groupName).localeCompare(safeLower(b.groupName));

          case 'urgency': {
            const scoreA = checkAlerts(a).length;
            const scoreB = checkAlerts(b).length;
            return scoreB - scoreA;
          }
          default:
            return 0;
        }
      } catch (e) {
        return 0;
      }
    });

    return items;
  }, [leads, pipelineSearch, pipelineFilter, pipelineSort]);

  // --- CALENDAR LOGIC (Internal) ---
  const calendarData = useMemo(() => {
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const days = [];
    
    // Pad Start
    let startDay = firstDay.getDay(); 
    startDay = startDay === 0 ? 6 : startDay - 1; // Mon=0
    for(let i=0; i<startDay; i++) days.push(null);
    
    // Days
    for(let i=1; i<=lastDay.getDate(); i++) days.push(new Date(year, month, i));
    
    return days;
  }, [calendarDate]);

  const getLeadsForDate = (date: Date) => {
    return processedLeads.filter(l => {
      if (!l.startDate) return false;
      const start = new Date(l.startDate);
      if (isNaN(start.getTime())) return false;
      start.setHours(0,0,0,0);
      
      let end = new Date(start);
      if (l.endDate) {
        const d = new Date(l.endDate);
        if (!isNaN(d.getTime())) {
          end = d;
          end.setHours(0,0,0,0);
        }
      }
      
      const check = new Date(date);
      check.setHours(0,0,0,0);
      return check >= start && check <= end;
    });
  };

  const checkIsOverdue = (item: InboxItem) => {
     if (item.status !== 'to_process') return false;
     const now = new Date();
     const reqDate = item.lastFollowUp ? new Date(item.lastFollowUp) : new Date(item.requestDate);
     if (isNaN(reqDate.getTime())) return false;
     const diff = now.getTime() - reqDate.getTime();
     return diff > 48 * 3600 * 1000; // 48h
  };

  const processedInbox = useMemo(() => {
    if (!inbox) return [];
    let items = [...inbox].filter(i => i.status === 'to_process');
    
    // Search
    if (inboxSearch) {
      const lower = safeLower(inboxSearch);
      items = items.filter(i => 
        safeLower(i.contactName).includes(lower) || 
        safeLower(i.companyName).includes(lower) || 
        safeLower(i.email).includes(lower)
      );
    }

    // Filter
    if (inboxFilter !== 'ALL') {
      try {
        if (inboxFilter === 'URGENT') {
          items = items.filter(i => checkIsOverdue(i));
        } else if (inboxFilter === 'THIS_MONTH') {
          const now = new Date();
          items = items.filter(i => {
            if (!i.eventStartDate) return false;
            const d = new Date(i.eventStartDate);
            return !isNaN(d.getTime()) && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
          });
        } else {
          items = items.filter(i => safeLower(i.source) === safeLower(inboxFilter));
        }
      } catch (e) {
        // Fallback
      }
    }

    // Sort
    items.sort((a, b) => {
      try {
        switch (inboxSort) {
          case 'date_asc': return safeDate(a.requestDate) - safeDate(b.requestDate);
          case 'date_desc': return safeDate(b.requestDate) - safeDate(a.requestDate);
          case 'alpha': return safeLower(a.contactName).localeCompare(safeLower(b.contactName));
          case 'event_date':
             const da = safeDate(a.eventStartDate);
             const db = safeDate(b.eventStartDate);
             if (!da) return 1; if (!db) return -1;
             return da - db; 
          case 'urgency':
             const ua = checkIsOverdue(a) ? 1 : 0;
             const ub = checkIsOverdue(b) ? 1 : 0;
             return ub - ua;
          default: return 0;
        }
      } catch (e) { return 0; }
    });
    return items;
  }, [inbox, inboxSearch, inboxFilter, inboxSort]);

  const handleExportCSV = () => {
    const archiveList = inbox.filter(i => i.status !== 'to_process');
    const headers = ['Date', 'Nom Contact', 'Entreprise', 'Email', 'T√©l√©phone', 'Source', 'Statut', 'Note'];
    const rows = archiveList.map(item => [
       new Date(item.requestDate).toLocaleDateString(),
       `"${item.contactName}"`,
       `"${item.companyName || ''}"`,
       item.email,
       item.phone,
       item.source,
       item.status === 'processed' ? 'Valid√©' : 'Non Abouti',
       `"${(item.note || '').replace(/"/g, '""')}"`
    ]);
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `archives_crm_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const canValidate = (lead: Lead) => {
    return lead.checklist.roomSetup && lead.checklist.menu && lead.checklist.roomingList;
  };

  const sortedArchives = useMemo(() => {
    if (!inbox) return [];
    return inbox.filter(i => i.status !== 'to_process').sort((a, b) => safeDate(b.requestDate) - safeDate(a.requestDate));
  }, [inbox]);

  const filteredContacts = useMemo(() => {
    if (!clients) return [];
    if (!contactSearch) return clients;
    const lower = safeLower(contactSearch);
    return clients.filter(c => safeLower(c.name).includes(lower) || safeLower(c.companyName).includes(lower));
  }, [clients, contactSearch]);

  const clientHistory = useMemo(() => {
    if (!selectedContact) return [];
    return leads.filter(l => 
        l.email === selectedContact.email || 
        l.contactName === selectedContact.name
    ).sort((a, b) => safeDate(b.requestDate) - safeDate(a.requestDate));
  }, [selectedContact, leads]);

  // --- RENDER ---

  const themeClass = `bg-${userSettings.themeColor}-600`;
  const themeText = `text-${userSettings.themeColor}-600`;

  return (
    <div className={`h-full flex flex-col overflow-hidden animate-in fade-in relative ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* Toast Notification */}
      {toastMessage && (
        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl z-[100] flex items-center gap-3 animate-in slide-in-from-bottom-5 fade-in duration-300">
           <div className="bg-emerald-500 rounded-full p-1"><CheckCircle2 size={12} className="text-white"/></div>
           <span className="text-xs font-bold">{toastMessage}</span>
        </div>
      )}

      {/* Header */}
      <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="flex items-center gap-4">
            <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-500/20">
              <Briefcase size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Suivi Commercial</h2>
              <p className="text-xs font-bold text-slate-400">Leads & Demandes Groupes</p>
            </div>
         </div>
         <button 
           onClick={() => onNavigate('dashboard')} // Will be intercepted to go to portal
           className="px-4 py-2 rounded-xl border-2 border-slate-200 dark:border-slate-700 font-black text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
         >
           <ArrowLeft size={14}/> Retour
         </button>
      </div>

      {/* Tabs */}
      <div className="px-6 py-4">
         <div className="flex p-1 rounded-2xl bg-slate-200 dark:bg-slate-800 w-fit overflow-x-auto whitespace-nowrap max-w-full no-scrollbar px-2">
            <button 
              onClick={() => setActiveTab('pipeline')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'pipeline' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
            >
              <Filter size={14}/> Pipeline
            </button>
            <button 
              onClick={() => setActiveTab('inbox')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'inbox' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
            >
              <Inbox size={14}/> Demandes (Inbox)
            </button>
            <button 
              onClick={() => setActiveTab('contacts')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'contacts' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
            >
              <Users size={14}/> Contacts
            </button>
            <button 
              onClick={() => setActiveTab('archives')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'archives' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
            >
              <Archive size={14}/> Archives
            </button>
            <button 
              onClick={() => setActiveTab('new_lead')}
              className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === 'new_lead' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-500'}`}
            >
              <Plus size={14}/> Nouveau Lead
            </button>
         </div>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-hidden p-4 md:px-6 md:pb-20 flex flex-col md:flex-row gap-4 md:gap-6">
         
         {/* --- PIPELINE TAB (ENHANCED) --- */}
         {activeTab === 'pipeline' && (
           <>
             {/* Left: Cockpit List OR Calendar */}
             <div className={`w-full md:w-1/3 flex flex-col rounded-[32px] border overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'} ${pipelineViewMode === 'calendar' ? 'md:w-2/3' : ''}`}>
                
                {/* COCKPIT TOOLBAR */}
                <div className="p-4 border-b border-slate-100 dark:border-slate-700 space-y-3">
                   {/* Top Row: Search & View Toggle */}
                   <div className="flex gap-2">
                      <div className="flex-1 flex items-center bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-2 border border-transparent focus-within:border-indigo-500 transition-colors">
                         <Search size={16} className="text-slate-400 mr-2"/>
                         <input 
                           type="text" 
                           placeholder="üîç Chercher un groupe..." 
                           value={pipelineSearch}
                           onChange={(e) => setPipelineSearch(e.target.value)}
                           className="bg-transparent outline-none w-full text-xs font-bold"
                         />
                      </div>
                      
                      {/* View Toggle */}
                      <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl">
                         <button 
                           onClick={() => setPipelineViewMode('list')}
                           className={`p-2 rounded-lg transition-all ${pipelineViewMode === 'list' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}
                           title="Vue Liste"
                         >
                           <LayoutList size={16}/>
                         </button>
                         <button 
                           onClick={() => setPipelineViewMode('calendar')}
                           className={`p-2 rounded-lg transition-all ${pipelineViewMode === 'calendar' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600' : 'text-slate-400'}`}
                           title="Vue Calendrier"
                         >
                           <CalendarDays size={16}/>
                         </button>
                      </div>
                   </div>

                   {/* Middle Row: Sort Dropdown */}
                   {pipelineViewMode === 'list' && (
                     <div className="relative">
                        <div className="flex items-center bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-2 border border-transparent">
                           <ArrowDownUp size={14} className="text-slate-400 mr-2"/>
                           <select 
                             value={pipelineSort}
                             onChange={(e) => setPipelineSort(e.target.value as any)}
                             className="bg-transparent outline-none w-full text-xs font-bold appearance-none cursor-pointer"
                           >
                              <option value="event_asc">üìÖ Prochaines Arriv√©es (D√©faut)</option>
                              <option value="created_desc">üÜï Date de Cr√©ation</option>
                              <option value="urgency">üö® Urgence / Retard</option>
                              <option value="alpha">Abc Alphab√©tique</option>
                           </select>
                        </div>
                     </div>
                   )}

                   {/* Bottom Row: Quick Filter Chips */}
                   <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                      <button onClick={() => setPipelineFilter('ALL')} className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase whitespace-nowrap border transition-all ${pipelineFilter === 'ALL' ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-200 dark:border-slate-700 text-slate-500'}`}>Tous</button>
                      <button onClick={() => setPipelineFilter('URGENT_ARRIVAL')} className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase whitespace-nowrap border transition-all ${pipelineFilter === 'URGENT_ARRIVAL' ? 'bg-red-500 text-white border-red-500' : 'border-slate-200 dark:border-slate-700 text-slate-500 hover:text-red-500'}`}>üö® J-30</button>
                      <button onClick={() => setPipelineFilter('LATE_FOLLOWUP')} className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase whitespace-nowrap border transition-all ${pipelineFilter === 'LATE_FOLLOWUP' ? 'bg-amber-500 text-white border-amber-500' : 'border-slate-200 dark:border-slate-700 text-slate-500 hover:text-amber-500'}`}>‚ö†Ô∏è Relance</button>
                      <button onClick={() => setPipelineFilter('THIS_MONTH')} className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase whitespace-nowrap border transition-all ${pipelineFilter === 'THIS_MONTH' ? 'bg-violet-500 text-white border-violet-500' : 'border-slate-200 dark:border-slate-700 text-slate-500'}`}>üìÖ Ce Mois</button>
                   </div>
                </div>
                
                {/* CONTENT AREA */}
                <div className="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar bg-slate-50/50 dark:bg-slate-900/50">
                   
                   {/* MODE LISTE */}
                   {pipelineViewMode === 'list' ? (
                     <>
                       {processedLeads.map(lead => {
                         const alerts = checkAlerts(lead);
                         return (
                           <div 
                             key={lead.id}
                             onClick={() => setSelectedLead(lead)}
                             className={`p-4 rounded-2xl border cursor-pointer transition-all ${selectedLead?.id === lead.id ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200' : 'bg-white dark:bg-slate-900 border-transparent hover:border-slate-200'}`}
                           >
                              <div className="flex justify-between items-start mb-2">
                                 <h4 className="font-bold text-sm line-clamp-1">{lead.groupName}</h4>
                                 <span className={`text-[8px] font-black uppercase px-2 py-0.5 rounded ${
                                   lead.status === 'valide' ? 'bg-emerald-100 text-emerald-700' : 
                                   lead.status === 'perdu' ? 'bg-slate-200 text-slate-500' : 
                                   lead.status === 'nouveau' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'
                                 }`}>
                                   {lead.status.replace('_', ' ')}
                                 </span>
                              </div>
                              <div className="flex justify-between items-center text-xs text-slate-500">
                                 <span>{lead.contactName}</span>
                                 <span>{lead.pax} Pax</span>
                              </div>
                              {/* UPDATED: Affichage Plage Dates en gras */}
                              <p className="text-[9px] font-bold text-indigo-400 mt-1 flex items-center gap-1">
                                 <Calendar size={10}/> 
                                 {lead.startDate ? (
                                    <span className="font-black">
                                      {new Date(lead.startDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'numeric'})}
                                      {lead.endDate ? ` au ${new Date(lead.endDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'numeric'})}` : ''}
                                    </span>
                                 ) : (
                                    <span>{lead.eventDate ? new Date(lead.eventDate).toLocaleDateString() : 'Dates √† d√©finir'}</span>
                                 )}
                              </p>
                              
                              {/* Alerts Badges */}
                              {alerts.length > 0 && (
                                <div className="flex gap-1 mt-3">
                                   {alerts.map((alert, idx) => (
                                     <div key={idx} className={`flex items-center gap-1 px-2 py-1 rounded text-[8px] font-black uppercase ${alert.color}`}>
                                        <AlertTriangle size={10}/> {alert.label}
                                     </div>
                                   ))}
                                </div>
                              )}
                           </div>
                         );
                       })}
                       {processedLeads.length === 0 && (
                         <div className="text-center py-10 text-slate-400 text-xs font-medium">Aucun dossier trouv√©.</div>
                       )}
                     </>
                   ) : (
                     /* MODE CALENDRIER */
                     <div className="h-full flex flex-col bg-white dark:bg-slate-900 rounded-b-[24px]">
                        {/* Month Header */}
                        <div className="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800">
                           <button onClick={() => setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth() - 1)))} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><ChevronLeft size={16}/></button>
                           <span className="text-sm font-black uppercase">{calendarDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</span>
                           <button onClick={() => setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth() + 1)))} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><ChevronRight size={16}/></button>
                        </div>
                        
                        {/* Grid */}
                        <div className="grid grid-cols-7 border-b border-slate-100 dark:border-slate-800 text-[10px] font-black text-slate-400 text-center py-2">
                           {['L', 'M', 'M', 'J', 'V', 'S', 'D'].map(d => <div key={d}>{d}</div>)}
                        </div>
                        <div className="flex-1 grid grid-cols-7 auto-rows-fr overflow-y-auto">
                           {calendarData.map((date, i) => {
                             if (!date) return <div key={`empty-${i}`} className="bg-slate-50/50 dark:bg-slate-800/30 border-b border-r border-slate-100 dark:border-slate-800" />;
                             
                             const daysLeads = getLeadsForDate(date);
                             const isToday = date.toDateString() === new Date().toDateString();

                             return (
                               <div key={i} className={`min-h-[80px] p-1 border-b border-r border-slate-100 dark:border-slate-800 relative ${isToday ? 'bg-indigo-50/30' : ''}`}>
                                  <span className={`text-[10px] font-bold block mb-1 ${isToday ? 'text-indigo-600' : 'text-slate-400'}`}>{date.getDate()}</span>
                                  <div className="space-y-1">
                                     {daysLeads.map(l => (
                                       <div 
                                         key={l.id}
                                         onClick={() => { setSelectedLead(l); setPipelineViewMode('list'); }} // SWITCH BACK TO LIST & SELECT
                                         className={`text-[8px] font-bold px-1 py-0.5 rounded truncate cursor-pointer hover:opacity-80 transition-opacity text-white ${
                                           l.status === 'valide' ? 'bg-emerald-500' :
                                           l.status === 'en_cours' ? 'bg-amber-400' :
                                           l.status === 'nouveau' ? 'bg-blue-400' : 'bg-slate-400'
                                         }`}
                                         title={l.groupName}
                                       >
                                          {l.groupName}
                                       </div>
                                     ))}
                                  </div>
                               </div>
                             );
                           })}
                        </div>
                     </div>
                   )}
                </div>
             </div>

             {/* Right: Detail (Existing Logic reused) */}
             <div className={`flex-1 rounded-[32px] border overflow-hidden flex flex-col ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                {selectedLead ? (
                  <div className="flex flex-col h-full">
                     {/* Detail Header */}
                     <div className="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-start">
                        <div>
                           <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Dossier #{selectedLead.id.split('-')[1]}</span>
                           <h2 className="text-3xl font-black mt-1">{selectedLead.groupName}</h2>
                           
                           {/* UPDATED: Date Pickers in Detail */}
                           <div className="grid grid-cols-2 gap-4 mt-3 bg-slate-50 dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-800">
                              <div>
                                 <label className="text-[9px] font-bold text-slate-400 uppercase ml-1">Arriv√©e</label>
                                 <input 
                                   type="date" 
                                   className="w-full bg-transparent font-bold text-xs outline-none text-slate-700 dark:text-slate-200"
                                   value={selectedLead.startDate || selectedLead.eventDate || ''}
                                   onChange={(e) => handleUpdateLead({ ...selectedLead, startDate: e.target.value })}
                                 />
                              </div>
                              <div>
                                 <label className="text-[9px] font-bold text-slate-400 uppercase ml-1">D√©part</label>
                                 <input 
                                   type="date" 
                                   className="w-full bg-transparent font-bold text-xs outline-none text-slate-700 dark:text-slate-200"
                                   value={selectedLead.endDate || ''}
                                   onChange={(e) => handleUpdateLead({ ...selectedLead, endDate: e.target.value })}
                                 />
                              </div>
                           </div>

                           <div className="flex items-center gap-4 mt-2">
                              <div className="flex items-center gap-2 text-xs font-medium text-slate-500">
                                 <User size={14}/> {selectedLead.contactName}
                              </div>
                           </div>
                        </div>
                        <div className="flex flex-col items-end gap-2">
                           <div className="bg-slate-100 dark:bg-slate-900 rounded-xl p-1 flex">
                              <select 
                                value={selectedLead.status}
                                onChange={(e) => handleUpdateLead({ ...selectedLead, status: e.target.value as LeadStatus })}
                                className="bg-transparent text-xs font-bold uppercase outline-none px-2 py-1 cursor-pointer disabled:opacity-50"
                              >
                                 <option value="nouveau">Nouveau</option>
                                 <option value="en_cours">En cours</option>
                                 <option value="valide" disabled={!canValidate(selectedLead)}>Valid√© (Checklist Requise)</option>
                                 <option value="perdu">Perdu</option>
                              </select>
                           </div>
                           <select 
                             value={selectedLead.ownerId || ''}
                             onChange={(e) => handleUpdateLead({ ...selectedLead, ownerId: e.target.value })}
                             className="text-[10px] font-bold bg-transparent outline-none text-right text-indigo-500 cursor-pointer"
                           >
                             <option value="">Assigner responsable...</option>
                             {users.map(u => <option key={u.uid} value={u.uid}>{u.displayName}</option>)}
                           </select>
                        </div>
                     </div>

                     {/* Detail Body */}
                     <div className="flex-1 overflow-y-auto p-6 space-y-8">
                        
                        {/* 1. Contact Info */}
                        <div className="grid grid-cols-2 gap-4">
                           <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900">
                              <p className="text-[10px] font-black uppercase text-slate-400 mb-1">Email</p>
                              <p className="font-bold text-sm">{selectedLead.email || '-'}</p>
                           </div>
                           <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900">
                              <p className="text-[10px] font-black uppercase text-slate-400 mb-1">T√©l√©phone</p>
                              <p className="font-bold text-sm">{selectedLead.phone || '-'}</p>
                           </div>
                        </div>

                        {/* 2. Checklist Validation - MANDATORY */}
                        <div className="p-6 rounded-2xl border-2 border-indigo-100 dark:border-indigo-900/50 bg-indigo-50/30 dark:bg-indigo-900/10">
                           <h4 className="text-sm font-black uppercase text-indigo-900 dark:text-indigo-200 mb-4 flex items-center gap-2">
                             <CheckSquare size={16}/> Checklist Validation
                           </h4>
                           <div className="space-y-3">
                              {[
                                { key: 'roomSetup', label: 'Disposition de salle valid√©e' },
                                { key: 'menu', label: 'Menu F&B valid√©' },
                                { key: 'roomingList', label: 'Rooming List re√ßue' },
                              ].map(item => (
                                <label key={item.key} className="flex items-center gap-3 cursor-pointer group">
                                   <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${selectedLead.checklist[item.key as keyof typeof selectedLead.checklist] ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300 bg-white dark:bg-slate-800'}`}>
                                      {selectedLead.checklist[item.key as keyof typeof selectedLead.checklist] && <CheckCircle2 size={14} className="text-white"/>}
                                   </div>
                                   <input 
                                     type="checkbox" 
                                     checked={selectedLead.checklist[item.key as keyof typeof selectedLead.checklist]}
                                     onChange={(e) => handleUpdateLead({
                                       ...selectedLead,
                                       checklist: { ...selectedLead.checklist, [item.key]: e.target.checked }
                                     })}
                                     className="hidden"
                                   />
                                   <span className={`text-sm font-bold ${selectedLead.checklist[item.key as keyof typeof selectedLead.checklist] ? 'text-indigo-900 dark:text-indigo-200' : 'text-slate-500'}`}>{item.label}</span>
                                </label>
                              ))}
                           </div>
                           {!canValidate(selectedLead) && selectedLead.status !== 'perdu' && (
                             <p className="text-[10px] text-amber-600 font-bold mt-4 flex items-center gap-1">
                               <AlertTriangle size={12}/> Compl√©tez la checklist pour passer en statut "Valid√©".
                             </p>
                           )}
                        </div>

                        {/* 3. Notes */}
                        <div className="space-y-2">
                           <h4 className="text-[10px] font-black uppercase text-slate-400 ml-1">Notes / Historique</h4>
                           <textarea 
                             className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 outline-none font-medium text-sm min-h-[150px]"
                             value={selectedLead.note}
                             onChange={(e) => handleUpdateLead({ ...selectedLead, note: e.target.value })}
                             placeholder="Notes internes..."
                           />
                        </div>

                        <div className="pt-4 flex justify-end">
                           <button onClick={() => handleDeleteLead(selectedLead.id)} className="text-red-400 hover:text-red-600 text-xs font-bold uppercase flex items-center gap-2">
                              <XCircle size={14}/> Supprimer le lead
                           </button>
                        </div>
                     </div>
                  </div>
                ) : (
                  <div className="flex-1 flex flex-col items-center justify-center opacity-30">
                     <Briefcase size={64} className="mb-4 text-slate-400"/>
                     <p className="text-xl font-black text-slate-500">S√©lectionnez un dossier</p>
                  </div>
                )}
             </div>
           </>
         )}

         {/* --- INBOX TAB --- */}
         {activeTab === 'inbox' && (
           <div className="flex flex-col md:flex-row h-full gap-4 md:gap-6 w-full">
              {/* Left: Quick Form */}
              <div className={`w-full md:w-1/3 flex flex-col rounded-[32px] border overflow-hidden p-6 space-y-4 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <h3 className="text-lg font-black uppercase tracking-tight">Saisie Rapide</h3>
                 <div className="space-y-3">
                    <input 
                      type="text" 
                      placeholder="Nom Contact *" 
                      className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-sm font-bold outline-none"
                      value={inboxForm.contactName}
                      onChange={(e) => setInboxForm({...inboxForm, contactName: e.target.value})}
                    />
                    <input 
                      type="text" 
                      placeholder="Entreprise" 
                      className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-sm font-bold outline-none"
                      value={inboxForm.companyName}
                      onChange={(e) => setInboxForm({...inboxForm, companyName: e.target.value})}
                    />
                    <input 
                      type="email" 
                      placeholder="Email" 
                      className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-sm font-bold outline-none"
                      value={inboxForm.email}
                      onChange={(e) => setInboxForm({...inboxForm, email: e.target.value})}
                    />
                    <input 
                      type="tel" 
                      placeholder="T√©l√©phone" 
                      className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-sm font-bold outline-none"
                      value={inboxForm.phone}
                      onChange={(e) => setInboxForm({...inboxForm, phone: e.target.value})}
                    />
                    
                    <div className="grid grid-cols-2 gap-2">
                        <div>
                            <label className="text-[9px] font-bold text-slate-400 uppercase ml-1">Du...</label>
                            <input 
                                type="date" 
                                className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-xs font-bold outline-none uppercase"
                                value={inboxForm.eventStartDate}
                                onChange={(e) => setInboxForm({...inboxForm, eventStartDate: e.target.value})}
                            />
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-slate-400 uppercase ml-1">Au...</label>
                            <input 
                                type="date" 
                                className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-xs font-bold outline-none uppercase"
                                value={inboxForm.eventEndDate}
                                onChange={(e) => setInboxForm({...inboxForm, eventEndDate: e.target.value})}
                            />
                        </div>
                    </div>

                    <textarea 
                        placeholder="Note / Commentaires (ex: Besoin particulier, occasion...)" 
                        className="w-full p-3 bg-slate-50 dark:bg-slate-900 rounded-xl text-xs font-medium outline-none resize-none h-20"
                        value={inboxForm.note}
                        onChange={(e) => setInboxForm({...inboxForm, note: e.target.value})}
                    />

                    <div className="flex gap-2">
                       {['email', 'phone', 'website'].map(s => (
                         <button 
                           key={s} 
                           onClick={() => setInboxForm({...inboxForm, source: s as InboxSource})}
                           className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase border ${inboxForm.source === s ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'border-slate-100 dark:border-slate-700 text-slate-400'}`}
                         >
                           {s === 'website' ? 'Web' : s === 'phone' ? 'T√©l' : 'Email'}
                         </button>
                       ))}
                    </div>
                    <button 
                      onClick={handleSaveInbox}
                      disabled={!inboxForm.contactName}
                      className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-indigo-700 disabled:opacity-50 transition-all"
                    >
                       Enregistrer Demande
                    </button>
                 </div>
              </div>

              {/* Right: Inbox List & Toolbar */}
              <div className="flex-1 flex flex-col h-full overflow-hidden">
                 
                 {/* TOOLBAR: Search, Sort, Filters */}
                 <div className={`mb-4 p-4 rounded-[24px] border shadow-sm space-y-3 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                    
                    {/* Row 1: Search & Sort */}
                    <div className="flex flex-col md:flex-row gap-3">
                       <div className="flex-1 flex items-center bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-2 border border-slate-100 dark:border-slate-700 focus-within:border-indigo-500 transition-colors">
                          <Search size={16} className="text-slate-400 mr-2"/>
                          <input 
                            type="text" 
                            placeholder="Rechercher un lead..." 
                            value={inboxSearch}
                            onChange={(e) => setInboxSearch(e.target.value)}
                            className="bg-transparent outline-none w-full text-xs font-bold"
                          />
                       </div>
                       <div className="relative md:min-w-[180px]">
                          <div className="flex items-center bg-slate-50 dark:bg-slate-900 rounded-xl px-3 py-2 border border-slate-100 dark:border-slate-700">
                             <ArrowDownUp size={14} className="text-slate-400 mr-2"/>
                             <select 
                               value={inboxSort}
                               onChange={(e) => setInboxSort(e.target.value as any)}
                               className="bg-transparent outline-none w-full text-xs font-bold appearance-none cursor-pointer"
                             >
                                <option value="date_desc">üìÖ R√©cent ‚Üí Ancien</option>
                                <option value="date_asc">üìÖ Ancien ‚Üí R√©cent</option>
                                <option value="urgency">üö® Urgence Relance</option>
                                <option value="event_date">üìÜ Date √âv√©nement</option>
                                <option value="alpha">Abc Alphab√©tique</option>
                             </select>
                          </div>
                       </div>
                    </div>

                    {/* Row 2: Filters & Counter */}
                    <div className="flex items-center justify-between overflow-x-auto no-scrollbar gap-4">
                       <div className="flex gap-2">
                          <button 
                            onClick={() => setInboxFilter('ALL')}
                            className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all border ${inboxFilter === 'ALL' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white dark:bg-slate-900 text-slate-500 border-slate-200 dark:border-slate-700'}`}
                          >
                             Tous
                          </button>
                          <button 
                            onClick={() => setInboxFilter('URGENT')}
                            className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all border flex items-center gap-1 ${inboxFilter === 'URGENT' ? 'bg-red-500 text-white border-red-500' : 'bg-white dark:bg-slate-900 text-slate-500 border-slate-200 dark:border-slate-700 hover:text-red-500'}`}
                          >
                             ‚ö†Ô∏è Retard Relance
                          </button>
                          <button 
                            onClick={() => setInboxFilter('THIS_MONTH')}
                            className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all border ${inboxFilter === 'THIS_MONTH' ? 'bg-violet-500 text-white border-violet-500' : 'bg-white dark:bg-slate-900 text-slate-500 border-slate-200 dark:border-slate-700'}`}
                          >
                             Ce Mois-ci
                          </button>
                          <div className="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-0.5">
                             {['EMAIL', 'PHONE', 'WEB'].map(f => (
                               <button 
                                 key={f}
                                 onClick={() => setInboxFilter(f as any)}
                                 className={`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${inboxFilter === f ? 'bg-white dark:bg-slate-600 shadow text-indigo-600' : 'text-slate-400'}`}
                               >
                                 {f === 'WEB' ? 'üåê' : f === 'PHONE' ? 'üìû' : 'üìß'}
                               </button>
                             ))}
                          </div>
                       </div>
                       <span className="text-[9px] font-bold text-slate-400 whitespace-nowrap">
                          {processedInbox.length} demande{processedInbox.length !== 1 ? 's' : ''} affich√©e{processedInbox.length !== 1 ? 's' : ''}
                       </span>
                    </div>
                 </div>

                 {/* List */}
                 <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar pb-10">
                    {processedInbox.map(item => {
                      const isAlert = checkIsOverdue(item);

                      return (
                        <div key={item.id} className={`p-4 rounded-2xl border flex flex-col md:flex-row justify-between md:items-center bg-white dark:bg-slate-800 ${isAlert ? 'border-orange-300 bg-orange-50 dark:bg-orange-900/10' : 'border-slate-100 dark:border-slate-700'}`}>
                           <div className="flex items-center gap-4 mb-3 md:mb-0">
                              <div className={`p-3 rounded-xl ${item.source === 'email' ? 'bg-blue-50 text-blue-600' : item.source === 'phone' ? 'bg-emerald-50 text-emerald-600' : 'bg-purple-50 text-purple-600'}`}>
                                 {item.source === 'email' ? <Mail size={18}/> : item.source === 'phone' ? <Phone size={18}/> : <Globe size={18}/>}
                              </div>
                              <div>
                                 <h4 className="font-bold text-sm">{item.contactName} {item.companyName && <span className="text-slate-400 font-medium">({item.companyName})</span>}</h4>
                                 <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Recu le {new Date(item.requestDate).toLocaleDateString()} √† {new Date(item.requestDate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                                 
                                 {item.eventStartDate && (
                                   <div className="flex items-center gap-1 mt-1.5 text-indigo-600 dark:text-indigo-400">
                                       <Calendar size={12} />
                                       <span className="text-[10px] font-black uppercase">
                                           {new Date(item.eventStartDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'numeric'})}
                                           {item.eventEndDate && ` au ${new Date(item.eventEndDate).toLocaleDateString('fr-FR', {day: 'numeric', month: 'numeric'})}`}
                                       </span>
                                   </div>
                                 )}

                                 {isAlert && <span className="text-[9px] font-black text-orange-500 flex items-center gap-1 mt-1"><AlertTriangle size={10}/> Relance n√©cessaire (+48h)</span>}
                              </div>
                           </div>
                           
                           <div className="flex items-center gap-4 md:gap-6 justify-between md:justify-end w-full md:w-auto">
                              {/* Quote Sent Toggle */}
                              <button
                                onClick={(e) => { e.stopPropagation(); handleToggleQuoteSent(item.id); }}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all ${
                                    item.quoteSent 
                                    ? 'bg-emerald-50 border-emerald-200 text-emerald-700' 
                                    : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-400 hover:border-slate-300'
                                }`}
                              >
                                <div className={`w-3 h-3 rounded flex items-center justify-center border transition-colors ${
                                    item.quoteSent ? 'bg-emerald-500 border-emerald-500' : 'bg-transparent border-slate-300'
                                }`}>
                                    {item.quoteSent && <Check size={8} className="text-white" strokeWidth={4} />}
                                </div>
                                <span className={`text-[10px] uppercase tracking-wide ${item.quoteSent ? 'font-black' : 'font-bold'}`}>Devis envoy√©</span>
                              </button>

                              <div className="text-right">
                                 <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">Derni√®re Relance</p>
                                 <input 
                                   type="date" 
                                   value={item.lastFollowUp ? item.lastFollowUp.split('T')[0] : ''}
                                   onChange={(e) => handleUpdateLastFollowUp(item.id, new Date(e.target.value).toISOString())}
                                   className="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-xs font-bold outline-none"
                                 />
                              </div>
                              <div className="flex gap-2">
                                 <button onClick={() => handleValidateRequest(item)} className="px-4 py-2 bg-emerald-500 text-white rounded-xl text-[10px] font-black uppercase shadow hover:bg-emerald-600 transition-colors flex items-center gap-1">
                                    <CheckCircle2 size={12}/> Valider
                                 </button>
                                 <button 
                                   onClick={(e) => { e.stopPropagation(); handleArchiveRequest(item.id); }}
                                   className="p-2 text-slate-300 hover:text-red-500 transition-colors" 
                                   title="Sans suite (Archiver)"
                                 >
                                    <XCircle size={18}/>
                                 </button>
                              </div>
                           </div>
                        </div>
                      );
                    })}
                    {processedInbox.length === 0 && (
                      <div className="text-center py-20 text-slate-400 font-medium">Aucune demande correspondant aux filtres.</div>
                    )}
                 </div>
              </div>
           </div>
         )}

         {/* --- ARCHIVES TAB --- */}
         {activeTab === 'archives' && (
           <div className="w-full h-full flex flex-col">
              {/* Toolbar */}
              <div className="flex justify-between items-center mb-6">
                 <div>
                    <h3 className="text-xl font-black">Historique des Demandes</h3>
                    <p className="text-xs text-slate-400 font-bold">Demandes trait√©es et archiv√©es</p>
                 </div>
                 <button 
                   onClick={handleExportCSV}
                   className="px-6 py-3 rounded-xl bg-emerald-600 text-white font-black text-xs uppercase flex items-center gap-2 shadow-lg hover:bg-emerald-700 transition-colors"
                 >
                    <Download size={16}/> Exporter Excel
                 </button>
              </div>

              {/* Archives Table */}
              <div className={`flex-1 rounded-[32px] border overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <div className="overflow-x-auto h-full">
                    <table className="w-full text-left text-sm">
                       <thead className="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                          <tr>
                             <th className="p-4 font-black uppercase text-xs text-slate-500 w-32">Date</th>
                             <th className="p-4 font-black uppercase text-xs text-slate-500">Nom / Prospect</th>
                             <th className="p-4 font-black uppercase text-xs text-slate-500">Entreprise</th>
                             <th className="p-4 font-black uppercase text-xs text-slate-500 w-32 text-center">Statut Final</th>
                             <th className="p-4 font-black uppercase text-xs text-slate-500">Note / Motif</th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                          {sortedArchives.map(item => (
                            <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                               <td className="p-4 font-bold text-slate-600 dark:text-slate-300">{new Date(item.requestDate).toLocaleDateString()}</td>
                               <td className="p-4 font-bold text-slate-900 dark:text-white">{item.contactName}</td>
                               <td className="p-4 text-slate-500">{item.companyName || '-'}</td>
                               <td className="p-4 text-center">
                                  <span className={`px-3 py-1 rounded-full text-[9px] font-black uppercase ${
                                    item.status === 'processed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-500'
                                  }`}>
                                    {item.status === 'processed' ? 'Valid√©' : 'Non Abouti'}
                                  </span>
                               </td>
                               <td className="p-4 text-slate-500 italic truncate max-w-xs">{item.note || '-'}</td>
                            </tr>
                          ))}
                          {sortedArchives.length === 0 && (
                            <tr>
                               <td colSpan={5} className="p-8 text-center text-slate-400 italic">Aucune archive disponible.</td>
                            </tr>
                          )}
                       </tbody>
                    </table>
                 </div>
              </div>
           </div>
         )}

         {/* --- CONTACTS TAB --- */}
         {activeTab === 'contacts' && (
           <div className="flex flex-col md:flex-row h-full gap-4 md:gap-6 w-full">
              {/* Left: List */}
              <div className={`w-full md:w-1/3 flex flex-col rounded-[32px] border overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 <div className="p-4 border-b border-slate-100 dark:border-slate-700 space-y-3">
                    <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-transparent focus-within:border-indigo-500">
                       <Search size={16} className="text-slate-400"/>
                       <input 
                         type="text" 
                         placeholder="Rechercher un contact..." 
                         className="bg-transparent outline-none text-xs font-bold w-full"
                         value={contactSearch}
                         onChange={(e) => setContactSearch(e.target.value)}
                        />
                    </div>
                    {/* EXPORT BUTTON */}
                    <button onClick={handleExportContacts} className="w-full py-2 rounded-xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-500 uppercase flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        <Download size={14}/> Exporter CSV
                    </button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
                    {filteredContacts.map(client => (
                      <div 
                        key={client.id} 
                        onClick={() => setSelectedContact(client)}
                        className={`p-4 rounded-xl cursor-pointer transition-all border ${selectedContact?.id === client.id ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200' : 'bg-transparent border-transparent hover:bg-slate-50 dark:hover:bg-slate-900'}`}
                      >
                         <div className="flex justify-between items-start">
                            <span className="font-bold text-sm">{client.name}</span>
                            <span className="text-[9px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 uppercase">{client.type === 'Entreprise' ? 'PRO' : 'PERSO'}</span>
                         </div>
                         <p className="text-xs text-slate-500 truncate">{client.email}</p>
                      </div>
                    ))}
                 </div>
              </div>

              {/* Right: Detail */}
              <div className={`flex-1 rounded-[32px] border overflow-hidden p-8 flex flex-col ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                 {selectedContact ? (
                   <div className="flex-1 flex flex-col h-full">
                      <div className="flex justify-between items-start mb-8">
                         <div>
                            <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Fiche Client</span>
                            <h2 className="text-3xl font-black mt-1">{selectedContact.name}</h2>
                            {selectedContact.companyName && <p className="text-sm font-bold text-slate-500">{selectedContact.companyName}</p>}
                         </div>
                         <div className="flex flex-col items-end gap-4">
                            <div className="text-right space-y-1">
                                <p className="text-sm font-bold">{selectedContact.email}</p>
                                <p className="text-sm font-bold">{selectedContact.phone}</p>
                            </div>
                            <button 
                                onClick={() => handleDeleteClient(selectedContact.id)}
                                className="flex items-center gap-2 text-xs font-bold text-red-400 hover:text-red-600 transition-colors bg-red-50 dark:bg-red-900/10 px-3 py-1.5 rounded-lg uppercase"
                            >
                                <Trash2 size={14}/> Supprimer
                            </button>
                         </div>
                      </div>

                      <div className="flex-1 overflow-y-auto">
                         <h4 className="text-xs font-black uppercase text-slate-400 mb-4 flex items-center gap-2"><Clock size={14}/> Historique des demandes</h4>
                         <div className="space-y-3">
                            {clientHistory.map(history => (
                              <div key={history.id} className="flex items-center justify-between p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800">
                                 <div>
                                    <p className="font-bold text-sm">{history.groupName}</p>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase">{new Date(history.requestDate).toLocaleDateString()} ‚Ä¢ {history.pax} PAX</p>
                                 </div>
                                 <span className={`text-[9px] font-black uppercase px-2 py-1 rounded ${
                                   history.status === 'valide' ? 'bg-emerald-100 text-emerald-600' : 
                                   history.status === 'perdu' ? 'bg-slate-200 text-slate-500' : 
                                   'bg-blue-100 text-blue-600'
                                 }`}>
                                   {history.status.replace('_', ' ')}
                                 </span>
                              </div>
                            ))}
                            {clientHistory.length === 0 && <p className="text-xs text-slate-400 italic">Aucun historique disponible.</p>}
                         </div>
                      </div>
                   </div>
                 ) : (
                   <div className="flex-1 flex flex-col items-center justify-center opacity-30">
                      <Users size={64} className="mb-4 text-slate-400"/>
                      <p className="text-xl font-black text-slate-500">S√©lectionnez un contact</p>
                   </div>
                 )}
              </div>
           </div>
         )}

         {/* --- NEW LEAD TAB --- */}
         {activeTab === 'new_lead' && (
           <div className="w-full max-w-2xl mx-auto overflow-y-auto no-scrollbar py-6">
              <div className={`p-8 rounded-[32px] border shadow-sm space-y-6 ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                 <h3 className="text-xl font-black uppercase tracking-tight">Nouvelle Demande Qualifi√©e</h3>
                 
                 <div className="space-y-4">
                    <div>
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Nom du Groupe / √âv√©nement *</label>
                       <input 
                         type="text" 
                         className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                         placeholder="Ex: S√©minaire L'Or√©al"
                         value={form.groupName}
                         onChange={(e) => setForm({...form, groupName: e.target.value})}
                       />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4">
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Contact Principal *</label>
                          <input 
                            type="text" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            placeholder="Nom du contact"
                            value={form.contactName}
                            onChange={(e) => setForm({...form, contactName: e.target.value})}
                          />
                       </div>
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">PAX Pr√©vu</label>
                          <input 
                            type="number" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            value={form.pax || ''}
                            onChange={(e) => setForm({...form, pax: parseInt(e.target.value) || 0})}
                          />
                       </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Email</label>
                          <input 
                            type="email" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            value={form.email}
                            onChange={(e) => setForm({...form, email: e.target.value})}
                          />
                       </div>
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">T√©l√©phone</label>
                          <input 
                            type="tel" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            value={form.phone}
                            onChange={(e) => setForm({...form, phone: e.target.value})}
                          />
                       </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Date Arriv√©e</label>
                          <input 
                            type="date" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            value={form.startDate || ''}
                            onChange={(e) => setForm({...form, startDate: e.target.value})}
                          />
                       </div>
                       <div>
                          <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Date D√©part</label>
                          <input 
                            type="date" 
                            className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm"
                            value={form.endDate || ''}
                            onChange={(e) => setForm({...form, endDate: e.target.value})}
                          />
                       </div>
                    </div>

                    <div>
                       <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Note / Commentaire</label>
                       <textarea 
                         className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-indigo-500 outline-none font-bold text-sm resize-none h-32"
                         placeholder="D√©tails de la demande..."
                         value={form.note}
                         onChange={(e) => setForm({...form, note: e.target.value})}
                       />
                    </div>
                 </div>

                 <div className="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                    <button 
                      onClick={handleCreateLead}
                      className="px-8 py-4 rounded-2xl bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition-colors"
                    >
                       Ajouter au Pipeline
                    </button>
                 </div>
              </div>
           </div>
         )}

      </div>
    </div>
  );
};

export default SalesCRMView;
import React, { useState } from 'react';
import { X, Moon, Sun, RefreshCw, User, MessageCircle, ShieldCheck, CheckCircle2, Loader2, QrCode, Lock, Trash2, AlertTriangle, LogOut, Plus, Shield, Users, Edit3, Save, Settings, MapPin } from 'lucide-react';
import { UserSettings, UserRole, UserPermissions } from '../types';
import { THEME_COLORS } from '../constants';
import { useAuth, getDefaultPermissions } from '../services/authContext';
import AdvancedAccessModal from './AdvancedAccessModal';

interface SettingsModalProps {
  isOpen: boolean;
  onClose: () => void;
  settings: UserSettings;
  onSave: (settings: UserSettings) => void;
  onGoogleLogin?: (token: string) => void;
  clientId?: string;
}

const SettingsModal: React.FC<SettingsModalProps> = ({ isOpen, onClose, settings, onSave, onGoogleLogin, clientId }) => {
  const { user, logout, registerUser, deleteUser, getAllUsers, updateUserPermissions, updateProfile } = useAuth();
  const [isSyncing, setIsSyncing] = useState<string | null>(null);
  const [showGoogleOAuth, setShowGoogleOAuth] = useState(false);
  const [confirmReset, setConfirmReset] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  
  // State pour gestion utilisateurs simple (Legacy)
  const [newUserEmail, setNewUserEmail] = useState('');
  const [newUserPwd, setNewUserPwd] = useState('');
  const [newUserName, setNewUserName] = useState('');
  const [newUserRole, setNewUserRole] = useState<UserRole>('staff'); 
  const [isCreatingUser, setIsCreatingUser] = useState(false);
  
  // Advanced Modal State
  const [showAdvancedAccess, setShowAdvancedAccess] = useState(false);

  const [userList, setUserList] = useState(getAllUsers());

  const isAdmin = user?.role === 'admin';

  if (!isOpen) return null;

  const handleSync = (type: 'google' | 'whatsapp') => {
    // ... (Existing Sync Logic)
    setIsSyncing(type);
    setTimeout(() => {
      onSave({ 
        ...settings, 
        [type === 'google' ? 'googleSync' : 'whatsappSync']: !settings[type === 'google' ? 'googleSync' : 'whatsappSync'] 
      });
      setIsSyncing(null);
    }, 1500);
  };

  const handleResetData = () => {
    localStorage.clear();
    window.location.reload();
  };

  // SAFE SAVE FUNCTION
  const handleSaveSettings = async () => {
    setIsSaving(true);
    try {
      // 1. Si le nom a chang√©, mettre √† jour le profil AUTH (Base de donn√©es)
      if (user && settings.userName !== user.displayName) {
        await updateProfile(settings.userName);
      }
      
      // 2. Mettre √† jour les pr√©f√©rences locales (Theme, etc.)
      onSave(settings);

      // 3. Fermer la modale uniquement si succ√®s
      onClose();
    } catch (e) {
      console.error("Erreur critique sauvegarde r√©glages:", e);
      alert("Une erreur est survenue lors de l'enregistrement. Veuillez r√©essayer.");
    } finally {
      setIsSaving(false);
    }
  };

  const handleCreateUser = async () => {
    if(!newUserEmail || !newUserPwd || !newUserName) return;
    try {
      await registerUser(newUserEmail, newUserPwd, newUserRole, newUserName, getDefaultPermissions(newUserRole));
      setNewUserEmail(''); setNewUserPwd(''); setNewUserName(''); setIsCreatingUser(false);
      setUserList(getAllUsers()); // Refresh list
    } catch (e: any) {
      alert(e.message);
    }
  };

  const handleDeleteUser = async (uid: string) => {
    if(window.confirm("Supprimer cet utilisateur ?")) {
      try {
        await deleteUser(uid);
        setUserList(getAllUsers());
      } catch (e: any) {
        alert(e.message);
      }
    }
  };

  const accentColor = THEME_COLORS.find(c => c.value === settings.themeColor)?.hex || '#4f46e5';

  return (
    <>
      <div className="fixed inset-0 z-[100] bg-black/80 flex items-end md:items-center md:justify-center animate-in fade-in backdrop-blur-md">
        {/* Modal Content */}
        <div className={`w-full md:max-w-2xl md:rounded-[40px] md:mx-4 rounded-t-[40px] p-6 pb-8 animate-in slide-in-from-bottom-20 md:slide-in-from-bottom-10 shadow-2xl max-h-[90%] md:max-h-[85%] flex flex-col ${settings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-950'}`}>
          
          <div className="flex justify-between items-center mb-6 flex-shrink-0 px-2">
            <h3 className="text-2xl font-black tracking-tight">R√©glages</h3>
            <button onClick={onClose} className="p-2.5 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:bg-slate-200 transition-colors">
              <X size={20}/>
            </button>
          </div>

          <div className="flex-1 overflow-y-auto no-scrollbar space-y-8 px-2">
            
            {/* Profil & Pr√©f√©rences */}
            <div className="space-y-4">
              <label className={`text-[10px] font-black uppercase tracking-[0.2em] ml-1 ${settings.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Profil & Pr√©f√©rences</label>
              
              {/* Nom */}
              <div className={`flex items-center gap-4 px-4 py-3.5 rounded-[22px] border-2 transition-all ${settings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-100 focus-within:border-indigo-500'}`}>
                <div className="p-2 bg-indigo-500 rounded-xl text-white">
                  <User size={18} />
                </div>
                <div className="flex-1">
                  <p className="text-xs font-bold opacity-50 uppercase tracking-wider mb-0.5">{user?.role} - {user?.permissions.canManageSettings ? 'Acc√®s Total' : 'Acc√®s Limit√©'}</p>
                  <input 
                    type="text" 
                    value={settings.userName} 
                    onChange={(e) => onSave({ ...settings, userName: e.target.value })}
                    className="bg-transparent outline-none w-full text-sm font-black placeholder:text-slate-400"
                  />
                </div>
              </div>
            </div>

            {/* Apparence */}
            <div className="space-y-3">
              <label className={`text-[10px] font-black uppercase tracking-[0.2em] ml-1 ${settings.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Apparence</label>
              <div className="flex justify-between gap-2 px-1 overflow-x-auto no-scrollbar py-1">
                {THEME_COLORS.map(c => (
                  <button
                    key={c.value}
                    onClick={() => onSave({ ...settings, themeColor: c.value })}
                    className={`w-10 h-10 rounded-[15px] flex-shrink-0 transition-all transform hover:scale-110 active:scale-95 ${settings.themeColor === c.value ? 'ring-2 ring-offset-2 ring-indigo-500 dark:ring-indigo-400 scale-105 shadow-md' : 'opacity-80'}`}
                    style={{ backgroundColor: c.hex }}
                  />
                ))}
              </div>
              <div 
                  onClick={() => onSave({ ...settings, darkMode: !settings.darkMode })}
                  className={`flex items-center justify-between p-4 rounded-[24px] cursor-pointer transition-all border-2 ${settings.darkMode ? 'bg-slate-800 border-indigo-500/30 shadow-inner' : 'bg-slate-50 border-transparent'}`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`p-2.5 rounded-xl ${settings.darkMode ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-500 text-white'}`}>
                      {settings.darkMode ? <Moon size={18}/> : <Sun size={18}/>}
                    </div>
                    <div>
                      <span className="text-xs font-black block leading-none">Mode Sombre</span>
                    </div>
                  </div>
                  <div className={`w-11 h-6 rounded-full transition-all relative ${settings.darkMode ? 'bg-indigo-500' : 'bg-slate-300'}`}>
                    <div className={`absolute top-1 w-4 h-4 rounded-full bg-white shadow-md transition-all ${settings.darkMode ? 'left-6' : 'left-1'}`} />
                  </div>
                </div>
            </div>

            {/* Gestion Utilisateurs & Permissions (Admin Only) */}
            {isAdmin && (
               <div className="space-y-3 pt-4 border-t border-slate-100 dark:border-slate-800 animate-in fade-in">
                 <div className="flex justify-between items-center px-1">
                   <label className={`text-[10px] font-black uppercase tracking-[0.2em] ${settings.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Gestion Utilisateurs</label>
                   
                   {/* NEW: ADVANCED ACCESS BUTTON */}
                   <button 
                     onClick={() => setShowAdvancedAccess(true)}
                     className="px-4 py-2 rounded-xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 text-[10px] font-black uppercase flex items-center gap-2 shadow-lg hover:opacity-90 transition-opacity"
                   >
                     <Settings size={12}/> Gestion Avanc√©e des Acc√®s
                   </button>
                 </div>

                 {/* Quick Add User (Legacy preserved but simplified) */}
                 <button onClick={() => setIsCreatingUser(!isCreatingUser)} className="text-indigo-500 text-[10px] font-black uppercase flex items-center gap-1 pl-1">
                     <Plus size={12} /> Ajout Rapide
                 </button>

                 {isCreatingUser && (
                   <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 space-y-3 animate-in zoom-in">
                      <h4 className="text-xs font-black uppercase mb-2">Nouvel Utilisateur</h4>
                      <div className="grid grid-cols-2 gap-3">
                        <input type="text" placeholder="Nom" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="w-full bg-transparent text-xs font-bold outline-none border-b pb-1 dark:text-white" />
                        <input type="email" placeholder="Email" value={newUserEmail} onChange={(e) => setNewUserEmail(e.target.value)} className="w-full bg-transparent text-xs font-bold outline-none border-b pb-1 dark:text-white" />
                      </div>
                      <input type="password" placeholder="Mot de passe" value={newUserPwd} onChange={(e) => setNewUserPwd(e.target.value)} className="w-full bg-transparent text-xs font-bold outline-none border-b pb-1 dark:text-white" />
                      <div className="flex gap-2 items-center">
                        <span className="text-[10px] font-bold text-slate-400">R√¥le:</span>
                        <select value={newUserRole} onChange={(e) => setNewUserRole(e.target.value as UserRole)} className="bg-transparent text-xs font-bold outline-none dark:text-white border rounded p-1">
                          <option value="admin">Administrateur</option>
                          <option value="manager">Manager</option>
                          <option value="staff">Staff</option>
                        </select>
                        <button onClick={handleCreateUser} className="ml-auto px-4 py-1.5 bg-indigo-600 text-white rounded-lg text-[10px] font-black uppercase">Cr√©er</button>
                      </div>
                   </div>
                 )}

                 <div className="space-y-2">
                   {userList.map(u => (
                     <div key={u.uid} className={`p-3 rounded-2xl border bg-white border-slate-100 dark:bg-slate-800 dark:border-slate-700`}>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <div className={`p-2 rounded-xl ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : u.role === 'manager' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500'}`}>
                                {u.role === 'admin' ? <Shield size={14} /> : <Users size={14} />}
                              </div>
                              <div>
                                <p className="text-xs font-bold dark:text-white">{u.displayName}</p>
                                <p className="text-[9px] text-slate-400 capitalize">{u.role}</p>
                              </div>
                            </div>
                            {u.uid !== user?.uid && (
                              <button onClick={() => handleDeleteUser(u.uid)} className="p-2 text-slate-300 hover:text-red-500 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                                <Trash2 size={14} />
                              </button>
                            )}
                          </div>
                     </div>
                   ))}
                 </div>
               </div>
            )}

            {/* Zone de Danger (Admin Only) */}
            {isAdmin && (
              <div className="space-y-2 pt-4 border-t border-slate-100 dark:border-slate-800">
                 <button 
                   onClick={() => setConfirmReset(!confirmReset)}
                   className={`w-full py-3 rounded-2xl flex items-center justify-center gap-2 text-xs font-bold transition-colors ${confirmReset ? 'bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400' : 'text-slate-400 hover:text-slate-600'}`}
                 >
                   {confirmReset ? <AlertTriangle size={14}/> : <Trash2 size={14}/>}
                   {confirmReset ? '√ätes-vous s√ªr ?' : 'R√©initialiser toutes les donn√©es'}
                 </button>
                 {confirmReset && (
                   <button 
                     onClick={handleResetData}
                     className="w-full py-3 rounded-2xl bg-red-500 text-white text-xs font-black uppercase tracking-widest shadow-lg animate-in zoom-in"
                   >
                     Confirmer suppression
                   </button>
                 )}
              </div>
            )}
          </div>

          <div className="pt-6 flex-shrink-0 px-2 space-y-3">
            <button 
              onClick={handleSaveSettings}
              disabled={isSaving}
              className={`w-full py-5 rounded-[28px] text-white font-black uppercase tracking-[0.15em] shadow-xl transition-all active:scale-95 text-sm flex items-center justify-center gap-2 ${isSaving ? 'opacity-70 cursor-not-allowed' : ''}`}
              style={{ backgroundColor: accentColor }}
            >
              {isSaving ? <Loader2 size={18} className="animate-spin" /> : <ShieldCheck size={18} />}
              {isSaving ? 'Enregistrement...' : 'Enregistrer'}
            </button>
            
            <button 
              onClick={() => { logout(); onClose(); }}
              className="w-full py-4 rounded-[28px] border-2 border-slate-100 dark:border-slate-700 text-slate-400 font-black uppercase tracking-[0.15em] hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-xs flex items-center justify-center gap-2"
            >
              <LogOut size={16} /> D√©connexion
            </button>
          </div>
        </div>
      </div>

      {/* ADVANCED MODAL */}
      <AdvancedAccessModal 
        isOpen={showAdvancedAccess} 
        onClose={() => setShowAdvancedAccess(false)} 
      />
    </>
  );
};

export default SettingsModal;

import React, { useState, useMemo } from 'react';
import { 
  Flower2, Plus, Calendar, Clock, Phone, Mail, 
  CheckCircle2, XCircle, AlertCircle, User, X, Search, Filter, ArrowDownUp, Archive, History
} from 'lucide-react';
import { SpaRequest, UserSettings, SpaRefusalReason, SpaStatus } from '../types';

interface SpaViewProps {
  userSettings: UserSettings;
  requests: SpaRequest[];
  onUpdateRequests: (requests: SpaRequest[]) => void;
}

const SpaView: React.FC<SpaViewProps> = ({ userSettings, requests, onUpdateRequests }) => {
  const [showNewModal, setShowNewModal] = useState(false);
  const [showRefusalModal, setShowRefusalModal] = useState(false);
  const [selectedRequestId, setSelectedRequestId] = useState<string | null>(null);
  
  // --- FILTER & SORT STATE ---
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<'pending' | 'confirmed' | 'today' | 'archived'>('pending');
  const [sortOrder, setSortOrder] = useState<'date_asc' | 'created_desc' | 'status'>('date_asc');

  // New Request Form
  const [newRequest, setNewRequest] = useState({
    clientName: '',
    phone: '',
    email: '',
    date: new Date().toISOString().split('T')[0],
    time: '10:00',
    treatment: ''
  });

  // Refusal Form
  const [refusalReason, setRefusalReason] = useState<SpaRefusalReason>('complet_cabine');

  const handleValidate = (id: string) => {
    const updated = requests.map(r => r.id === id ? { ...r, status: 'confirmed' as const } : r);
    onUpdateRequests(updated);
  };

  const handleDeclineClick = (id: string) => {
    setSelectedRequestId(id);
    setShowRefusalModal(true);
  };

  const handleConfirmRefusal = () => {
    if (!selectedRequestId) return;
    const updated = requests.map(r => r.id === selectedRequestId ? { 
      ...r, 
      status: 'refused' as SpaStatus,
      refusalReason: refusalReason
    } : r);
    onUpdateRequests(updated);
    setShowRefusalModal(false);
    setSelectedRequestId(null);
  };

  const handleSaveNew = () => {
    if (!newRequest.clientName || !newRequest.date || !newRequest.time) return;
    
    const request: SpaRequest = {
      id: `spa-${Date.now()}`,
      ...newRequest,
      status: 'pending',
      createdAt: new Date().toISOString()
    };
    
    onUpdateRequests([request, ...requests]);
    setShowNewModal(false);
    setNewRequest({
      clientName: '', phone: '', email: '', 
      date: new Date().toISOString().split('T')[0], time: '10:00', treatment: ''
    });
  };

  // --- FILTERING LOGIC (NULL SAFETY) ---
  const processedRequests = useMemo(() => {
    const todayStr = new Date().toISOString().split('T')[0];

    return requests.filter(req => {
      // 1. Search Filter (Safe Lowercase)
      const searchLower = searchTerm.toLowerCase();
      const matchesSearch = 
        (req.clientName || '').toLowerCase().includes(searchLower) ||
        (req.phone || '').includes(searchLower) ||
        (req.email || '').toLowerCase().includes(searchLower);

      if (!matchesSearch) return false;

      // 2. Status/Chip Filter
      if (filterStatus === 'pending') return req.status === 'pending';
      if (filterStatus === 'confirmed') return req.status === 'confirmed' && req.date >= todayStr;
      if (filterStatus === 'today') return req.date === todayStr && (req.status as string) !== 'refused';
      if (filterStatus === 'archived') {
        // Show refused OR past confirmed events
        return (req.status as string) === 'refused' || (req.status === 'confirmed' && req.date < todayStr);
      }
      return true;
    }).sort((a, b) => {
      // 3. Sorting (Safe Date Parsing)
      try {
        if (sortOrder === 'date_asc') {
          // Sort by Care Date (Next -> Far)
          const dateA = new Date(`${a.date || '9999-12-31'}T${a.time || '00:00'}`).getTime();
          const dateB = new Date(`${b.date || '9999-12-31'}T${b.time || '00:00'}`).getTime();
          return dateA - dateB;
        } 
        if (sortOrder === 'created_desc') {
          // Sort by Request Date (Recent -> Old)
          const createdA = new Date(a.createdAt || 0).getTime();
          const createdB = new Date(b.createdAt || 0).getTime();
          return createdB - createdA;
        }
        if (sortOrder === 'status') {
          return (a.status || '').localeCompare(b.status || '');
        }
        return 0;
      } catch (e) {
        return 0; // Prevent crash on sort error
      }
    });
  }, [requests, searchTerm, filterStatus, sortOrder]);

  const getStatusColor = (req: SpaRequest) => {
    // Override color for past events in archive view
    const todayStr = new Date().toISOString().split('T')[0];
    const isPast = req.date < todayStr;

    if (filterStatus === 'archived' || isPast || (req.status as string) === 'refused') {
       return 'border-slate-200 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 opacity-80 grayscale';
    }

    switch (req.status as string) {
      case 'confirmed': return 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20';
      case 'refused': return 'border-red-200 bg-red-50 dark:bg-red-900/10 opacity-70';
      default: return 'border-violet-200 bg-white dark:bg-slate-800'; // Pending
    }
  };

  return (
    <div className={`h-full flex flex-col overflow-hidden animate-in fade-in ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* Header */}
      <div className={`p-6 border-b z-20 flex justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-50 border-slate-200'}`}>
         <div className="flex items-center gap-4">
            <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
              <Flower2 size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Spa & Bien-√™tre</h2>
              <p className="text-xs font-bold text-slate-400">Demandes de Soins</p>
            </div>
         </div>
         <button 
           onClick={() => setShowNewModal(true)}
           className="px-6 py-3 rounded-xl bg-violet-600 text-white font-black text-xs uppercase flex items-center gap-2 shadow-lg hover:bg-violet-700 transition-colors"
         >
           <Plus size={16}/> Nouvelle R√©servation
         </button>
      </div>

      {/* TOOLBAR */}
      <div className={`px-6 py-4 border-b flex flex-col md:flex-row gap-4 justify-between items-center ${userSettings.darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
         
         {/* Search */}
         <div className="flex items-center bg-slate-100 dark:bg-slate-800 rounded-xl px-3 py-2 w-full md:w-64 border border-transparent focus-within:border-violet-500 transition-colors">
            <Search size={16} className="text-slate-400 mr-2"/>
            <input 
              type="text" 
              placeholder="üîç Chercher un client..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="bg-transparent outline-none text-xs font-bold w-full"
            />
         </div>

         {/* Quick Filters */}
         <div className="flex gap-2 overflow-x-auto no-scrollbar w-full md:w-auto">
            <button 
              onClick={() => setFilterStatus('pending')}
              className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase whitespace-nowrap border transition-all ${filterStatus === 'pending' ? 'bg-violet-100 text-violet-700 border-violet-200' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}`}
            >
               En Attente
            </button>
            <button 
              onClick={() => setFilterStatus('confirmed')}
              className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase whitespace-nowrap border transition-all ${filterStatus === 'confirmed' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}`}
            >
               Confirm√©s
            </button>
            <button 
              onClick={() => setFilterStatus('today')}
              className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase whitespace-nowrap border transition-all ${filterStatus === 'today' ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}`}
            >
               Aujourd'hui
            </button>
            <button 
              onClick={() => setFilterStatus('archived')}
              className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase whitespace-nowrap border transition-all ${filterStatus === 'archived' ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}`}
            >
               Archives / Refus√©s
            </button>
         </div>

         {/* Sort */}
         <div className="flex items-center gap-2 w-full md:w-auto">
            <ArrowDownUp size={14} className="text-slate-400"/>
            <select 
              value={sortOrder}
              onChange={(e) => setSortOrder(e.target.value as any)}
              className="bg-transparent text-xs font-bold outline-none cursor-pointer text-slate-600 dark:text-slate-300"
            >
               <option value="date_asc">üìÖ Date de Soin (Prochain)</option>
               <option value="created_desc">üì© Date Demande (R√©cent)</option>
               <option value="status">Statut</option>
            </select>
         </div>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto px-6 pb-20 pt-6 no-scrollbar">
         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
            {processedRequests.map(req => (
              <div 
                key={req.id} 
                className={`p-5 rounded-3xl border-2 transition-all hover:shadow-md flex flex-col justify-between ${getStatusColor(req)}`}
              >
                 <div className="space-y-4">
                    <div className="flex justify-between items-start">
                       <div className="flex items-center gap-2">
                          <div className={`p-2 rounded-full shadow-sm ${filterStatus === 'archived' ? 'bg-slate-200 text-slate-500' : 'bg-white dark:bg-slate-700 text-violet-500'}`}>
                             <User size={16}/>
                          </div>
                          <div>
                             <h3 className="font-bold text-sm">{req.clientName}</h3>
                             <p className="text-[10px] text-slate-500 font-medium">Demande du {new Date(req.createdAt || Date.now()).toLocaleDateString()}</p>
                          </div>
                       </div>
                       <span className={`px-2 py-1 rounded text-[9px] font-black uppercase ${
                         req.status === 'confirmed' ? 'bg-emerald-100 text-emerald-700' :
                         req.status === 'refused' ? 'bg-red-100 text-red-700' :
                         'bg-violet-100 text-violet-700'
                       }`}>
                         {req.status === 'pending' ? 'En attente' : req.status === 'confirmed' ? 'Confirm√©' : 'Refus√©'}
                       </span>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                       <div className="p-3 bg-white/50 dark:bg-slate-900/50 rounded-xl flex items-center gap-2">
                          <Calendar size={14} className="text-slate-400"/>
                          <span className="text-xs font-bold">{req.date ? new Date(req.date).toLocaleDateString() : 'Date N/A'}</span>
                       </div>
                       <div className="p-3 bg-white/50 dark:bg-slate-900/50 rounded-xl flex items-center gap-2">
                          <Clock size={14} className="text-slate-400"/>
                          <span className="text-xs font-bold">{req.time || '--:--'}</span>
                       </div>
                    </div>

                    <div className="p-3 bg-white/50 dark:bg-slate-900/50 rounded-xl">
                       <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Soin souhait√©</p>
                       <p className="text-sm font-medium italic">"{req.treatment || 'Non pr√©cis√©'}"</p>
                    </div>

                    <div className="flex gap-4 text-xs font-bold">
                       <a href={`tel:${req.phone}`} className="flex items-center gap-1 text-slate-500 hover:text-violet-600 transition-colors">
                          <Phone size={12}/> {req.phone}
                       </a>
                       {req.email && (
                         <a href={`mailto:${req.email}`} className="flex items-center gap-1 text-slate-500 hover:text-violet-600 transition-colors">
                            <Mail size={12}/> Email
                         </a>
                       )}
                    </div>
                 </div>

                 {/* ACTION BUTTONS (Only if pending) */}
                 {req.status === 'pending' && (
                   <div className="flex gap-2 mt-6 pt-4 border-t border-slate-200 dark:border-slate-700/50">
                      <button 
                        onClick={() => handleDeclineClick(req.id)}
                        className="flex-1 py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 dark:border-red-900/50 dark:hover:bg-red-900/20 font-bold text-xs uppercase flex items-center justify-center gap-2 transition-colors"
                      >
                         <XCircle size={16}/> D√©cliner
                      </button>
                      <button 
                        onClick={() => handleValidate(req.id)}
                        className="flex-1 py-3 rounded-xl bg-emerald-500 text-white font-bold text-xs uppercase flex items-center justify-center gap-2 shadow-md hover:bg-emerald-600 transition-colors"
                      >
                         <CheckCircle2 size={16}/> Valider
                      </button>
                   </div>
                 )}

                 {/* ARCHIVE/REFUSED DETAILS */}
                 {(req.status as string) === 'refused' && req.refusalReason && (
                   <div className="mt-4 pt-2 border-t border-red-200">
                      <p className="text-[10px] text-red-500 font-bold uppercase flex items-center gap-1">
                         <AlertCircle size={10}/> Motif : {req.refusalReason.replace('_', ' ')}
                      </p>
                   </div>
                 )}
                 {req.status === 'confirmed' && req.date < new Date().toISOString().split('T')[0] && (
                   <div className="mt-4 pt-2 border-t border-slate-200 dark:border-slate-700">
                      <p className="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1">
                         <History size={10}/> Soin Termin√© / Pass√©
                      </p>
                   </div>
                 )}
              </div>
            ))}
            {processedRequests.length === 0 && (
              <div className="col-span-full py-20 text-center opacity-40">
                 <Flower2 size={48} className="mx-auto mb-4 text-slate-400"/>
                 <p className="font-bold text-slate-500">Aucune demande trouv√©e avec ces filtres.</p>
              </div>
            )}
         </div>
      </div>

      {/* MODAL NEW REQUEST */}
      {showNewModal && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className={`w-full max-w-md rounded-[32px] p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-xl font-black">Nouvelle Demande</h3>
                 <button onClick={() => setShowNewModal(false)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={20}/></button>
              </div>
              <div className="space-y-4">
                 <input 
                   type="text" 
                   placeholder="Nom & Pr√©nom" 
                   className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border border-transparent focus:border-violet-500"
                   value={newRequest.clientName}
                   onChange={(e) => setNewRequest({...newRequest, clientName: e.target.value})}
                 />
                 <div className="grid grid-cols-2 gap-3">
                    <input 
                      type="tel" 
                      placeholder="T√©l√©phone" 
                      className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border border-transparent focus:border-violet-500"
                      value={newRequest.phone}
                      onChange={(e) => setNewRequest({...newRequest, phone: e.target.value})}
                    />
                    <input 
                      type="email" 
                      placeholder="Email" 
                      className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border border-transparent focus:border-violet-500"
                      value={newRequest.email}
                      onChange={(e) => setNewRequest({...newRequest, email: e.target.value})}
                    />
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                    <input 
                      type="date" 
                      className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border border-transparent focus:border-violet-500"
                      value={newRequest.date}
                      onChange={(e) => setNewRequest({...newRequest, date: e.target.value})}
                    />
                    <input 
                      type="time" 
                      className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none border border-transparent focus:border-violet-500"
                      value={newRequest.time}
                      onChange={(e) => setNewRequest({...newRequest, time: e.target.value})}
                    />
                 </div>
                 <textarea 
                   placeholder="Soin souhait√© / Commentaire (ex: Massage dos 30min)" 
                   className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 font-medium text-sm outline-none border border-transparent focus:border-violet-500 resize-none h-24"
                   value={newRequest.treatment}
                   onChange={(e) => setNewRequest({...newRequest, treatment: e.target.value})}
                 />
                 <button 
                   onClick={handleSaveNew}
                   className="w-full py-4 rounded-2xl bg-violet-600 text-white font-black uppercase text-xs tracking-widest shadow-lg mt-2"
                 >
                    Enregistrer Demande
                 </button>
              </div>
           </div>
        </div>
      )}

      {/* MODAL REFUSAL */}
      {showRefusalModal && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
           <div className={`w-full max-w-sm rounded-[32px] p-6 shadow-2xl ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
              <h3 className="text-lg font-black mb-4 text-center">Motif du Refus</h3>
              <div className="space-y-4">
                 <select 
                   value={refusalReason}
                   onChange={(e) => setRefusalReason(e.target.value as SpaRefusalReason)}
                   className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 font-bold text-sm outline-none cursor-pointer border border-transparent focus:border-red-500"
                 >
                    <option value="complet_cabine">Complet (Cabine)</option>
                    <option value="complet_soin">Complet (Praticien)</option>
                    <option value="contre_indication">Contre-indication M√©dicale</option>
                    <option value="annulation">Annulation Client</option>
                    <option value="autre">Autre motif</option>
                 </select>
                 <div className="flex gap-2">
                    <button onClick={() => setShowRefusalModal(false)} className="flex-1 py-3 rounded-xl font-bold text-xs text-slate-500 bg-slate-100 dark:bg-slate-800">Annuler</button>
                    <button onClick={handleConfirmRefusal} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-xs uppercase shadow-md hover:bg-red-600">Confirmer Refus</button>
                 </div>
              </div>
           </div>
        </div>
      )}

    </div>
  );
};

export default SpaView;


import React, { useState, useMemo } from 'react';
import { X, TrendingUp, DollarSign, Users, Calendar, AlertCircle, BarChart3, PieChart, ArrowUpRight, Filter, ChevronDown, CheckCircle2 } from 'lucide-react';
import { Group, UserSettings } from '../types';

interface StatsModalProps {
  isOpen: boolean;
  onClose: () => void;
  groups: Group[];
  userSettings: UserSettings;
}

const StatsModal: React.FC<StatsModalProps> = ({ isOpen, onClose, groups, userSettings }) => {
  const [dateRange, setDateRange] = useState<'month' | 'year' | 'all'>('year');
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());

  // --- DATA PROCESSING ---

  // 1. Filter Groups based on range
  const filteredGroups = useMemo(() => {
    return groups.filter(g => {
      const start = new Date(g.startDate);
      if (dateRange === 'all') return true;
      if (dateRange === 'year') return start.getFullYear() === selectedYear;
      if (dateRange === 'month') {
        const now = new Date();
        return start.getMonth() === now.getMonth() && start.getFullYear() === now.getFullYear();
      }
      return true;
    });
  }, [groups, dateRange, selectedYear]);

  // 2. Financial KPIs
  const financialData = useMemo(() => {
    let totalHT = 0;
    let totalTTC = 0;
    let expectedCashflow = 0; // Arrhes non per√ßues
    let confirmedCount = 0;

    filteredGroups.forEach(g => {
      if (g.status === 'confirmed') {
        confirmedCount++;
        let groupHT = 0;
        let groupTTC = 0;

        g.invoiceItems?.forEach(item => {
          const lineHT = item.quantity * item.unitPrice;
          const lineTTC = lineHT * (1 + item.vatRate / 100);
          groupHT += lineHT;
          groupTTC += lineTTC;
        });

        totalHT += groupHT;
        totalTTC += groupTTC;

        // Cashflow Gap (Unpaid deposits)
        g.paymentSchedule?.forEach(p => {
          if (!p.paid) {
            expectedCashflow += (groupTTC * p.percentage / 100);
          }
        });
      }
    });

    return { totalHT, totalTTC, expectedCashflow, confirmedCount };
  }, [filteredGroups]);

  // 3. Operational KPIs
  const opsData = useMemo(() => {
    let totalNights = 0; // Cumul nuit√©es
    let totalPax = 0;
    const roomDistrib = { single: 0, twin: 0, double: 0, family: 0 };

    filteredGroups.forEach(g => {
      if (g.status === 'confirmed') {
        totalNights += g.nights;
        totalPax += g.pax;
        if (g.rooms) {
          roomDistrib.single += (g.rooms.single * g.nights);
          roomDistrib.twin += (g.rooms.twin * g.nights);
          roomDistrib.double += (g.rooms.double * g.nights);
          roomDistrib.family += (g.rooms.family * g.nights);
        }
      }
    });

    const totalRoomNights = roomDistrib.single + roomDistrib.twin + roomDistrib.double + roomDistrib.family;

    return { totalNights, totalPax, roomDistrib, totalRoomNights };
  }, [filteredGroups]);

  // 4. Monthly Revenue Chart Data
  const monthlyRevenue = useMemo(() => {
    const data: number[] = new Array(12).fill(0);
    filteredGroups.forEach(g => {
      if (g.status === 'confirmed') {
        const d = new Date(g.startDate);
        if (!isNaN(d.getTime())) {
          const month = d.getMonth();
          let groupHT = 0;
          g.invoiceItems?.forEach(item => groupHT += item.quantity * item.unitPrice);
          data[month] += groupHT;
        }
      }
    });
    return data;
  }, [filteredGroups]);

  // 5. Top Items
  const topItems = useMemo(() => {
    const itemsMap: Record<string, { qty: number, rev: number }> = {};
    filteredGroups.forEach(g => {
      if (g.status === 'confirmed') {
        g.invoiceItems?.forEach(item => {
          if (!item.description) return;
          if (!itemsMap[item.description]) itemsMap[item.description] = { qty: 0, rev: 0 };
          itemsMap[item.description].qty += item.quantity;
          itemsMap[item.description].rev += item.quantity * item.unitPrice;
        });
      }
    });
    return Object.entries(itemsMap)
      .sort((a, b) => b[1].rev - a[1].rev)
      .slice(0, 5);
  }, [filteredGroups]);

  // 6. Pending Payments List
  const pendingPayments = useMemo(() => {
    const payments: { groupName: string, amount: number, date: string, label: string, status: string }[] = [];
    filteredGroups.forEach(g => {
      // Calcul du total TTC du groupe pour appliquer les pourcentages
      let groupTTC = 0;
      g.invoiceItems?.forEach(item => groupTTC += (item.quantity * item.unitPrice) * (1 + item.vatRate / 100));

      g.paymentSchedule?.forEach(p => {
        if (!p.paid) {
          const amount = groupTTC * p.percentage / 100;
          payments.push({
            groupName: g.name,
            amount,
            date: p.dueDate,
            label: p.label,
            status: new Date(p.dueDate) < new Date() ? 'overdue' : 'pending'
          });
        }
      });
    });
    return payments.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  }, [filteredGroups]);


  if (!isOpen) return null;

  const maxRevenue = Math.max(...monthlyRevenue, 1); // Avoid division by zero

  return (
    <div className="fixed inset-0 z-[160] bg-black/80 flex items-center justify-center animate-in fade-in backdrop-blur-sm p-4">
      <div className={`w-full max-w-6xl rounded-[40px] p-8 shadow-2xl flex flex-col h-[90vh] ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
        
        {/* Header */}
        <div className="flex justify-between items-center mb-8 shrink-0">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-violet-600 rounded-2xl text-white shadow-lg shadow-violet-500/20">
              <BarChart3 size={28} />
            </div>
            <div>
              <h2 className="text-2xl font-black">Tableau de Bord</h2>
              <p className="text-xs font-bold text-slate-400">Performances & Analyse</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
             <div className={`flex p-1 rounded-xl ${userSettings.darkMode ? 'bg-slate-800' : 'bg-white border'}`}>
                {(['month', 'year', 'all'] as const).map(r => (
                  <button 
                    key={r}
                    onClick={() => setDateRange(r)}
                    className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${dateRange === r ? 'bg-violet-600 text-white shadow' : 'text-slate-400 hover:text-slate-600'}`}
                  >
                    {r === 'month' ? 'Ce mois' : r === 'year' ? `Ann√©e ${selectedYear}` : 'Tout'}
                  </button>
                ))}
             </div>
             <button onClick={onClose} className="p-3 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-500 hover:opacity-80"><X size={20}/></button>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto pr-2 pb-10 custom-scrollbar space-y-6">
          
          {/* KPI Cards */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
             {/* CA */}
             <div className={`p-6 rounded-[28px] border relative overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className="flex justify-between items-start mb-4 relative z-10">
                   <div className="p-3 rounded-xl bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20">
                     <DollarSign size={20}/>
                   </div>
                   <span className="text-[10px] font-black uppercase text-slate-400 bg-slate-50 dark:bg-slate-700 px-2 py-1 rounded-lg">Confirm√©</span>
                </div>
                <h3 className="text-3xl font-black text-slate-900 dark:text-white mb-1">{financialData.totalHT.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}</h3>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">CA Total HT</p>
                {/* Decorative blob */}
                <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-emerald-500/10 rounded-full blur-2xl pointer-events-none"></div>
             </div>

             {/* Cashflow */}
             <div className={`p-6 rounded-[28px] border relative overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className="flex justify-between items-start mb-4 relative z-10">
                   <div className="p-3 rounded-xl bg-amber-50 text-amber-600 dark:bg-amber-900/20">
                     <AlertCircle size={20}/>
                   </div>
                   <span className="text-[10px] font-black uppercase text-amber-500">√Ä Encaisser</span>
                </div>
                <h3 className="text-3xl font-black text-slate-900 dark:text-white mb-1">{financialData.expectedCashflow.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}</h3>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Tr√©sorerie Attendue</p>
             </div>

             {/* Volume */}
             <div className={`p-6 rounded-[28px] border relative overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className="flex justify-between items-start mb-4 relative z-10">
                   <div className="p-3 rounded-xl bg-blue-50 text-blue-600 dark:bg-blue-900/20">
                     <Users size={20}/>
                   </div>
                </div>
                <div className="flex items-baseline gap-2">
                  <h3 className="text-3xl font-black text-slate-900 dark:text-white mb-1">{opsData.totalPax}</h3>
                  <span className="text-sm font-bold text-slate-400">Pax</span>
                </div>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">{financialData.confirmedCount} Groupes Confirm√©s</p>
             </div>

             {/* Nights */}
             <div className={`p-6 rounded-[28px] border relative overflow-hidden ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className="flex justify-between items-start mb-4 relative z-10">
                   <div className="p-3 rounded-xl bg-indigo-50 text-indigo-600 dark:bg-indigo-900/20">
                     <Calendar size={20}/>
                   </div>
                </div>
                <h3 className="text-3xl font-black text-slate-900 dark:text-white mb-1">{opsData.totalNights}</h3>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Nuit√©es Groupes</p>
             </div>
          </div>

          {/* Charts Row */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
             
             {/* Revenue Bar Chart */}
             <div className={`col-span-2 p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
               <h3 className="text-sm font-black uppercase text-slate-400 tracking-widest mb-6 flex items-center gap-2"><TrendingUp size={16}/> √âvolution du CA Mensuel</h3>
               <div className="h-64 flex items-end justify-between gap-2 md:gap-4 px-2">
                  {monthlyRevenue.map((val: number, idx: number) => (
                    <div key={idx} className="flex-1 flex flex-col items-center gap-2 group">
                       <div className="w-full relative flex items-end h-full">
                          <div 
                            className="w-full bg-indigo-500 rounded-t-lg transition-all duration-500 group-hover:bg-indigo-400 relative"
                            style={{ height: `${(val / maxRevenue) * 100}%`, minHeight: val > 0 ? '4px' : '0' }}
                          >
                             {val > 0 && (
                               <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[9px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                 {(val / 1000).toFixed(1)}k‚Ç¨
                               </div>
                             )}
                          </div>
                       </div>
                       <span className="text-[9px] font-bold text-slate-400 uppercase">{new Date(2000, idx, 1).toLocaleDateString('fr-FR', { month: 'short' })}</span>
                    </div>
                  ))}
               </div>
             </div>

             {/* Room Distribution (Simple Visualization) */}
             <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
               <h3 className="text-sm font-black uppercase text-slate-400 tracking-widest mb-6 flex items-center gap-2"><PieChart size={16}/> R√©partition Chambres</h3>
               
               <div className="space-y-4">
                  {Object.entries(opsData.roomDistrib).map(([type, rawCount]) => {
                    const count = rawCount as number;
                    const percentage = opsData.totalRoomNights > 0 ? (count / opsData.totalRoomNights) * 100 : 0;
                    return (
                      <div key={type}>
                        <div className="flex justify-between text-xs font-bold mb-1">
                          <span className="capitalize text-slate-600 dark:text-slate-300">{type}</span>
                          <span className="text-slate-400">{Math.round(percentage)}%</span>
                        </div>
                        <div className="h-3 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                          <div 
                            className={`h-full rounded-full ${type === 'single' ? 'bg-blue-500' : type === 'twin' ? 'bg-indigo-500' : type === 'double' ? 'bg-violet-500' : 'bg-fuchsia-500'}`} 
                            style={{ width: `${percentage}%` }}
                          />
                        </div>
                      </div>
                    );
                  })}
                  {opsData.totalRoomNights === 0 && <p className="text-xs text-slate-400 italic text-center py-10">Aucune donn√©e</p>}
               </div>
             </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
             
             {/* Pending Payments Table */}
             <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <h3 className="text-sm font-black uppercase text-slate-400 tracking-widest mb-6 flex items-center gap-2"><AlertCircle size={16}/> Relances R√®glements</h3>
                <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                   {pendingPayments.map((p, idx) => (
                     <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-transparent hover:border-slate-200 transition-colors">
                        <div>
                           <p className="font-bold text-sm text-slate-800 dark:text-white">{p.groupName}</p>
                           <p className={`text-[10px] font-bold uppercase tracking-wide ${p.status === 'overdue' ? 'text-red-500' : 'text-slate-400'}`}>
                             {p.label} ‚Ä¢ {new Date(p.date).toLocaleDateString('fr-FR')}
                           </p>
                        </div>
                        <div className="text-right">
                           <p className="font-black text-slate-900 dark:text-white">{p.amount.toFixed(0)} ‚Ç¨</p>
                           {p.status === 'overdue' && <span className="text-[8px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold uppercase">Retard</span>}
                        </div>
                     </div>
                   ))}
                   {pendingPayments.length === 0 && <p className="text-xs text-slate-400 italic text-center py-4">Aucun paiement en attente.</p>}
                </div>
             </div>

             {/* Top Items */}
             <div className={`p-6 rounded-[32px] border ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100 shadow-sm'}`}>
                <h3 className="text-sm font-black uppercase text-slate-400 tracking-widest mb-6 flex items-center gap-2"><ArrowUpRight size={16}/> Top Ventes (CA)</h3>
                <div className="space-y-3">
                   {topItems.map((item, idx) => (
                     <div key={idx} className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center font-black text-xs text-slate-500">#{idx+1}</div>
                        <div className="flex-1">
                           <div className="flex justify-between text-xs font-bold mb-1">
                              <span className="truncate">{item[0]}</span>
                              <span>{item[1].rev.toFixed(0)} ‚Ç¨</span>
                           </div>
                           <div className="h-1.5 w-full bg-slate-100 dark:bg-slate-700 rounded-full">
                              <div className="h-full bg-emerald-500 rounded-full" style={{ width: `${topItems[0][1].rev > 0 ? (item[1].rev / topItems[0][1].rev) * 100 : 0}%` }} />
                           </div>
                        </div>
                     </div>
                   ))}
                   {topItems.length === 0 && <p className="text-xs text-slate-400 italic text-center py-4">Pas assez de donn√©es.</p>}
                </div>
             </div>

          </div>

        </div>
      </div>
    </div>
  );
};

export default StatsModal;

import React, { useState, useEffect, useRef } from 'react';
import { X, Calendar, Clock, MessageSquare, Paperclip, ChevronDown, FileText, Trash2, Download, Eye, Plus, AlertCircle, Briefcase, Smartphone, Share2, Loader2 } from 'lucide-react';
import { Contact, Task, UserSettings, Attachment, Group } from '../types';
import { TASK_TYPES } from '../constants';
import { generateId } from '../services/db';

interface TaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  contacts: Contact[];
  onSave: (task: Task, options?: { sendSms?: boolean, shareInChat?: boolean }) => void;
  userSettings: UserSettings;
  editTask?: Task | null;
  onTriggerCommunication?: (contactId: number, text: string) => void;
  groups?: Group[]; 
}

const TaskModal: React.FC<TaskModalProps> = ({ isOpen, onClose, contacts, onSave, userSettings, editTask, onTriggerCommunication, groups = [] }) => {
  const [text, setText] = useState('');
  const [tag, setTag] = useState('G√©n√©ral');
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [note, setNote] = useState('');
  const [contactId, setContactId] = useState<string | number>('');
  const [linkedGroupId, setLinkedGroupId] = useState<string | number>(''); 
  const [priority, setPriority] = useState<'Low' | 'Medium' | 'High'>('Medium'); 
  const [status, setStatus] = useState<'Pas commenc√©' | 'En cours' | 'Termin√©'>('Pas commenc√©');
  const [attachments, setAttachments] = useState<Attachment[]>([]);
  
  // Options de communication
  const [sendSms, setSendSms] = useState(false);
  const [shareInChat, setShareInChat] = useState(false);

  const fileInputRef = useRef<HTMLInputElement>(null);
  const [showTimePicker, setShowTimePicker] = useState(false);
  const hours = Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0'));
  const minutes = ['00', '15', '30', '45'];

  useEffect(() => {
    if (editTask && isOpen) {
      setText(editTask.text); setTag(editTask.tag); setDate(editTask.date || '');
      setTime(editTask.time || ''); setNote(editTask.note || '');
      setContactId(editTask.linkedContactId || ''); 
      setLinkedGroupId(editTask.linkedGroupId || '');
      setPriority(editTask.priority || 'Medium');
      setStatus(editTask.status);
      
      if (editTask.attachments) {
        setAttachments(editTask.attachments);
      } else {
        setAttachments([]);
      }
      // Reset options on edit
      setSendSms(false);
      setShareInChat(false);

    } else if (!editTask && isOpen) {
      setText(''); setTag('G√©n√©ral'); setDate(''); setTime(''); setNote(''); 
      setContactId(''); setLinkedGroupId(''); setPriority('Medium'); setStatus('Pas commenc√©');
      setAttachments([]);
      setSendSms(false);
      setShareInChat(true); // Default share for new tasks
    }
    setShowTimePicker(false);
  }, [editTask, isOpen]);

  // --- LOGIQUE D'UPLOAD ROBUSTE (Rempla√ßant l'async/await) ---
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 1. Validation Taille
    if (file.size > 5 * 1024 * 1024) {
      alert("Le fichier est trop lourd (Max 5 Mo).");
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }

    // 2. Lecture via FileReader Standard (Callback)
    const reader = new FileReader();
    reader.onloadend = () => {
      if (typeof reader.result === 'string') {
         const newAttachment: Attachment = {
            id: `att-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: file.name,
            type: file.type,
            url: reader.result
         };
         setAttachments(prev => [...prev, newAttachment]);
      }
    };
    reader.onerror = () => {
      alert("Erreur lors de la lecture du fichier.");
    };
    reader.readAsDataURL(file);

    // 3. Reset Input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const removeAttachment = (id: string) => {
    setAttachments(prev => prev.filter(a => a.id !== id));
  };

  if (!isOpen) return null;

  const handleSave = () => {
    if (!text) return;
    onSave({
      id: editTask ? editTask.id : generateId('task-'), // UUID-compatible ID
      text, tag, date, time, status,
      done: status === 'Termin√©', linkedContactId: contactId, linkedGroupId, priority, note,
      attachments,
    }, { sendSms, shareInChat });
    onClose();
  };

  const handleTimeSelect = (h: string, m: string) => {
    setTime(`${h}:${m}`);
    setShowTimePicker(false);
  };

  const themeBg = `bg-${userSettings.themeColor}-600`;
  const selectedContact = contacts.find(c => c.id.toString() === contactId.toString());

  return (
    <div className={`fixed inset-0 z-[110] bg-black/60 flex items-end md:items-center md:justify-center animate-in fade-in backdrop-blur-sm overflow-hidden ${userSettings.darkMode ? 'dark' : ''}`}>
      <div className={`w-full md:max-w-xl md:rounded-[40px] md:mx-4 rounded-t-[40px] p-8 pb-12 animate-in slide-in-from-bottom-20 md:slide-in-from-bottom-10 max-h-[92vh] overflow-y-auto no-scrollbar ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        <div className="flex justify-between items-center mb-8">
          <h3 className="text-2xl font-black">{editTask ? 'Modifier T√¢che' : 'Nouvelle T√¢che'}</h3>
          <button onClick={onClose} className="p-3 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400"><X size={20}/></button>
        </div>

        <div className="space-y-6">
          <div className="p-6 rounded-[28px] border-2 border-slate-100 dark:border-slate-800">
            <textarea placeholder="Titre de la t√¢che..." value={text} onChange={(e) => setText(e.target.value)} className="w-full bg-transparent outline-none font-black text-xl resize-none h-16 dark:text-white placeholder:text-slate-400" />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
             <div className="space-y-1">
               <label className="text-[10px] font-black uppercase text-slate-400 ml-1">√âch√©ance</label>
               <div className="relative h-[54px]">
                 <div className="absolute inset-0 p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-2 border-transparent hover:border-indigo-400 flex items-center gap-2 shadow-sm transition-colors">
                   <Calendar size={16} className="text-indigo-500" />
                   <span className="font-black text-xs dark:text-white">
                      {date ? new Date(date).toLocaleDateString('fr-FR') : 'D√©finir date'}
                   </span>
                 </div>
                 <input 
                    type="date" 
                    value={date} 
                    onChange={(e) => setDate(e.target.value)} 
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                 />
               </div>
             </div>
             
             <div className="space-y-1 relative">
               <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Heure</label>
               <button 
                 type="button"
                 onClick={() => setShowTimePicker(!showTimePicker)}
                 className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-2 border-transparent hover:border-indigo-400 flex items-center justify-between shadow-sm transition-colors"
               >
                 <div className="flex items-center gap-2">
                   <Clock size={16} className="text-indigo-500" />
                   <span className="font-black text-xs dark:text-white">{time || '--:--'}</span>
                 </div>
                 <ChevronDown size={14} className={`text-slate-400 transition-transform ${showTimePicker ? 'rotate-180' : ''}`} />
               </button>

               {showTimePicker && (
                 <div className="absolute top-full left-0 right-0 mt-2 p-3 bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-3xl shadow-2xl z-50 animate-in zoom-in-95">
                    <div className="grid grid-cols-4 gap-1 h-32 overflow-y-auto no-scrollbar py-1">
                      {hours.map(h => (
                        <div key={h} className="contents">
                          {minutes.map(m => (
                            <button 
                              key={`${h}:${m}`} 
                              onClick={() => handleTimeSelect(h, m)}
                              className={`p-1.5 rounded-lg text-[9px] font-black transition-all ${time === `${h}:${m}` ? 'bg-indigo-600 text-white' : 'hover:bg-indigo-50 dark:hover:bg-slate-700 text-slate-500'}`}
                            >
                              {h}:{m}
                            </button>
                          ))}
                        </div>
                      ))}
                    </div>
                 </div>
               )}
             </div>
          </div>

          <div className="space-y-2">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Type</label>
            <div className="flex flex-wrap gap-2">
              {TASK_TYPES.map(t => (
                <button key={t} onClick={() => setTag(t)} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase border-2 transition-all ${tag === t ? 'border-indigo-600 bg-indigo-50 text-indigo-600 dark:bg-slate-700 dark:text-indigo-400' : 'border-slate-50 dark:border-slate-800 text-slate-400'}`}>{t}</button>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
             <div className="space-y-1">
                <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Priorit√©</label>
                <div className="flex gap-1 p-1 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                   <button onClick={() => setPriority('Low')} className={`flex-1 py-3 rounded-xl text-[9px] font-black uppercase transition-all ${priority === 'Low' ? 'bg-white shadow-sm text-slate-600' : 'text-slate-400'}`}>Bas</button>
                   <button onClick={() => setPriority('Medium')} className={`flex-1 py-3 rounded-xl text-[9px] font-black uppercase transition-all ${priority === 'Medium' ? 'bg-white shadow-sm text-violet-600' : 'text-slate-400'}`}>Moyen</button>
                   <button onClick={() => setPriority('High')} className={`flex-1 py-3 rounded-xl text-[9px] font-black uppercase transition-all ${priority === 'High' ? 'bg-white shadow-sm text-red-600' : 'text-slate-400'}`}>Urgent</button>
                </div>
             </div>
             <div className="space-y-1">
                <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Lier Groupe</label>
                <div className="relative">
                  <select 
                    value={linkedGroupId} 
                    onChange={(e) => setLinkedGroupId(e.target.value)} 
                    className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none font-bold text-xs outline-none appearance-none dark:text-white"
                  >
                    <option value="">Aucun groupe</option>
                    {groups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                  </select>
                  <Briefcase size={14} className="absolute right-4 top-4 text-slate-400 pointer-events-none" />
                </div>
             </div>
          </div>

          <div className="space-y-1">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Note (Optionnel)</label>
            <textarea placeholder="D√©tails, instructions..." value={note} onChange={(e) => setNote(e.target.value)} className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none font-bold text-xs h-24 dark:text-white placeholder:text-slate-400" />
          </div>

          {/* Attachments Section */}
          <div className="space-y-3">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Pi√®ces Jointes</label>
            <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleFileChange} 
                className="hidden" 
                accept="image/*" 
            />
            <div className="space-y-2">
              {attachments.map((att) => (
                <div key={att.id} className="flex items-center justify-between p-4 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 border-2 border-indigo-100 dark:border-indigo-800 animate-in zoom-in">
                  <div 
                    onClick={() => window.open(att.url, '_blank')}
                    className="flex items-center gap-3 overflow-hidden flex-1 cursor-pointer group/att"
                    title="Cliquer pour voir/t√©l√©charger"
                  >
                    {/* STYLE ADAPT√â DU MODULE MAINTENANCE POUR LES PHOTOS */}
                    {att.type.startsWith('image/') ? (
                       <div className="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-900 overflow-hidden flex-shrink-0 border border-slate-200 dark:border-slate-700 relative">
                          <img src={att.url} alt={att.name} className="w-full h-full object-cover" />
                       </div>
                    ) : (
                       <div className="p-2 bg-white dark:bg-indigo-800 rounded-xl shrink-0">
                          <FileText size={18} className="text-indigo-600 dark:text-indigo-300" />
                       </div>
                    )}
                    <span className="text-xs font-bold truncate dark:text-indigo-100 group-hover/att:text-indigo-600 group-hover/att:underline transition-all">
                      {att.name}
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <button type="button" onClick={() => removeAttachment(att.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                      <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              ))}
              <button 
                type="button" 
                onClick={() => fileInputRef.current?.click()} 
                className="flex items-center gap-2 px-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 text-slate-500 font-bold text-xs w-full justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm border-2 border-dashed border-slate-200 dark:border-slate-700"
              >
                <Plus size={16}/>
                Ajouter un fichier
              </button>
            </div>
          </div>

          {/* Communication Options */}
          <div className="space-y-4 pt-4 border-t border-slate-100 dark:border-slate-800">
            <div>
              <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Lier un contact (SMS)</label>
              <select value={contactId} onChange={(e) => setContactId(e.target.value)} className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 font-bold text-sm text-slate-900 dark:text-white border-none outline-none appearance-none">
                <option value="">S√©lectionner...</option>
                {contacts.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
            </div>

            {/* Checkboxes for Actions */}
            <div className="flex flex-col gap-3">
               {contactId && (
                 <label className={`flex items-center gap-3 p-3 rounded-2xl border-2 cursor-pointer transition-all ${sendSms ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800' : 'bg-slate-50 border-transparent dark:bg-slate-800'}`}>
                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${sendSms ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}>
                       {sendSms && <Plus size={12} className="text-white"/>}
                    </div>
                    <input type="checkbox" checked={sendSms} onChange={(e) => setSendSms(e.target.checked)} className="hidden" />
                    <div className="flex-1">
                       <span className="text-xs font-bold block">Envoyer une alerte SMS</span>
                       <span className="text-[10px] text-slate-400">√Ä {selectedContact?.name || 'Contact s√©lectionn√©'}</span>
                    </div>
                    <Smartphone size={18} className={sendSms ? 'text-emerald-500' : 'text-slate-300'} />
                 </label>
               )}

               <label className={`flex items-center gap-3 p-3 rounded-2xl border-2 cursor-pointer transition-all ${shareInChat ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/20 dark:border-indigo-800' : 'bg-slate-50 border-transparent dark:bg-slate-800'}`}>
                  <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${shareInChat ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>
                     {shareInChat && <Plus size={12} className="text-white"/>}
                  </div>
                  <input type="checkbox" checked={shareInChat} onChange={(e) => setShareInChat(e.target.checked)} className="hidden" />
                  <div className="flex-1">
                     <span className="text-xs font-bold block">Partager dans la Messagerie</span>
                     <span className="text-[10px] text-slate-400">Notifier l'√©quipe (Interne)</span>
                  </div>
                  <Share2 size={18} className={shareInChat ? 'text-indigo-500' : 'text-slate-300'} />
               </label>
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-[10px] font-black uppercase text-slate-400 ml-1">√âtat initial</label>
            <div className="flex gap-2 p-1 bg-slate-50 dark:bg-slate-800 rounded-2xl">
              {(['Pas commenc√©', 'En cours', 'Termin√©'] as const).map(s => (
                <button key={s} onClick={() => setStatus(s)} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${status === s ? 'bg-white dark:bg-slate-700 shadow-sm text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}>{s}</button>
              ))}
            </div>
          </div>
        </div>

        <button onClick={handleSave} className={`w-full py-6 rounded-[32px] text-white font-black uppercase tracking-[0.2em] mt-8 shadow-xl ${themeBg}`}>
          {editTask ? 'Enregistrer les modifications' : 'Cr√©er la t√¢che'}
        </button>
      </div>
    </div>
  );
};

export default TaskModal;
import React, { useState } from 'react';
import { CheckSquare, Plus, Trash2, Calendar, Tag, AlertCircle, Paperclip, LayoutList, Columns, Briefcase, X, Download } from 'lucide-react';
import { Task, UserSettings, Group } from '../types';
import { TASK_TYPES } from '../constants';
import KanbanView from './KanbanView';

interface TasksViewProps {
  todos: Task[];
  userSettings: UserSettings;
  groups: Group[]; // Needed for linking
  onAdd: () => void;
  onToggle: (id: string | number) => void;
  onTaskClick: (task: Task) => void;
  onDelete: (id: string | number) => void;
  onStatusChange?: (id: string | number, status: 'Pas commenc√©' | 'En cours' | 'Termin√©') => void;
}

const TasksView: React.FC<TasksViewProps> = ({ todos, userSettings, groups, onAdd, onToggle, onTaskClick, onDelete, onStatusChange }) => {
  const [viewMode, setViewMode] = useState<'list' | 'kanban'>('list');
  const [activeTag, setActiveTag] = useState<string>('ALL');
  const [enlargedImage, setEnlargedImage] = useState<string | null>(null);

  const filtered = todos.filter(t => {
    if (activeTag !== 'ALL') return t.tag === activeTag;
    return true;
  });

  const themeColor = userSettings.themeColor;

  const getPriorityColor = (p?: string) => {
    switch (p) {
      case 'High': return 'text-red-500 bg-red-50 dark:bg-red-900/20';
      case 'Medium': return 'text-violet-500 bg-violet-50 dark:bg-violet-900/20';
      default: return 'text-slate-500 bg-slate-100 dark:bg-slate-700';
    }
  };

  return (
    <div className="px-6 py-6 space-y-6 animate-in fade-in h-full flex flex-col">
      <div className="flex justify-between items-center shrink-0">
        <h2 className="text-2xl font-black">Plan d'Action</h2>
        <div className="flex gap-2">
           <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
              <button 
                onClick={() => setViewMode('list')}
                className={`p-2 rounded-lg transition-all ${viewMode === 'list' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}
              >
                <LayoutList size={18}/>
              </button>
              <button 
                onClick={() => setViewMode('kanban')}
                className={`p-2 rounded-lg transition-all ${viewMode === 'kanban' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}
              >
                <Columns size={18}/>
              </button>
           </div>
           <button 
            onClick={onAdd}
            className={`p-2 rounded-xl text-white bg-${themeColor}-600 shadow-lg hover:opacity-90 active:scale-95 transition-all`}
          >
            <Plus size={20} />
          </button>
        </div>
      </div>

      {/* Interactive Tag Filters */}
      <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2 shrink-0">
        <button 
          onClick={() => setActiveTag('ALL')}
          className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all whitespace-nowrap border-2 ${activeTag === 'ALL' ? `border-${themeColor}-600 bg-${themeColor}-50 text-${themeColor}-600` : 'border-slate-100 dark:border-slate-800 text-slate-400 bg-white dark:bg-slate-800'}`}
        >
          Tous
        </button>
        {TASK_TYPES.map(tag => (
          <button 
            key={tag}
            onClick={() => setActiveTag(tag)}
            className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all whitespace-nowrap border-2 ${activeTag === tag ? `border-indigo-600 bg-indigo-50 text-indigo-600` : 'border-slate-100 dark:border-slate-800 text-slate-400 bg-white dark:bg-slate-800'}`}
          >
            {tag}
          </button>
        ))}
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto no-scrollbar">
        {viewMode === 'kanban' ? (
          <KanbanView 
            tasks={filtered} 
            userSettings={userSettings} 
            groups={groups}
            onTaskClick={onTaskClick}
            onStatusChange={(id, status) => onStatusChange && onStatusChange(id, status)}
          />
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
            {filtered.map(task => {
              const linkedGroup = groups.find(g => g.id.toString() === task.linkedGroupId?.toString());
              // Find first image attachment
              const imageAttachment = task.attachments?.find(a => a.type.startsWith('image/'));

              return (
              <div 
                key={task.id} 
                className={`p-5 rounded-3xl border transition-all flex items-start gap-4 hover:shadow-md relative overflow-hidden ${task.done ? 'opacity-50' : ''} ${userSettings.darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}
              >
                {/* Priority Stripe */}
                <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${task.priority === 'High' ? 'bg-red-500' : task.priority === 'Medium' ? 'bg-violet-500' : 'bg-slate-300'}`} />

                <button 
                  onClick={() => onToggle(task.id)}
                  className={`mt-0.5 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${task.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}
                >
                  {task.done && <CheckSquare size={12} className="text-white" />}
                </button>
                <div className="flex-1 cursor-pointer min-w-0" onClick={() => onTaskClick(task)}>
                  {linkedGroup && (
                    <div className="flex items-center gap-1 text-[9px] font-black text-indigo-500 uppercase mb-1">
                      <Briefcase size={10} /> {linkedGroup.name}
                    </div>
                  )}
                  <p className={`text-sm font-bold leading-snug break-words ${task.done ? 'line-through text-slate-400' : ''}`}>{task.text}</p>
                  
                  {/* Affiche la photo si elle existe */}
                  {imageAttachment && (
                    <div className="mt-3">
                        <img
                        src={imageAttachment.url}
                        alt="Rendu t√¢che"
                        // Style copi√© de Maintenance : largeur max, hauteur fixe, coins arrondis, curseur main
                        className="w-full h-32 object-cover rounded-lg cursor-pointer border border-slate-200 hover:opacity-90 transition-opacity"
                        // Au clic, on d√©finit cette image comme "agrandie"
                        onClick={(e) => {
                            e.stopPropagation(); // Important : ne pas ouvrir le d√©tail de la t√¢che
                            setEnlargedImage(imageAttachment.url);
                        }}
                        />
                    </div>
                  )}

                  <div className="flex flex-wrap gap-2 mt-3">
                    <span className={`text-[9px] font-bold px-2 py-1 rounded-lg flex items-center gap-1 ${getPriorityColor(task.priority)}`}>
                      {task.priority === 'High' ? 'Urgent' : task.priority === 'Medium' ? 'Normal' : 'Bas'}
                    </span>
                    <span className={`text-[9px] font-bold px-2 py-1 rounded-lg flex items-center gap-1 bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-300`}>
                      <Tag size={10} /> {task.tag}
                    </span>
                    {task.date && (
                      <span className="text-[9px] font-bold px-2 py-1 rounded-lg bg-slate-100 text-slate-500 flex items-center gap-1">
                        <Calendar size={10} /> {new Date(task.date).toLocaleDateString('fr-FR', {day: 'numeric', month:'short'})}
                      </span>
                    )}
                    {task.attachments && task.attachments.length > 0 && !imageAttachment && (
                      <span className="text-[9px] font-bold px-2 py-1 rounded-lg bg-indigo-100 text-indigo-600 flex items-center gap-1">
                        <Paperclip size={10} />
                      </span>
                    )}
                  </div>
                </div>
                <button 
                  onClick={() => onDelete(task.id)}
                  className="p-2 text-slate-300 hover:text-red-500 transition-colors"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            )})}
            {filtered.length === 0 && (
              <div className="col-span-full p-12 text-center text-slate-400 flex flex-col items-center justify-center min-h-[40vh]">
                <CheckSquare size={64} className="mb-4 opacity-20" />
                <p className="text-lg font-medium">Aucune t√¢che trouv√©e.</p>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Modal pour image agrandie */}
      {enlargedImage && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={() => setEnlargedImage(null)}>
            <div className="relative max-w-4xl w-full max-h-[90vh] flex flex-col items-center" onClick={e => e.stopPropagation()}>
            {/* Bouton Fermer (Croix) */}
            <button onClick={() => setEnlargedImage(null)} className="absolute -top-4 -right-4 p-2 bg-white rounded-full text-slate-800 shadow-lg hover:bg-slate-100 z-10">
                <X size={20} />
            </button>

            {/* L'image en grand */}
            <img src={enlargedImage} alt="Agrandissement" className="w-full h-full object-contain rounded-lg shadow-2xl max-h-[80vh]" />

            {/* Bouton T√©l√©charger (en bas) */}
            <div className="absolute -bottom-16 left-0 right-0 flex justify-center">
                <a 
                href={enlargedImage} 
                download={`tache-photo-${Date.now()}.jpg`} // Nom du fichier t√©l√©charg√©
                className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors"
                onClick={(e) => e.stopPropagation()} // Emp√™che la fermeture du modal au t√©l√©chargement
                >
                <Download size={20} />
                <span>T√©l√©charger l'image</span>
                </a>
            </div>
            </div>
        </div>
      )}
    </div>
  );
};

export default TasksView;

import React, { useState, useMemo } from 'react';
import { X, Calendar as CalendarIcon, ChevronLeft, ChevronRight, MapPin, Clock, Filter } from 'lucide-react';
import { Group, Venue, UserSettings } from '../types';

interface VenueCalendarModalProps {
  isOpen: boolean;
  onClose: () => void;
  groups: Group[];
  venues: Venue[];
  userSettings: UserSettings;
  onGroupClick: (group: Group) => void;
}

// Helper to estimate duration if not present (simple heuristics)
const getDurationInHours = (description: string) => {
  const lower = description.toLowerCase();
  if (lower.includes('journ√©e') || lower.includes('s√©minaire')) return 8;
  if (lower.includes('demi') || lower.includes('matin') || lower.includes('apr√®s-midi')) return 4;
  if (lower.includes('d√Æner') || lower.includes('d√©jeuner') || lower.includes('soir√©e')) return 3;
  if (lower.includes('cocktail')) return 2;
  return 1; // default
};

const VenueCalendarModal: React.FC<VenueCalendarModalProps> = ({ isOpen, onClose, groups, venues, userSettings, onGroupClick }) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState<'month' | 'week'>('week');
  const [selectedVenueId, setSelectedVenueId] = useState<string>('ALL');

  // Generate Flattened Events from Groups
  const events = useMemo(() => {
    const allEvents: any[] = [];
    groups.forEach(group => {
      if (group.invoiceItems) {
        group.invoiceItems.forEach(item => {
          if (item.date && item.location) {
            const [h, m] = (item.time || '09:00').split(':').map(Number);
            const start = new Date(item.date);
            start.setHours(h, m, 0, 0);
            
            let end: Date;
            let duration: number;

            if (item.endTime) {
              const [eh, em] = item.endTime.split(':').map(Number);
              end = new Date(item.date);
              end.setHours(eh, em, 0, 0);
              // Calculate duration in hours for grid height
              duration = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
            } else {
              duration = getDurationInHours(item.description);
              end = new Date(start);
              end.setHours(start.getHours() + duration);
            }

            allEvents.push({
              id: `${group.id}-${item.id}`,
              groupId: group.id,
              group: group, // store full group ref for click
              title: group.name,
              description: item.description,
              venue: item.location,
              start,
              end,
              duration: Math.max(0.5, duration), // Min height
              color: group.status === 'confirmed' ? 'bg-emerald-500' : 'bg-amber-400'
            });
          }
        });
      }
    });
    return allEvents;
  }, [groups]);

  // Filtering
  const filteredEvents = useMemo(() => {
    if (selectedVenueId === 'ALL') return events;
    const venueName = venues.find(v => v.id === selectedVenueId)?.name;
    return events.filter(e => e.venue === venueName);
  }, [events, selectedVenueId, venues]);

  const changeDate = (dir: number) => {
    const d = new Date(currentDate);
    if (view === 'month') {
      d.setMonth(d.getMonth() + dir);
    } else {
      d.setDate(d.getDate() + (dir * 7));
    }
    setCurrentDate(d);
  };

  const isSameDay = (d1: Date, d2: Date) => {
    return d1.getDate() === d2.getDate() && 
           d1.getMonth() === d2.getMonth() && 
           d1.getFullYear() === d2.getFullYear();
  };

  const getWeekDays = (date: Date) => {
    const startOfWeek = new Date(date);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Monday start
    startOfWeek.setDate(diff);
    
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(startOfWeek);
      d.setDate(startOfWeek.getDate() + i);
      days.push(d);
    }
    return days;
  };

  const getMonthDays = (date: Date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const days = [];
    
    // Pad start
    let startDay = firstDay.getDay(); 
    startDay = startDay === 0 ? 6 : startDay - 1; // Mon=0
    for(let i=0; i<startDay; i++) days.push(null);
    
    // Days
    for(let i=1; i<=lastDay.getDate(); i++) days.push(new Date(year, month, i));
    
    return days;
  };

  const themeClass = `bg-${userSettings.themeColor}-600`;
  const themeText = `text-${userSettings.themeColor}-600`;

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[160] bg-black/80 flex items-center justify-center animate-in fade-in backdrop-blur-sm p-2 md:p-6">
      <div className={`w-full max-w-7xl rounded-[32px] p-4 md:p-6 shadow-2xl flex flex-col h-[95vh] md:h-[90vh] ${userSettings.darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        
        {/* Header */}
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 shrink-0 gap-4">
           <div className="flex items-center gap-3 w-full md:w-auto">
             <div className={`p-3 rounded-2xl ${userSettings.darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
               <MapPin size={24} className={themeText} />
             </div>
             <div>
               <h2 className="text-xl font-black">Calendrier des Lieux</h2>
               <p className="text-xs text-slate-400 font-bold hidden md:block">Occupation des espaces</p>
             </div>
           </div>
           
           <div className="flex items-center gap-3 w-full md:w-auto overflow-x-auto">
              {/* View Switcher */}
              <div className={`flex p-1 rounded-xl ${userSettings.darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
                <button onClick={() => setView('week')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${view === 'week' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`}>Semaine</button>
                <button onClick={() => setView('month')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${view === 'month' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`}>Mois</button>
              </div>

              {/* Venue Filter */}
              <div className="relative">
                <select 
                  value={selectedVenueId} 
                  onChange={(e) => setSelectedVenueId(e.target.value)}
                  className={`appearance-none pl-3 pr-8 py-2.5 rounded-xl text-xs font-bold uppercase outline-none border-2 cursor-pointer ${userSettings.darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-700'}`}
                >
                  <option value="ALL">Tous les lieux</option>
                  {venues.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                </select>
                <Filter size={12} className="absolute right-3 top-3.5 text-slate-400 pointer-events-none" />
              </div>

              {/* Navigation */}
              <div className="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 rounded-xl p-1 ml-auto md:ml-0">
                <button onClick={() => changeDate(-1)} className="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-colors"><ChevronLeft size={16}/></button>
                <span className="text-xs font-black uppercase w-28 text-center truncate">
                  {view === 'month' 
                    ? currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric'}) 
                    : `Sem. ${currentDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}`
                  }
                </span>
                <button onClick={() => changeDate(1)} className="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-colors"><ChevronRight size={16}/></button>
              </div>
              
              <button onClick={onClose} className="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-slate-200 shrink-0"><X size={20}/></button>
           </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-hidden border rounded-3xl border-slate-200 dark:border-slate-800 relative bg-white dark:bg-slate-900/50">
          
          {/* WEEK VIEW (Detailed) */}
          {view === 'week' && (
            <div className="h-full flex flex-col overflow-hidden">
              {/* Days Header */}
              <div className="flex border-b border-slate-200 dark:border-slate-800 pr-[6px]">
                <div className="w-16 border-r border-slate-200 dark:border-slate-800 shrink-0 bg-slate-50 dark:bg-slate-800/50" /> {/* Time gutter */}
                <div className="flex-1 grid grid-cols-7">
                  {getWeekDays(currentDate).map((day, i) => (
                    <div key={i} className={`p-3 text-center border-r border-slate-200 dark:border-slate-800 last:border-0 ${isSameDay(day, new Date()) ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`}>
                      <span className="block text-[9px] font-black uppercase text-slate-400">{day.toLocaleDateString('fr-FR', { weekday: 'short' })}</span>
                      <span className={`text-lg font-black ${isSameDay(day, new Date()) ? themeText : ''}`}>{day.getDate()}</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Time Grid Scrollable */}
              <div className="flex-1 overflow-y-auto relative no-scrollbar">
                <div className="flex min-h-[1440px]"> {/* 24h * 60px height */}
                  
                  {/* Time Axis */}
                  <div className="w-16 border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/30 shrink-0 text-[10px] font-bold text-slate-400 text-center pt-2">
                    {Array.from({ length: 24 }).map((_, h) => (
                      <div key={h} className="h-[60px] border-b border-slate-100 dark:border-slate-800/50 relative">
                        <span className="-top-2 relative">{h}:00</span>
                      </div>
                    ))}
                  </div>

                  {/* Columns */}
                  <div className="flex-1 grid grid-cols-7 relative">
                    {/* Grid Lines */}
                    {Array.from({ length: 24 }).map((_, h) => (
                      <div key={`line-${h}`} className="absolute w-full border-b border-slate-100 dark:border-slate-800 pointer-events-none" style={{ top: h * 60, height: 60 }} />
                    ))}

                    {getWeekDays(currentDate).map((day, i) => {
                      const dayEvents = filteredEvents.filter(e => isSameDay(e.start, day));
                      
                      return (
                        <div key={i} className="relative border-r border-slate-200 dark:border-slate-800 last:border-0 h-[1440px]">
                          {dayEvents.map(evt => {
                            const top = (evt.start.getHours() * 60 + evt.start.getMinutes()); // 1px per min
                            const height = Math.max(40, evt.duration * 60);
                            
                            return (
                              <div 
                                key={evt.id}
                                onClick={() => onGroupClick(evt.group)}
                                className={`absolute left-1 right-1 rounded-xl p-2 cursor-pointer shadow-sm border border-black/5 hover:scale-[1.02] transition-transform z-10 overflow-hidden flex flex-col justify-center ${evt.color} text-white`}
                                style={{ top: `${top}px`, height: `${height}px` }}
                                title={`${evt.title} - ${evt.venue}`}
                              >
                                <p className="text-[10px] font-black leading-tight truncate">{evt.time || evt.start.getHours() + ':00'} - {evt.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                                <p className="font-bold text-xs leading-tight truncate">{evt.title}</p>
                                <div className="flex items-center gap-1 mt-0.5 opacity-90">
                                  <MapPin size={8} /> 
                                  <span className="text-[9px] font-medium truncate">{evt.venue}</span>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* MONTH VIEW */}
          {view === 'month' && (
            <div className="h-full flex flex-col">
              <div className="grid grid-cols-7 border-b border-slate-200 dark:border-slate-800">
                {['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].map(d => (
                  <div key={d} className="py-3 text-center text-[10px] font-black uppercase text-slate-400 tracking-widest">
                    {d}
                  </div>
                ))}
              </div>
              <div className="flex-1 grid grid-cols-7 auto-rows-fr overflow-y-auto">
                {getMonthDays(currentDate).map((day, i) => {
                  if (!day) return <div key={i} className="bg-slate-50/50 dark:bg-slate-800/20 border-b border-r border-slate-200 dark:border-slate-800" />;
                  
                  const dayEvents = filteredEvents.filter(e => isSameDay(e.start, day));
                  const isToday = isSameDay(day, new Date());

                  return (
                    <div key={i} className={`border-b border-r border-slate-200 dark:border-slate-800 p-2 min-h-[100px] flex flex-col gap-1 ${isToday ? 'bg-indigo-50/30 dark:bg-indigo-900/10' : ''}`}>
                      <span className={`text-xs font-bold mb-1 w-6 h-6 flex items-center justify-center rounded-full ${isToday ? themeClass + ' text-white' : 'text-slate-500'}`}>
                        {day.getDate()}
                      </span>
                      <div className="space-y-1 overflow-y-auto max-h-[80px] no-scrollbar">
                        {dayEvents.map(evt => (
                          <div 
                            key={evt.id}
                            onClick={() => onGroupClick(evt.group)}
                            className={`px-2 py-1 rounded-md text-[9px] font-bold truncate cursor-pointer hover:opacity-80 transition-opacity ${evt.color} text-white`}
                            title={`${evt.title} (${evt.venue})`}
                          >
                            {evt.start.getHours()}:00 {evt.title}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

        </div>
      </div>
    </div>
  );
};

export default VenueCalendarModal;
